2025-07-21 23:12:10,351 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:10,372 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:10,384 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:10,385 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:10,659 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:12:10,659 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:12:10,660 - INFO - app - Environment: PRODUCTION
2025-07-21 23:12:10,737 - INFO - app - Application startup initiated
2025-07-21 23:12:10,738 - INFO - app - Initializing core services...
2025-07-21 23:12:10,772 - INFO - app - Firebase initialized
2025-07-21 23:12:10,772 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:12:10,792 - INFO - app - Redis initialized
2025-07-21 23:12:11,328 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:12:11,331 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:12:11,334 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:12:11,334 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:12:11,334 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:12:11,334 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:12:11,335 - INFO - app - Scheduler initialized
2025-07-21 23:12:11,336 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:12:11,336 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:12:12,579 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:12:12,594 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:12:12,641 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:12:12,641 - INFO - app - Background tasks initialized
2025-07-21 23:12:12,641 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:12:13,335 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:12:13,336 - INFO - app - Application startup completed successfully
2025-07-21 23:12:13,336 - INFO - app - Starting cache validation task
2025-07-21 23:12:13,340 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:12:13,343 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:12:13,346 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:12:13,346 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:12:13,346 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:12:13,346 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:12:13,346 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:12:13,365 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:12:13,365 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:12:13,365 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:12:13,365 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:12:13,373 - INFO - app - Validating cache for 30 users
2025-07-21 23:12:13,393 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:12:13,393 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:12:13,399 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,402 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:12:13,416 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:12:13,420 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:12:13,421 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,423 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:12:13,428 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:12:13,431 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:12:13,432 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:12:13,436 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:12:13,436 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:12:13,437 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:12:13,438 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:12:13,439 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:12:13,440 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,446 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:12:13,448 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:12:13,449 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:12:13,452 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:12:13,453 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:12:13,454 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:12:13,457 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:12:13,458 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,459 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:12:13,467 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:12:13,471 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:12:13,474 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:12:13,475 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:12:13,475 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:12:13,476 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,489 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,511 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,529 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,545 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,556 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,567 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,581 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,592 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,604 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,613 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,622 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,629 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,660 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,672 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:12:13,675 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,991 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:12:13,994 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:12:13,996 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:12:13,998 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:12:13,998 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470900000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470900000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3470800000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3470800000'}], 'margin_call': False}
2025-07-21 23:12:13,999 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:12:14,000 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,000 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:12:14,000 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:12:14,008 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,018 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,026 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,026 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:12:14,030 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,042 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,053 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,053 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:12:14,058 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,066 - INFO - app - Cache validation completed
2025-07-21 23:12:14,071 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,072 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:12:14,283 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:12:14,627 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-191.75390755762426341747232', 'margin': '9494.47', 'free_margin': '-9686.22390755762426341747232', 'profit_loss': '-10093.77390755762426341747232', 'margin_level': '-2.019637826625649071696180198', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10028.45000000000000000000000', 'current_price': '117426.3000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-59.38537050693114856133846601', 'current_price': '96.2340000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.938537050693114856133846601', 'current_price': '96.2340000000'}], 'margin_call': False}
2025-07-21 23:12:14,629 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -2.019637826625649071696180198
2025-07-21 23:12:14,629 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:12:14,629 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:12:14,656 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,656 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:12:14,685 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,686 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:12:14,718 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,718 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:12:14,752 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,752 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:12:14,782 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,782 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:12:14,812 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,812 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:12:14,846 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,846 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:12:14,877 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,877 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:12:15,076 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:12:15,243 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,250 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,257 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,257 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,300 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,312 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,398 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,450 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.850969069942155637382887906% which is below threshold 100.0%
2025-07-21 23:12:15,450 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '109.885000000000000000000000', 'margin': '5936.62', 'free_margin': '-5826.735000000000000000000000', 'profit_loss': '-6279.735000000000000000000000', 'margin_level': '1.850969069942155637382887906', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6279.735000000000000000000000', 'current_price': '117426.3000000000'}], 'margin_call': True}
2025-07-21 23:12:15,453 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.850969069942155637382887906
2025-07-21 23:12:15,493 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:12:15,493 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:12:15,589 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,590 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,596 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,600 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,612 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,613 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,619 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,620 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,623 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,623 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,630 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,630 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,637 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,642 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,661 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,662 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,662 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,662 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,685 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,703 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,703 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,750 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:12:16,049 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.19720445450633777082307770% which is below threshold 100.0%
2025-07-21 23:12:16,049 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '92574.09000000000000000000000', 'margin': '146484.47', 'free_margin': '-53910.38000000000000000000000', 'profit_loss': '-91771.72000000000000000000000', 'margin_level': '63.19720445450633777082307770', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-116.5000000000000000000000000', 'current_price': '38.7700000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91655.22000000000000000000000', 'current_price': '117426.3000000000'}], 'margin_call': True}
2025-07-21 23:12:16,053 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.19720445450633777082307770
2025-07-21 23:12:16,071 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:12:16,072 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:12:16,147 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:16,148 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:12:16,186 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:16,186 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:12:16,230 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:16,231 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:12:16,233 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:12:16,233 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:12:16,248 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:12:16,251 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:12:16,252 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:12:16,290 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:16,290 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:12:16,293 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:12:16,293 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:12:16,296 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:12:16,296 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:12:16,490 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:12:16,492 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:12:17,367 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:12:17,370 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:12:17,375 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:12:17,375 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:12:17,509 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:12:17,510 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:12:17,921 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:12:17,938 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:12:17,938 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:12:17,939 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:12:18,145 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:12:18,146 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:12:18,516 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:12:18,521 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:12:18,522 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:12:18,522 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:12:18,572 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:18,572 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:12:18,621 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:26,796 - INFO - app - Application shutdown initiated
2025-07-21 23:12:26,797 - INFO - app - Scheduler shutdown completed
2025-07-21 23:12:26,812 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:12:27,111 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:12:27,111 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:12:28,659 - INFO - app - Redis connection closed
2025-07-21 23:12:28,659 - INFO - app - Application shutdown completed
2025-07-21 23:14:59,089 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:14:59,124 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:14:59,138 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:14:59,138 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:14:59,406 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:14:59,406 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:14:59,406 - INFO - app - Environment: PRODUCTION
2025-07-21 23:14:59,459 - INFO - app - Application startup initiated
2025-07-21 23:14:59,459 - INFO - app - Initializing core services...
2025-07-21 23:14:59,497 - INFO - app - Firebase initialized
2025-07-21 23:14:59,497 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:14:59,544 - INFO - app - Redis initialized
2025-07-21 23:15:00,207 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:15:00,210 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:15:00,212 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:15:00,212 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:15:00,212 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:15:00,213 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:15:00,213 - INFO - app - Scheduler initialized
2025-07-21 23:15:00,215 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:15:00,215 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:15:01,434 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:15:01,447 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:15:01,501 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:15:01,502 - INFO - app - Background tasks initialized
2025-07-21 23:15:01,502 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:15:02,251 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:15:02,251 - INFO - app - Application startup completed successfully
2025-07-21 23:15:02,252 - INFO - app - Starting cache validation task
2025-07-21 23:15:02,254 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:15:02,256 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:15:02,257 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:15:02,257 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:15:02,257 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:15:02,257 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:15:02,257 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:15:02,278 - INFO - app - Validating cache for 30 users
2025-07-21 23:15:02,280 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:15:02,282 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:15:02,282 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:15:02,282 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:15:02,293 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:15:02,299 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:15:02,300 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:15:02,305 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:15:02,309 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:15:02,311 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:15:02,316 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:15:02,319 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:15:02,327 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:15:02,330 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:15:02,333 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:15:02,336 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:15:02,336 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:15:02,338 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:15:02,343 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:15:02,345 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:15:02,346 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:15:02,350 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:15:02,351 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:15:02,353 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:15:02,355 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:15:02,356 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:15:02,358 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:15:02,360 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:15:02,361 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:15:02,362 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:15:02,362 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:15:02,385 - INFO - app - Cache validation completed
2025-07-21 23:15:02,526 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:15:02,837 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:15:02,839 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:15:02,841 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:15:02,842 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:15:02,842 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3466700000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3466700000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3466600000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3466600000'}], 'margin_call': False}
2025-07-21 23:15:02,844 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:15:02,845 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:15:02,845 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:15:02,869 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:02,869 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:15:02,900 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:02,900 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:15:02,931 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:02,931 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:15:03,149 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:15:03,452 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-175.29861374415599353184349', 'margin': '9494.47', 'free_margin': '-9669.76861374415599353184349', 'profit_loss': '-10077.31861374415599353184349', 'margin_level': '-1.846323320250166607844813771', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10013.33000000000000000000000', 'current_price': '117464.1000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-58.17146704014181230167590206', 'current_price': '96.2520000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.817146704014181230167590206', 'current_price': '96.2520000000'}], 'margin_call': False}
2025-07-21 23:15:03,454 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.846323320250166607844813771
2025-07-21 23:15:03,454 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:15:03,454 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:15:03,480 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,480 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:15:03,505 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,505 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:15:03,528 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,528 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:15:03,551 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,551 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:15:03,573 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,573 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:15:03,591 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,592 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:15:03,611 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,611 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:15:03,632 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,632 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:15:03,804 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:15:03,903 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:03,917 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:03,931 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:03,966 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:04,003 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:04,010 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:04,020 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:04,097 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.914641664785686131165545378% which is below threshold 100.0%
2025-07-21 23:15:04,097 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '113.665000000000000000000000', 'margin': '5936.62', 'free_margin': '-5822.955000000000000000000000', 'profit_loss': '-6275.955000000000000000000000', 'margin_level': '1.914641664785686131165545378', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6275.955000000000000000000000', 'current_price': '117464.1000000000'}], 'margin_call': True}
2025-07-21 23:15:04,100 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.914641664785686131165545378
2025-07-21 23:15:04,129 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:15:04,129 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:15:04,190 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,206 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,212 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,212 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,223 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,227 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,227 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,227 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,250 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,250 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,250 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,309 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,314 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,316 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,320 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,320 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,332 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,332 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,333 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,334 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,348 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:15:04,645 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.35292062018588045545032863% which is below threshold 100.0%
2025-07-21 23:15:04,645 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '92802.19000000000000000000000', 'margin': '146484.47', 'free_margin': '-53682.28000000000000000000000', 'profit_loss': '-91543.62000000000000000000000', 'margin_level': '63.35292062018588045545032863', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-115.2000000000000000000000000', 'current_price': '38.7960000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91428.42000000000000000000000', 'current_price': '117464.1000000000'}], 'margin_call': True}
2025-07-21 23:15:04,649 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.35292062018588045545032863
2025-07-21 23:15:04,651 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:15:04,652 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:15:04,676 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:04,676 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:15:04,693 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:04,694 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:15:04,713 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:04,713 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:15:04,714 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:15:04,714 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:15:04,718 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:15:04,719 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:15:04,719 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:15:04,732 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:04,733 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:15:04,733 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:15:04,733 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:15:04,734 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:15:04,734 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:15:04,824 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:15:04,825 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:15:05,290 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:15:05,293 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:15:05,295 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:15:05,295 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:15:05,366 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:15:05,367 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:15:05,745 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:15:05,750 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:15:05,750 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:15:05,750 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:15:05,931 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:15:05,933 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:15:06,245 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:15:06,247 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:15:06,248 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:15:06,248 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:15:06,291 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:06,291 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:15:06,322 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:17,265 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:15:17,267 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:15:17,271 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:15:17,273 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:15:17,275 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:15:17,277 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:15:17,281 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:15:17,282 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:15:17,287 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:15:17,289 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:15:17,290 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:15:17,294 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:15:17,296 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:15:17,298 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:15:17,299 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:15:17,301 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:15:17,302 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:15:17,305 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:15:17,306 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:15:17,309 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:15:17,313 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:15:17,315 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:15:17,316 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:15:17,316 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:15:31,159 - INFO - app - Application shutdown initiated
2025-07-21 23:15:31,160 - INFO - app - Scheduler shutdown completed
2025-07-21 23:15:31,296 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:15:33,049 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:15:33,050 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:15:33,065 - INFO - app - Redis connection closed
2025-07-21 23:15:33,065 - INFO - app - Application shutdown completed
2025-07-21 23:16:42,491 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:42,520 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:42,533 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:42,533 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:42,817 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:16:42,817 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:16:42,817 - INFO - app - Environment: PRODUCTION
2025-07-21 23:16:42,874 - INFO - app - Application startup initiated
2025-07-21 23:16:42,875 - INFO - app - Initializing core services...
2025-07-21 23:16:42,912 - INFO - app - Firebase initialized
2025-07-21 23:16:42,912 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:16:42,955 - INFO - app - Redis initialized
2025-07-21 23:16:43,484 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:16:43,488 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:16:43,490 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:16:43,490 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:16:43,490 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:16:43,491 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:16:43,491 - INFO - app - Scheduler initialized
2025-07-21 23:16:43,492 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:16:43,493 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:16:44,547 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:16:44,561 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:16:44,598 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:16:44,598 - INFO - app - Background tasks initialized
2025-07-21 23:16:44,598 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:16:45,777 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:16:45,777 - INFO - app - Application startup completed successfully
2025-07-21 23:16:45,777 - INFO - app - Starting cache validation task
2025-07-21 23:16:45,782 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:16:45,787 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:16:45,792 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:16:45,792 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:16:45,792 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:16:45,792 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:16:45,793 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:16:45,844 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:16:45,848 - INFO - app - Validating cache for 30 users
2025-07-21 23:16:45,856 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:16:45,857 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:16:45,857 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:16:45,870 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:16:45,893 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:16:45,893 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:16:45,896 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:16:45,898 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:16:45,900 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:16:45,902 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:16:45,903 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:16:45,906 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:16:45,907 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:16:45,909 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:16:45,910 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:16:45,913 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:16:45,914 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:16:45,914 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:16:45,915 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:16:45,916 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:16:45,918 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:16:45,919 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:16:45,922 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:16:45,924 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:16:45,925 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:16:45,928 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:16:45,930 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:16:45,931 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:16:45,932 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:16:45,933 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:16:45,977 - INFO - app - Cache validation completed
2025-07-21 23:16:46,158 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:16:46,468 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:16:46,470 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:16:46,473 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:16:46,475 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:16:46,476 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470200000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470200000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3470100000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3470100000'}], 'margin_call': False}
2025-07-21 23:16:46,492 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:16:46,494 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:16:46,494 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:16:46,515 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:46,515 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:16:46,546 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:46,546 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:16:46,596 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:46,596 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:16:46,953 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:16:47,313 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-159.15494856524093123984840', 'margin': '9494.47', 'free_margin': '-9653.62494856524093123984840', 'profit_loss': '-10061.17494856524093123984840', 'margin_level': '-1.676291025883919073311605598', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9997.690000000000000000000000', 'current_price': '117503.2000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-57.71358960476448294531672983', 'current_price': '96.2590000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.771358960476448294531672983', 'current_price': '96.2590000000'}], 'margin_call': False}
2025-07-21 23:16:47,329 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.676291025883919073311605598
2025-07-21 23:16:47,329 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:16:47,329 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:16:47,356 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,356 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:16:47,384 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,384 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:16:47,415 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,415 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:16:47,439 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,439 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:16:47,469 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,469 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:16:47,499 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,499 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:16:47,533 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,533 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:16:47,567 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,567 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:16:47,720 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:16:48,075 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,078 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,090 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,093 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,121 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,121 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,139 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,157 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.980504057864576139284643450% which is below threshold 100.0%
2025-07-21 23:16:48,158 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '117.575000000000000000000000', 'margin': '5936.62', 'free_margin': '-5819.045000000000000000000000', 'profit_loss': '-6272.045000000000000000000000', 'margin_level': '1.980504057864576139284643450', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6272.045000000000000000000000', 'current_price': '117503.2000000000'}], 'margin_call': True}
2025-07-21 23:16:48,171 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.980504057864576139284643450
2025-07-21 23:16:48,234 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:16:48,236 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:16:48,446 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,469 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,473 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,483 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,484 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,503 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,504 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,504 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,507 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,507 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,507 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,509 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,517 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,524 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:16:48,524 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,525 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,525 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,525 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
o...
2025-07-21 23:16:48,526 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,532 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,532 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,825 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.51464424863604995123373829% which is below threshold 100.0%
2025-07-21 23:16:48,825 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93039.09000000000000000000000', 'margin': '146484.47', 'free_margin': '-53445.38000000000000000000000', 'profit_loss': '-91306.72000000000000000000000', 'margin_level': '63.51464424863604995123373829', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.9000000000000000000000000', 'current_price': '38.8420000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91193.82000000000000000000000', 'current_price': '117503.2000000000'}], 'margin_call': True}
2025-07-21 23:16:48,828 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.51464424863604995123373829
2025-07-21 23:16:48,830 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:16:48,830 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:16:48,851 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:48,852 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:16:48,876 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:48,876 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:16:48,899 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:48,899 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:16:48,900 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:16:48,900 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:16:48,905 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:16:48,906 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:16:48,906 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:16:48,933 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:48,933 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:16:48,934 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:16:48,934 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:16:48,935 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:16:48,935 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:16:49,106 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:16:49,107 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:16:49,543 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:16:49,546 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:16:49,548 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:16:49,548 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:16:49,650 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:16:49,651 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:16:49,945 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:16:49,948 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:16:49,949 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:16:49,949 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:16:50,160 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:16:50,161 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:16:50,456 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:16:50,459 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:16:50,459 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:16:50,459 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:16:50,516 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:50,516 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:16:50,562 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:00,789 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:17:00,791 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:17:00,793 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:17:00,795 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:17:00,797 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:17:00,799 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:17:00,802 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:17:00,804 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:17:00,809 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:17:00,811 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:17:00,812 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:17:00,815 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:17:00,816 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:17:00,817 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:17:00,819 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:17:00,820 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:17:00,821 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:17:00,823 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:17:00,824 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:17:00,826 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:17:00,827 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:17:00,828 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:17:00,829 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:17:00,829 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:17:20,569 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:17:20,569 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:17:20,570 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:17:20,570 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:17:20,576 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:17:20,577 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:17:20,577 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:17:20,582 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:17:20,582 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:17:20,595 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:17:20,597 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:17:20,597 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:17:20,653 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:17:20,654 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:17:21,001 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:21,003 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:21,004 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:21,005 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:21,005 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.347035'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.347035'}], 'margin_call': False}
2025-07-21 23:17:21,005 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-21 23:17:21,005 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:17:21,006 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:17:21,027 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,027 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:17:21,047 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,047 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:17:21,062 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,062 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:17:21,112 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:17:21,113 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 14, falling back to DB and updating cache.
2025-07-21 23:17:21,507 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '0.0', 'equity': '-10099.66768584750522775412976', 'margin': '0.0', 'free_margin': '-10099.66768584750522775412976', 'profit_loss': '-10099.66768584750522775412976', 'margin_level': '0.0', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10033.73000000000000000000000', 'current_price': '117413.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-59.94335077045929795829977871', 'current_price': '96.226'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.994335077045929795829977871', 'current_price': '96.226'}], 'margin_call': False}
2025-07-21 23:17:21,508 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-21 23:17:21,508 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:17:21,508 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:17:21,529 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,529 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:17:21,545 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,545 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:17:21,560 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,560 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:17:21,575 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,575 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:17:21,588 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,588 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:17:21,602 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,602 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:17:21,616 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,616 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:17:21,630 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,630 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:17:21,681 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:17:22,029 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.828734195552351337966721805% which is below threshold 100.0%
2025-07-21 23:17:22,029 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '108.565000000000000000000000', 'margin': '5936.62', 'free_margin': '-5828.055000000000000000000000', 'profit_loss': '-6281.055000000000000000000000', 'margin_level': '1.828734195552351337966721805', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6281.055000000000000000000000', 'current_price': '117413.1'}], 'margin_call': True}
2025-07-21 23:17:22,033 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.828734195552351337966721805
2025-07-21 23:17:22,120 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:17:22,121 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:17:22,279 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:17:22,280 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 26, falling back to DB and updating cache.
2025-07-21 23:17:22,573 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '0.0', 'equity': '-91847.89500000000000000000000', 'margin': '0.0', 'free_margin': '-91847.89500000000000000000000', 'profit_loss': '-91847.89500000000000000000000', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.475000000000000000000000', 'current_price': '38.8305'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91734.42000000000000000000000', 'current_price': '117413.1'}], 'margin_call': False}
2025-07-21 23:17:22,575 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 0.0
2025-07-21 23:17:22,575 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:17:22,575 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:17:22,611 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:22,611 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:17:22,647 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:22,647 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:17:22,669 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:22,670 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:17:22,670 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:22,670 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:17:22,677 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:17:22,678 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:17:22,678 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:17:22,697 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:22,698 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:17:22,698 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:22,698 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:17:22,699 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:22,699 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:17:22,762 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:17:22,763 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:17:22,765 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:17:23,052 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:23,053 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-21 23:17:23,054 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:17:23,054 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:17:23,134 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:17:23,135 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:17:23,137 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:17:23,426 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:23,427 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:17:23,427 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:17:23,427 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:17:23,517 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:17:23,518 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:17:23,520 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:17:23,810 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:23,812 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:17:23,813 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:17:23,813 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:17:23,839 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:23,839 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:17:23,867 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:27,616 - INFO - app - Application shutdown initiated
2025-07-21 23:17:27,617 - INFO - app - Scheduler shutdown completed
2025-07-21 23:17:27,619 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:17:28,796 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:17:28,796 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:17:28,802 - INFO - app - Redis connection closed
2025-07-21 23:17:28,802 - INFO - app - Application shutdown completed
2025-07-21 23:17:31,221 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:31,279 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:31,296 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:31,296 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:31,860 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:17:31,860 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:17:31,860 - INFO - app - Environment: PRODUCTION
2025-07-21 23:17:31,929 - INFO - app - Application startup initiated
2025-07-21 23:17:31,929 - INFO - app - Initializing core services...
2025-07-21 23:17:31,970 - INFO - app - Firebase initialized
2025-07-21 23:17:31,970 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:17:31,991 - INFO - app - Redis initialized
2025-07-21 23:17:32,532 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:17:32,535 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:17:32,537 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:17:32,538 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:17:32,538 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:17:32,539 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:17:32,539 - INFO - app - Scheduler initialized
2025-07-21 23:17:32,540 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:17:32,540 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:17:33,478 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:17:33,493 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:17:33,523 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:17:33,523 - INFO - app - Background tasks initialized
2025-07-21 23:17:33,523 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:17:34,107 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:17:34,107 - INFO - app - Application startup completed successfully
2025-07-21 23:17:34,108 - INFO - app - Starting cache validation task
2025-07-21 23:17:34,116 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:17:34,123 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:17:34,128 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:17:34,128 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:17:34,129 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:17:34,129 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:17:34,129 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:17:34,199 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:17:34,206 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:17:34,206 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:17:34,206 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:17:34,207 - INFO - app - Validating cache for 30 users
2025-07-21 23:17:34,216 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:17:34,227 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,231 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:17:34,231 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:17:34,231 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:17:34,233 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:17:34,234 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:17:34,234 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,238 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:17:34,240 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:17:34,244 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:17:34,244 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,244 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:17:34,246 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:17:34,248 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:17:34,252 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:17:34,252 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:17:34,252 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:17:34,254 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:17:34,255 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:17:34,256 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,256 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:17:34,258 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:17:34,262 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:17:34,266 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:17:34,267 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:17:34,268 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,269 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:17:34,273 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:17:34,275 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:17:34,276 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:17:34,276 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:17:34,279 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,291 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,300 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,311 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,324 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,335 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,343 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,352 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,360 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,368 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,379 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,389 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,398 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,402 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:17:34,689 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:34,690 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,693 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:34,697 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:34,699 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:34,699 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.347035'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.347035'}], 'margin_call': False}
2025-07-21 23:17:34,699 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:17:34,700 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:17:34,700 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:17:34,706 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,713 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,721 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,727 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:34,727 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:17:34,728 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,757 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,773 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,782 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:34,782 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:17:34,787 - INFO - app - Cache validation completed
2025-07-21 23:17:34,824 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:34,825 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:17:35,026 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:17:35,340 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-198.24365275296410589572844', 'margin': '9494.47', 'free_margin': '-9692.71365275296410589572844', 'profit_loss': '-10100.26365275296410589572844', 'margin_level': '-2.087990722525471204772129882', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10033.73000000000000000000000', 'current_price': '117413.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-60.48513886633100535975312652', 'current_price': '96.218'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.048513886633100535975312652', 'current_price': '96.218'}], 'margin_call': False}
2025-07-21 23:17:35,343 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -2.087990722525471204772129882
2025-07-21 23:17:35,343 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:17:35,343 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:17:35,395 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,395 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:17:35,450 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,451 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:17:35,512 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,512 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:17:35,578 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,578 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:17:35,637 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,637 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:17:35,691 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,691 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:17:35,727 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,728 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:17:35,767 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,767 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:17:35,957 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:17:36,273 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.828734195552351337966721805% which is below threshold 100.0%
2025-07-21 23:17:36,274 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '108.565000000000000000000000', 'margin': '5936.62', 'free_margin': '-5828.055000000000000000000000', 'profit_loss': '-6281.055000000000000000000000', 'margin_level': '1.828734195552351337966721805', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6281.055000000000000000000000', 'current_price': '117413.1'}], 'margin_call': True}
2025-07-21 23:17:36,276 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.828734195552351337966721805
2025-07-21 23:17:36,322 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:17:36,322 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:17:36,488 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,490 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,490 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,556 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,585 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,605 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,608 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:17:36,654 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,851 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:36,853 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:36,856 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:36,875 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:36,875 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:36,879 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:36,879 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:36,880 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:36,880 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:36,912 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:36,935 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:37,084 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:37,084 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '92497.91500000000000000000000', 'margin': '146484.47', 'free_margin': '-53986.55500000000000000000000', 'profit_loss': '-91847.89500000000000000000000', 'margin_level': '63.14520235489809943675257862', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.475000000000000000000000', 'current_price': '38.8305'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91734.42000000000000000000000', 'current_price': '117413.1'}], 'margin_call': True}
2025-07-21 23:17:37,086 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.14520235489809943675257862
2025-07-21 23:17:37,087 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:17:37,087 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:17:37,104 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:37,104 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:37,108 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:37,109 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:37,160 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:37,160 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:17:37,233 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:37,233 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:17:37,278 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:37,278 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:17:37,280 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:37,280 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:17:37,293 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:17:37,296 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:17:37,296 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:17:37,340 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:37,340 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:17:37,343 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:37,343 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:17:37,344 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:37,344 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:17:37,494 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:17:37,495 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:17:38,264 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:17:38,267 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:17:38,271 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:17:38,272 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:17:38,449 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:17:38,451 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:17:38,750 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:38,766 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:17:38,766 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:17:38,766 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:17:39,217 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:17:39,221 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:17:39,525 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:39,533 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:17:39,534 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:17:39,536 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:17:39,597 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:39,598 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:17:39,629 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:49,116 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:17:49,118 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:17:49,121 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:17:49,123 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:17:49,125 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:17:49,128 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:17:49,131 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:17:49,133 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:17:49,138 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:17:49,139 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:17:49,140 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:17:49,143 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:17:49,144 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:17:49,145 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:17:49,146 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:17:49,147 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:17:49,148 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:17:49,150 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:17:49,151 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:17:49,153 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:17:49,154 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:17:49,155 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:17:49,156 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:17:49,156 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:17:49,484 - INFO - app - Application shutdown initiated
2025-07-21 23:17:49,484 - INFO - app - Scheduler shutdown completed
2025-07-21 23:17:49,487 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:17:49,723 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:17:49,724 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:17:49,847 - INFO - app - Redis connection closed
2025-07-21 23:17:49,848 - INFO - app - Application shutdown completed
