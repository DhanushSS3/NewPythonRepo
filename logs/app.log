2025-07-21 23:12:10,351 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:10,372 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:10,384 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:10,385 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:10,659 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:12:10,659 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:12:10,660 - INFO - app - Environment: PRODUCTION
2025-07-21 23:12:10,737 - INFO - app - Application startup initiated
2025-07-21 23:12:10,738 - INFO - app - Initializing core services...
2025-07-21 23:12:10,772 - INFO - app - Firebase initialized
2025-07-21 23:12:10,772 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:12:10,792 - INFO - app - Redis initialized
2025-07-21 23:12:11,328 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:12:11,331 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:12:11,334 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:12:11,334 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:12:11,334 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:12:11,334 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:12:11,335 - INFO - app - Scheduler initialized
2025-07-21 23:12:11,336 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:12:11,336 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:12:12,579 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:12:12,594 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:12:12,641 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:12:12,641 - INFO - app - Background tasks initialized
2025-07-21 23:12:12,641 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:12:13,335 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:12:13,336 - INFO - app - Application startup completed successfully
2025-07-21 23:12:13,336 - INFO - app - Starting cache validation task
2025-07-21 23:12:13,340 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:12:13,343 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:12:13,346 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:12:13,346 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:12:13,346 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:12:13,346 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:12:13,346 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:12:13,365 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:12:13,365 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:12:13,365 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:12:13,365 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:12:13,373 - INFO - app - Validating cache for 30 users
2025-07-21 23:12:13,393 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:12:13,393 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:12:13,399 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,402 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:12:13,416 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:12:13,420 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:12:13,421 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,423 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:12:13,428 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:12:13,431 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:12:13,432 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:12:13,436 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:12:13,436 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:12:13,437 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:12:13,438 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:12:13,439 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:12:13,440 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,446 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:12:13,448 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:12:13,449 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:12:13,452 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:12:13,453 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:12:13,454 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:12:13,457 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:12:13,458 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,459 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:12:13,467 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:12:13,471 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:12:13,474 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:12:13,475 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:12:13,475 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:12:13,476 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,489 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,511 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,529 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,545 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,556 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,567 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,581 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,592 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,604 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,613 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,622 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,629 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,660 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,672 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:12:13,675 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-21 23:12:13,991 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:12:13,994 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:12:13,996 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:12:13,998 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:12:13,998 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470900000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470900000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3470800000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3470800000'}], 'margin_call': False}
2025-07-21 23:12:13,999 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:12:14,000 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,000 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:12:14,000 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:12:14,008 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,018 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,026 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,026 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:12:14,030 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,042 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,053 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,053 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:12:14,058 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-21 23:12:14,066 - INFO - app - Cache validation completed
2025-07-21 23:12:14,071 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,072 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:12:14,283 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:12:14,627 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-191.75390755762426341747232', 'margin': '9494.47', 'free_margin': '-9686.22390755762426341747232', 'profit_loss': '-10093.77390755762426341747232', 'margin_level': '-2.019637826625649071696180198', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10028.45000000000000000000000', 'current_price': '117426.3000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-59.38537050693114856133846601', 'current_price': '96.2340000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.938537050693114856133846601', 'current_price': '96.2340000000'}], 'margin_call': False}
2025-07-21 23:12:14,629 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -2.019637826625649071696180198
2025-07-21 23:12:14,629 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:12:14,629 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:12:14,656 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,656 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:12:14,685 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,686 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:12:14,718 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,718 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:12:14,752 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,752 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:12:14,782 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,782 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:12:14,812 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,812 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:12:14,846 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,846 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:12:14,877 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:14,877 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:12:15,076 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:12:15,243 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,250 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,257 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,257 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,300 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,312 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,398 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:12:15,450 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.850969069942155637382887906% which is below threshold 100.0%
2025-07-21 23:12:15,450 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '109.885000000000000000000000', 'margin': '5936.62', 'free_margin': '-5826.735000000000000000000000', 'profit_loss': '-6279.735000000000000000000000', 'margin_level': '1.850969069942155637382887906', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6279.735000000000000000000000', 'current_price': '117426.3000000000'}], 'margin_call': True}
2025-07-21 23:12:15,453 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.850969069942155637382887906
2025-07-21 23:12:15,493 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:12:15,493 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:12:15,589 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,590 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,596 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,600 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,612 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,613 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,619 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,620 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,623 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,623 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,630 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,630 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,637 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,642 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,661 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,662 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,662 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,662 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,685 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:12:15,703 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:12:15,703 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:12:15,750 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:12:16,049 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.19720445450633777082307770% which is below threshold 100.0%
2025-07-21 23:12:16,049 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '92574.09000000000000000000000', 'margin': '146484.47', 'free_margin': '-53910.38000000000000000000000', 'profit_loss': '-91771.72000000000000000000000', 'margin_level': '63.19720445450633777082307770', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-116.5000000000000000000000000', 'current_price': '38.7700000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91655.22000000000000000000000', 'current_price': '117426.3000000000'}], 'margin_call': True}
2025-07-21 23:12:16,053 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.19720445450633777082307770
2025-07-21 23:12:16,071 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:12:16,072 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:12:16,147 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:16,148 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:12:16,186 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:16,186 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:12:16,230 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:16,231 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:12:16,233 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:12:16,233 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:12:16,248 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:12:16,251 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:12:16,252 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:12:16,290 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:16,290 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:12:16,293 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:12:16,293 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:12:16,296 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:12:16,296 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:12:16,490 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:12:16,492 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:12:17,367 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:12:17,370 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:12:17,375 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:12:17,375 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:12:17,509 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:12:17,510 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:12:17,921 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:12:17,938 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:12:17,938 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:12:17,939 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:12:18,145 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:12:18,146 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:12:18,516 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:12:18,521 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:12:18,522 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:12:18,522 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:12:18,572 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:18,572 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:12:18,621 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:12:26,796 - INFO - app - Application shutdown initiated
2025-07-21 23:12:26,797 - INFO - app - Scheduler shutdown completed
2025-07-21 23:12:26,812 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:12:27,111 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:12:27,111 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:12:28,659 - INFO - app - Redis connection closed
2025-07-21 23:12:28,659 - INFO - app - Application shutdown completed
2025-07-21 23:14:59,089 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:14:59,124 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:14:59,138 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:14:59,138 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:14:59,406 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:14:59,406 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:14:59,406 - INFO - app - Environment: PRODUCTION
2025-07-21 23:14:59,459 - INFO - app - Application startup initiated
2025-07-21 23:14:59,459 - INFO - app - Initializing core services...
2025-07-21 23:14:59,497 - INFO - app - Firebase initialized
2025-07-21 23:14:59,497 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:14:59,544 - INFO - app - Redis initialized
2025-07-21 23:15:00,207 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:15:00,210 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:15:00,212 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:15:00,212 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:15:00,212 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:15:00,213 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:15:00,213 - INFO - app - Scheduler initialized
2025-07-21 23:15:00,215 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:15:00,215 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:15:01,434 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:15:01,447 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:15:01,501 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:15:01,502 - INFO - app - Background tasks initialized
2025-07-21 23:15:01,502 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:15:02,251 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:15:02,251 - INFO - app - Application startup completed successfully
2025-07-21 23:15:02,252 - INFO - app - Starting cache validation task
2025-07-21 23:15:02,254 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:15:02,256 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:15:02,257 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:15:02,257 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:15:02,257 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:15:02,257 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:15:02,257 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:15:02,278 - INFO - app - Validating cache for 30 users
2025-07-21 23:15:02,280 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:15:02,282 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:15:02,282 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:15:02,282 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:15:02,293 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:15:02,299 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:15:02,300 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:15:02,305 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:15:02,309 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:15:02,311 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:15:02,316 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:15:02,319 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:15:02,327 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:15:02,330 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:15:02,333 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:15:02,336 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:15:02,336 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:15:02,338 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:15:02,343 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:15:02,345 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:15:02,346 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:15:02,350 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:15:02,351 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:15:02,353 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:15:02,355 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:15:02,356 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:15:02,358 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:15:02,360 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:15:02,361 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:15:02,362 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:15:02,362 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:15:02,385 - INFO - app - Cache validation completed
2025-07-21 23:15:02,526 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:15:02,837 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:15:02,839 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:15:02,841 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:15:02,842 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:15:02,842 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3466700000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3466700000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3466600000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3466600000'}], 'margin_call': False}
2025-07-21 23:15:02,844 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:15:02,845 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:15:02,845 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:15:02,869 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:02,869 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:15:02,900 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:02,900 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:15:02,931 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:02,931 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:15:03,149 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:15:03,452 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-175.29861374415599353184349', 'margin': '9494.47', 'free_margin': '-9669.76861374415599353184349', 'profit_loss': '-10077.31861374415599353184349', 'margin_level': '-1.846323320250166607844813771', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10013.33000000000000000000000', 'current_price': '117464.1000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-58.17146704014181230167590206', 'current_price': '96.2520000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.817146704014181230167590206', 'current_price': '96.2520000000'}], 'margin_call': False}
2025-07-21 23:15:03,454 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.846323320250166607844813771
2025-07-21 23:15:03,454 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:15:03,454 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:15:03,480 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,480 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:15:03,505 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,505 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:15:03,528 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,528 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:15:03,551 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,551 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:15:03,573 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,573 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:15:03,591 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,592 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:15:03,611 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,611 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:15:03,632 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:03,632 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:15:03,804 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:15:03,903 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:03,917 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:03,931 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:03,966 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:04,003 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:04,010 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:04,020 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:15:04,097 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.914641664785686131165545378% which is below threshold 100.0%
2025-07-21 23:15:04,097 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '113.665000000000000000000000', 'margin': '5936.62', 'free_margin': '-5822.955000000000000000000000', 'profit_loss': '-6275.955000000000000000000000', 'margin_level': '1.914641664785686131165545378', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6275.955000000000000000000000', 'current_price': '117464.1000000000'}], 'margin_call': True}
2025-07-21 23:15:04,100 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.914641664785686131165545378
2025-07-21 23:15:04,129 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:15:04,129 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:15:04,190 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,206 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,212 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,212 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,223 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,227 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,227 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,227 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,250 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,250 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,250 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,309 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,314 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,316 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:15:04,320 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,320 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,332 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,332 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,333 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:15:04,334 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:15:04,348 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:15:04,645 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.35292062018588045545032863% which is below threshold 100.0%
2025-07-21 23:15:04,645 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '92802.19000000000000000000000', 'margin': '146484.47', 'free_margin': '-53682.28000000000000000000000', 'profit_loss': '-91543.62000000000000000000000', 'margin_level': '63.35292062018588045545032863', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-115.2000000000000000000000000', 'current_price': '38.7960000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91428.42000000000000000000000', 'current_price': '117464.1000000000'}], 'margin_call': True}
2025-07-21 23:15:04,649 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.35292062018588045545032863
2025-07-21 23:15:04,651 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:15:04,652 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:15:04,676 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:04,676 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:15:04,693 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:04,694 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:15:04,713 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:04,713 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:15:04,714 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:15:04,714 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:15:04,718 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:15:04,719 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:15:04,719 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:15:04,732 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:04,733 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:15:04,733 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:15:04,733 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:15:04,734 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:15:04,734 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:15:04,824 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:15:04,825 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:15:05,290 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:15:05,293 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:15:05,295 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:15:05,295 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:15:05,366 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:15:05,367 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:15:05,745 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:15:05,750 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:15:05,750 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:15:05,750 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:15:05,931 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:15:05,933 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:15:06,245 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:15:06,247 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:15:06,248 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:15:06,248 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:15:06,291 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:06,291 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:15:06,322 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:15:17,265 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:15:17,267 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:15:17,271 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:15:17,273 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:15:17,275 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:15:17,277 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:15:17,281 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:15:17,282 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:15:17,287 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:15:17,289 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:15:17,290 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:15:17,294 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:15:17,296 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:15:17,298 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:15:17,299 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:15:17,301 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:15:17,302 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:15:17,305 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:15:17,306 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:15:17,309 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:15:17,313 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:15:17,315 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:15:17,316 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:15:17,316 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:15:31,159 - INFO - app - Application shutdown initiated
2025-07-21 23:15:31,160 - INFO - app - Scheduler shutdown completed
2025-07-21 23:15:31,296 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:15:33,049 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:15:33,050 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:15:33,065 - INFO - app - Redis connection closed
2025-07-21 23:15:33,065 - INFO - app - Application shutdown completed
2025-07-21 23:16:42,491 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:42,520 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:42,533 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:42,533 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:42,817 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:16:42,817 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:16:42,817 - INFO - app - Environment: PRODUCTION
2025-07-21 23:16:42,874 - INFO - app - Application startup initiated
2025-07-21 23:16:42,875 - INFO - app - Initializing core services...
2025-07-21 23:16:42,912 - INFO - app - Firebase initialized
2025-07-21 23:16:42,912 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:16:42,955 - INFO - app - Redis initialized
2025-07-21 23:16:43,484 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:16:43,488 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:16:43,490 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:16:43,490 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:16:43,490 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:16:43,491 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:16:43,491 - INFO - app - Scheduler initialized
2025-07-21 23:16:43,492 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:16:43,493 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:16:44,547 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:16:44,561 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:16:44,598 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:16:44,598 - INFO - app - Background tasks initialized
2025-07-21 23:16:44,598 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:16:45,777 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:16:45,777 - INFO - app - Application startup completed successfully
2025-07-21 23:16:45,777 - INFO - app - Starting cache validation task
2025-07-21 23:16:45,782 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:16:45,787 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:16:45,792 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:16:45,792 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:16:45,792 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:16:45,792 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:16:45,793 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:16:45,844 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:16:45,848 - INFO - app - Validating cache for 30 users
2025-07-21 23:16:45,856 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:16:45,857 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:16:45,857 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:16:45,870 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:16:45,893 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:16:45,893 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:16:45,896 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:16:45,898 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:16:45,900 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:16:45,902 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:16:45,903 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:16:45,906 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:16:45,907 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:16:45,909 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:16:45,910 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:16:45,913 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:16:45,914 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:16:45,914 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:16:45,915 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:16:45,916 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:16:45,918 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:16:45,919 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:16:45,922 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:16:45,924 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:16:45,925 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:16:45,928 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:16:45,930 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:16:45,931 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:16:45,932 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:16:45,933 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:16:45,977 - INFO - app - Cache validation completed
2025-07-21 23:16:46,158 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:16:46,468 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:16:46,470 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:16:46,473 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:16:46,475 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:16:46,476 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470200000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470200000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3470100000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3470100000'}], 'margin_call': False}
2025-07-21 23:16:46,492 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:16:46,494 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:16:46,494 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:16:46,515 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:46,515 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:16:46,546 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:46,546 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:16:46,596 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:46,596 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:16:46,953 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:16:47,313 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-159.15494856524093123984840', 'margin': '9494.47', 'free_margin': '-9653.62494856524093123984840', 'profit_loss': '-10061.17494856524093123984840', 'margin_level': '-1.676291025883919073311605598', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9997.690000000000000000000000', 'current_price': '117503.2000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-57.71358960476448294531672983', 'current_price': '96.2590000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.771358960476448294531672983', 'current_price': '96.2590000000'}], 'margin_call': False}
2025-07-21 23:16:47,329 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.676291025883919073311605598
2025-07-21 23:16:47,329 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:16:47,329 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:16:47,356 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,356 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:16:47,384 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,384 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:16:47,415 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,415 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:16:47,439 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,439 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:16:47,469 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,469 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:16:47,499 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,499 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:16:47,533 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,533 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:16:47,567 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:47,567 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:16:47,720 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:16:48,075 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,078 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,090 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,093 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,121 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,121 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,139 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:16:48,157 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.980504057864576139284643450% which is below threshold 100.0%
2025-07-21 23:16:48,158 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '117.575000000000000000000000', 'margin': '5936.62', 'free_margin': '-5819.045000000000000000000000', 'profit_loss': '-6272.045000000000000000000000', 'margin_level': '1.980504057864576139284643450', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6272.045000000000000000000000', 'current_price': '117503.2000000000'}], 'margin_call': True}
2025-07-21 23:16:48,171 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.980504057864576139284643450
2025-07-21 23:16:48,234 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:16:48,236 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:16:48,446 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,469 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,473 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,483 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,484 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,503 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,504 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,504 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,507 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,507 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,507 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,509 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,517 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:16:48,524 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:16:48,524 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,525 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,525 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,525 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
o...
2025-07-21 23:16:48,526 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,532 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:16:48,532 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:16:48,825 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.51464424863604995123373829% which is below threshold 100.0%
2025-07-21 23:16:48,825 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93039.09000000000000000000000', 'margin': '146484.47', 'free_margin': '-53445.38000000000000000000000', 'profit_loss': '-91306.72000000000000000000000', 'margin_level': '63.51464424863604995123373829', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.9000000000000000000000000', 'current_price': '38.8420000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91193.82000000000000000000000', 'current_price': '117503.2000000000'}], 'margin_call': True}
2025-07-21 23:16:48,828 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.51464424863604995123373829
2025-07-21 23:16:48,830 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:16:48,830 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:16:48,851 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:48,852 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:16:48,876 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:48,876 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:16:48,899 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:48,899 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:16:48,900 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:16:48,900 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:16:48,905 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:16:48,906 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:16:48,906 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:16:48,933 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:48,933 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:16:48,934 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:16:48,934 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:16:48,935 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:16:48,935 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:16:49,106 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:16:49,107 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:16:49,543 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:16:49,546 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:16:49,548 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:16:49,548 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:16:49,650 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:16:49,651 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:16:49,945 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:16:49,948 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:16:49,949 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:16:49,949 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:16:50,160 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:16:50,161 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:16:50,456 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:16:50,459 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:16:50,459 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:16:50,459 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:16:50,516 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:16:50,516 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:16:50,562 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:00,789 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:17:00,791 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:17:00,793 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:17:00,795 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:17:00,797 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:17:00,799 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:17:00,802 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:17:00,804 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:17:00,809 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:17:00,811 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:17:00,812 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:17:00,815 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:17:00,816 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:17:00,817 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:17:00,819 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:17:00,820 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:17:00,821 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:17:00,823 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:17:00,824 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:17:00,826 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:17:00,827 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:17:00,828 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:17:00,829 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:17:00,829 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:17:20,569 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:17:20,569 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:17:20,570 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:17:20,570 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:17:20,576 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:17:20,577 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:17:20,577 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:17:20,582 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:17:20,582 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:17:20,595 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:17:20,597 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:17:20,597 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:17:20,653 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:17:20,654 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:17:21,001 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:21,003 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:21,004 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:21,005 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:21,005 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.347035'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.347035'}], 'margin_call': False}
2025-07-21 23:17:21,005 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-21 23:17:21,005 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:17:21,006 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:17:21,027 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,027 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:17:21,047 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,047 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:17:21,062 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,062 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:17:21,112 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:17:21,113 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 14, falling back to DB and updating cache.
2025-07-21 23:17:21,507 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '0.0', 'equity': '-10099.66768584750522775412976', 'margin': '0.0', 'free_margin': '-10099.66768584750522775412976', 'profit_loss': '-10099.66768584750522775412976', 'margin_level': '0.0', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10033.73000000000000000000000', 'current_price': '117413.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-59.94335077045929795829977871', 'current_price': '96.226'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.994335077045929795829977871', 'current_price': '96.226'}], 'margin_call': False}
2025-07-21 23:17:21,508 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-21 23:17:21,508 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:17:21,508 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:17:21,529 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,529 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:17:21,545 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,545 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:17:21,560 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,560 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:17:21,575 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,575 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:17:21,588 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,588 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:17:21,602 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,602 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:17:21,616 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,616 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:17:21,630 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:21,630 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:17:21,681 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:17:22,029 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.828734195552351337966721805% which is below threshold 100.0%
2025-07-21 23:17:22,029 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '108.565000000000000000000000', 'margin': '5936.62', 'free_margin': '-5828.055000000000000000000000', 'profit_loss': '-6281.055000000000000000000000', 'margin_level': '1.828734195552351337966721805', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6281.055000000000000000000000', 'current_price': '117413.1'}], 'margin_call': True}
2025-07-21 23:17:22,033 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.828734195552351337966721805
2025-07-21 23:17:22,120 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:17:22,121 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:17:22,279 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:17:22,280 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 26, falling back to DB and updating cache.
2025-07-21 23:17:22,573 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '0.0', 'equity': '-91847.89500000000000000000000', 'margin': '0.0', 'free_margin': '-91847.89500000000000000000000', 'profit_loss': '-91847.89500000000000000000000', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.475000000000000000000000', 'current_price': '38.8305'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91734.42000000000000000000000', 'current_price': '117413.1'}], 'margin_call': False}
2025-07-21 23:17:22,575 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 0.0
2025-07-21 23:17:22,575 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:17:22,575 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:17:22,611 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:22,611 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:17:22,647 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:22,647 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:17:22,669 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:22,670 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:17:22,670 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:22,670 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:17:22,677 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:17:22,678 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:17:22,678 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:17:22,697 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:22,698 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:17:22,698 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:22,698 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:17:22,699 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:22,699 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:17:22,762 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:17:22,763 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:17:22,765 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:17:23,052 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:23,053 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-21 23:17:23,054 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:17:23,054 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:17:23,134 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:17:23,135 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:17:23,137 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:17:23,426 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:23,427 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:17:23,427 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:17:23,427 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:17:23,517 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:17:23,518 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:17:23,520 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:17:23,810 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:23,812 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:17:23,813 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:17:23,813 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:17:23,839 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:23,839 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:17:23,867 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:27,616 - INFO - app - Application shutdown initiated
2025-07-21 23:17:27,617 - INFO - app - Scheduler shutdown completed
2025-07-21 23:17:27,619 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:17:28,796 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:17:28,796 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:17:28,802 - INFO - app - Redis connection closed
2025-07-21 23:17:28,802 - INFO - app - Application shutdown completed
2025-07-21 23:17:31,221 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:31,279 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:31,296 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:31,296 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:31,860 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:17:31,860 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:17:31,860 - INFO - app - Environment: PRODUCTION
2025-07-21 23:17:31,929 - INFO - app - Application startup initiated
2025-07-21 23:17:31,929 - INFO - app - Initializing core services...
2025-07-21 23:17:31,970 - INFO - app - Firebase initialized
2025-07-21 23:17:31,970 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:17:31,991 - INFO - app - Redis initialized
2025-07-21 23:17:32,532 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:17:32,535 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:17:32,537 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:17:32,538 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:17:32,538 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:17:32,539 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:17:32,539 - INFO - app - Scheduler initialized
2025-07-21 23:17:32,540 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:17:32,540 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:17:33,478 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:17:33,493 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:17:33,523 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:17:33,523 - INFO - app - Background tasks initialized
2025-07-21 23:17:33,523 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:17:34,107 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:17:34,107 - INFO - app - Application startup completed successfully
2025-07-21 23:17:34,108 - INFO - app - Starting cache validation task
2025-07-21 23:17:34,116 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:17:34,123 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:17:34,128 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:17:34,128 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:17:34,129 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:17:34,129 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:17:34,129 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:17:34,199 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:17:34,206 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:17:34,206 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:17:34,206 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:17:34,207 - INFO - app - Validating cache for 30 users
2025-07-21 23:17:34,216 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:17:34,227 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,231 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:17:34,231 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:17:34,231 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:17:34,233 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:17:34,234 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:17:34,234 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,238 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:17:34,240 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:17:34,244 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:17:34,244 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,244 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:17:34,246 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:17:34,248 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:17:34,252 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:17:34,252 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:17:34,252 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:17:34,254 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:17:34,255 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:17:34,256 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,256 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:17:34,258 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:17:34,262 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:17:34,266 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:17:34,267 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:17:34,268 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,269 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:17:34,273 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:17:34,275 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:17:34,276 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:17:34,276 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:17:34,279 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,291 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,300 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,311 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,324 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,335 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,343 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,352 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,360 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,368 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,379 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,389 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,398 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,402 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:17:34,689 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:34,690 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,693 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:34,697 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:34,699 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:17:34,699 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.347035'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.347035'}], 'margin_call': False}
2025-07-21 23:17:34,699 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:17:34,700 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:17:34,700 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:17:34,706 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,713 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,721 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,727 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:34,727 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:17:34,728 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,757 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,773 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-21 23:17:34,782 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:34,782 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:17:34,787 - INFO - app - Cache validation completed
2025-07-21 23:17:34,824 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:34,825 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:17:35,026 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:17:35,340 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-198.24365275296410589572844', 'margin': '9494.47', 'free_margin': '-9692.71365275296410589572844', 'profit_loss': '-10100.26365275296410589572844', 'margin_level': '-2.087990722525471204772129882', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10033.73000000000000000000000', 'current_price': '117413.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-60.48513886633100535975312652', 'current_price': '96.218'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.048513886633100535975312652', 'current_price': '96.218'}], 'margin_call': False}
2025-07-21 23:17:35,343 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -2.087990722525471204772129882
2025-07-21 23:17:35,343 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:17:35,343 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:17:35,395 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,395 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:17:35,450 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,451 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:17:35,512 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,512 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:17:35,578 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,578 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:17:35,637 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,637 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:17:35,691 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,691 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:17:35,727 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,728 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:17:35,767 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:35,767 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:17:35,957 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:17:36,273 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.828734195552351337966721805% which is below threshold 100.0%
2025-07-21 23:17:36,274 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '108.565000000000000000000000', 'margin': '5936.62', 'free_margin': '-5828.055000000000000000000000', 'profit_loss': '-6281.055000000000000000000000', 'margin_level': '1.828734195552351337966721805', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6281.055000000000000000000000', 'current_price': '117413.1'}], 'margin_call': True}
2025-07-21 23:17:36,276 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.828734195552351337966721805
2025-07-21 23:17:36,322 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:17:36,322 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:17:36,488 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,490 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,490 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,556 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,585 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,605 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,608 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:17:36,654 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:17:36,851 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:36,853 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:36,856 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:36,875 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:36,875 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:36,879 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:36,879 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:36,880 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:36,880 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:36,912 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:17:36,935 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:37,084 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:37,084 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '92497.91500000000000000000000', 'margin': '146484.47', 'free_margin': '-53986.55500000000000000000000', 'profit_loss': '-91847.89500000000000000000000', 'margin_level': '63.14520235489809943675257862', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.475000000000000000000000', 'current_price': '38.8305'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91734.42000000000000000000000', 'current_price': '117413.1'}], 'margin_call': True}
2025-07-21 23:17:37,086 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.14520235489809943675257862
2025-07-21 23:17:37,087 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:17:37,087 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:17:37,104 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:37,104 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:37,108 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:17:37,109 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:17:37,160 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:37,160 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:17:37,233 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:37,233 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:17:37,278 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:37,278 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:17:37,280 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:37,280 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:17:37,293 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:17:37,296 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:17:37,296 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:17:37,340 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:37,340 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:17:37,343 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:37,343 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:17:37,344 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:17:37,344 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:17:37,494 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:17:37,495 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:17:38,264 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:17:38,267 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:17:38,271 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:17:38,272 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:17:38,449 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:17:38,451 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:17:38,750 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:38,766 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:17:38,766 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:17:38,766 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:17:39,217 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:17:39,221 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:17:39,525 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:17:39,533 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:17:39,534 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:17:39,536 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:17:39,597 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:39,598 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:17:39,629 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:17:49,116 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:17:49,118 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:17:49,121 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:17:49,123 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:17:49,125 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:17:49,128 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:17:49,131 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:17:49,133 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:17:49,138 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:17:49,139 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:17:49,140 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:17:49,143 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:17:49,144 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:17:49,145 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:17:49,146 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:17:49,147 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:17:49,148 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:17:49,150 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:17:49,151 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:17:49,153 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:17:49,154 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:17:49,155 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:17:49,156 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:17:49,156 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:17:49,484 - INFO - app - Application shutdown initiated
2025-07-21 23:17:49,484 - INFO - app - Scheduler shutdown completed
2025-07-21 23:17:49,487 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:17:49,723 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:17:49,724 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:17:49,847 - INFO - app - Redis connection closed
2025-07-21 23:17:49,848 - INFO - app - Application shutdown completed
2025-07-21 23:25:53,148 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:25:53,171 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:25:53,183 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:25:53,183 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:25:53,443 - INFO - app - Application starting up - Trading system initialized
2025-07-21 23:25:53,443 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-21 23:25:53,443 - INFO - app - Environment: PRODUCTION
2025-07-21 23:25:53,497 - INFO - app - Application startup initiated
2025-07-21 23:25:53,497 - INFO - app - Initializing core services...
2025-07-21 23:25:53,531 - INFO - app - Firebase initialized
2025-07-21 23:25:53,531 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-21 23:25:53,552 - INFO - app - Redis initialized
2025-07-21 23:25:54,153 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-21 23:25:54,157 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-21 23:25:54,160 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-21 23:25:54,160 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-21 23:25:54,160 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-21 23:25:54,161 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-21 23:25:54,161 - INFO - app - Scheduler initialized
2025-07-21 23:25:54,162 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:25:54,164 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-21 23:25:55,240 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-21 23:25:55,242 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:25:55,299 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-21 23:25:55,299 - INFO - app - Background tasks initialized
2025-07-21 23:25:55,299 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:25:55,962 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:25:55,963 - INFO - app - Application startup completed successfully
2025-07-21 23:25:55,963 - INFO - app - Starting cache validation task
2025-07-21 23:25:55,978 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-21 23:25:55,983 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-21 23:25:55,986 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-21 23:25:55,987 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:25:55,987 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:25:55,987 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:25:55,987 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:25:56,014 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:25:56,015 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:25:56,015 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:25:56,016 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:25:56,026 - INFO - app - Validating cache for 30 users
2025-07-21 23:25:56,031 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:25:56,048 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,051 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:25:56,051 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:25:56,057 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:25:56,062 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:25:56,064 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:25:56,068 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,073 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:25:56,078 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:25:56,084 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:25:56,087 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:25:56,087 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:25:56,089 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,089 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:25:56,093 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:25:56,093 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:25:56,093 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:25:56,095 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:25:56,099 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:25:56,100 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:25:56,101 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:25:56,102 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:25:56,105 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:25:56,106 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,107 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:25:56,110 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:25:56,112 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:25:56,114 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:25:56,115 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:25:56,115 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:25:56,116 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,127 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,139 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,150 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,159 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,168 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,178 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,187 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,198 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,206 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,237 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,251 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,265 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,279 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,292 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,305 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,322 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,327 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:25:56,625 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,626 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:25:56,629 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:25:56,631 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:25:56,632 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:25:56,632 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3471600000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3471600000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3471500000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3471500000'}], 'margin_call': False}
2025-07-21 23:25:56,633 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:25:56,634 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:25:56,634 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:25:56,634 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,641 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,650 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,656 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:56,656 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:25:56,662 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-21 23:25:56,671 - INFO - app - Cache validation completed
2025-07-21 23:25:56,673 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:56,673 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:25:56,691 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:56,691 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:25:56,920 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:25:57,210 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-199.12070511345953479561046', 'margin': '9494.47', 'free_margin': '-9693.59070511345953479561046', 'profit_loss': '-10101.14070511345953479561046', 'margin_level': '-2.097228229837574238431533935', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10036.41000000000000000000000', 'current_price': '117406.4000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-58.84609555769048617782769306', 'current_price': '96.2420000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.884609555769048617782769306', 'current_price': '96.2420000000'}], 'margin_call': False}
2025-07-21 23:25:57,212 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -2.097228229837574238431533935
2025-07-21 23:25:57,212 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:25:57,212 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:25:57,234 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:57,234 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:25:57,257 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:57,257 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:25:57,280 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:57,280 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:25:57,302 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:57,302 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:25:57,326 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:57,326 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:25:57,352 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:57,352 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:25:57,377 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:57,377 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:25:57,395 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:57,395 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:25:57,529 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:25:57,825 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.817448312339344610232758708% which is below threshold 100.0%
2025-07-21 23:25:57,825 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '107.895000000000000000000000', 'margin': '5936.62', 'free_margin': '-5828.725000000000000000000000', 'profit_loss': '-6281.725000000000000000000000', 'margin_level': '1.817448312339344610232758708', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6281.725000000000000000000000', 'current_price': '117406.4000000000'}], 'margin_call': True}
2025-07-21 23:25:57,827 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.817448312339344610232758708
2025-07-21 23:25:57,858 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:25:57,858 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:25:57,873 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:25:57,879 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:25:57,890 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:25:57,904 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:25:57,918 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:25:57,938 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:25:57,962 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-21 23:25:58,147 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:25:58,251 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:25:58,264 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:25:58,265 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:25:58,285 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:25:58,286 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:25:58,303 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:25:58,303 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
o...
2025-07-21 23:25:58,303 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:25:58,307 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:25:58,322 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:25:58,335 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:25:58,338 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:25:58,339 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:25:58,347 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:25:58,347 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:25:58,359 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:25:58,359 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:25:58,366 - INFO - app.core.config - .env file loaded successfully.
2025-07-21 23:25:58,379 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-21 23:25:58,379 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-21 23:25:58,443 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.11866370544263156360534328% which is below threshold 100.0%
2025-07-21 23:25:58,444 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '92459.04000000000000000000000', 'margin': '146484.47', 'free_margin': '-54025.43000000000000000000000', 'profit_loss': '-91886.77000000000000000000000', 'margin_level': '63.11866370544263156360534328', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.1500000000000000000000000', 'current_price': '38.8570000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91774.62000000000000000000000', 'current_price': '117406.4000000000'}], 'margin_call': True}
2025-07-21 23:25:58,447 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.11866370544263156360534328
2025-07-21 23:25:58,449 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:25:58,450 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:25:58,477 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:58,477 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:25:58,509 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:58,510 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:25:58,541 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:58,541 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:25:58,543 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:25:58,543 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:25:58,554 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:25:58,556 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:25:58,556 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:25:58,581 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:25:58,581 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:25:58,582 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:25:58,582 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:25:58,583 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:25:58,583 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:25:58,717 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:25:58,717 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:25:59,173 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:25:59,175 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:25:59,177 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:25:59,177 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:25:59,293 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:25:59,295 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:25:59,588 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:25:59,589 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:25:59,590 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:25:59,590 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:25:59,664 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:25:59,666 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:26:00,197 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:26:00,198 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:26:00,199 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:26:00,199 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:26:00,225 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:00,226 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:26:00,296 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:10,975 - INFO - app - Starting stale cache cleanup task
2025-07-21 23:26:10,977 - INFO - app - Found 28 static orders cache entries to check
2025-07-21 23:26:10,979 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-21 23:26:10,980 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-21 23:26:10,982 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-21 23:26:10,983 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-21 23:26:10,986 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-21 23:26:10,987 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-21 23:26:10,991 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-21 23:26:10,993 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-21 23:26:10,995 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-21 23:26:10,997 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-21 23:26:10,998 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-21 23:26:10,999 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-21 23:26:11,000 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-21 23:26:11,002 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-21 23:26:11,003 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-21 23:26:11,005 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-21 23:26:11,005 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-21 23:26:11,007 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-21 23:26:11,009 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-21 23:26:11,010 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-21 23:26:11,011 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-21 23:26:11,011 - INFO - app - Completed stale cache cleanup task
2025-07-21 23:26:30,303 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:26:30,304 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:26:30,304 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:26:30,304 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:26:30,310 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:26:30,311 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:26:30,311 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:26:30,314 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:26:30,314 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:26:30,325 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:26:30,328 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:26:30,328 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:26:30,496 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:26:30,804 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:26:30,829 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:26:30,838 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:26:30,848 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:26:30,848 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346935'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346935'}], 'margin_call': False}
2025-07-21 23:26:30,852 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:26:30,857 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:26:30,857 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:26:30,903 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:30,903 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:26:30,938 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:30,939 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:26:30,971 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:30,971 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:26:31,081 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:26:31,400 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-144.35268800108250735766719', 'margin': '9494.47', 'free_margin': '-9638.82268800108250735766719', 'profit_loss': '-10046.37268800108250735766719', 'margin_level': '-1.520387004235965855468153462', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9983.130000000000000000000000', 'current_price': '117539.6'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-57.49335272825682487060654240', 'current_price': '96.262'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.749335272825682487060654240', 'current_price': '96.262'}], 'margin_call': False}
2025-07-21 23:26:31,403 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.520387004235965855468153462
2025-07-21 23:26:31,403 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:26:31,403 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:26:31,431 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:31,431 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:26:31,447 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:31,447 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:26:31,464 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:31,465 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:26:31,493 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:31,493 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:26:31,535 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:31,536 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:26:31,593 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:31,593 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:26:31,651 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:31,652 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:26:31,729 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:31,729 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:26:31,930 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:26:32,315 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.014193261485491744460652695% which is below threshold 100.0%
2025-07-21 23:26:32,316 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '119.575000000000000000000000', 'margin': '5936.62', 'free_margin': '-5817.045000000000000000000000', 'profit_loss': '-6270.045000000000000000000000', 'margin_level': '2.014193261485491744460652695', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6270.045000000000000000000000', 'current_price': '117523.2'}], 'margin_call': True}
2025-07-21 23:26:32,326 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.014193261485491744460652695
2025-07-21 23:26:32,412 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:26:32,413 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:26:32,667 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:26:32,965 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.59688846196460259575639657% which is below threshold 100.0%
2025-07-21 23:26:32,965 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93159.56499999999970000000000', 'margin': '146484.47', 'free_margin': '-53324.90500000000030000000000', 'profit_loss': '-91186.24500000000030000000000', 'margin_level': '63.59688846196460259575639657', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.4250000000003000000000000', 'current_price': '38.851499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91073.82000000000000000000000', 'current_price': '117523.2'}], 'margin_call': True}
2025-07-21 23:26:32,968 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.59688846196460259575639657
2025-07-21 23:26:32,970 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:26:32,970 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:26:33,021 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:33,022 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:26:33,073 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:33,073 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:26:33,197 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:33,197 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:26:33,204 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:26:33,204 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:26:33,245 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:26:33,248 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:26:33,249 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:26:33,306 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:33,306 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:26:33,307 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:26:33,308 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:26:33,311 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:26:33,312 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:26:33,488 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:26:33,491 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:26:33,801 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:26:33,804 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:26:33,806 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:26:33,806 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:26:34,005 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:26:34,006 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:26:34,360 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:26:34,362 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:26:34,362 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:26:34,362 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:26:34,522 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:26:34,523 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:26:34,872 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:26:34,880 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:26:34,882 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:26:34,882 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:26:34,939 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:34,939 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:26:34,998 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:26:54,163 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:26:54,493 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:27:05,000 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:27:05,000 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:27:05,000 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:27:05,000 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:27:05,006 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:27:05,006 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:27:05,006 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:27:05,011 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:27:05,011 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:27:05,017 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:27:05,019 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:27:05,019 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:27:05,139 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:27:05,497 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:27:05,501 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:27:05,503 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:27:05,506 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:27:05,507 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.347105'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.347105'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346945'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346945'}], 'margin_call': False}
2025-07-21 23:27:05,509 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:27:05,513 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:27:05,513 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:27:05,530 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:05,531 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:27:05,573 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:05,573 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:27:05,642 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:05,646 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:27:05,859 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:27:06,212 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-163.26589511497168834858848', 'margin': '9494.47', 'free_margin': '-9657.73589511497168834858848', 'profit_loss': '-10065.28589511497168834858848', 'margin_level': '-1.719589351643342791631217751', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-10002.57000000000000000000000', 'current_price': '117491.0'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-57.01445010451971668053497859', 'current_price': '96.269'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.701445010451971668053497859', 'current_price': '96.269'}], 'margin_call': False}
2025-07-21 23:27:06,213 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.719589351643342791631217751
2025-07-21 23:27:06,213 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:27:06,213 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:27:06,251 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:06,251 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:27:06,283 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:06,284 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:27:06,328 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:06,328 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:27:06,364 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:06,365 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:27:06,400 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:06,400 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:27:06,434 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:06,434 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:27:06,464 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:06,464 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:27:06,496 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:06,496 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:27:06,623 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:27:06,912 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.949341544515229204496834899% which is below threshold 100.0%
2025-07-21 23:27:06,912 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '115.725000000000000000000000', 'margin': '5936.62', 'free_margin': '-5820.895000000000000000000000', 'profit_loss': '-6273.895000000000000000000000', 'margin_level': '1.949341544515229204496834899', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6273.895000000000000000000000', 'current_price': '117484.7'}], 'margin_call': True}
2025-07-21 23:27:06,915 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 1.949341544515229204496834899
2025-07-21 23:27:06,966 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:27:06,967 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:27:07,073 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:27:07,357 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.43919256423564880290722969% which is below threshold 100.0%
2025-07-21 23:27:07,357 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '92928.56499999999970000000000', 'margin': '146484.47', 'free_margin': '-53555.90500000000030000000000', 'profit_loss': '-91417.24500000000030000000000', 'margin_level': '63.43919256423564880290722969', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.4250000000003000000000000', 'current_price': '38.851499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-91304.82000000000000000000000', 'current_price': '117484.7'}], 'margin_call': True}
2025-07-21 23:27:07,360 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.43919256423564880290722969
2025-07-21 23:27:07,362 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:27:07,362 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:27:07,397 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:07,397 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:27:07,425 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:07,425 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:27:07,442 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:07,442 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:27:07,442 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:27:07,443 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:27:07,446 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:27:07,447 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:27:07,447 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:27:07,463 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:07,463 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:27:07,464 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:27:07,464 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:27:07,464 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:27:07,464 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:27:07,516 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:27:07,517 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:27:07,813 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:27:07,818 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:27:07,821 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:27:07,821 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:27:07,912 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:27:07,913 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:27:08,197 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:27:08,201 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:27:08,201 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:27:08,201 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:27:08,361 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:27:08,362 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:27:08,651 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:27:08,654 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:27:08,654 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:27:08,654 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:27:08,672 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:08,672 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:27:08,700 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:38,702 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:27:38,702 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:27:38,702 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:27:38,702 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:27:38,713 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:27:38,713 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:27:38,713 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:27:38,719 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:27:38,719 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:27:38,731 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:27:38,733 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:27:38,733 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:27:38,839 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:27:39,386 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:27:39,390 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:27:39,393 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:27:39,396 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:27:39,396 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.347105'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.347105'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346945'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346945'}], 'margin_call': False}
2025-07-21 23:27:39,399 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:27:39,400 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:27:39,400 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:27:39,455 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:39,455 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:27:39,518 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:39,518 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:27:39,576 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:39,576 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:27:39,769 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:27:40,110 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-132.80308641975308641975309', 'margin': '9494.47', 'free_margin': '-9627.27308641975308641975309', 'profit_loss': '-10034.82308641975308641975309', 'margin_level': '-1.398741440225237284648359413', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9973.970000000000000000000000', 'current_price': '117562.5'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.32098765432098765432098765', 'current_price': '96.294'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.532098765432098765432098765', 'current_price': '96.294'}], 'margin_call': False}
2025-07-21 23:27:40,112 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.398741440225237284648359413
2025-07-21 23:27:40,113 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:27:40,113 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:27:40,165 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:40,165 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:27:40,219 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:40,219 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:27:40,282 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:40,282 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:27:40,325 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:40,325 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:27:40,365 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:40,365 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:27:40,411 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:40,412 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:27:40,442 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:40,442 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:27:40,457 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:40,457 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:27:40,572 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:27:40,896 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.080392546600590908631510860% which is below threshold 100.0%
2025-07-21 23:27:40,897 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '123.505000000000000000000000', 'margin': '5936.62', 'free_margin': '-5813.115000000000000000000000', 'profit_loss': '-6266.115000000000000000000000', 'margin_level': '2.080392546600590908631510860', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6266.115000000000000000000000', 'current_price': '117562.5'}], 'margin_call': True}
2025-07-21 23:27:40,899 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.080392546600590908631510860
2025-07-21 23:27:40,928 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:27:40,928 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:27:41,018 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:27:41,310 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.75837315723639492295667930% which is below threshold 100.0%
2025-07-21 23:27:41,310 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93396.11499999999975000000000', 'margin': '146484.47', 'free_margin': '-53088.35500000000025000000000', 'profit_loss': '-90949.69500000000025000000000', 'margin_level': '63.75837315723639492295667930', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.6750000000002500000000000', 'current_price': '38.866499999999995'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90838.02000000000000000000000', 'current_price': '117562.5'}], 'margin_call': True}
2025-07-21 23:27:41,314 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.75837315723639492295667930
2025-07-21 23:27:41,318 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:27:41,318 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:27:41,371 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:41,371 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:27:41,431 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:41,431 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:27:41,519 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:41,519 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:27:41,521 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:27:41,521 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:27:41,539 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:27:41,541 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:27:41,541 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:27:41,576 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:41,576 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:27:41,577 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:27:41,577 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:27:41,579 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:27:41,579 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:27:41,899 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:27:41,903 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:27:42,193 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:27:42,196 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:27:42,199 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:27:42,199 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:27:42,357 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:27:42,358 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:27:42,641 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:27:42,646 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:27:42,646 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:27:42,647 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:27:42,903 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:27:42,904 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:27:43,207 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:27:43,212 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:27:43,213 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:27:43,213 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:27:43,257 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:43,257 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:27:43,311 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:27:54,168 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:27:54,462 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:28:13,315 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:28:13,316 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:28:13,316 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:28:13,316 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:28:13,328 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:28:13,329 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:28:13,329 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:28:13,339 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:28:13,339 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:28:13,356 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:28:13,360 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:28:13,361 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:28:13,561 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:28:13,856 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:28:13,862 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:28:13,867 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:28:13,871 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:28:13,871 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346935'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346935'}], 'margin_call': False}
2025-07-21 23:28:13,875 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:28:13,877 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:28:13,877 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:28:13,942 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:13,942 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:28:14,004 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,004 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:28:14,074 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,075 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:28:14,253 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:28:14,537 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-130.96508103574230904515814', 'margin': '9494.47', 'free_margin': '-9625.43508103574230904515814', 'profit_loss': '-10032.98508103574230904515814', 'margin_level': '-1.379382746332784337042069120', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9971.690000000000000000000000', 'current_price': '117568.2'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.72280094158391731378013474', 'current_price': '96.288'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.572280094158391731378013474', 'current_price': '96.288'}], 'margin_call': False}
2025-07-21 23:28:14,541 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.379382746332784337042069120
2025-07-21 23:28:14,541 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:28:14,541 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:28:14,591 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,591 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:28:14,650 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,650 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:28:14,696 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,696 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:28:14,735 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,736 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:28:14,772 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,772 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:28:14,810 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,810 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:28:14,849 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,849 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:28:14,891 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:14,891 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:28:15,022 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:28:15,319 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.089993969632551856106673494% which is below threshold 100.0%
2025-07-21 23:28:15,320 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '124.075000000000000000000000', 'margin': '5936.62', 'free_margin': '-5812.545000000000000000000000', 'profit_loss': '-6265.545000000000000000000000', 'margin_level': '2.089993969632551856106673494', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6265.545000000000000000000000', 'current_price': '117568.2'}], 'margin_call': True}
2025-07-21 23:28:15,325 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.089993969632551856106673494
2025-07-21 23:28:15,379 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:28:15,379 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:28:15,503 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:28:15,840 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.78154967553898375711773405% which is below threshold 100.0%
2025-07-21 23:28:15,840 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93430.06500000000000000000000', 'margin': '146484.47', 'free_margin': '-53054.40500000000000000000000', 'profit_loss': '-90915.74500000000000000000000', 'margin_level': '63.78154967553898375711773405', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.925000000000000000000000', 'current_price': '38.8615'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90803.82000000000000000000000', 'current_price': '117568.2'}], 'margin_call': True}
2025-07-21 23:28:15,841 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.78154967553898375711773405
2025-07-21 23:28:15,843 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:28:15,844 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:28:15,891 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:15,891 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:28:15,956 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:15,956 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:28:16,030 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:16,030 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:28:16,033 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:28:16,034 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:28:16,058 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:28:16,061 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:28:16,061 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:28:16,118 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:16,119 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:28:16,121 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:28:16,122 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:28:16,124 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:28:16,124 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:28:16,345 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:28:16,346 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:28:16,656 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:28:16,661 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:28:16,664 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:28:16,665 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:28:16,841 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:28:16,842 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:28:17,171 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:28:17,175 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:28:17,175 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:28:17,175 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:28:17,377 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:28:17,380 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:28:17,691 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:28:17,694 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:28:17,695 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:28:17,695 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:28:17,786 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:17,787 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:28:17,829 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:47,837 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:28:47,838 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:28:47,838 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:28:47,838 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:28:47,859 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:28:47,860 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:28:47,860 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:28:47,867 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:28:47,867 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:28:47,876 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:28:47,879 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:28:47,879 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:28:47,981 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:28:48,303 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:28:48,312 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:28:48,316 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:28:48,320 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:28:48,320 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346935'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346935'}], 'margin_call': False}
2025-07-21 23:28:48,323 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:28:48,325 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:28:48,326 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:28:48,365 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:48,365 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:28:48,412 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:48,412 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:28:48,451 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:48,451 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:28:48,572 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:28:48,917 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-116.43430276998004532079683', 'margin': '9494.47', 'free_margin': '-9610.90430276998004532079683', 'profit_loss': '-10018.45430276998004532079683', 'margin_level': '-1.226338097544992456880656108', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9957.010000000000000000000000', 'current_price': '117604.9'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.85845706361822301890621301', 'current_price': '96.286'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.585845706361822301890621301', 'current_price': '96.286'}], 'margin_call': False}
2025-07-21 23:28:48,920 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.226338097544992456880656108
2025-07-21 23:28:48,920 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:28:48,920 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:28:48,942 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:48,942 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:28:48,955 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:48,955 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:28:48,968 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:48,968 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:28:48,987 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:48,987 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:28:49,002 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:49,002 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:28:49,016 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:49,016 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:28:49,043 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:49,043 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:28:49,058 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:49,058 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:28:49,102 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:28:49,423 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.151813658276931991604650458% which is below threshold 100.0%
2025-07-21 23:28:49,423 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '127.745000000000000000000000', 'margin': '5936.62', 'free_margin': '-5808.875000000000000000000000', 'profit_loss': '-6261.875000000000000000000000', 'margin_level': '2.151813658276931991604650458', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6261.875000000000000000000000', 'current_price': '117604.9'}], 'margin_call': True}
2025-07-21 23:28:49,426 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.151813658276931991604650458
2025-07-21 23:28:49,466 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:28:49,466 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:28:49,560 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:28:49,935 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.93149731162627683330526437% which is below threshold 100.0%
2025-07-21 23:28:49,936 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93649.71500000000000000000000', 'margin': '146484.47', 'free_margin': '-52834.75500000000000000000000', 'profit_loss': '-90696.09500000000000000000000', 'margin_level': '63.93149731162627683330526437', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.475000000000000000000000', 'current_price': '38.8505'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90583.62000000000000000000000', 'current_price': '117604.9'}], 'margin_call': True}
2025-07-21 23:28:49,940 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.93149731162627683330526437
2025-07-21 23:28:49,942 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:28:49,942 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:28:49,975 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:49,975 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:28:49,993 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:49,993 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:28:50,017 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:50,017 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:28:50,018 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:28:50,018 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:28:50,024 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:28:50,028 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:28:50,028 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:28:50,072 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:50,073 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:28:50,075 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:28:50,076 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:28:50,078 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:28:50,078 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:28:50,234 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:28:50,236 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:28:50,552 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:28:50,556 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:28:50,558 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:28:50,558 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:28:50,703 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:28:50,704 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:28:51,064 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:28:51,068 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:28:51,068 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:28:51,069 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:28:51,252 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:28:51,254 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:28:51,575 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:28:51,577 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:28:51,578 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:28:51,578 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:28:51,643 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:51,643 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:28:51,689 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:28:54,173 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:28:54,544 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:29:21,698 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:29:21,699 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:29:21,699 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:29:21,699 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:29:21,706 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:29:21,706 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:29:21,706 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:29:21,713 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:29:21,713 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:29:21,723 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:29:21,725 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:29:21,725 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:29:21,777 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:29:22,089 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:29:22,091 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:29:22,094 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:29:22,095 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:29:22,096 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346935'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346935'}], 'margin_call': False}
2025-07-21 23:29:22,098 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:29:22,100 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:29:22,100 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:29:22,117 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,117 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:29:22,132 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,132 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:29:22,147 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,147 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:29:22,225 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:29:22,606 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-122.42217171341418049252288', 'margin': '9494.47', 'free_margin': '-9616.89217171341418049252288', 'profit_loss': '-10024.44217171341418049252288', 'margin_level': '-1.289405008530378004170036663', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9962.930000000000000000000000', 'current_price': '117590.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.92015610310380044774807069', 'current_price': '96.285'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.592015610310380044774807069', 'current_price': '96.285'}], 'margin_call': False}
2025-07-21 23:29:22,610 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.289405008530378004170036663
2025-07-21 23:29:22,611 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:29:22,611 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:29:22,715 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,716 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:29:22,750 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,750 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:29:22,783 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,783 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:29:22,821 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,821 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:29:22,859 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,859 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:29:22,889 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,889 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:29:22,919 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,919 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:29:22,950 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:22,950 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:29:23,036 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:29:23,321 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.143222911353598512284768100% which is below threshold 100.0%
2025-07-21 23:29:23,321 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '127.235000000000000000000000', 'margin': '5936.62', 'free_margin': '-5809.385000000000000000000000', 'profit_loss': '-6262.385000000000000000000000', 'margin_level': '2.143222911353598512284768100', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6262.385000000000000000000000', 'current_price': '117599.8'}], 'margin_call': True}
2025-07-21 23:29:23,324 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.143222911353598512284768100
2025-07-21 23:29:23,375 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:29:23,375 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:29:23,551 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:29:23,855 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.91030052537309914149943677% which is below threshold 100.0%
2025-07-21 23:29:23,856 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93618.66499999999980000000000', 'margin': '146484.47', 'free_margin': '-52865.80500000000020000000000', 'profit_loss': '-90727.14500000000020000000000', 'margin_level': '63.91030052537309914149943677', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.9250000000002000000000000', 'current_price': '38.841499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90614.22000000000000000000000', 'current_price': '117599.8'}], 'margin_call': True}
2025-07-21 23:29:23,860 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.91030052537309914149943677
2025-07-21 23:29:23,864 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:29:23,864 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:29:23,929 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:23,929 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:29:23,962 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:23,962 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:29:23,996 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:23,996 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:29:23,997 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:29:23,997 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:29:24,012 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:29:24,015 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:29:24,015 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:29:24,062 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:24,062 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:29:24,063 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:29:24,064 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:29:24,066 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:29:24,066 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:29:24,190 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:29:24,191 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:29:24,483 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:29:24,485 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:29:24,487 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:29:24,487 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:29:24,617 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:29:24,618 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:29:24,923 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:29:24,930 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:29:24,931 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:29:24,931 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:29:25,100 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:29:25,101 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:29:25,396 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:29:25,399 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:29:25,399 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:29:25,399 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:29:25,446 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:25,446 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:29:25,491 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:54,174 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:29:54,548 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:29:55,510 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:29:55,511 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:29:55,511 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:29:55,511 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:29:55,520 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:29:55,520 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:29:55,520 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:29:55,527 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:29:55,527 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:29:55,542 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:29:55,546 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:29:55,546 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:29:55,631 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:29:55,920 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:29:55,924 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:29:55,927 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:29:55,931 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:29:55,932 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.347015'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.347015'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346855'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346855'}], 'margin_call': False}
2025-07-21 23:29:55,935 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:29:55,936 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:29:55,936 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:29:55,988 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:55,988 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:29:56,018 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,018 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:29:56,041 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,042 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:29:56,109 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:29:56,500 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-117.65179647603909499813994', 'margin': '9494.47', 'free_margin': '-9612.12179647603909499813994', 'profit_loss': '-10019.67179647603909499813994', 'margin_level': '-1.239161285211697914661270613', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9959.050000000000000000000000', 'current_price': '117599.8'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.11072406912644999830903987', 'current_price': '96.297'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.511072406912644999830903987', 'current_price': '96.297'}], 'margin_call': False}
2025-07-21 23:29:56,503 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.239161285211697914661270613
2025-07-21 23:29:56,503 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:29:56,503 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:29:56,531 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,531 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:29:56,552 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,552 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:29:56,579 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,580 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:29:56,596 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,596 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:29:56,614 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,614 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:29:56,635 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,635 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:29:56,653 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,653 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:29:56,670 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:56,670 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:29:56,718 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:29:57,106 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.143222911353598512284768100% which is below threshold 100.0%
2025-07-21 23:29:57,106 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '127.235000000000000000000000', 'margin': '5936.62', 'free_margin': '-5809.385000000000000000000000', 'profit_loss': '-6262.385000000000000000000000', 'margin_level': '2.143222911353598512284768100', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6262.385000000000000000000000', 'current_price': '117599.8'}], 'margin_call': True}
2025-07-21 23:29:57,109 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.143222911353598512284768100
2025-07-21 23:29:57,125 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:29:57,125 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:29:57,216 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:29:57,521 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.91071012510746019697514692% which is below threshold 100.0%
2025-07-21 23:29:57,550 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93619.26500000000000000000000', 'margin': '146484.47', 'free_margin': '-52865.20500000000000000000000', 'profit_loss': '-90726.54500000000000000000000', 'margin_level': '63.91071012510746019697514692', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.325000000000000000000000', 'current_price': '38.8535'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90614.22000000000000000000000', 'current_price': '117599.8'}], 'margin_call': True}
2025-07-21 23:29:57,567 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.91071012510746019697514692
2025-07-21 23:29:57,583 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:29:57,583 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:29:57,675 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:57,675 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:29:57,715 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:57,715 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:29:57,751 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:57,751 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:29:57,752 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:29:57,752 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:29:57,758 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:29:57,763 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:29:57,763 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:29:57,800 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:57,800 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:29:57,800 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:29:57,800 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:29:57,801 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:29:57,801 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:29:57,911 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:29:57,912 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:29:58,200 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:29:58,202 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:29:58,205 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:29:58,205 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:29:58,332 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:29:58,333 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:29:58,622 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:29:58,624 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:29:58,624 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:29:58,624 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:29:58,763 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:29:58,764 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:29:59,056 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:29:59,060 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:29:59,060 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:29:59,060 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:29:59,123 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:29:59,123 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:29:59,193 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:29,199 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:30:29,199 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:30:29,199 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:30:29,199 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:30:29,212 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:30:29,212 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:30:29,213 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:30:29,222 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:30:29,222 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:30:29,248 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:30:29,252 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:30:29,252 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:30:29,523 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:30:29,914 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:30:29,926 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:30:29,949 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:30:29,957 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:30:29,957 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.347065'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.347065'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346905'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346905'}], 'margin_call': False}
2025-07-21 23:30:29,960 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:30:29,961 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:30:29,961 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:30:30,003 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,004 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:30:30,041 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,041 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:30:30,090 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,090 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:30:30,230 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:30:30,597 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-99.16904761904761904761905', 'margin': '9494.47', 'free_margin': '-9593.63904761904761904761905', 'profit_loss': '-10001.18904761904761904761905', 'margin_level': '-1.044492716487045817698292269', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9939.970000000000000000000000', 'current_price': '117647.5'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.65367965367965367965367965', 'current_price': '96.289'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.565367965367965367965367965', 'current_price': '96.289'}], 'margin_call': False}
2025-07-21 23:30:30,601 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.044492716487045817698292269
2025-07-21 23:30:30,601 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:30:30,601 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:30:30,653 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,654 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:30:30,712 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,712 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:30:30,783 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,783 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:30:30,824 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,825 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:30:30,867 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,867 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:30:30,945 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:30,946 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:30:31,019 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:31,020 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:30:31,088 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:31,088 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:30:31,229 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:30:31,618 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.223571661989482230629550148% which is below threshold 100.0%
2025-07-21 23:30:31,618 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '132.005000000000000000000000', 'margin': '5936.62', 'free_margin': '-5804.615000000000000000000000', 'profit_loss': '-6257.615000000000000000000000', 'margin_level': '2.223571661989482230629550148', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6257.615000000000000000000000', 'current_price': '117647.5'}], 'margin_call': True}
2025-07-21 23:30:31,623 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.223571661989482230629550148
2025-07-21 23:30:31,670 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:30:31,670 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:30:31,815 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:30:32,130 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 64.10619159833120876226674404% which is below threshold 100.0%
2025-07-21 23:30:32,130 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93905.61500000000000000000000', 'margin': '146484.47', 'free_margin': '-52578.85500000000000000000000', 'profit_loss': '-90440.19500000000000000000000', 'margin_level': '64.10619159833120876226674404', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.175000000000000000000000', 'current_price': '38.8565'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90328.02000000000000000000000', 'current_price': '117647.5'}], 'margin_call': True}
2025-07-21 23:30:32,134 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 64.10619159833120876226674404
2025-07-21 23:30:32,137 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:30:32,137 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:30:32,187 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:32,187 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:30:32,225 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:32,225 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:30:32,297 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:32,297 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:30:32,298 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:30:32,298 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:30:32,307 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:30:32,309 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:30:32,309 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:30:32,341 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:32,341 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:30:32,344 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:30:32,344 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:30:32,344 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:30:32,345 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:30:32,475 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:30:32,477 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:30:32,797 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:30:32,800 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:30:32,802 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:30:32,803 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:30:32,953 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:30:32,954 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:30:33,237 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:30:33,243 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:30:33,243 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:30:33,244 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:30:33,424 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:30:33,425 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:30:33,750 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:30:33,753 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:30:33,753 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:30:33,753 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:30:33,801 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:33,801 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:30:33,840 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:30:54,174 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:30:54,485 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:30:56,687 - INFO - app - Starting cache validation task
2025-07-21 23:30:56,697 - INFO - app - Validating cache for 30 users
2025-07-21 23:30:56,698 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,704 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,714 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,725 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,736 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,747 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,757 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,769 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,781 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,792 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,808 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,820 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,830 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,842 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,853 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,865 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,878 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,891 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,903 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,913 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,923 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,934 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,946 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,961 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,978 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-21 23:30:56,991 - INFO - app - Cache validation completed
2025-07-21 23:31:03,847 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:31:03,848 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:31:03,848 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:31:03,848 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:31:03,856 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:31:03,856 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:31:03,856 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:31:03,861 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:31:03,861 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:31:03,876 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:31:03,879 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:31:03,879 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:31:04,001 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:31:04,387 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:31:04,391 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:31:04,397 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:31:04,401 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:31:04,402 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3470950000000002'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346935'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346935'}], 'margin_call': False}
2025-07-21 23:31:04,406 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:31:04,407 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:31:04,408 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:31:04,460 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:04,460 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:31:04,515 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:04,515 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:31:04,573 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:04,573 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:31:04,783 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:31:05,080 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-117.72821428571428571428571', 'margin': '9494.47', 'free_margin': '-9612.19821428571428571428571', 'profit_loss': '-10019.74821428571428571428571', 'margin_level': '-1.239966151725312584212554361', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9959.050000000000000000000000', 'current_price': '117599.8'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.18019480519480519480519481', 'current_price': '96.296'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.518019480519480519480519481', 'current_price': '96.296'}], 'margin_call': False}
2025-07-21 23:31:05,081 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.239966151725312584212554361
2025-07-21 23:31:05,082 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:31:05,082 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:31:05,121 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:05,122 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:31:05,163 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:05,163 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:31:05,194 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:05,194 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:31:05,234 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:05,234 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:31:05,272 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:05,272 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:31:05,323 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:05,323 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:31:05,369 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:05,369 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:31:05,409 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:05,410 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:31:05,549 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:31:05,921 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.223571661989482230629550148% which is below threshold 100.0%
2025-07-21 23:31:05,922 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '132.005000000000000000000000', 'margin': '5936.62', 'free_margin': '-5804.615000000000000000000000', 'profit_loss': '-6257.615000000000000000000000', 'margin_level': '2.223571661989482230629550148', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6257.615000000000000000000000', 'current_price': '117647.5'}], 'margin_call': True}
2025-07-21 23:31:05,926 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.223571661989482230629550148
2025-07-21 23:31:05,978 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:31:05,978 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:31:06,202 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:31:06,536 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 64.10636226488719247849277128% which is below threshold 100.0%
2025-07-21 23:31:06,536 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93905.86500000000000000000000', 'margin': '146484.47', 'free_margin': '-52578.60500000000000000000000', 'profit_loss': '-90439.94500000000000000000000', 'margin_level': '64.10636226488719247849277128', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.925000000000000000000000', 'current_price': '38.8615'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90328.02000000000000000000000', 'current_price': '117647.5'}], 'margin_call': True}
2025-07-21 23:31:06,540 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 64.10636226488719247849277128
2025-07-21 23:31:06,543 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:31:06,543 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:31:06,604 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:06,604 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:31:06,644 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:06,644 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:31:06,684 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:06,684 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:31:06,685 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:31:06,686 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:31:06,697 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:31:06,699 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:31:06,699 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:31:06,733 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:06,734 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:31:06,735 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:31:06,735 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:31:06,736 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:31:06,736 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:31:06,867 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:31:06,868 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:31:07,167 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:31:07,169 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:31:07,173 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:31:07,173 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:31:07,385 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:31:07,386 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:31:07,752 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:31:07,755 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:31:07,755 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:31:07,755 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:31:07,923 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:31:07,925 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:31:08,277 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:31:08,281 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:31:08,281 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:31:08,281 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:31:08,327 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:08,327 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:31:08,366 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:38,371 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:31:38,371 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:31:38,371 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:31:38,371 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:31:38,382 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:31:38,382 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:31:38,383 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:31:38,392 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:31:38,392 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:31:38,421 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:31:38,424 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:31:38,425 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:31:38,634 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:31:38,926 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:31:38,930 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:31:38,934 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:31:38,939 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:31:38,939 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.347065'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.347065'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.346905'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.346905'}], 'margin_call': False}
2025-07-21 23:31:38,945 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:31:38,948 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:31:38,948 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:31:39,017 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:39,017 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:31:39,087 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:39,087 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:31:39,158 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:39,158 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:31:39,438 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:31:39,748 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-105.45067426066722584485511', 'margin': '9494.47', 'free_margin': '-9599.92067426066722584485511', 'profit_loss': '-10007.47067426066722584485511', 'margin_level': '-1.110653614795425398625253542', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9946.250000000000000000000000', 'current_price': '117631.8'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.65515841878838713168646338', 'current_price': '96.289'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.565515841878838713168646338', 'current_price': '96.289'}], 'margin_call': False}
2025-07-21 23:31:39,755 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.110653614795425398625253542
2025-07-21 23:31:39,755 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:31:39,755 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:31:39,804 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:39,805 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:31:39,847 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:39,847 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:31:39,886 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:39,887 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:31:39,929 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:39,930 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:31:39,977 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:39,977 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:31:40,016 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:40,017 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:31:40,055 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:40,056 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:31:40,093 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:40,094 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:31:40,202 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:31:40,485 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.223571661989482230629550148% which is below threshold 100.0%
2025-07-21 23:31:40,485 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '132.005000000000000000000000', 'margin': '5936.62', 'free_margin': '-5804.615000000000000000000000', 'profit_loss': '-6257.615000000000000000000000', 'margin_level': '2.223571661989482230629550148', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6257.615000000000000000000000', 'current_price': '117647.5'}], 'margin_call': True}
2025-07-21 23:31:40,488 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.223571661989482230629550148
2025-07-21 23:31:40,535 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:31:40,536 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:31:40,650 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:31:40,951 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 64.10636226488719247849277128% which is below threshold 100.0%
2025-07-21 23:31:40,951 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93905.86500000000000000000000', 'margin': '146484.47', 'free_margin': '-52578.60500000000000000000000', 'profit_loss': '-90439.94500000000000000000000', 'margin_level': '64.10636226488719247849277128', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.925000000000000000000000', 'current_price': '38.8615'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90328.02000000000000000000000', 'current_price': '117647.5'}], 'margin_call': True}
2025-07-21 23:31:40,955 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 64.10636226488719247849277128
2025-07-21 23:31:40,957 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:31:40,958 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:31:41,020 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:41,020 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:31:41,061 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:41,061 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:31:41,099 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:41,099 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:31:41,100 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:31:41,101 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:31:41,109 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:31:41,111 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:31:41,112 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:31:41,146 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:41,146 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:31:41,149 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:31:41,149 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:31:41,150 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:31:41,150 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:31:41,256 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:31:41,257 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:31:41,556 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:31:41,560 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:31:41,562 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:31:41,562 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:31:41,770 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:31:41,786 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:31:42,170 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:31:42,187 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:31:42,190 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:31:42,190 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:31:42,365 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:31:42,365 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:31:42,783 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:31:42,788 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:31:42,788 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:31:42,788 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:31:42,837 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:42,837 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:31:42,870 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:31:54,171 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:31:54,559 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:32:12,886 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:32:12,886 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:32:12,886 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:32:12,886 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:32:12,897 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:32:12,897 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:32:12,897 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:32:12,904 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:32:12,904 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:32:12,916 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:32:12,918 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:32:12,919 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:32:13,056 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:32:13,407 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:32:13,412 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:32:13,417 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:32:13,423 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:32:13,423 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.347045'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.347045'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3468849999999999'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3468849999999999'}], 'margin_call': False}
2025-07-21 23:32:13,427 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:32:13,430 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:32:13,431 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:32:13,502 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:13,502 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:32:13,551 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:13,552 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:32:13,627 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:13,628 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:32:13,864 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:32:14,183 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-108.31785714285714285714286', 'margin': '9494.47', 'free_margin': '-9602.78785714285714285714286', 'profit_loss': '-10010.33785714285714285714286', 'margin_level': '-1.140852065916866795694155229', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9948.970000000000000000000000', 'current_price': '117625.0'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-55.78896103896103896103896104', 'current_price': '96.287'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.578896103896103896103896104', 'current_price': '96.287'}], 'margin_call': False}
2025-07-21 23:32:14,188 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.140852065916866795694155229
2025-07-21 23:32:14,188 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:32:14,188 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:32:14,248 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:14,248 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:32:14,320 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:14,320 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:32:14,408 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:14,409 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:32:14,492 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:14,492 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:32:14,538 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:14,538 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:32:14,580 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:14,580 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:32:14,625 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:14,625 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:32:14,672 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:14,672 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:32:14,835 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:32:15,132 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.185671307915952174806539748% which is below threshold 100.0%
2025-07-21 23:32:15,132 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '129.755000000000000000000000', 'margin': '5936.62', 'free_margin': '-5806.865000000000000000000000', 'profit_loss': '-6259.865000000000000000000000', 'margin_level': '2.185671307915952174806539748', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6259.865000000000000000000000', 'current_price': '117625.0'}], 'margin_call': True}
2025-07-21 23:32:15,136 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.185671307915952174806539748
2025-07-21 23:32:15,199 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:32:15,199 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:32:15,360 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:32:15,757 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 64.01420232465598571643806337% which is below threshold 100.0%
2025-07-21 23:32:15,757 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93770.86500000000000000000000', 'margin': '146484.47', 'free_margin': '-52713.60500000000000000000000', 'profit_loss': '-90574.94500000000000000000000', 'margin_level': '64.01420232465598571643806337', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.925000000000000000000000', 'current_price': '38.8615'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90463.02000000000000000000000', 'current_price': '117625.0'}], 'margin_call': True}
2025-07-21 23:32:15,761 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 64.01420232465598571643806337
2025-07-21 23:32:15,763 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:32:15,763 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:32:15,820 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:15,820 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:32:15,871 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:15,871 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:32:15,934 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:15,934 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:32:15,937 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:32:15,937 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:32:15,951 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:32:15,953 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:32:15,953 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:32:15,992 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:15,992 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:32:15,993 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:32:15,993 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:32:15,994 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:32:15,995 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:32:16,133 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:32:16,134 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:32:16,476 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:32:16,481 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:32:16,484 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:32:16,484 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:32:16,768 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:32:16,769 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:32:17,086 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:32:17,089 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:32:17,089 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:32:17,089 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:32:17,214 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:32:17,215 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:32:17,504 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:32:17,508 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:32:17,508 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:32:17,508 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:32:17,556 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:17,557 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:32:17,605 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:47,623 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:32:47,624 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:32:47,624 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:32:47,624 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:32:47,634 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:32:47,634 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:32:47,635 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:32:47,643 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:32:47,643 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:32:47,665 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:32:47,668 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:32:47,669 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:32:47,862 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:32:48,221 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:32:48,226 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:32:48,229 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:32:48,232 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:32:48,233 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.347175'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.347175'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3470149999999999'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3470149999999999'}], 'margin_call': False}
2025-07-21 23:32:48,235 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:32:48,237 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:32:48,237 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:32:48,288 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:48,289 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:32:48,344 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:48,344 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:32:48,399 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:48,399 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:32:48,612 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:32:48,941 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-112.92728455856489623637004', 'margin': '9494.47', 'free_margin': '-9607.39728455856489623637004', 'profit_loss': '-10014.94728455856489623637004', 'margin_level': '-1.189400614869127989623117878', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9955.810000000000000000000000', 'current_price': '117607.9'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-53.76116778051354203306366514', 'current_price': '96.317'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.376116778051354203306366514', 'current_price': '96.317'}], 'margin_call': False}
2025-07-21 23:32:48,947 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.189400614869127989623117878
2025-07-21 23:32:48,947 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:32:48,948 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:32:49,015 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:49,015 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:32:49,058 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:49,058 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:32:49,124 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:49,124 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:32:49,187 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:49,187 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:32:49,252 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:49,252 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:32:49,311 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:49,311 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:32:49,363 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:49,363 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:32:49,403 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:49,403 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:32:49,598 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:32:49,955 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.156867038820069332381051844% which is below threshold 100.0%
2025-07-21 23:32:49,956 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '128.045000000000000000000000', 'margin': '5936.62', 'free_margin': '-5808.575000000000000000000000', 'profit_loss': '-6261.575000000000000000000000', 'margin_level': '2.156867038820069332381051844', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6261.575000000000000000000000', 'current_price': '117607.9'}], 'margin_call': True}
2025-07-21 23:32:49,958 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.156867038820069332381051844
2025-07-21 23:32:49,990 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:32:49,990 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:32:50,088 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:32:50,378 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.94460450312582623946415617% which is below threshold 100.0%
2025-07-21 23:32:50,378 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93668.91500000000000000000000', 'margin': '146484.47', 'free_margin': '-52815.55500000000000000000000', 'profit_loss': '-90676.89500000000000000000000', 'margin_level': '63.94460450312582623946415617', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.275000000000000000000000', 'current_price': '38.8745'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90565.62000000000000000000000', 'current_price': '117607.9'}], 'margin_call': True}
2025-07-21 23:32:50,383 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.94460450312582623946415617
2025-07-21 23:32:50,385 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:32:50,385 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:32:50,430 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:50,430 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:32:50,461 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:50,462 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:32:50,496 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:50,496 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:32:50,497 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:32:50,497 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:32:50,504 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:32:50,506 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:32:50,506 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:32:50,562 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:50,563 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:32:50,565 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:32:50,565 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:32:50,567 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:32:50,567 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:32:50,749 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:32:50,750 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:32:51,086 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:32:51,089 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:32:51,091 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:32:51,091 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:32:51,335 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:32:51,336 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:32:51,652 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:32:51,657 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:32:51,657 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:32:51,657 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:32:51,835 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:32:51,836 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:32:52,139 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:32:52,142 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:32:52,142 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:32:52,142 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:32:52,207 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:52,208 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:32:52,261 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:32:54,161 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:32:54,565 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:33:22,265 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:33:22,265 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:33:22,265 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:33:22,265 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:33:22,274 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:33:22,275 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:33:22,275 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:33:22,280 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:33:22,280 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:33:22,289 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:33:22,292 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:33:22,292 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:33:22,425 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:33:22,805 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:33:22,809 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:33:22,814 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:33:22,818 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:33:22,819 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3471950000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.347035'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.347035'}], 'margin_call': False}
2025-07-21 23:33:22,821 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:33:22,822 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:33:22,822 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:33:22,867 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:22,867 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:33:22,917 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:22,918 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:33:22,979 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:22,979 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:33:23,156 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:33:23,519 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-124.32453663683772650717315', 'margin': '9494.47', 'free_margin': '-9618.79453663683772650717315', 'profit_loss': '-10026.34453663683772650717315', 'margin_level': '-1.309441565846621522919901269', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9967.210000000000000000000000', 'current_price': '117579.4'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-53.75866966985247864288468172', 'current_price': '96.317'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.375866966985247864288468172', 'current_price': '96.317'}], 'margin_call': False}
2025-07-21 23:33:23,525 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.309441565846621522919901269
2025-07-21 23:33:23,525 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:33:23,525 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:33:23,595 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:23,595 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:33:23,653 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:23,654 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:33:23,710 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:23,710 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:33:23,780 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:23,780 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:33:23,846 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:23,847 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:33:23,897 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:23,897 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:33:23,938 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:23,939 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:33:24,001 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:24,001 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:33:24,198 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:33:24,568 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.108859923660264595005238671% which is below threshold 100.0%
2025-07-21 23:33:24,568 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '125.195000000000000000000000', 'margin': '5936.62', 'free_margin': '-5811.425000000000000000000000', 'profit_loss': '-6264.425000000000000000000000', 'margin_level': '2.108859923660264595005238671', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6264.425000000000000000000000', 'current_price': '117579.4'}], 'margin_call': True}
2025-07-21 23:33:24,573 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.108859923660264595005238671
2025-07-21 23:33:24,626 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:33:24,626 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:33:24,729 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:33:25,079 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.82820991194493163678033583% which is below threshold 100.0%
2025-07-21 23:33:25,079 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93498.41499999999980000000000', 'margin': '146484.47', 'free_margin': '-52986.05500000000020000000000', 'profit_loss': '-90847.39500000000020000000000', 'margin_level': '63.82820991194493163678033583', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-110.7750000000002000000000000', 'current_price': '38.884499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90736.62000000000000000000000', 'current_price': '117579.4'}], 'margin_call': True}
2025-07-21 23:33:25,084 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.82820991194493163678033583
2025-07-21 23:33:25,087 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:33:25,087 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:33:25,119 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:25,120 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:33:25,148 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:25,149 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:33:25,190 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:25,190 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:33:25,191 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:33:25,191 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:33:25,200 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:33:25,203 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:33:25,203 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:33:25,232 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:25,232 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:33:25,233 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:33:25,233 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:33:25,234 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:33:25,234 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:33:25,377 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:33:25,378 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:33:25,795 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:33:25,798 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:33:25,799 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:33:25,800 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:33:25,926 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:33:25,927 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:33:26,309 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:33:26,314 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:33:26,315 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:33:26,315 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:33:26,441 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:33:26,442 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:33:26,822 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:33:26,825 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:33:26,825 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:33:26,825 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:33:26,903 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:26,903 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:33:26,940 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:54,166 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-21 23:33:54,569 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-21 23:33:56,949 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:33:56,949 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-21 23:33:56,949 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-21 23:33:56,949 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-21 23:33:56,958 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-21 23:33:56,958 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-21 23:33:56,959 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-21 23:33:56,966 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-21 23:33:56,966 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-21 23:33:56,983 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:33:56,987 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-21 23:33:56,987 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-21 23:33:57,109 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:33:57,447 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:33:57,450 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:33:57,453 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:33:57,455 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-21 23:33:57,455 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.347205'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.347205'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.347045'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.347045'}], 'margin_call': False}
2025-07-21 23:33:57,457 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:33:57,458 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:33:57,458 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-21 23:33:57,476 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:57,477 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-21 23:33:57,491 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:57,491 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-21 23:33:57,506 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:57,506 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-21 23:33:57,575 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-21 23:33:57,926 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '-141.49052542579239999458882', 'margin': '9494.47', 'free_margin': '-9635.96052542579239999458882', 'profit_loss': '-10043.51052542579239999458882', 'margin_level': '-1.490241429229776912187713690', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9984.450000000000000000000000', 'current_price': '117536.3'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-53.69138675072036363144437981', 'current_price': '96.318'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-5.369138675072036363144437981', 'current_price': '96.318'}], 'margin_call': False}
2025-07-21 23:33:57,929 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -1.490241429229776912187713690
2025-07-21 23:33:57,930 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-21 23:33:57,930 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-21 23:33:57,990 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:57,991 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-21 23:33:58,035 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:58,035 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-21 23:33:58,050 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:58,050 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-21 23:33:58,063 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:58,063 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-21 23:33:58,077 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:58,077 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-21 23:33:58,091 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:58,091 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-21 23:33:58,105 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:58,105 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-21 23:33:58,118 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:58,118 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-21 23:33:58,167 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-21 23:33:58,464 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.036259689857191465850938750% which is below threshold 100.0%
2025-07-21 23:33:58,464 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '120.885000000000000000000000', 'margin': '5936.62', 'free_margin': '-5815.735000000000000000000000', 'profit_loss': '-6268.735000000000000000000000', 'margin_level': '2.036259689857191465850938750', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6268.735000000000000000000000', 'current_price': '117536.3'}], 'margin_call': True}
2025-07-21 23:33:58,466 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.036259689857191465850938750
2025-07-21 23:33:58,501 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-21 23:33:58,501 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-21 23:33:58,666 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-21 23:33:58,967 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 63.65136522663460484923760177% which is below threshold 100.0%
2025-07-21 23:33:58,967 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '93239.36499999999975000000000', 'margin': '146484.47', 'free_margin': '-53245.10500000000025000000000', 'profit_loss': '-91106.44500000000025000000000', 'margin_level': '63.65136522663460484923760177', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.2250000000002500000000000', 'current_price': '38.875499999999995'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-90995.22000000000000000000000', 'current_price': '117536.3'}], 'margin_call': True}
2025-07-21 23:33:58,977 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 63.65136522663460484923760177
2025-07-21 23:33:58,990 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-21 23:33:58,990 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-21 23:33:59,084 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:59,084 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-21 23:33:59,120 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:59,121 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-21 23:33:59,152 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:59,152 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-21 23:33:59,153 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-21 23:33:59,153 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-21 23:33:59,161 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-21 23:33:59,165 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-21 23:33:59,165 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-21 23:33:59,201 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:33:59,202 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-21 23:33:59,204 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-21 23:33:59,205 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-21 23:33:59,206 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-21 23:33:59,206 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-21 23:33:59,308 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-21 23:33:59,308 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-21 23:33:59,596 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-21 23:33:59,599 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-21 23:33:59,601 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-21 23:33:59,601 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-21 23:33:59,677 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-21 23:33:59,678 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-21 23:33:59,964 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:33:59,971 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-21 23:33:59,971 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-21 23:33:59,971 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-21 23:34:00,171 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-21 23:34:00,172 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-21 23:34:00,510 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-21 23:34:00,513 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-21 23:34:00,513 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-21 23:34:00,514 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-21 23:34:00,541 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:34:00,541 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-21 23:34:00,556 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-21 23:34:28,613 - INFO - app - Application shutdown initiated
2025-07-21 23:34:28,614 - INFO - app - Scheduler shutdown completed
2025-07-21 23:34:28,627 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-21 23:34:28,986 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-21 23:34:28,987 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-21 23:34:30,298 - INFO - app - Redis connection closed
2025-07-21 23:34:30,298 - INFO - app - Application shutdown completed
