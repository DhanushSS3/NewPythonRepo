2025-07-08 09:36:57,659 - INFO - orders - Application starting up - Orders logging initialized
2025-07-08 09:36:57,659 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-08 09:37:07,057 - INFO - orders - Starting the pending order checker background task.
2025-07-08 09:37:07,062 - INFO - orders - Starting the SL/TP checker task (triggered by market updates).
2025-07-08 09:37:10,277 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:16,582 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:16,677 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:16,768 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:16,834 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:16,915 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:18,957 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:20,938 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:23,352 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:25,613 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:27,859 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:29,659 - INFO - orders - Order close request received - Order ID: 5812391229, User ID: 1, Close Price: 0.89221
2025-07-08 09:37:29,659 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x000001DC990C9220>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-08 09:37:29,660 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-08 09:37:29,660 - INFO - orders - Request to close order 5812391229 for user 1 (user_type: demo) with price 0.89221. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-08 09:37:29,698 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-08 09:37:29,719 - INFO - orders - Existing entry commission for order 5812391229: 0.10000000
2025-07-08 09:37:29,719 - INFO - orders - Commission calculation for order 5812391229: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-08 09:37:29,719 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 0.250000000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 5812391229)
2025-07-08 09:37:29,720 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-08 09:37:29,720 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-08 09:37:29,721 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-08 09:37:29,721 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-08 09:37:29,722 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3677200000'), 'o': Decimal('1.3677200000')}
2025-07-08 09:37:29,722 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3677200000
2025-07-08 09:37:29,723 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 0.250000000000000000000000 CAD / 1.3677200000 = 0.1827859503407130114350890533 USD
2025-07-08 09:37:29,765 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24908.37000000, margin=6.53
2025-07-08 09:37:29,765 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24908.37000000, margin=6.53
2025-07-08 09:37:29,767 - INFO - orders - User data cache updated for user 1
2025-07-08 09:37:29,767 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-08 09:37:29,767 - INFO - orders - Using order model: DemoUserOrder
2025-07-08 09:37:29,771 - INFO - orders - Fetched 1 open orders for user 1
2025-07-08 09:37:29,775 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-08 09:37:29,776 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 1 pending orders
2025-07-08 09:37:29,776 - INFO - orders - Publishing order update for user 1
2025-07-08 09:37:29,779 - INFO - orders - Publishing user data update for user 1
2025-07-08 09:37:29,780 - INFO - orders - Publishing market data trigger
2025-07-08 09:37:29,783 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:30,163 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:30,332 - INFO - orders - Order close request received - Order ID: 9006643171, User ID: 1, Close Price: 0.89222
2025-07-08 09:37:30,332 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x000001DC990C8640>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-08 09:37:30,333 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-08 09:37:30,334 - INFO - orders - Request to close order 9006643171 for user 1 (user_type: demo) with price 0.89222. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-08 09:37:30,370 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-08 09:37:30,430 - INFO - orders - Existing entry commission for order 9006643171: 0.10000000
2025-07-08 09:37:30,430 - INFO - orders - Commission calculation for order 9006643171: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-08 09:37:30,430 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.329250000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 9006643171)
2025-07-08 09:37:30,431 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-08 09:37:30,433 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-08 09:37:30,434 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-08 09:37:30,434 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-08 09:37:30,437 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3677200000'), 'o': Decimal('1.3677200000')}
2025-07-08 09:37:30,437 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3677200000
2025-07-08 09:37:30,437 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.329250000000000000000000 CAD / 1.3677200000 = -0.2407290965987190360600122832 USD
2025-07-08 09:37:30,479 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24907.93000000, margin=0
2025-07-08 09:37:30,480 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24907.93000000, margin=0
2025-07-08 09:37:30,482 - INFO - orders - User data cache updated for user 1
2025-07-08 09:37:30,482 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-08 09:37:30,482 - INFO - orders - Using order model: DemoUserOrder
2025-07-08 09:37:30,490 - INFO - orders - Fetched 0 open orders for user 1
2025-07-08 09:37:30,498 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-08 09:37:30,500 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 1 pending orders
2025-07-08 09:37:30,500 - INFO - orders - Publishing order update for user 1
2025-07-08 09:37:30,502 - INFO - orders - Publishing user data update for user 1
2025-07-08 09:37:30,505 - INFO - orders - Publishing market data trigger
2025-07-08 09:37:30,512 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:32,575 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:35,123 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:37,067 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:39,352 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:39,796 - INFO - orders - Order placement request received - User: 1, Symbol: AUDJPY, Type: BUY
2025-07-08 09:37:40,158 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.6700000000', 'o': '95.6700000000'}
2025-07-08 09:37:40,159 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.6700000000, ask=95.67956700000000
2025-07-08 09:37:40,159 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.6700000000, ask=95.67956700000000
2025-07-08 09:37:40,160 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 956.80 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-08 09:37:40,161 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-08 09:37:40,162 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-08 09:37:40,163 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-08 09:37:40,163 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-08 09:37:40,165 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.8070000000'), 'o': Decimal('146.8020000000')}
2025-07-08 09:37:40,165 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.8070000000
2025-07-08 09:37:40,165 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 956.80 JPY / 146.8070000000 = 6.517400396438861907129769016 USD
2025-07-08 09:37:40,166 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 95.67956700000000, Margin: 6.517400396438861907129769016, Commission: 0.10
2025-07-08 09:37:40,225 - INFO - orders - [PERF] Order processing: 0.4169s
2025-07-08 09:37:40,225 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '9881120223', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_price': Decimal('95.67956700000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.517400396438861907129769016'), 'commission': Decimal('0.10'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-08 09:37:40,226 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 9881120223
2025-07-08 09:37:40,267 - INFO - orders - [PERF] Order creation: 0.0419s
2025-07-08 09:37:40,267 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-08 09:37:40,268 - INFO - orders - Publishing order update for user 1
2025-07-08 09:37:40,271 - INFO - orders - Publishing user data update for user 1
2025-07-08 09:37:40,274 - INFO - orders - Publishing market data trigger
2025-07-08 09:37:40,278 - INFO - orders - [PERF] TOTAL place_order: 0.4826s
2025-07-08 09:37:40,281 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:40,380 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-08 09:37:41,620 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:43,955 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:45,334 - INFO - orders - Order placement request received - User: 1, Symbol: AUDJPY, Type: SELL
2025-07-08 09:37:45,743 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.6650000000', 'o': '95.6600000000'}
2025-07-08 09:37:45,743 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.6650000000, ask=95.67456650000000
2025-07-08 09:37:45,743 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.6650000000, ask=95.67456650000000
2025-07-08 09:37:45,744 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 956.65 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-08 09:37:45,745 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-08 09:37:45,746 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-08 09:37:45,746 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-08 09:37:45,746 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-08 09:37:45,749 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.8070000000'), 'o': Decimal('146.8020000000')}
2025-07-08 09:37:45,749 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.8070000000
2025-07-08 09:37:45,749 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 956.65 JPY / 146.8070000000 = 6.516378646794771366487974007 USD
2025-07-08 09:37:45,749 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 95.6650000000, Margin: 6.516378646794771366487974007, Commission: 0.10
2025-07-08 09:37:45,766 - INFO - orders - [PERF] Order processing: 0.4276s
2025-07-08 09:37:45,767 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '5643410017', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('95.6650000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.516378646794771366487974007'), 'commission': Decimal('0.10'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-08 09:37:45,768 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 5643410017
2025-07-08 09:37:45,819 - INFO - orders - [PERF] Order creation: 0.0522s
2025-07-08 09:37:45,819 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-08 09:37:45,819 - INFO - orders - Publishing order update for user 1
2025-07-08 09:37:45,821 - INFO - orders - Publishing user data update for user 1
2025-07-08 09:37:45,824 - INFO - orders - Publishing market data trigger
2025-07-08 09:37:45,832 - INFO - orders - [PERF] TOTAL place_order: 0.4973s
2025-07-08 09:37:45,836 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:45,917 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-08 09:37:46,298 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:48,467 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:50,796 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:53,037 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:56,813 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:37:57,701 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:38:00,906 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:38:02,960 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:38:04,607 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:38:06,900 - INFO - orders - Market data update received, triggering SL/TP check
2025-07-08 09:44:17,575 - INFO - orders - Application starting up - Orders logging initialized
2025-07-08 09:44:17,576 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
