2025-07-10 21:09:54,312 - INFO - app - Application shutdown initiated
2025-07-10 21:09:54,312 - INFO - app - Scheduler shutdown completed
2025-07-10 21:09:54,365 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-10 21:09:55,842 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-10 21:09:55,842 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-10 21:09:55,845 - INFO - app - Redis connection closed
2025-07-10 21:09:55,846 - INFO - app - Application shutdown completed
2025-07-10 21:10:00,688 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-10 21:10:00,704 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:10:00,717 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:10:00,717 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:10:00,989 - INFO - app - Application starting up - Trading system initialized
2025-07-10 21:10:00,989 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-10 21:10:00,989 - INFO - app - Environment: PRODUCTION
2025-07-10 21:10:01,041 - INFO - app - Application startup initiated
2025-07-10 21:10:01,041 - INFO - app - Initializing core services...
2025-07-10 21:10:01,072 - INFO - app - Firebase initialized
2025-07-10 21:10:01,072 - WARNING - app.dependencies.redis_client - Redis client not initialized, attempting late connection.
2025-07-10 21:10:03,111 - INFO - app - Redis initialized
2025-07-10 21:10:03,115 - INFO - app - Scheduler initialized
2025-07-10 21:10:03,117 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-10 21:10:03,118 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-10 21:10:04,224 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-10 21:10:04,225 - INFO - app - Starting stale cache cleanup task
2025-07-10 21:10:08,288 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-10 21:10:08,288 - INFO - app - Background tasks initialized
2025-07-10 21:10:08,913 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-10 21:10:08,913 - INFO - app - Application startup completed successfully
2025-07-10 21:10:08,914 - INFO - app - Starting cache validation task
2025-07-10 21:10:08,916 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-10 21:10:08,916 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:10:08,931 - INFO - app - Validating cache for 10 users
2025-07-10 21:10:08,931 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:10:10,958 - INFO - app - Found 8 static orders cache entries to check
2025-07-10 21:10:15,013 - WARNING - app - Found stale cache entry for user 9, will be refreshed on next access
2025-07-10 21:10:17,046 - WARNING - app - Found stale cache entry for user 2, will be refreshed on next access
2025-07-10 21:10:17,046 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:10:21,118 - WARNING - app - Found stale cache entry for user 8, will be refreshed on next access
2025-07-10 21:10:21,120 - INFO - app - [BarclaysMarginChecker] Skipping user 4: no dynamic_portfolio in cache.
2025-07-10 21:10:21,136 - WARNING - app - Found stale cache entry for user 3, will be refreshed on next access
2025-07-10 21:10:21,138 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:10:21,151 - WARNING - app - Found stale cache entry for user 10, will be refreshed on next access
2025-07-10 21:10:21,151 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:10:21,151 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-10 21:10:21,152 - WARNING - app - Found stale cache entry for user 5, will be refreshed on next access
2025-07-10 21:10:21,152 - INFO - app - Completed stale cache cleanup task
2025-07-10 21:10:21,154 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:10:21,159 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:10:23,926 - INFO - app - Starting stale cache cleanup task
2025-07-10 21:10:25,276 - INFO - app - Found 8 static orders cache entries to check
2025-07-10 21:10:25,279 - WARNING - app - Found stale cache entry for user 9, will be refreshed on next access
2025-07-10 21:10:25,281 - WARNING - app - Found stale cache entry for user 2, will be refreshed on next access
2025-07-10 21:10:25,283 - WARNING - app - Found stale cache entry for user 8, will be refreshed on next access
2025-07-10 21:10:25,286 - WARNING - app - Found stale cache entry for user 3, will be refreshed on next access
2025-07-10 21:10:25,287 - INFO - app - Cache validation completed
2025-07-10 21:10:27,321 - WARNING - app - Found stale cache entry for user 10, will be refreshed on next access
2025-07-10 21:10:27,325 - WARNING - app - Found stale cache entry for user 5, will be refreshed on next access
2025-07-10 21:10:27,325 - INFO - app - Completed stale cache cleanup task
2025-07-10 21:10:28,287 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-10 21:10:28,287 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-10 21:10:28,451 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:10:28,457 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:10:28,465 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:10:28,465 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:10:28,470 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:10:28,470 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:11:03,627 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:11:03,656 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:11:03,680 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:11:03,683 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:11:03,702 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:11:21,171 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:11:21,172 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:11:21,178 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:11:21,180 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:11:21,185 - INFO - app - [BarclaysMarginChecker] User 4: free_margin=476.31046069915885, total_pending_margin=1317.9967803, pending_orders=3, margin=5800.0
2025-07-10 21:11:21,185 - WARNING - app - [BarclaysMarginChecker] Cancelling order 9627043752 for user 4 (order_margin=6.54835538) due to insufficient margin.
2025-07-10 21:11:21,228 - INFO - app.core.firebase - [FIREBASE] Payload being pushed to Firebase (all stringified): {'order_id': '9627043752', 'cancel_id': '9931262237', 'user_id': '4', 'order_type': 'SELL_LIMIT', 'timestamp': '2025-07-11T04:11:21.228077', 'status': 'PENDING', 'order_quantity': '0.01000000', 'order_status': 'CANCELLED', 'contract_value': '1000.00000000', 'cancel_message': 'Auto-cancelled due to insufficient margin', 'account_type': 'live'}
2025-07-10 21:11:21,617 - INFO - app.core.firebase - Order data (ID: 9627043752) sent to Firebase successfully.
2025-07-10 21:11:21,631 - ERROR - app - Error in barclays_pending_order_margin_checker loop: get_user_by_id() missing 1 required positional argument: 'user_type'
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1274, in barclays_pending_order_margin_checker
    db_user = await get_user_by_id(db, user_id=user_id)
                    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^
TypeError: get_user_by_id() missing 1 required positional argument: 'user_type'
2025-07-10 21:12:03,507 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:12:03,518 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:12:03,529 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:12:03,530 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:12:03,536 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:12:21,638 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:12:21,638 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:12:21,641 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:12:21,642 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:12:21,644 - INFO - app - [BarclaysMarginChecker] User 4: free_margin=476.4567289020801, total_pending_margin=1311.44842492, pending_orders=2, margin=5800.0
2025-07-10 21:12:21,644 - WARNING - app - [BarclaysMarginChecker] Cancelling order 3128757828 for user 4 (order_margin=655.71792971) due to insufficient margin.
2025-07-10 21:12:21,660 - INFO - app.core.firebase - [FIREBASE] Payload being pushed to Firebase (all stringified): {'order_id': '3128757828', 'cancel_id': '2745333630', 'user_id': '4', 'order_type': 'SELL_LIMIT', 'timestamp': '2025-07-11T04:12:21.660258', 'status': 'PENDING', 'order_quantity': '1.00000000', 'order_status': 'CANCELLED', 'contract_value': '100000.00000000', 'cancel_message': 'Auto-cancelled due to insufficient margin', 'account_type': 'live'}
2025-07-10 21:12:22,031 - INFO - app.core.firebase - Order data (ID: 3128757828) sent to Firebase successfully.
2025-07-10 21:12:22,045 - ERROR - app - Error in barclays_pending_order_margin_checker loop: get_user_by_id() missing 1 required positional argument: 'user_type'
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1274, in barclays_pending_order_margin_checker
    db_user = await get_user_by_id(db, user_id=user_id)
                    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^
TypeError: get_user_by_id() missing 1 required positional argument: 'user_type'
2025-07-10 21:13:03,514 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:13:03,523 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:13:03,530 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:13:03,532 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:13:03,539 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:13:22,050 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:13:22,050 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:13:22,055 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:13:22,057 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:13:22,061 - INFO - app - [BarclaysMarginChecker] User 4: free_margin=476.5106929454053, total_pending_margin=655.73049521, pending_orders=1, margin=5800.0
2025-07-10 21:13:22,061 - WARNING - app - [BarclaysMarginChecker] Cancelling order 5045010173 for user 4 (order_margin=655.73049521) due to insufficient margin.
2025-07-10 21:13:22,083 - INFO - app.core.firebase - [FIREBASE] Payload being pushed to Firebase (all stringified): {'order_id': '5045010173', 'cancel_id': '4485370031', 'user_id': '4', 'order_type': 'SELL_LIMIT', 'timestamp': '2025-07-11T04:13:22.083646', 'status': 'PENDING', 'order_quantity': '1.00000000', 'order_status': 'CANCELLED', 'contract_value': '100000.00000000', 'cancel_message': 'Auto-cancelled due to insufficient margin', 'account_type': 'live'}
2025-07-10 21:13:22,445 - INFO - app.core.firebase - Order data (ID: 5045010173) sent to Firebase successfully.
2025-07-10 21:13:22,458 - ERROR - app - Error in barclays_pending_order_margin_checker loop: get_user_by_id() missing 1 required positional argument: 'user_type'
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1274, in barclays_pending_order_margin_checker
    db_user = await get_user_by_id(db, user_id=user_id)
                    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^
TypeError: get_user_by_id() missing 1 required positional argument: 'user_type'
2025-07-10 21:13:43,387 - INFO - app - Application shutdown initiated
2025-07-10 21:13:43,388 - INFO - app - Scheduler shutdown completed
2025-07-10 21:13:43,534 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-10 21:13:44,157 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-10 21:13:44,157 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-10 21:13:44,159 - INFO - app - Redis connection closed
2025-07-10 21:13:44,160 - INFO - app - Application shutdown completed
2025-07-10 21:13:45,963 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-10 21:13:45,978 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:13:45,988 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:13:45,989 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:13:46,267 - INFO - app - Application starting up - Trading system initialized
2025-07-10 21:13:46,267 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-10 21:13:46,267 - INFO - app - Environment: PRODUCTION
2025-07-10 21:13:46,317 - INFO - app - Application startup initiated
2025-07-10 21:13:46,317 - INFO - app - Initializing core services...
2025-07-10 21:13:46,347 - INFO - app - Firebase initialized
2025-07-10 21:13:46,348 - WARNING - app.dependencies.redis_client - Redis client not initialized, attempting late connection.
2025-07-10 21:13:48,389 - INFO - app - Redis initialized
2025-07-10 21:13:48,396 - INFO - app - Scheduler initialized
2025-07-10 21:13:48,399 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-10 21:13:48,400 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-10 21:13:49,388 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-10 21:13:49,390 - INFO - app - Starting stale cache cleanup task
2025-07-10 21:13:53,441 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-10 21:13:53,441 - INFO - app - Background tasks initialized
2025-07-10 21:13:54,085 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-10 21:13:54,086 - INFO - app - Application startup completed successfully
2025-07-10 21:13:54,086 - INFO - app - Starting cache validation task
2025-07-10 21:13:54,088 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-10 21:13:54,088 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:13:54,110 - INFO - app - Validating cache for 10 users
2025-07-10 21:13:54,111 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:13:56,121 - INFO - app - Found 8 static orders cache entries to check
2025-07-10 21:14:00,177 - WARNING - app - Found stale cache entry for user 9, will be refreshed on next access
2025-07-10 21:14:02,204 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:14:02,204 - WARNING - app - Found stale cache entry for user 2, will be refreshed on next access
2025-07-10 21:14:02,206 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-10 21:14:02,209 - WARNING - app - Found stale cache entry for user 8, will be refreshed on next access
2025-07-10 21:14:02,218 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:14:02,239 - WARNING - app - Found stale cache entry for user 3, will be refreshed on next access
2025-07-10 21:14:02,243 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:14:04,279 - WARNING - app - Found stale cache entry for user 10, will be refreshed on next access
2025-07-10 21:14:04,282 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:14:04,284 - WARNING - app - Found stale cache entry for user 5, will be refreshed on next access
2025-07-10 21:14:04,284 - INFO - app - Completed stale cache cleanup task
2025-07-10 21:14:04,292 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:14:04,294 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-10 21:14:04,317 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:14:06,366 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-10 21:14:06,375 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-10 21:14:08,460 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-10 21:14:09,087 - INFO - app - Starting stale cache cleanup task
2025-07-10 21:14:10,514 - INFO - app - Found 8 static orders cache entries to check
2025-07-10 21:14:10,523 - WARNING - app - Found stale cache entry for user 9, will be refreshed on next access
2025-07-10 21:14:10,528 - WARNING - app - Found stale cache entry for user 2, will be refreshed on next access
2025-07-10 21:14:10,533 - WARNING - app - Found stale cache entry for user 8, will be refreshed on next access
2025-07-10 21:14:10,535 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-10 21:14:10,554 - WARNING - app - Found stale cache entry for user 3, will be refreshed on next access
2025-07-10 21:14:10,560 - WARNING - app - Found stale cache entry for user 10, will be refreshed on next access
2025-07-10 21:14:10,562 - WARNING - app - Found stale cache entry for user 5, will be refreshed on next access
2025-07-10 21:14:10,562 - INFO - app - Completed stale cache cleanup task
2025-07-10 21:14:10,568 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-10 21:14:10,596 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-10 21:14:10,624 - INFO - app - Cache validation completed
2025-07-10 21:14:11,756 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-10 21:14:11,961 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:14:11,962 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:14:11,976 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:14:11,976 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:14:11,979 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:14:11,979 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:14:48,889 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:14:48,910 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:14:48,927 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:14:48,931 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:14:48,945 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:15:04,328 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:15:04,328 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:15:04,333 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:15:04,335 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:15:04,338 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:15:04,339 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:15:04,340 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:15:04,341 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:15:04,345 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:15:11,891 - INFO - app - Application shutdown initiated
2025-07-10 21:15:11,891 - INFO - app - Scheduler shutdown completed
2025-07-10 21:15:12,224 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-10 21:15:14,256 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-10 21:15:14,257 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-10 21:15:14,259 - INFO - app - Redis connection closed
2025-07-10 21:15:14,259 - INFO - app - Application shutdown completed
2025-07-10 21:22:43,489 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-10 21:22:43,524 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:22:43,542 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:22:43,542 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:22:43,981 - INFO - app - Application starting up - Trading system initialized
2025-07-10 21:22:43,981 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-10 21:22:43,981 - INFO - app - Environment: PRODUCTION
2025-07-10 21:22:44,054 - INFO - app - Application startup initiated
2025-07-10 21:22:44,054 - INFO - app - Initializing core services...
2025-07-10 21:22:44,141 - INFO - app - Firebase initialized
2025-07-10 21:22:44,141 - WARNING - app.dependencies.redis_client - Redis client not initialized, attempting late connection.
2025-07-10 21:22:46,180 - INFO - app - Redis initialized
2025-07-10 21:22:46,191 - INFO - app - Scheduler initialized
2025-07-10 21:22:46,196 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-10 21:22:46,197 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-10 21:22:47,353 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-10 21:22:47,371 - INFO - app - Starting stale cache cleanup task
2025-07-10 21:22:51,478 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-10 21:22:51,478 - INFO - app - Background tasks initialized
2025-07-10 21:22:52,196 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-10 21:22:52,196 - INFO - app - Application startup completed successfully
2025-07-10 21:22:52,197 - INFO - app - Starting cache validation task
2025-07-10 21:22:52,200 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-10 21:22:52,200 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:22:52,219 - INFO - app - Validating cache for 10 users
2025-07-10 21:22:52,219 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:22:54,242 - INFO - app - Found 8 static orders cache entries to check
2025-07-10 21:22:56,275 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-10 21:22:58,294 - WARNING - app - Found stale cache entry for user 9, will be refreshed on next access
2025-07-10 21:23:00,353 - WARNING - app - Found stale cache entry for user 2, will be refreshed on next access
2025-07-10 21:23:00,354 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:23:00,360 - WARNING - app - Found stale cache entry for user 8, will be refreshed on next access
2025-07-10 21:23:00,361 - INFO - app - [BarclaysMarginChecker] Skipping user 4: no dynamic_portfolio in cache.
2025-07-10 21:23:02,417 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:23:02,417 - WARNING - app - Found stale cache entry for user 3, will be refreshed on next access
2025-07-10 21:23:02,441 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:23:02,443 - WARNING - app - Found stale cache entry for user 10, will be refreshed on next access
2025-07-10 21:23:02,444 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-10 21:23:02,450 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:23:02,451 - WARNING - app - Found stale cache entry for user 5, will be refreshed on next access
2025-07-10 21:23:02,451 - INFO - app - Completed stale cache cleanup task
2025-07-10 21:23:02,469 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:23:04,494 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 4 by invalidating refresh token.
2025-07-10 21:23:04,507 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-10 21:23:04,560 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-10 21:23:06,620 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-10 21:23:06,679 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-10 21:23:06,742 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-10 21:23:06,778 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-10 21:23:06,802 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-10 21:23:06,822 - INFO - app - Cache validation completed
2025-07-10 21:23:07,197 - INFO - app - Starting stale cache cleanup task
2025-07-10 21:23:07,199 - INFO - app - Found 8 static orders cache entries to check
2025-07-10 21:23:07,200 - WARNING - app - Found stale cache entry for user 9, will be refreshed on next access
2025-07-10 21:23:07,201 - WARNING - app - Found stale cache entry for user 2, will be refreshed on next access
2025-07-10 21:23:07,203 - WARNING - app - Found stale cache entry for user 8, will be refreshed on next access
2025-07-10 21:23:07,204 - WARNING - app - Found stale cache entry for user 3, will be refreshed on next access
2025-07-10 21:23:07,206 - WARNING - app - Found stale cache entry for user 10, will be refreshed on next access
2025-07-10 21:23:07,207 - WARNING - app - Found stale cache entry for user 5, will be refreshed on next access
2025-07-10 21:23:07,208 - INFO - app - Completed stale cache cleanup task
2025-07-10 21:23:08,062 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-10 21:23:08,066 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-10 21:23:08,313 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:23:08,314 - INFO - app.core.config - .env file loaded successfully.
2025-07-10 21:23:08,327 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:23:08,327 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:23:08,328 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-10 21:23:08,328 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-10 21:23:46,572 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:23:46,592 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:23:46,610 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:23:46,613 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:23:46,630 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:24:02,471 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:24:02,471 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:24:02,482 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:24:02,483 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:24:02,488 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:24:02,489 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:24:02,491 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:24:02,495 - INFO - app - [BarclaysMarginChecker] User 9: no pending orders.
2025-07-10 21:24:02,501 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:24:46,665 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:24:46,679 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:24:46,692 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:24:46,695 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:24:46,708 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:25:02,503 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:25:02,503 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:25:02,527 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:25:02,529 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:25:02,535 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:25:02,537 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:25:02,538 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:25:02,539 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:25:02,546 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:25:46,587 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:25:46,610 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:25:46,626 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:25:46,630 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:25:46,650 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:26:02,561 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:26:02,562 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:26:02,572 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:26:02,574 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:26:02,579 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:26:02,582 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:26:02,586 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:26:02,587 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:26:02,591 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:26:46,605 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:26:46,628 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:26:46,647 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:26:46,650 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:26:46,669 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:27:02,606 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:27:02,606 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:27:02,612 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:27:02,614 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:27:02,618 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:27:02,619 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:27:02,619 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:27:02,620 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:27:02,624 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:27:46,597 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:27:46,616 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:27:46,632 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:27:46,635 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:27:46,649 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:28:02,635 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:28:02,636 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:28:02,644 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:28:02,646 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:28:02,651 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:28:02,653 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:28:02,656 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:28:02,659 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:28:02,664 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:28:06,843 - INFO - app - Starting cache validation task
2025-07-10 21:28:06,851 - INFO - app - Validating cache for 10 users
2025-07-10 21:28:06,853 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-10 21:28:06,863 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-10 21:28:06,867 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-10 21:28:06,876 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-10 21:28:06,886 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-10 21:28:06,898 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-10 21:28:06,912 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-10 21:28:06,921 - INFO - app - Cache validation completed
2025-07-10 21:28:25,681 - INFO - app.core.firebase - [FIREBASE] Payload being pushed to Firebase (all stringified): {'order_id': '4497093422', 'user_id': '9', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': '0.01', 'price': '96.809', 'status': 'OPEN', 'contract_value': '1000.0', 'account_type': 'live', 'timestamp': '2025-07-11T04:28:25.681341'}
2025-07-10 21:28:26,090 - INFO - app.core.firebase - Order data (ID: 4497093422) sent to Firebase successfully.
2025-07-10 21:28:46,596 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:28:46,611 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:28:46,627 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:28:46,630 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:28:46,641 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:29:02,665 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:29:02,666 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:29:02,672 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:29:02,676 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:29:02,681 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:29:02,682 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:29:02,683 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:29:02,684 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:29:02,691 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:29:46,622 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:29:46,651 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:29:46,674 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:29:46,679 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:29:46,697 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:30:02,698 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:30:02,698 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:30:02,704 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:30:02,706 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:30:02,711 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:30:02,712 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:30:02,713 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:30:02,714 - INFO - app - [BarclaysMarginChecker] Skipping user 9: no dynamic_portfolio in cache.
2025-07-10 21:30:02,719 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:30:46,617 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:30:47,057 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:30:47,111 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:30:47,118 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:30:47,134 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:31:01,445 - INFO - app.core.firebase - [FIREBASE] Payload being pushed to Firebase (all stringified): {'order_id': '9190132347', 'user_id': '9', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': '0.13', 'price': '116551.4', 'status': 'OPEN', 'contract_value': '0.13', 'account_type': 'live', 'timestamp': '2025-07-11T04:31:01.445106'}
2025-07-10 21:31:01,755 - INFO - app.core.firebase - Order data (ID: 9190132347) sent to Firebase successfully.
2025-07-10 21:31:02,723 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:31:02,723 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:31:02,730 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:31:02,732 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:31:02,736 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:31:02,737 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:31:02,740 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:31:02,744 - INFO - app - [BarclaysMarginChecker] User 9: no pending orders.
2025-07-10 21:31:02,749 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:31:46,622 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:31:47,027 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:31:47,037 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:31:47,040 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:31:47,050 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:32:02,765 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:32:02,766 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:32:02,774 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:32:02,776 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:32:02,780 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:32:02,782 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:32:02,783 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:32:02,787 - INFO - app - [BarclaysMarginChecker] User 9: no pending orders.
2025-07-10 21:32:02,790 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:32:46,626 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:32:47,023 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:32:47,033 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:32:47,036 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:32:47,045 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:32:56,548 - INFO - app.core.firebase - [FIREBASE] Payload being pushed to Firebase (all stringified): {'order_id': '3333380822', 'order_company_name': 'AUDCAD', 'order_price': '0.89', 'contract_value': '300000.0', 'order_quantity': '3.0', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING-PROCESSING', 'status': 'PENDING', 'action': 'place_pending_order', 'account_type': 'live', 'timestamp': '2025-07-11T04:32:56.548670'}
2025-07-10 21:32:56,848 - INFO - app.core.firebase - Order data (ID: 3333380822) sent to Firebase successfully.
2025-07-10 21:33:02,792 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:33:02,792 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:33:02,801 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:33:02,803 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:33:02,808 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:33:02,809 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:33:02,810 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:33:02,814 - INFO - app - [BarclaysMarginChecker] User 9: no pending orders.
2025-07-10 21:33:02,818 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:33:06,927 - INFO - app - Starting cache validation task
2025-07-10 21:33:06,932 - INFO - app - Validating cache for 10 users
2025-07-10 21:33:06,933 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-10 21:33:06,944 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-10 21:33:06,950 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-10 21:33:06,952 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-10 21:33:06,957 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-10 21:33:06,962 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-10 21:33:06,967 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-10 21:33:06,972 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-10 21:33:06,976 - INFO - app - Cache validation completed
2025-07-10 21:33:07,213 - INFO - app - Starting stale cache cleanup task
2025-07-10 21:33:07,213 - INFO - app - Found 8 static orders cache entries to check
2025-07-10 21:33:07,214 - WARNING - app - Found stale cache entry for user 2, will be refreshed on next access
2025-07-10 21:33:07,215 - WARNING - app - Found stale cache entry for user 8, will be refreshed on next access
2025-07-10 21:33:07,217 - WARNING - app - Found stale cache entry for user 3, will be refreshed on next access
2025-07-10 21:33:07,218 - WARNING - app - Found stale cache entry for user 10, will be refreshed on next access
2025-07-10 21:33:07,219 - WARNING - app - Found stale cache entry for user 5, will be refreshed on next access
2025-07-10 21:33:07,219 - INFO - app - Completed stale cache cleanup task
2025-07-10 21:33:46,564 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:33:46,937 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 99.09782221041662839619455580% which is below threshold 100.0%
2025-07-10 21:33:46,942 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:33:46,951 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:33:46,952 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:33:46,961 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:34:02,820 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:34:02,820 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:34:02,824 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:34:02,825 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:34:02,827 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:34:02,828 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:34:02,829 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:34:02,830 - INFO - app - [BarclaysMarginChecker] User 9: no pending orders.
2025-07-10 21:34:02,833 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:34:46,624 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:34:47,035 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:34:47,053 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:34:47,057 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:34:47,073 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:35:02,848 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:35:02,848 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:35:02,856 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:35:02,858 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:35:02,863 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:35:02,864 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:35:02,865 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:35:02,869 - INFO - app - [BarclaysMarginChecker] User 9: free_margin=813.7629115891383, total_pending_margin=1974.06022178, pending_orders=1, margin=7579.96
2025-07-10 21:35:02,870 - WARNING - app - [BarclaysMarginChecker] Cancelling order 3333380822 for user 9 (order_margin=1974.06022178) due to insufficient margin.
2025-07-10 21:35:02,928 - INFO - app.core.firebase - [FIREBASE] Payload being pushed to Firebase (all stringified): {'order_id': '3333380822', 'cancel_id': '1920503271', 'user_id': '9', 'order_type': 'BUY_LIMIT', 'timestamp': '2025-07-11T04:35:02.928046', 'status': 'CANCELLED', 'order_quantity': '3.00000000', 'order_status': 'CANCELLED-PROCESSING', 'contract_value': '300000.00000000', 'cancel_message': 'Auto-cancelled due to insufficient margin', 'account_type': 'live'}
2025-07-10 21:35:03,316 - INFO - app.core.firebase - Order data (ID: 3333380822) sent to Firebase successfully.
2025-07-10 21:35:03,441 - INFO - app - [BarclaysMarginChecker] After cancelling order 3333380822: new free_margin=813.7629115891383, new total_pending_margin=0
2025-07-10 21:35:03,457 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:35:46,633 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 8.
2025-07-10 21:35:46,946 - WARNING - app - No user data found for user 11 (live). Skipping portfolio update.
2025-07-10 21:35:46,954 - WARNING - app - User 2 has no group_name set. Skipping portfolio update.
2025-07-10 21:35:46,956 - WARNING - app - No group settings found for group string. Skipping portfolio update for user 3.
2025-07-10 21:35:46,963 - WARNING - app - User 5 has no group_name set. Skipping portfolio update.
2025-07-10 21:36:03,459 - INFO - app - [BarclaysMarginChecker] --- Loop iteration end (after sleep) ---
2025-07-10 21:36:03,460 - INFO - app - [BarclaysMarginChecker] --- Loop iteration start ---
2025-07-10 21:36:03,464 - INFO - app - [BarclaysMarginChecker] Checking 4 live users.
2025-07-10 21:36:03,466 - INFO - app - [BarclaysMarginChecker] User 4 group: Standard, sending_orders: barclays
2025-07-10 21:36:03,469 - INFO - app - [BarclaysMarginChecker] User 4: no pending orders.
2025-07-10 21:36:03,470 - INFO - app - [BarclaysMarginChecker] User 8 group: string, sending_orders: None
2025-07-10 21:36:03,471 - INFO - app - [BarclaysMarginChecker] User 9 group: Group B, sending_orders: barclays
2025-07-10 21:36:03,475 - INFO - app - [BarclaysMarginChecker] User 9: no pending orders.
2025-07-10 21:36:03,478 - INFO - app - [BarclaysMarginChecker] Skipping user 11: no user_data in cache.
2025-07-10 21:36:13,341 - INFO - app - Application shutdown initiated
2025-07-10 21:36:13,342 - INFO - app - Scheduler shutdown completed
2025-07-10 21:36:13,540 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-10 21:36:14,918 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-10 21:36:14,918 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-10 21:36:14,922 - INFO - app - Redis connection closed
2025-07-10 21:36:14,922 - INFO - app - Application shutdown completed
