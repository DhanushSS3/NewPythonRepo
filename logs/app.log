2025-07-25 03:29:45,703 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-25 03:29:45,746 - INFO - app.core.config - .env file loaded successfully.
2025-07-25 03:29:45,760 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-25 03:29:45,760 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-25 03:29:46,086 - INFO - app - Application starting up - Trading system initialized
2025-07-25 03:29:46,086 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-25 03:29:46,086 - INFO - app - Environment: PRODUCTION
2025-07-25 03:29:46,145 - INFO - app - Application startup initiated
2025-07-25 03:29:46,146 - INFO - app - Initializing core services...
2025-07-25 03:29:46,213 - INFO - app - Firebase initialized
2025-07-25 03:29:46,213 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-25 03:29:46,293 - INFO - app - Redis initialized
2025-07-25 03:29:46,964 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-25 03:29:46,967 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-25 03:29:46,970 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-25 03:29:46,970 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-25 03:29:46,971 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-25 03:29:46,971 - INFO - app - Scheduler initialized
2025-07-25 03:29:46,973 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-25 03:29:46,974 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-25 03:29:48,204 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-25 03:29:48,211 - INFO - app - Starting stale cache cleanup task
2025-07-25 03:29:48,280 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-25 03:29:48,280 - INFO - app - Background tasks initialized
2025-07-25 03:29:48,280 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-25 03:29:49,014 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-25 03:29:49,015 - INFO - app - Application startup completed successfully
2025-07-25 03:29:49,015 - INFO - app - Starting cache validation task
2025-07-25 03:29:49,019 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-25 03:29:49,021 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-25 03:29:49,023 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-25 03:29:49,056 - INFO - app - Found 30 static orders cache entries to check
2025-07-25 03:29:49,070 - INFO - app - Validating cache for 30 users
2025-07-25 03:29:49,073 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-25 03:29:49,089 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,093 - ERROR - app - Error checking cache key b'user_static_orders:live:21': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,096 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-25 03:29:49,104 - ERROR - app - Error checking cache key b'user_static_orders:live:29': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,105 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,114 - ERROR - app - Error checking cache key b'user_static_orders:live:24': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,123 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-25 03:29:49,125 - ERROR - app - Error checking cache key b'user_static_orders:live:19': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,133 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-25 03:29:49,134 - ERROR - app - Error checking cache key b'user_static_orders:live:17': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,138 - ERROR - app - Error checking cache key b'user_static_orders:live:5': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,141 - ERROR - app - Error checking cache key b'user_static_orders:live:6': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,141 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,142 - ERROR - app - Error checking cache key b'user_static_orders:live:23': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,150 - ERROR - app - Error checking cache key b'user_static_orders:live:20': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,154 - ERROR - app - Error checking cache key b'user_static_orders:live:8': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,158 - ERROR - app - Error checking cache key b'user_static_orders:live:16': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,159 - ERROR - app - Error checking cache key b'user_static_orders:live:31': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,164 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,166 - ERROR - app - Error checking cache key b'user_static_orders:live:3': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,171 - ERROR - app - Error checking cache key b'user_static_orders:live:2': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,179 - ERROR - app - Error checking cache key b'user_static_orders:live:12': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,180 - ERROR - app - Error checking cache key b'user_static_orders:live:13': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,182 - ERROR - app - Error checking cache key b'user_static_orders:live:18': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,183 - ERROR - app - Error checking cache key b'user_static_orders:live:30': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,184 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,184 - ERROR - app - Error checking cache key b'user_static_orders:live:22': a bytes-like object is required, not 'str'
2025-07-25 03:29:49,184 - INFO - app - Completed stale cache cleanup task
2025-07-25 03:29:49,193 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,201 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,219 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,236 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,259 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,273 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,287 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,297 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,307 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,317 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,351 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,369 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,390 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,416 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,747 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.148986662926999110217029672% which is below threshold 100.0%
2025-07-25 03:29:49,753 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 1.148986662926999110217029672
2025-07-25 03:29:49,760 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,773 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,786 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,801 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,815 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:49,820 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,860 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-25 03:29:49,880 - INFO - app - Cache validation completed
2025-07-25 03:29:49,887 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:49,933 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:50,552 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: -7.577580676197155659931016055
2025-07-25 03:29:50,578 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:50,606 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:50,630 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:50,658 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:50,684 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:50,710 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:50,735 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:50,763 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:51,172 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-25 03:29:51,179 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-25 03:29:51,179 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-25 03:29:51,181 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-25 03:29:51,189 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-25 03:29:51,258 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-25 03:29:51,260 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-25 03:29:51,334 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: -0.6131771951042849298085442558
2025-07-25 03:29:51,504 - INFO - app.core.config - .env file loaded successfully.
2025-07-25 03:29:51,506 - INFO - app.core.config - .env file loaded successfully.
2025-07-25 03:29:51,514 - INFO - app.core.config - .env file loaded successfully.
2025-07-25 03:29:51,528 - INFO - app.core.config - .env file loaded successfully.
2025-07-25 03:29:51,529 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-25 03:29:51,529 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-25 03:29:51,530 - INFO - app.core.config - .env file loaded successfully.
2025-07-25 03:29:51,532 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-25 03:29:51,532 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-25 03:29:51,537 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-25 03:29:51,537 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-25 03:29:51,548 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-25 03:29:51,548 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-25 03:29:51,552 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-25 03:29:51,552 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-25 03:29:51,566 - INFO - app.core.config - .env file loaded successfully.
2025-07-25 03:29:51,580 - INFO - app.core.config - .env file loaded successfully.
2025-07-25 03:29:51,580 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-25 03:29:51,581 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-25 03:29:51,590 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-25 03:29:51,590 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-25 03:29:51,884 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 57.20648748635264885076213199% which is below threshold 100.0%
2025-07-25 03:29:51,886 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 57.20648748635264885076213199
2025-07-25 03:29:51,917 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:51,959 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:52,050 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-25 03:29:52,174 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-25 03:29:52,477 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-25 03:29:52,482 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-25 03:29:52,514 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-25 03:29:52,516 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-25 03:29:52,538 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:52,539 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-25 03:29:52,539 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-25 03:29:52,636 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-25 03:29:52,935 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-25 03:29:53,033 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-25 03:29:53,340 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-25 03:29:53,891 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-25 03:29:54,190 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-25 03:29:54,256 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:29:54,273 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-25 03:30:04,016 - INFO - app - Starting stale cache cleanup task
2025-07-25 03:30:04,018 - INFO - app - Found 30 static orders cache entries to check
2025-07-25 03:30:04,022 - ERROR - app - Error checking cache key b'user_static_orders:live:21': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,025 - ERROR - app - Error checking cache key b'user_static_orders:live:29': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,029 - ERROR - app - Error checking cache key b'user_static_orders:live:24': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,031 - ERROR - app - Error checking cache key b'user_static_orders:live:19': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,032 - ERROR - app - Error checking cache key b'user_static_orders:live:17': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,032 - ERROR - app - Error checking cache key b'user_static_orders:live:5': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,033 - ERROR - app - Error checking cache key b'user_static_orders:live:6': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,034 - ERROR - app - Error checking cache key b'user_static_orders:live:23': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,035 - ERROR - app - Error checking cache key b'user_static_orders:live:20': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,036 - ERROR - app - Error checking cache key b'user_static_orders:live:8': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,038 - ERROR - app - Error checking cache key b'user_static_orders:live:16': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,039 - ERROR - app - Error checking cache key b'user_static_orders:live:31': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,041 - ERROR - app - Error checking cache key b'user_static_orders:live:3': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,042 - ERROR - app - Error checking cache key b'user_static_orders:live:2': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,043 - ERROR - app - Error checking cache key b'user_static_orders:live:12': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,043 - ERROR - app - Error checking cache key b'user_static_orders:live:13': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,043 - ERROR - app - Error checking cache key b'user_static_orders:live:18': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,044 - ERROR - app - Error checking cache key b'user_static_orders:live:30': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,044 - ERROR - app - Error checking cache key b'user_static_orders:live:22': a bytes-like object is required, not 'str'
2025-07-25 03:30:04,044 - INFO - app - Completed stale cache cleanup task
2025-07-25 03:30:05,340 - INFO - app - Application shutdown initiated
2025-07-25 03:30:05,340 - INFO - app - Scheduler shutdown completed
2025-07-25 03:30:05,653 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-25 03:30:07,966 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-25 03:30:07,967 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-25 03:30:07,974 - INFO - app - Redis connection closed
2025-07-25 03:30:07,974 - INFO - app - Application shutdown completed
