2025-07-22 03:19:54,675 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:19:54,708 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:19:54,718 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:19:54,719 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:19:54,997 - INFO - app - Application starting up - Trading system initialized
2025-07-22 03:19:54,997 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 03:19:54,997 - INFO - app - Environment: PRODUCTION
2025-07-22 03:19:55,062 - INFO - app - Application startup initiated
2025-07-22 03:19:55,062 - INFO - app - Initializing core services...
2025-07-22 03:19:55,098 - INFO - app - Firebase initialized
2025-07-22 03:19:55,098 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 03:19:55,119 - INFO - app - Redis initialized
2025-07-22 03:19:55,986 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 03:19:55,989 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 03:19:55,992 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 03:19:55,992 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 03:19:55,992 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 03:19:55,993 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 03:19:55,993 - INFO - app - Scheduler initialized
2025-07-22 03:19:55,994 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:19:55,995 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 03:19:56,898 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:19:56,917 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:19:56,956 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 03:19:56,956 - INFO - app - Background tasks initialized
2025-07-22 03:19:56,956 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:19:57,571 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:19:57,571 - INFO - app - Application startup completed successfully
2025-07-22 03:19:57,572 - INFO - app - Starting cache validation task
2025-07-22 03:19:57,575 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 03:19:57,578 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 03:19:57,580 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 03:19:57,580 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:19:57,580 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:19:57,580 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:19:57,581 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:19:57,620 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 03:19:57,634 - INFO - app - Validating cache for 30 users
2025-07-22 03:19:57,636 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:19:57,636 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:19:57,636 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:19:57,640 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:19:57,652 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:19:57,652 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:19:57,655 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:19:57,659 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:19:57,661 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:19:57,665 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:19:57,666 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:19:57,670 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:19:57,671 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:19:57,673 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:19:57,675 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:19:57,675 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:19:57,675 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:19:57,676 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:19:57,677 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:19:57,679 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:19:57,680 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:19:57,681 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:19:57,684 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:19:57,686 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:19:57,688 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:19:57,691 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:19:57,693 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:19:57,695 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:19:57,695 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:19:57,716 - WARNING - app - User 4: Missing static orders cache, refreshing...
2025-07-22 03:19:57,744 - INFO - app - Cache validation completed
2025-07-22 03:19:57,857 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:19:58,146 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:19:58,148 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:19:58,149 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:19:58,150 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:19:58,151 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3495200000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3495200000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3495100000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3495100000'}], 'margin_call': False}
2025-07-22 03:19:58,152 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:19:58,153 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:19:58,153 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:19:58,176 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,176 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:19:58,194 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,194 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:19:58,216 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,216 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:19:58,436 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:19:58,744 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.975377872009417860507462418% which is below threshold 100.0%
2025-07-22 03:19:58,745 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '187.551659444572575940522867', 'margin': '9494.47', 'free_margin': '-9306.918340555427424059477133', 'profit_loss': '-9714.468340555427424059477133', 'margin_level': '1.975377872009417860507462418', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9639.646000000000000000000000', 'current_price': '118398.3100000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-68.02030959584311278134284823', 'current_price': '96.1090000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.802030959584311278134284823', 'current_price': '96.1090000000'}], 'margin_call': True}
2025-07-22 03:19:58,746 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 1.975377872009417860507462418
2025-07-22 03:19:58,777 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:19:58,777 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:19:58,799 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,799 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:19:58,822 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,822 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:19:58,845 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,845 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:19:58,869 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,870 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:19:58,891 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,891 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:19:58,917 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,917 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:19:58,940 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,940 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:19:58,963 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:19:58,963 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:19:59,131 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:19:59,318 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:19:59,325 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:19:59,334 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:19:59,337 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:19:59,345 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:19:59,350 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:19:59,422 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.488281210520464506739525184% which is below threshold 100.0%
2025-07-22 03:19:59,423 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '207.086000000000000000000000', 'margin': '5936.62', 'free_margin': '-5729.534000000000000000000000', 'profit_loss': '-6182.534000000000000000000000', 'margin_level': '3.488281210520464506739525184', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6182.534000000000000000000000', 'current_price': '118398.3100000000'}], 'margin_call': True}
2025-07-22 03:19:59,425 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.488281210520464506739525184
2025-07-22 03:19:59,484 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:19:59,484 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:19:59,645 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:19:59,649 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:19:59,662 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:19:59,663 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:19:59,670 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:19:59,674 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:19:59,674 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:19:59,679 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:19:59,679 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:19:59,682 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:19:59,682 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:19:59,682 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:19:59,683 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:19:59,683 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:19:59,686 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:19:59,692 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:19:59,692 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:19:59,702 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:19:59,703 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:19:59,705 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:19:59,705 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:19:59,709 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:20:00,005 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.18220709676595751071768905% which is below threshold 100.0%
2025-07-22 03:20:00,005 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98411.50000000000000000000000', 'margin': '146484.47', 'free_margin': '-48072.97000000000000000000000', 'profit_loss': '-85934.31000000000000000000000', 'margin_level': '67.18220709676595751071768905', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.1500000000000000000000000', 'current_price': '38.8770000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85823.16000000000000000000000', 'current_price': '118398.3100000000'}], 'margin_call': True}
2025-07-22 03:20:00,008 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.18220709676595751071768905
2025-07-22 03:20:00,009 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:20:00,009 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:20:00,031 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:00,031 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:20:00,049 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:00,049 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:20:00,067 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:00,067 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:20:00,068 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:20:00,068 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:20:00,073 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:20:00,074 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:20:00,075 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:20:00,089 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:00,090 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:20:00,090 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:20:00,090 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:20:00,091 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:20:00,091 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:20:00,186 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:20:00,186 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:20:00,617 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:20:00,619 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:20:00,620 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:20:00,620 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:20:00,690 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:20:00,691 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:20:00,979 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:20:00,981 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:20:00,982 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:20:00,982 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:20:01,057 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:20:01,057 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:20:01,399 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:20:01,410 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:20:01,410 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:20:01,411 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:20:01,451 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:01,451 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:20:01,480 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:12,572 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:20:12,573 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:20:12,574 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:20:12,575 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:20:12,576 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:20:12,578 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:20:12,580 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:20:12,581 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:20:12,585 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:20:12,586 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:20:12,587 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:20:12,588 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:20:12,589 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:20:12,592 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:20:12,595 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:20:12,596 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:20:12,598 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:20:12,599 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:20:12,601 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:20:12,601 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:20:12,604 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:20:12,606 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:20:12,609 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:20:12,610 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:20:31,492 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:20:31,493 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:20:31,493 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:20:31,493 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:20:31,498 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:20:31,498 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:20:31,498 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:20:31,502 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:20:31,502 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:20:31,511 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:20:31,513 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:20:31,513 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:20:31,563 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:20:31,861 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:20:31,868 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:20:31,873 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:20:31,877 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:20:31,877 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.349515'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.349515'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3493549999999999'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3493549999999999'}], 'margin_call': False}
2025-07-22 03:20:31,881 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:20:31,883 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:20:31,883 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:20:31,935 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:31,935 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:20:31,960 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:31,960 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:20:31,976 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:31,976 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:20:32,025 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:20:32,323 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.829940466700691002462017985% which is below threshold 100.0%
2025-07-22 03:20:32,323 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '173.743148628757097021455559', 'margin': '9494.47', 'free_margin': '-9320.726851371242902978544441', 'profit_loss': '-9728.276851371242902978544441', 'margin_level': '1.829940466700691002462017985', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9652.486000000000000000000000', 'current_price': '118366.21'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-68.90077397385718452594949159', 'current_price': '96.096'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.890077397385718452594949159', 'current_price': '96.096'}], 'margin_call': True}
2025-07-22 03:20:32,325 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 1.829940466700691002462017985
2025-07-22 03:20:32,362 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:20:32,363 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:20:32,387 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:32,387 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:20:32,409 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:32,409 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:20:32,429 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:32,430 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:20:32,449 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:32,449 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:20:32,469 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:32,469 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:20:32,491 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:32,491 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:20:32,514 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:32,515 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:20:32,543 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:32,543 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:20:32,652 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:20:32,978 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.434210038708894960432030347% which is below threshold 100.0%
2025-07-22 03:20:32,979 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '203.876000000000000000000000', 'margin': '5936.62', 'free_margin': '-5732.744000000000000000000000', 'profit_loss': '-6185.744000000000000000000000', 'margin_level': '3.434210038708894960432030347', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6185.744000000000000000000000', 'current_price': '118366.21'}], 'margin_call': True}
2025-07-22 03:20:32,982 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.434210038708894960432030347
2025-07-22 03:20:33,012 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:20:33,012 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:20:33,105 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:20:33,398 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.05029891564614323962123766% which is below threshold 100.0%
2025-07-22 03:20:33,398 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98218.27500000000000000000000', 'margin': '146484.47', 'free_margin': '-48266.19500000000000000000000', 'profit_loss': '-86127.53500000000000000000000', 'margin_level': '67.05029891564614323962123766', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.775000000000000000000000', 'current_price': '38.8645'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-86015.76000000000000000000000', 'current_price': '118366.21'}], 'margin_call': True}
2025-07-22 03:20:33,403 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.05029891564614323962123766
2025-07-22 03:20:33,405 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:20:33,405 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:20:33,433 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:33,433 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:20:33,464 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:33,464 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:20:33,496 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:33,496 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:20:33,496 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:20:33,497 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:20:33,512 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:20:33,515 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:20:33,515 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:20:33,541 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:33,542 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:20:33,544 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:20:33,544 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:20:33,546 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:20:33,546 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:20:33,663 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:20:33,663 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:20:33,956 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:20:33,958 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:20:33,960 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:20:33,960 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:20:34,049 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:20:34,050 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:20:34,345 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:20:34,347 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:20:34,347 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:20:34,347 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:20:34,461 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:20:34,462 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:20:34,751 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:20:34,752 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:20:34,752 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:20:34,752 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:20:34,785 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:34,785 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:20:34,809 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:20:56,006 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:20:56,314 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:21:04,810 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:21:04,810 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:21:04,811 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:21:04,811 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:21:04,819 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:21:04,819 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:21:04,819 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:21:04,823 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:21:04,823 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:21:04,834 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:21:04,838 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:21:04,838 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:21:04,965 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:21:05,300 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:21:05,304 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:21:05,306 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:21:05,309 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:21:05,309 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.349405'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.349405'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.349245'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.349245'}], 'margin_call': False}
2025-07-22 03:21:05,311 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:21:05,312 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:21:05,312 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:21:05,342 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:05,342 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:21:05,379 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:05,379 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:21:05,446 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:05,446 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:21:05,569 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:21:05,916 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.164435124579711248888885267% which is below threshold 100.0%
2025-07-22 03:21:05,916 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '205.501643572683310612380545', 'margin': '9494.47', 'free_margin': '-9288.968356427316689387619455', 'profit_loss': '-9696.518356427316689387619455', 'margin_level': '2.164435124579711248888885267', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9620.290000000000000000000000', 'current_price': '118446.7'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-69.29850584301517217056314051', 'current_price': '96.09'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.929850584301517217056314051', 'current_price': '96.09'}], 'margin_call': True}
2025-07-22 03:21:05,921 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.164435124579711248888885267
2025-07-22 03:21:05,960 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:21:05,960 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:21:06,013 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:06,014 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:21:06,052 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:06,053 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:21:06,095 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:06,095 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:21:06,130 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:06,130 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:21:06,160 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:06,161 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:21:06,192 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:06,192 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:21:06,226 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:06,226 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:21:06,261 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:06,261 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:21:06,375 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:21:06,732 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.569792238681269813462879551% which is below threshold 100.0%
2025-07-22 03:21:06,733 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '211.925000000000000000000000', 'margin': '5936.62', 'free_margin': '-5724.695000000000000000000000', 'profit_loss': '-6177.695000000000000000000000', 'margin_level': '3.569792238681269813462879551', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6177.695000000000000000000000', 'current_price': '118446.7'}], 'margin_call': True}
2025-07-22 03:21:06,735 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.569792238681269813462879551
2025-07-22 03:21:06,833 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:21:06,833 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:21:07,764 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:21:08,166 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.38036120825641090144231672% which is below threshold 100.0%
2025-07-22 03:21:08,166 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98701.76499999999975000000000', 'margin': '146484.47', 'free_margin': '-47782.70500000000025000000000', 'profit_loss': '-85644.04500000000025000000000', 'margin_level': '67.38036120825641090144231672', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.2250000000002500000000000', 'current_price': '38.875499999999995'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85532.82000000000000000000000', 'current_price': '118446.7'}], 'margin_call': True}
2025-07-22 03:21:08,169 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.38036120825641090144231672
2025-07-22 03:21:08,172 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:21:08,172 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:21:08,230 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:08,230 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:21:08,340 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:08,340 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:21:08,424 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:08,424 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:21:08,430 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:21:08,430 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:21:08,446 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:21:08,450 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:21:08,451 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:21:08,521 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:08,521 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:21:08,523 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:21:08,524 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:21:08,526 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:21:08,526 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:21:08,747 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:21:08,749 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:21:09,100 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:21:09,132 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:21:09,139 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:21:09,139 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:21:09,437 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:21:09,440 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:21:09,806 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:21:09,810 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:21:09,810 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:21:09,811 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:21:09,924 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:21:09,926 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:21:10,317 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:21:10,320 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:21:10,320 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:21:10,320 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:21:10,385 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:10,385 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:21:10,449 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:24,205 - INFO - app - Application shutdown initiated
2025-07-22 03:21:24,206 - INFO - app - Scheduler shutdown completed
2025-07-22 03:21:24,583 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 03:21:25,282 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 03:21:25,282 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 03:21:25,287 - INFO - app - Redis connection closed
2025-07-22 03:21:25,288 - INFO - app - Application shutdown completed
2025-07-22 03:21:27,087 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:27,119 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:27,130 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:27,130 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:43,111 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:43,168 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:43,182 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:43,182 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:53,013 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:53,033 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:53,046 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:53,046 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:53,452 - INFO - app - Application starting up - Trading system initialized
2025-07-22 03:21:53,452 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 03:21:53,452 - INFO - app - Environment: PRODUCTION
2025-07-22 03:21:53,495 - INFO - app - Application startup initiated
2025-07-22 03:21:53,495 - INFO - app - Initializing core services...
2025-07-22 03:21:53,528 - INFO - app - Firebase initialized
2025-07-22 03:21:53,528 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 03:21:53,549 - INFO - app - Redis initialized
2025-07-22 03:21:54,039 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 03:21:54,042 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 03:21:54,045 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 03:21:54,045 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 03:21:54,045 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 03:21:54,046 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 03:21:54,046 - INFO - app - Scheduler initialized
2025-07-22 03:21:54,047 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:21:54,047 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 03:21:55,178 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:21:55,187 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:21:55,223 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 03:21:55,223 - INFO - app - Background tasks initialized
2025-07-22 03:21:55,223 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:21:55,880 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:21:55,880 - INFO - app - Application startup completed successfully
2025-07-22 03:21:55,881 - INFO - app - Starting cache validation task
2025-07-22 03:21:55,885 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 03:21:55,887 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 03:21:55,890 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 03:21:55,890 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:21:55,890 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:21:55,890 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:21:55,890 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:21:55,922 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:21:55,930 - INFO - app - Validating cache for 30 users
2025-07-22 03:21:55,932 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:21:55,932 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:21:55,932 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:21:55,939 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:21:55,951 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:21:55,954 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:21:55,954 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:21:55,961 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:21:55,965 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:21:55,969 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:21:55,970 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:21:55,973 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:21:55,974 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:21:55,977 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:21:55,978 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:21:55,978 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:21:55,979 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:21:55,981 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:21:55,982 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:21:55,984 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:21:55,985 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:21:55,986 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:21:55,990 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:21:55,991 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:21:55,993 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:21:55,994 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:21:55,997 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:21:56,000 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:21:56,002 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:21:56,003 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:21:56,042 - INFO - app - Cache validation completed
2025-07-22 03:21:56,199 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:21:56,524 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:21:56,529 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:21:56,535 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:21:56,540 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:21:56,540 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3492300000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3492300000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3492200000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3492200000'}], 'margin_call': False}
2025-07-22 03:21:56,544 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:21:56,549 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:21:56,549 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:21:56,604 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:56,605 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:21:56,673 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:56,673 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:21:56,752 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:56,752 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:21:57,095 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:21:57,401 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.388489886720491912708953981% which is below threshold 100.0%
2025-07-22 03:21:57,402 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '226.774455747711088504577823', 'margin': '9494.47', 'free_margin': '-9267.695544252288911495422177', 'profit_loss': '-9675.245544252288911495422177', 'margin_level': '2.388489886720491912708953981', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9600.290000000000000000000000', 'current_price': '118496.7000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-68.14140386571719226856561546', 'current_price': '96.1070000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.814140386571719226856561546', 'current_price': '96.1070000000'}], 'margin_call': True}
2025-07-22 03:21:57,407 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.388489886720491912708953981
2025-07-22 03:21:57,433 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:21:57,433 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:21:57,457 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:57,457 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:21:57,481 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:57,481 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:21:57,503 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:57,503 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:21:57,530 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:57,530 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:21:57,555 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:57,561 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:21:57,587 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:57,587 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:21:57,612 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:57,613 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:21:57,637 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:57,637 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:21:57,777 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:21:57,976 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:57,983 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:58,004 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:58,008 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:58,016 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:58,018 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:58,078 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.654015247733558826402902662% which is below threshold 100.0%
2025-07-22 03:21:58,079 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '216.925000000000000000000000', 'margin': '5936.62', 'free_margin': '-5719.695000000000000000000000', 'profit_loss': '-6172.695000000000000000000000', 'margin_level': '3.654015247733558826402902662', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6172.695000000000000000000000', 'current_price': '118496.7000000000'}], 'margin_call': True}
2025-07-22 03:21:58,082 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.654015247733558826402902662
2025-07-22 03:21:58,093 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:21:58,126 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:21:58,126 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:21:58,335 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:58,336 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:58,361 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:58,361 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:58,367 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:58,367 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:58,369 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:58,372 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:58,380 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:58,385 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:58,395 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:58,396 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:58,396 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:58,396 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:58,403 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:58,403 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:58,404 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:58,404 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:58,438 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:21:58,449 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:21:58,459 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:21:58,459 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:21:58,746 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.58551947520443634741621416% which is below threshold 100.0%
2025-07-22 03:21:58,746 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '99002.29000000000000000000000', 'margin': '146484.47', 'free_margin': '-47482.18000000000000000000000', 'profit_loss': '-85343.52000000000000000000000', 'margin_level': '67.58551947520443634741621416', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-110.7000000000000000000000000', 'current_price': '38.8860000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85232.82000000000000000000000', 'current_price': '118496.7000000000'}], 'margin_call': True}
2025-07-22 03:21:58,749 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.58551947520443634741621416
2025-07-22 03:21:58,750 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:21:58,750 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:21:58,767 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:58,768 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:21:58,780 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:58,780 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:21:58,800 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:58,800 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:21:58,801 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:21:58,801 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:21:58,807 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:21:58,809 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:21:58,809 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:21:58,824 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:21:58,825 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:21:58,825 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:21:58,825 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:21:58,826 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:21:58,826 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:21:58,998 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:21:58,999 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:22:00,116 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:22:00,122 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:22:00,123 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:22:00,123 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:22:00,209 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:22:00,210 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:22:00,592 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:22:00,595 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:22:00,595 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:22:00,595 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:22:00,656 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:22:00,657 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:22:01,002 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:22:01,006 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:22:01,006 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:22:01,006 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:22:01,028 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:01,028 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:22:01,047 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:10,891 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:22:10,893 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:22:10,895 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:22:10,898 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:22:10,900 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:22:10,901 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:22:10,905 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:22:10,906 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:22:10,908 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:22:10,910 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:22:10,912 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:22:10,913 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:22:10,914 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:22:10,915 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:22:10,917 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:22:10,918 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:22:10,919 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:22:10,921 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:22:10,921 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:22:10,922 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:22:10,924 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:22:10,925 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:22:10,926 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:22:10,926 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:22:31,059 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:22:31,059 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:22:31,059 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:22:31,060 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:22:31,069 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:22:31,069 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:22:31,070 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:22:31,077 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:22:31,078 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:22:31,094 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:22:31,098 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:22:31,098 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:22:31,272 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:22:31,623 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:22:31,626 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:22:31,630 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:22:31,633 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:22:31,633 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.349385'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.349385'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.349225'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.349225'}], 'margin_call': False}
2025-07-22 03:22:31,636 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:22:31,637 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:22:31,638 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:22:31,683 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:31,684 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:22:31,759 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:31,759 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:22:31,826 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:31,826 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:22:32,026 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:22:32,351 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.172279193760198641318617816% which is below threshold 100.0%
2025-07-22 03:22:32,351 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '206.246396367803931940403773', 'margin': '9494.47', 'free_margin': '-9288.223603632196068059596227', 'profit_loss': '-9695.773603632196068059596227', 'margin_level': '2.172279193760198641318617816', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9620.002000000000000000000000', 'current_price': '118447.42'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-68.88327602926915278145111523', 'current_price': '96.096'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.888327602926915278145111523', 'current_price': '96.096'}], 'margin_call': True}
2025-07-22 03:22:32,352 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.172279193760198641318617816
2025-07-22 03:22:32,390 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:22:32,390 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:22:32,449 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:32,449 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:22:32,493 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:32,493 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:22:32,555 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:32,555 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:22:32,637 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:32,637 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:22:32,671 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:32,671 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:22:32,685 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:32,685 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:22:32,699 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:32,699 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:22:32,713 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:32,713 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:22:32,771 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:22:33,071 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.571005050011622775249215884% which is below threshold 100.0%
2025-07-22 03:22:33,071 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '211.997000000000000000000000', 'margin': '5936.62', 'free_margin': '-5724.623000000000000000000000', 'profit_loss': '-6177.623000000000000000000000', 'margin_level': '3.571005050011622775249215884', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6177.623000000000000000000000', 'current_price': '118447.42'}], 'margin_call': True}
2025-07-22 03:22:33,074 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.571005050011622775249215884
2025-07-22 03:22:33,118 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:22:33,119 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:22:33,195 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:22:33,497 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.38320792641021928809245103% which is below threshold 100.0%
2025-07-22 03:22:33,498 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98705.93499999999975000000000', 'margin': '146484.47', 'free_margin': '-47778.53500000000025000000000', 'profit_loss': '-85639.87500000000025000000000', 'margin_level': '67.38320792641021928809245103', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.3750000000002500000000000', 'current_price': '38.872499999999995'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85528.50000000000000000000000', 'current_price': '118447.42'}], 'margin_call': True}
2025-07-22 03:22:33,502 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.38320792641021928809245103
2025-07-22 03:22:33,504 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:22:33,504 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:22:33,539 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:33,539 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:22:33,572 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:33,572 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:22:33,607 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:33,607 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:22:33,608 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:22:33,609 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:22:33,620 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:22:33,622 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:22:33,623 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:22:33,672 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:33,672 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:22:33,674 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:22:33,674 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:22:33,676 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:22:33,676 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:22:33,777 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:22:33,778 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:22:34,085 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:22:34,086 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:22:34,087 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:22:34,087 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:22:34,137 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:22:34,137 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:22:34,437 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:22:34,441 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:22:34,441 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:22:34,442 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:22:34,511 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:22:34,512 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:22:34,830 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:22:34,832 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:22:34,832 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:22:34,832 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:22:34,889 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:34,889 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:22:34,924 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:22:54,046 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:22:54,350 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:23:04,935 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:23:04,935 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:23:04,935 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:23:04,936 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:23:04,950 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:23:04,951 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:23:04,951 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:23:04,961 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:23:04,961 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:23:04,987 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:23:04,991 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:23:04,991 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:23:05,196 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:23:05,541 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:23:05,545 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:23:05,552 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:23:05,558 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:23:05,558 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.349345'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.349345'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3491849999999999'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3491849999999999'}], 'margin_call': False}
2025-07-22 03:23:05,570 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:23:05,572 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:23:05,572 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:23:05,613 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:05,613 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:23:05,646 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:05,646 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:23:05,679 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:05,680 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:23:05,785 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:23:06,132 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.256740329345669942894539611% which is below threshold 100.0%
2025-07-22 03:23:06,132 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '214.265533547625829027139195', 'margin': '9494.47', 'free_margin': '-9280.204466452374170972860805', 'profit_loss': '-9687.754466452374170972860805', 'margin_level': '2.256740329345669942894539611', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9611.686000000000000000000000', 'current_price': '118468.21'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-69.15315132034015542987345893', 'current_price': '96.092'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.915315132034015542987345893', 'current_price': '96.092'}], 'margin_call': True}
2025-07-22 03:23:06,135 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.256740329345669942894539611
2025-07-22 03:23:06,187 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:23:06,187 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:23:06,232 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:06,233 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:23:06,292 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:06,292 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:23:06,336 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:06,336 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:23:06,382 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:06,382 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:23:06,425 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:06,426 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:23:06,478 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:06,478 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:23:06,534 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:06,535 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:23:06,587 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:06,587 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:23:06,801 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:23:07,153 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.606024977175564546829677493% which is below threshold 100.0%
2025-07-22 03:23:07,153 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '214.076000000000000000000000', 'margin': '5936.62', 'free_margin': '-5722.544000000000000000000000', 'profit_loss': '-6175.544000000000000000000000', 'margin_level': '3.606024977175564546829677493', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6175.544000000000000000000000', 'current_price': '118468.21'}], 'margin_call': True}
2025-07-22 03:23:07,155 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.606024977175564546829677493
2025-07-22 03:23:07,212 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:23:07,213 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:23:07,386 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:23:07,388 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 26, falling back to DB and updating cache.
2025-07-22 03:23:07,765 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '0.0', 'equity': '-85514.83500000000025000000000', 'margin': '0.0', 'free_margin': '-85514.83500000000025000000000', 'profit_loss': '-85514.83500000000025000000000', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-111.0750000000002500000000000', 'current_price': '38.878499999999995'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85403.76000000000000000000000', 'current_price': '118468.21'}], 'margin_call': False}
2025-07-22 03:23:07,768 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 0.0
2025-07-22 03:23:07,768 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:23:07,768 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:23:07,796 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:07,796 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:23:07,812 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:07,812 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:23:07,848 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:07,848 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:23:07,852 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:23:07,852 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:23:07,863 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:23:07,864 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:23:07,865 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:23:07,954 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:07,954 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:23:07,955 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:23:07,956 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:23:07,957 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:23:07,957 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:23:08,090 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:23:08,091 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:23:08,095 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:23:08,483 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:23:08,485 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:23:08,486 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:23:08,486 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:23:08,605 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:23:08,606 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:23:08,610 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:23:08,993 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:23:08,996 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:23:08,996 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:23:08,997 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:23:09,100 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:23:09,101 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:23:09,105 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:23:09,412 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:23:09,413 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:23:09,414 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:23:09,414 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:23:09,445 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:09,446 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:23:09,474 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:39,485 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:23:39,486 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:23:39,486 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:23:39,486 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:23:39,500 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:23:39,501 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:23:39,501 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:23:39,510 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:23:39,511 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:23:39,531 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:23:39,534 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:23:39,535 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:23:39,725 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:23:39,726 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:23:40,127 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:23:40,131 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:23:40,134 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:23:40,136 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:23:40,136 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3493650000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3493650000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.349205'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.349205'}], 'margin_call': False}
2025-07-22 03:23:40,140 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:23:40,141 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:23:40,141 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:23:40,185 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:40,185 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:23:40,247 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:40,247 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:23:40,302 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:40,302 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:23:40,398 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:23:41,065 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.171033538508004124067515691% which is below threshold 100.0%
2025-07-22 03:23:41,066 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '206.128128003580899158353057', 'margin': '9494.47', 'free_margin': '-9288.341871996419100841646943', 'profit_loss': '-9695.891871996419100841646943', 'margin_level': '2.171033538508004124067515691', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9619.966000000000000000000000', 'current_price': '118447.51'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-69.02351999674463712876994758', 'current_price': '96.094'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.902351999674463712876994758', 'current_price': '96.094'}], 'margin_call': True}
2025-07-22 03:23:41,070 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.171033538508004124067515691
2025-07-22 03:23:41,117 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:23:41,117 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:23:41,150 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:41,150 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:23:41,181 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:41,181 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:23:41,211 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:41,211 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:23:41,240 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:41,240 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:23:41,270 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:41,270 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:23:41,292 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:41,292 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:23:41,307 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:41,307 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:23:41,339 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:41,340 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:23:41,461 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:23:41,865 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.571156651427916895472507925% which is below threshold 100.0%
2025-07-22 03:23:41,866 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '212.006000000000000000000000', 'margin': '5936.62', 'free_margin': '-5724.614000000000000000000000', 'profit_loss': '-6177.614000000000000000000000', 'margin_level': '3.571156651427916895472507925', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6177.614000000000000000000000', 'current_price': '118447.51'}], 'margin_call': True}
2025-07-22 03:23:41,869 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.571156651427916895472507925
2025-07-22 03:23:41,899 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:23:41,900 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:23:41,952 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:23:41,953 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 26, falling back to DB and updating cache.
2025-07-22 03:23:42,275 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '0.0', 'equity': '-85638.41000000000000000000000', 'margin': '0.0', 'free_margin': '-85638.41000000000000000000000', 'profit_loss': '-85638.41000000000000000000000', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-110.4500000000000000000000000', 'current_price': '38.8910000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85527.96000000000000000000000', 'current_price': '118447.51'}], 'margin_call': False}
2025-07-22 03:23:42,279 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 0.0
2025-07-22 03:23:42,279 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:23:42,280 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:23:42,315 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:42,315 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:23:42,333 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:42,333 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:23:42,350 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:42,350 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:23:42,350 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:23:42,350 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:23:42,354 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:23:42,356 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:23:42,356 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:23:42,371 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:42,371 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:23:42,372 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:23:42,372 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:23:42,374 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:23:42,374 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:23:42,422 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:23:42,423 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:23:42,425 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:23:42,762 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:23:42,765 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:23:42,765 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:23:42,765 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:23:42,870 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:23:42,871 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:23:42,878 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:23:43,301 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:23:43,305 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:23:43,306 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:23:43,306 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:23:43,449 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:23:43,449 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:23:43,454 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:23:43,816 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:23:43,820 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:23:43,820 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:23:43,821 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:23:43,864 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:43,864 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:23:43,900 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:23:54,056 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:23:54,362 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:23:58,198 - INFO - app - Application shutdown initiated
2025-07-22 03:23:58,200 - INFO - app - Scheduler shutdown completed
2025-07-22 03:23:58,205 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 03:23:58,975 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 03:23:58,975 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 03:23:58,985 - INFO - app - Redis connection closed
2025-07-22 03:23:58,985 - INFO - app - Application shutdown completed
2025-07-22 03:28:31,417 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:28:31,465 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:28:31,483 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:28:31,483 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:28:32,081 - INFO - app - Application starting up - Trading system initialized
2025-07-22 03:28:32,081 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 03:28:32,081 - INFO - app - Environment: PRODUCTION
2025-07-22 03:28:32,152 - INFO - app - Application startup initiated
2025-07-22 03:28:32,152 - INFO - app - Initializing core services...
2025-07-22 03:28:32,187 - INFO - app - Firebase initialized
2025-07-22 03:28:32,187 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 03:28:32,208 - INFO - app - Redis initialized
2025-07-22 03:28:33,441 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 03:28:33,444 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 03:28:33,446 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 03:28:33,447 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 03:28:33,447 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 03:28:33,447 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 03:28:33,447 - INFO - app - Scheduler initialized
2025-07-22 03:28:33,449 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:28:33,449 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 03:28:34,742 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:28:34,749 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:28:34,845 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 03:28:34,845 - INFO - app - Background tasks initialized
2025-07-22 03:28:34,845 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:28:35,541 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:28:35,542 - INFO - app - Application startup completed successfully
2025-07-22 03:28:35,542 - INFO - app - Starting cache validation task
2025-07-22 03:28:35,545 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 03:28:35,549 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 03:28:35,551 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 03:28:35,551 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:28:35,551 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:28:35,551 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:28:35,551 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:28:35,558 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:28:35,571 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:28:35,571 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:28:35,571 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:28:35,572 - INFO - app - Validating cache for 30 users
2025-07-22 03:28:35,573 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:28:35,583 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,589 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:28:35,589 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:28:35,593 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:28:35,595 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:28:35,604 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:28:35,605 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,607 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:28:35,608 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:28:35,612 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:28:35,613 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:28:35,615 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:28:35,615 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:28:35,616 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:28:35,618 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:28:35,619 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:28:35,619 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:28:35,619 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:28:35,619 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,620 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:28:35,621 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:28:35,624 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:28:35,625 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:28:35,626 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:28:35,627 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:28:35,629 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:28:35,630 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:28:35,632 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:28:35,632 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:28:35,633 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,647 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,656 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,670 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,681 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,691 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,703 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,714 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,726 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,761 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,781 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,799 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,813 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,827 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,839 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,861 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,875 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 03:28:35,883 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:28:36,217 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 03:28:36,222 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:28:36,225 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:28:36,227 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:28:36,229 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:28:36,229 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3492900000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3492900000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3492800000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3492800000'}], 'margin_call': False}
2025-07-22 03:28:36,230 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 03:28:36,231 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:28:36,232 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:28:36,232 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:28:36,243 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 03:28:36,267 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:36,267 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:28:36,267 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 03:28:36,280 - INFO - app - Cache validation completed
2025-07-22 03:28:36,298 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:36,298 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:28:36,334 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:36,334 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:28:36,521 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:28:36,873 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.381455344966785879648767693% which is below threshold 100.0%
2025-07-22 03:28:36,874 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '226.106563291267995307488354', 'margin': '9494.47', 'free_margin': '-9268.363436708732004692511646', 'profit_loss': '-9675.913436708732004692511646', 'margin_level': '2.381455344966785879648767693', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9601.042000000000000000000000', 'current_price': '118494.8200000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-68.06494246248364062955604229', 'current_price': '96.1080000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.806494246248364062955604229', 'current_price': '96.1080000000'}], 'margin_call': True}
2025-07-22 03:28:36,877 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.381455344966785879648767693
2025-07-22 03:28:36,907 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:28:36,907 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:28:36,931 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:36,931 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:28:36,955 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:36,955 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:28:36,980 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:36,980 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:28:37,009 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:37,009 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:28:37,037 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:37,037 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:28:37,061 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:37,061 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:28:37,087 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:37,087 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:28:37,121 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:37,121 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:28:37,320 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:28:37,328 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:28:37,334 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:28:37,386 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:28:37,389 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:28:37,390 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:28:37,400 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:28:37,718 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:28:37,737 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:28:37,747 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:28:37,752 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:28:37,766 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:28:37,782 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:28:37,790 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:28:37,791 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:28:37,795 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.650848462593192759516357793% which is below threshold 100.0%
2025-07-22 03:28:37,796 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '216.737000000000000000000000', 'margin': '5936.62', 'free_margin': '-5719.883000000000000000000000', 'profit_loss': '-6172.883000000000000000000000', 'margin_level': '3.650848462593192759516357793', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6172.883000000000000000000000', 'current_price': '118494.8200000000'}], 'margin_call': True}
2025-07-22 03:28:37,797 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:28:37,801 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.650848462593192759516357793
2025-07-22 03:28:37,814 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:28:37,814 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:28:37,820 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:28:37,820 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:28:37,826 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:28:37,827 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:28:37,828 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:28:37,844 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:28:37,844 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:28:37,845 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:28:37,845 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:28:37,845 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:28:37,858 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:28:37,858 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:28:37,930 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:28:38,306 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.59195019103390277481292044% which is below threshold 100.0%
2025-07-22 03:28:38,307 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '99011.71000000000000000000000', 'margin': '146484.47', 'free_margin': '-47472.76000000000000000000000', 'profit_loss': '-85334.10000000000000000000000', 'margin_level': '67.59195019103390277481292044', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-110.4000000000000000000000000', 'current_price': '38.8920000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85223.70000000000000000000000', 'current_price': '118498.2200000000'}], 'margin_call': True}
2025-07-22 03:28:38,311 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.59195019103390277481292044
2025-07-22 03:28:38,314 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:28:38,315 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:28:38,336 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:38,337 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:28:38,350 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:38,350 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:28:38,367 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:38,367 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:28:38,368 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:28:38,368 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:28:38,372 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:28:38,373 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:28:38,373 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:28:38,387 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:38,387 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:28:38,388 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:28:38,388 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:28:38,388 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:28:38,388 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:28:38,455 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:28:38,456 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:28:38,921 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:28:38,928 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:28:38,930 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:28:38,930 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:28:38,990 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:28:38,990 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:28:39,330 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:28:39,333 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:28:39,333 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:28:39,333 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:28:39,405 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:28:39,406 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:28:39,706 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:28:39,709 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:28:39,709 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:28:39,709 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:28:39,732 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:39,732 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:28:39,749 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:28:50,550 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:28:50,553 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:28:50,556 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:28:50,558 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:28:50,560 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:28:50,562 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:28:50,565 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:28:50,567 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:28:50,571 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:28:50,572 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:28:50,575 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:28:50,577 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:28:50,579 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:28:50,580 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:28:50,582 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:28:50,584 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:28:50,586 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:28:50,587 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:28:50,588 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:28:50,589 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:28:50,590 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:28:50,591 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:28:50,592 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:28:50,592 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:29:09,757 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:29:09,758 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:29:09,758 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:29:09,758 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:29:09,763 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:29:09,763 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:29:09,763 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:29:09,766 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:29:09,766 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:29:09,773 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:29:09,774 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:29:09,774 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:29:09,843 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:29:10,270 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:29:10,277 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:29:10,288 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:29:10,293 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:29:10,293 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.349185'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.349185'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.349025'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.349025'}], 'margin_call': False}
2025-07-22 03:29:10,296 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:29:10,298 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:29:10,298 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:29:10,344 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:10,344 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:29:10,387 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:10,388 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:29:10,427 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:10,427 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:29:10,586 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:29:10,978 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.160011950545364239054182614% which is below threshold 100.0%
2025-07-22 03:29:10,978 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '205.081686640944444067727652', 'margin': '9494.47', 'free_margin': '-9289.388313359055555932272348', 'profit_loss': '-9696.938313359055555932272348', 'margin_level': '2.160011950545364239054182614', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9619.682000000000000000000000', 'current_price': '118448.22'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-70.23301214459595993842940742', 'current_price': '96.076'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-7.023301214459595993842940742', 'current_price': '96.076'}], 'margin_call': True}
2025-07-22 03:29:10,981 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.160011950545364239054182614
2025-07-22 03:29:11,027 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:29:11,028 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:29:11,073 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:11,073 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:29:11,114 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:11,115 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:29:11,165 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:11,165 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:29:11,212 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:11,212 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:29:11,252 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:11,252 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:29:11,296 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:11,296 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:29:11,339 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:11,339 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:29:11,381 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:11,381 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:29:11,506 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:29:11,897 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.572352618156459399456256254% which is below threshold 100.0%
2025-07-22 03:29:11,897 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '212.077000000000000000000000', 'margin': '5936.62', 'free_margin': '-5724.543000000000000000000000', 'profit_loss': '-6177.543000000000000000000000', 'margin_level': '3.572352618156459399456256254', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6177.543000000000000000000000', 'current_price': '118448.22'}], 'margin_call': True}
2025-07-22 03:29:11,905 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.572352618156459399456256254
2025-07-22 03:29:11,960 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:29:11,960 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:29:12,231 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:29:12,608 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.38682605739707424275078443% which is below threshold 100.0%
2025-07-22 03:29:12,608 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98711.23500000000000000000000', 'margin': '146484.47', 'free_margin': '-47773.23500000000000000000000', 'profit_loss': '-85634.57500000000000000000000', 'margin_level': '67.38682605739707424275078443', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-110.875000000000000000000000', 'current_price': '38.8825'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85523.70000000000000000000000', 'current_price': '118448.22'}], 'margin_call': True}
2025-07-22 03:29:12,609 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.38682605739707424275078443
2025-07-22 03:29:12,610 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:29:12,611 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:29:12,636 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:12,636 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:29:12,657 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:12,657 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:29:12,682 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:12,682 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:29:12,683 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:29:12,683 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:29:12,696 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:29:12,698 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:29:12,698 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:29:12,721 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:12,721 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:29:12,721 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:29:12,721 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:29:12,722 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:29:12,722 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:29:12,801 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:29:12,802 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:29:13,120 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:29:13,121 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:29:13,122 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:29:13,122 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:29:13,209 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:29:13,210 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:29:13,636 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:29:13,638 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:29:13,638 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:29:13,638 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:29:13,773 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:29:13,774 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:29:14,098 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:29:14,100 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:29:14,101 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:29:14,101 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:29:14,137 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:14,137 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:29:14,161 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:33,450 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:29:33,753 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:29:44,177 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:29:44,178 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:29:44,178 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:29:44,178 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:29:44,190 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:29:44,191 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:29:44,191 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:29:44,197 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:29:44,198 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:29:44,211 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:29:44,213 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:29:44,213 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:29:44,275 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:29:44,603 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:29:44,628 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:29:44,637 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:29:44,643 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:29:44,643 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.349215'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.349215'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.349055'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.349055'}], 'margin_call': False}
2025-07-22 03:29:44,649 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:29:44,652 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:29:44,652 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:29:44,691 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:44,691 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:29:44,707 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:44,708 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:29:44,735 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:44,735 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:29:44,837 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:29:45,184 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.148359278073876552917890130% which is below threshold 100.0%
2025-07-22 03:29:45,185 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '203.975327148940787153823203', 'margin': '9494.47', 'free_margin': '-9290.494672851059212846176797', 'profit_loss': '-9698.044672851059212846176797', 'margin_level': '2.148359278073876552917890130', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9620.562000000000000000000000', 'current_price': '118446.02'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-70.43879350096292076925163425', 'current_price': '96.073'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-7.043879350096292076925163425', 'current_price': '96.073'}], 'margin_call': True}
2025-07-22 03:29:45,188 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.148359278073876552917890130
2025-07-22 03:29:45,216 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:29:45,216 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:29:45,246 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:45,247 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:29:45,277 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:45,277 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:29:45,319 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:45,319 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:29:45,337 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:45,337 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:29:45,358 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:45,358 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:29:45,376 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:45,376 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:29:45,412 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:45,412 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:29:45,444 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:45,444 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:29:45,592 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:29:45,994 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.582307777826439960785766985% which is below threshold 100.0%
2025-07-22 03:29:45,994 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '212.668000000000000000000000', 'margin': '5936.62', 'free_margin': '-5723.952000000000000000000000', 'profit_loss': '-6176.952000000000000000000000', 'margin_level': '3.582307777826439960785766985', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6176.952000000000000000000000', 'current_price': '118454.13'}], 'margin_call': True}
2025-07-22 03:29:45,999 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.582307777826439960785766985
2025-07-22 03:29:46,052 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:29:46,052 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:29:46,205 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:29:46,608 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.41106753500900129549569316% which is below threshold 100.0%
2025-07-22 03:29:46,609 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98746.74500000000000000000000', 'margin': '146484.47', 'free_margin': '-47737.72500000000000000000000', 'profit_loss': '-85599.06500000000000000000000', 'margin_level': '67.41106753500900129549569316', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-110.825000000000000000000000', 'current_price': '38.8835'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85488.24000000000000000000000', 'current_price': '118454.13'}], 'margin_call': True}
2025-07-22 03:29:46,617 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.41106753500900129549569316
2025-07-22 03:29:46,620 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:29:46,622 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:29:46,695 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:46,696 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:29:46,760 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:46,761 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:29:46,992 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:46,992 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:29:47,012 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:29:47,013 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:29:47,084 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:29:47,088 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:29:47,088 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:29:47,127 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:47,127 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:29:47,128 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:29:47,128 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:29:47,129 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:29:47,129 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:29:47,225 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:29:47,226 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:29:47,630 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:29:47,633 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:29:47,636 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:29:47,636 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:29:47,734 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:29:47,735 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:29:48,101 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:29:48,107 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:29:48,107 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:29:48,108 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:29:48,174 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:29:48,175 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:29:48,529 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:29:48,533 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:29:48,533 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:29:48,533 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:29:48,593 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:29:48,593 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:29:48,667 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:18,685 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:30:18,685 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:30:18,686 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:30:18,686 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:30:18,700 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:30:18,700 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:30:18,701 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:30:18,710 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:30:18,710 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:30:18,738 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:30:18,743 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:30:18,743 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:30:18,887 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:30:19,279 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:30:19,316 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:30:19,330 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:30:19,344 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:30:19,345 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3492250000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3492250000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.349065'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.349065'}], 'margin_call': False}
2025-07-22 03:30:19,347 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:30:19,349 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:30:19,349 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:30:19,381 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:19,381 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:30:19,417 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:19,417 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:30:19,450 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:19,450 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:30:19,551 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:30:19,851 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.206571063316008617538135862% which is below threshold 100.0%
2025-07-22 03:30:19,851 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '209.502227635219443389573048', 'margin': '9494.47', 'free_margin': '-9284.967772364780556610426952', 'profit_loss': '-9692.517772364780556610426952', 'margin_level': '2.206571063316008617538135862', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9615.406000000000000000000000', 'current_price': '118458.91'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-70.10161124070959691856995606', 'current_price': '96.078'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-7.010161124070959691856995606', 'current_price': '96.078'}], 'margin_call': True}
2025-07-22 03:30:19,853 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.206571063316008617538135862
2025-07-22 03:30:19,906 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:30:19,906 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:30:19,958 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:19,958 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:30:20,003 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:20,003 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:30:20,042 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:20,042 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:30:20,075 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:20,075 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:30:20,105 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:20,105 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:30:20,154 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:20,154 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:30:20,191 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:20,191 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:30:20,233 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:20,234 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:30:20,374 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:30:20,743 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.590359497491838790422833195% which is below threshold 100.0%
2025-07-22 03:30:20,743 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '213.146000000000000000000000', 'margin': '5936.62', 'free_margin': '-5723.474000000000000000000000', 'profit_loss': '-6176.474000000000000000000000', 'margin_level': '3.590359497491838790422833195', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6176.474000000000000000000000', 'current_price': '118458.91'}], 'margin_call': True}
2025-07-22 03:30:20,745 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.590359497491838790422833195
2025-07-22 03:30:20,778 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:30:20,779 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:30:20,931 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:30:21,319 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.43054400237786299120992143% which is below threshold 100.0%
2025-07-22 03:30:21,319 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98775.27500000000000000000000', 'margin': '146484.47', 'free_margin': '-47709.19500000000000000000000', 'profit_loss': '-85570.53500000000000000000000', 'margin_level': '67.43054400237786299120992143', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-110.975000000000000000000000', 'current_price': '38.8805'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85459.56000000000000000000000', 'current_price': '118458.91'}], 'margin_call': True}
2025-07-22 03:30:21,322 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.43054400237786299120992143
2025-07-22 03:30:21,324 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:30:21,324 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:30:21,372 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:21,373 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:30:21,447 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:21,448 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:30:21,512 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:21,512 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:30:21,513 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:30:21,513 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:30:21,577 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:30:21,585 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:30:21,585 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:30:21,622 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:21,622 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:30:21,623 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:30:21,624 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:30:21,624 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:30:21,625 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:30:21,737 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:30:21,738 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:30:22,032 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:30:22,038 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:30:22,041 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:30:22,042 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:30:22,164 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:30:22,166 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:30:22,704 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:30:22,707 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:30:22,708 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:30:22,708 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:30:22,876 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:30:22,877 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:30:23,194 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:30:23,197 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:30:23,197 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:30:23,197 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:30:23,246 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:23,246 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:30:23,287 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:31,793 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 30
2025-07-22 03:30:31,798 - INFO - app.api.v1.endpoints.users - Refresh token validated successfully for user ID: 30
2025-07-22 03:30:31,814 - INFO - app.api.v1.endpoints.users - New access and refresh tokens generated for user ID 30 using refresh token.
2025-07-22 03:30:31,953 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 30
2025-07-22 03:30:31,957 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 30
2025-07-22 03:30:31,958 - INFO - app.api.v1.endpoints.users - Refresh token validated successfully for user ID: 30
2025-07-22 03:30:31,965 - INFO - app.api.v1.endpoints.users - Refresh token validated successfully for user ID: 30
2025-07-22 03:30:31,974 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 30
2025-07-22 03:30:31,978 - INFO - app.api.v1.endpoints.users - Refresh token validated successfully for user ID: 30
2025-07-22 03:30:31,986 - INFO - app.api.v1.endpoints.users - New access and refresh tokens generated for user ID 30 using refresh token.
2025-07-22 03:30:31,993 - INFO - app.api.v1.endpoints.users - New access and refresh tokens generated for user ID 30 using refresh token.
2025-07-22 03:30:31,995 - INFO - app.api.v1.endpoints.users - New access and refresh tokens generated for user ID 30 using refresh token.
2025-07-22 03:30:32,623 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 0 symbols for user 30
2025-07-22 03:30:32,623 - INFO - app.api.v1.endpoints.favorites - Symbols: []
2025-07-22 03:30:33,449 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:30:33,741 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:30:41,090 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 30 by invalidating refresh token.
2025-07-22 03:30:50,817 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 0 symbols for user 25
2025-07-22 03:30:50,817 - INFO - app.api.v1.endpoints.favorites - Symbols: []
2025-07-22 03:30:53,291 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:30:53,292 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:30:53,292 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:30:53,292 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:30:53,302 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:30:53,302 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:30:53,303 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:30:53,310 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:30:53,310 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:30:53,327 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:30:53,331 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:30:53,331 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:30:53,512 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:30:53,891 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:30:53,895 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:30:53,899 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:30:53,903 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:30:53,904 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.349235'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.349235'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.349075'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.349075'}], 'margin_call': False}
2025-07-22 03:30:53,907 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:30:53,909 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:30:53,910 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:30:53,963 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:53,963 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:30:53,995 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:53,995 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:30:54,020 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,020 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:30:54,183 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:30:54,489 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.250792536208083200295235163% which is below threshold 100.0%
2025-07-22 03:30:54,489 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '213.700822112515597027071014', 'margin': '9494.47', 'free_margin': '-9280.769177887484402972928986', 'profit_loss': '-9688.319177887484402972928986', 'margin_level': '2.250792536208083200295235163', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9611.282000000000000000000000', 'current_price': '118469.22'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-70.03379807953127542993544187', 'current_price': '96.079'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-7.003379807953127542993544187', 'current_price': '96.079'}], 'margin_call': True}
2025-07-22 03:30:54,493 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.250792536208083200295235163
2025-07-22 03:30:54,612 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:30:54,612 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:30:54,647 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,647 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:30:54,691 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,691 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:30:54,735 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,736 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:30:54,778 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,778 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:30:54,810 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,810 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:30:54,842 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,843 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:30:54,880 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,880 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:30:54,912 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:54,912 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:30:55,041 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:30:55,336 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.607726281958420784891065960% which is below threshold 100.0%
2025-07-22 03:30:55,336 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '214.177000000000000000000000', 'margin': '5936.62', 'free_margin': '-5722.443000000000000000000000', 'profit_loss': '-6175.443000000000000000000000', 'margin_level': '3.607726281958420784891065960', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'swap': 'None', 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6175.443000000000000000000000', 'current_price': '118469.22'}], 'margin_call': True}
2025-07-22 03:30:55,339 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.607726281958420784891065960
2025-07-22 03:30:55,378 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:30:55,378 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:30:55,545 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:30:55,841 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.47147666916499728606042675% which is below threshold 100.0%
2025-07-22 03:30:55,841 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98835.23499999999970000000000', 'margin': '146484.47', 'free_margin': '-47649.23500000000030000000000', 'profit_loss': '-85510.57500000000030000000000', 'margin_level': '67.47147666916499728606042675', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.8750000000003000000000000', 'current_price': '38.842499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85397.70000000000000000000000', 'current_price': '118469.22'}], 'margin_call': True}
2025-07-22 03:30:55,846 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.47147666916499728606042675
2025-07-22 03:30:55,849 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:30:55,849 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:30:55,871 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:55,871 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:30:55,907 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:55,907 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:30:55,945 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:55,945 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:30:55,948 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:30:55,948 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:30:55,967 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:30:55,969 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:30:55,969 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:30:56,011 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:56,011 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:30:56,013 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:30:56,013 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:30:56,014 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:30:56,014 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:30:56,136 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:30:56,137 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:30:56,456 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:30:56,459 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:30:56,462 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:30:56,462 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:30:56,591 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:30:56,592 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:30:56,891 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:30:56,894 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:30:56,895 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:30:56,895 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:30:57,043 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:30:57,044 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:30:57,358 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:30:57,359 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:30:57,359 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:30:57,359 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:30:57,388 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:30:57,388 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:30:57,419 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:27,436 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:31:27,436 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:31:27,437 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:31:27,437 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:31:27,445 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:31:27,446 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:31:27,446 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:31:27,454 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:31:27,454 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:31:27,475 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:31:27,479 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:31:27,480 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:31:27,631 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:31:27,983 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:31:27,988 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:31:27,990 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:31:27,991 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:31:27,992 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.349215'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.349215'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.349055'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.349055'}], 'margin_call': False}
2025-07-22 03:31:27,994 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:31:27,995 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:31:27,996 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:31:28,037 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,037 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:31:28,085 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,085 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:31:28,133 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,133 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:31:28,275 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:31:28,600 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.145383808812030550700260404% which is below threshold 100.0%
2025-07-22 03:31:28,601 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '203.692822112515597027071014', 'margin': '9494.47', 'free_margin': '-9290.777177887484402972928986', 'profit_loss': '-9698.327177887484402972928986', 'margin_level': '2.145383808812030550700260404', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9621.290000000000000000000000', 'current_price': '118444.2'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-70.03379807953127542993544187', 'current_price': '96.079'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-7.003379807953127542993544187', 'current_price': '96.079'}], 'margin_call': True}
2025-07-22 03:31:28,603 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.145383808812030550700260404
2025-07-22 03:31:28,663 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:31:28,663 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:31:28,734 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,734 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:31:28,779 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,779 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:31:28,827 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,827 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:31:28,868 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,868 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:31:28,906 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,907 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:31:28,940 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,940 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:31:28,977 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:28,977 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:31:29,021 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:29,022 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:31:29,125 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:31:29,438 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.565581088228655362815878395% which is below threshold 100.0%
2025-07-22 03:31:29,439 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '211.675000000000000000000000', 'margin': '5936.62', 'free_margin': '-5724.945000000000000000000000', 'profit_loss': '-6177.945000000000000000000000', 'margin_level': '3.565581088228655362815878395', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6177.945000000000000000000000', 'current_price': '118444.2'}], 'margin_call': True}
2025-07-22 03:31:29,447 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.565581088228655362815878395
2025-07-22 03:31:29,506 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:31:29,507 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:31:29,638 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:31:30,029 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.36896068231669869167700849% which is below threshold 100.0%
2025-07-22 03:31:30,030 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98685.06499999999980000000000', 'margin': '146484.47', 'free_margin': '-47799.40500000000020000000000', 'profit_loss': '-85660.74500000000020000000000', 'margin_level': '67.36896068231669869167700849', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.9250000000002000000000000', 'current_price': '38.841499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85547.82000000000000000000000', 'current_price': '118444.2'}], 'margin_call': True}
2025-07-22 03:31:30,034 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.36896068231669869167700849
2025-07-22 03:31:30,035 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:31:30,035 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:31:30,068 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:30,068 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:31:30,103 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:30,103 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:31:30,144 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:30,145 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:31:30,148 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:31:30,148 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:31:30,177 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:31:30,179 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:31:30,179 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:31:30,219 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:30,219 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:31:30,220 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:31:30,221 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:31:30,222 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:31:30,222 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:31:30,335 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:31:30,339 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:31:30,633 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:31:30,636 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:31:30,638 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:31:30,638 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:31:30,769 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:31:30,770 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:31:31,136 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:31:31,142 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:31:31,142 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:31:31,142 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:31:31,259 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:31:31,260 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:31:31,563 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:31:31,574 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:31:31,574 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:31:31,574 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:31:31,650 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:31,650 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:31:31,683 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:31:33,453 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:31:33,815 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:31:43,748 - INFO - app - Application shutdown initiated
2025-07-22 03:31:43,757 - INFO - app - Scheduler shutdown completed
2025-07-22 03:31:43,824 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 03:31:46,028 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 03:31:46,028 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 03:31:46,041 - INFO - app - Redis connection closed
2025-07-22 03:31:46,042 - INFO - app - Application shutdown completed
2025-07-22 03:40:09,619 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:40:09,663 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:40:09,681 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:40:09,681 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:40:10,079 - INFO - app - Application starting up - Trading system initialized
2025-07-22 03:40:10,079 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 03:40:10,079 - INFO - app - Environment: PRODUCTION
2025-07-22 03:40:10,150 - INFO - app - Application startup initiated
2025-07-22 03:40:10,150 - INFO - app - Initializing core services...
2025-07-22 03:40:10,202 - INFO - app - Firebase initialized
2025-07-22 03:40:10,202 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 03:40:10,234 - INFO - app - Redis initialized
2025-07-22 03:40:10,964 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 03:40:10,968 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 03:40:10,974 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 03:40:10,974 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 03:40:10,974 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 03:40:10,975 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 03:40:10,975 - INFO - app - Scheduler initialized
2025-07-22 03:40:10,977 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:40:10,977 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 03:40:12,264 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:40:12,272 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:40:12,308 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 03:40:12,308 - INFO - app - Background tasks initialized
2025-07-22 03:40:12,308 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:40:13,077 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:40:13,078 - INFO - app - Application startup completed successfully
2025-07-22 03:40:13,078 - INFO - app - Starting cache validation task
2025-07-22 03:40:13,081 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 03:40:13,087 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 03:40:13,089 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 03:40:13,089 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:40:13,089 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:40:13,089 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:40:13,089 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:40:13,119 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:40:13,120 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:40:13,120 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:40:13,120 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:40:13,123 - INFO - app - Validating cache for 30 users
2025-07-22 03:40:13,138 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:40:13,154 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,158 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:40:13,159 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:40:13,166 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:40:13,168 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:40:13,171 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:40:13,177 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,178 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:40:13,186 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:40:13,190 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:40:13,192 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:40:13,194 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:40:13,195 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:40:13,196 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:40:13,197 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:40:13,198 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:40:13,198 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:40:13,198 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:40:13,199 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:40:13,200 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:40:13,200 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,201 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:40:13,202 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:40:13,203 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:40:13,205 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:40:13,209 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:40:13,210 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:40:13,211 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:40:13,211 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:40:13,213 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,223 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,235 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,242 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,252 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,260 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,270 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,276 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,285 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,293 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,300 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,309 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,316 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,325 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,335 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,344 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,391 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,408 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:40:13,411 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,718 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:40:13,720 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:40:13,721 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:40:13,722 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,722 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:40:13,722 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3491500000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3491500000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3491400000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3491400000'}], 'margin_call': False}
2025-07-22 03:40:13,724 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:40:13,726 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:40:13,726 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:40:13,731 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,742 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,748 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:13,748 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:40:13,750 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,764 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 03:40:13,774 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:13,775 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:40:13,780 - INFO - app - Cache validation completed
2025-07-22 03:40:13,803 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:13,803 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:40:14,031 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:40:14,358 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.366476529998692772101292563% which is below threshold 100.0%
2025-07-22 03:40:14,358 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '224.684404197766885639325592', 'margin': '9494.47', 'free_margin': '-9269.785595802233114360674408', 'profit_loss': '-9677.335595802233114360674408', 'margin_level': '2.366476529998692772101292563', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9601.290000000000000000000000', 'current_price': '118494.2000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-69.13235982021192214606764425', 'current_price': '96.0920000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.913235982021192214606764425', 'current_price': '96.0920000000'}], 'margin_call': True}
2025-07-22 03:40:14,360 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.366476529998692772101292563
2025-07-22 03:40:14,389 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:40:14,389 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:40:14,413 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:14,413 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:40:14,438 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:14,438 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:40:14,459 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:14,459 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:40:14,483 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:14,483 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:40:14,507 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:14,507 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:40:14,533 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:14,533 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:40:14,557 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:14,557 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:40:14,581 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:14,581 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:40:14,774 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:40:14,929 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:40:14,933 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:40:14,935 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:40:14,941 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:40:14,947 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:40:14,947 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:40:14,997 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:40:15,061 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.649804097280944375755901506% which is below threshold 100.0%
2025-07-22 03:40:15,061 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '216.675000000000000000000000', 'margin': '5936.62', 'free_margin': '-5719.945000000000000000000000', 'profit_loss': '-6172.945000000000000000000000', 'margin_level': '3.649804097280944375755901506', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6172.945000000000000000000000', 'current_price': '118494.2000000000'}], 'margin_call': True}
2025-07-22 03:40:15,063 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.649804097280944375755901506
2025-07-22 03:40:15,116 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:40:15,116 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:40:15,234 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:40:15,236 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:40:15,246 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:40:15,257 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:40:15,260 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:40:15,262 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:40:15,263 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:40:15,263 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:40:15,263 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:40:15,267 - INFO - app.core.config - .env file loaded successfully.
t: Trading App, API Prefix: /api/v1
2025-07-22 03:40:15,267 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:40:15,274 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:40:15,274 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:40:15,280 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:40:15,280 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:40:15,283 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:40:15,283 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:40:15,305 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:40:15,319 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:40:15,319 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 03:40:15,323 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:40:15,600 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 67.57418721588711759000800563% which is below threshold 100.0%
2025-07-22 03:40:15,600 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '98985.69000000000000000000000', 'margin': '146484.47', 'free_margin': '-47498.78000000000000000000000', 'profit_loss': '-85360.12000000000000000000000', 'margin_level': '67.57418721588711759000800563', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.3000000000000000000000000', 'current_price': '38.8540000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-85247.82000000000000000000000', 'current_price': '118494.2000000000'}], 'margin_call': True}
2025-07-22 03:40:15,610 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 67.57418721588711759000800563
2025-07-22 03:40:15,612 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:40:15,612 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:40:15,634 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:15,634 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:40:15,646 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:15,646 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:40:15,666 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:15,666 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:40:15,667 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:40:15,667 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:40:15,671 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:40:15,672 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:40:15,672 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:40:15,686 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:15,686 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:40:15,686 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:40:15,686 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:40:15,687 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:40:15,687 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:40:15,762 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:40:15,763 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:40:16,183 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:40:16,186 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:40:16,187 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:40:16,187 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:40:16,363 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:40:16,365 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:40:16,664 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:40:16,666 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:40:16,666 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:40:16,666 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:40:16,747 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:40:16,748 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:40:17,037 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:40:17,040 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:40:17,041 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:40:17,041 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:40:17,096 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:17,096 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:40:17,129 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:18,138 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 25 by invalidating refresh token.
2025-07-22 03:40:26,352 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 0 symbols for user 30
2025-07-22 03:40:26,353 - INFO - app.api.v1.endpoints.favorites - Symbols: []
2025-07-22 03:40:28,083 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:40:28,087 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:40:28,091 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:40:28,094 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:40:28,099 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:40:28,104 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:40:28,110 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:40:28,113 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:40:28,120 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:40:28,123 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:40:28,130 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:40:28,134 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:40:28,136 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:40:28,139 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:40:28,143 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:40:28,147 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:40:28,153 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:40:28,157 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:40:28,160 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:40:28,164 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:40:28,169 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:40:28,173 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:40:28,177 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:40:28,177 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:40:47,130 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:40:47,130 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:40:47,131 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:40:47,131 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:40:47,142 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:40:47,142 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:40:47,142 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:40:47,148 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:40:47,149 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:40:47,159 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:40:47,164 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:40:47,164 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:40:47,285 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:40:47,582 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:40:47,584 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:40:47,588 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:40:47,591 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:40:47,591 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.348695'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.348695'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.348535'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.348535'}], 'margin_call': False}
2025-07-22 03:40:47,593 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:40:47,594 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:40:47,595 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:40:47,639 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:47,639 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:40:47,682 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:47,683 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:40:47,716 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:47,717 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:40:47,827 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:40:48,212 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.171843018374062441103939209% which is below threshold 100.0%
2025-07-22 03:40:48,213 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '301.149683826619846251881177', 'margin': '9494.47', 'free_margin': '-9193.320316173380153748118823', 'profit_loss': '-9600.870316173380153748118823', 'margin_level': '3.171843018374062441103939209', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9524.530000000000000000000000', 'current_price': '118686.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-69.40028743034559431647165693', 'current_price': '96.088'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.940028743034559431647165693', 'current_price': '96.088'}], 'margin_call': True}
2025-07-22 03:40:48,217 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.171843018374062441103939209
2025-07-22 03:40:48,254 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:40:48,254 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:40:48,317 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:48,317 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:40:48,363 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:48,363 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:40:48,412 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:48,412 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:40:48,452 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:48,452 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:40:48,485 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:48,485 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:40:48,502 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:48,503 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:40:48,519 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:48,519 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:40:48,540 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:48,540 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:40:48,694 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:40:49,030 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.973052006023629607419710205% which is below threshold 100.0%
2025-07-22 03:40:49,030 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '235.865000000000000000000000', 'margin': '5936.62', 'free_margin': '-5700.755000000000000000000000', 'profit_loss': '-6153.755000000000000000000000', 'margin_level': '3.973052006023629607419710205', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6153.755000000000000000000000', 'current_price': '118686.1'}], 'margin_call': True}
2025-07-22 03:40:49,032 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.973052006023629607419710205
2025-07-22 03:40:49,073 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:40:49,073 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:40:49,256 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:40:49,632 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.36002137291413874795055066% which is below threshold 100.0%
2025-07-22 03:40:49,633 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100136.8149999999997000000000', 'margin': '146484.47', 'free_margin': '-46347.6550000000003000000000', 'profit_loss': '-84208.99500000000030000000000', 'margin_level': '68.36002137291413874795055066', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.5750000000003000000000000', 'current_price': '38.848499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84096.42000000000000000000000', 'current_price': '118686.1'}], 'margin_call': True}
2025-07-22 03:40:49,635 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.36002137291413874795055066
2025-07-22 03:40:49,642 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:40:49,644 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:40:49,707 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:49,707 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:40:49,742 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:49,742 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:40:49,779 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:49,780 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:40:49,781 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:40:49,781 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:40:49,794 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:40:49,797 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:40:49,797 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:40:49,836 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:49,836 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:40:49,837 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:40:49,838 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:40:49,839 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:40:49,839 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:40:49,998 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:40:49,999 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:40:50,351 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:40:50,358 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:40:50,364 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:40:50,364 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:40:51,791 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:40:51,793 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:40:52,194 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:40:52,200 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:40:52,200 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:40:52,200 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:40:52,329 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:40:52,331 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:40:52,704 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:40:53,012 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:40:53,012 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:40:53,012 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:40:53,062 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:40:53,063 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:40:53,098 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:10,983 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:41:11,339 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:41:23,111 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:41:23,111 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:41:23,111 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:41:23,112 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:41:23,126 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:41:23,127 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:41:23,127 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:41:23,133 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:41:23,133 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:41:23,148 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:41:23,153 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:41:23,153 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:41:23,314 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:41:23,641 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:41:23,646 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:41:23,648 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:41:23,651 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:41:23,651 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.348725'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.348725'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.348565'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.348565'}], 'margin_call': False}
2025-07-22 03:41:23,653 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:41:23,654 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:41:23,654 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:41:23,694 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:23,694 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:41:23,719 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:23,719 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:41:23,743 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:23,743 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:41:23,792 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:41:24,109 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.197406342645892650850323030% which is below threshold 100.0%
2025-07-22 03:41:24,110 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '303.576785980611483967188665', 'margin': '9494.47', 'free_margin': '-9190.893214019388516032811335', 'profit_loss': '-9598.443214019388516032811335', 'margin_level': '3.197406342645892650850323030', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9522.250000000000000000000000', 'current_price': '118691.8'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-69.26655819944410548437394075', 'current_price': '96.09'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.926655819944410548437394075', 'current_price': '96.09'}], 'margin_call': True}
2025-07-22 03:41:24,113 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.197406342645892650850323030
2025-07-22 03:41:24,164 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:41:24,164 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:41:24,240 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:24,241 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:41:24,351 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:24,351 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:41:24,389 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:24,389 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:41:24,424 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:24,424 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:41:24,455 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:24,455 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:41:24,500 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:24,500 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:41:24,529 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:24,529 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:41:24,565 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:24,565 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:41:24,698 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:41:25,062 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.982653429055590554894872840% which is below threshold 100.0%
2025-07-22 03:41:25,063 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '236.435000000000000000000000', 'margin': '5936.62', 'free_margin': '-5700.185000000000000000000000', 'profit_loss': '-6153.185000000000000000000000', 'margin_level': '3.982653429055590554894872840', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6153.185000000000000000000000', 'current_price': '118691.8'}], 'margin_call': True}
2025-07-22 03:41:25,070 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.982653429055590554894872840
2025-07-22 03:41:25,119 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:41:25,119 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:41:25,342 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:41:25,685 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.38323202452792435949012206% which is below threshold 100.0%
2025-07-22 03:41:25,685 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100170.8150000000000000000000', 'margin': '146484.47', 'free_margin': '-46313.6550000000000000000000', 'profit_loss': '-84174.99500000000000000000000', 'margin_level': '68.38323202452792435949012206', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.775000000000000000000000', 'current_price': '38.8445'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84062.22000000000000000000000', 'current_price': '118691.8'}], 'margin_call': True}
2025-07-22 03:41:25,688 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.38323202452792435949012206
2025-07-22 03:41:25,690 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:41:25,691 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:41:25,731 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:25,732 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:41:25,755 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:25,756 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:41:25,777 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:25,777 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:41:25,778 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:41:25,778 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:41:25,782 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:41:25,783 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:41:25,783 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:41:25,802 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:25,802 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:41:25,803 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:41:25,803 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:41:25,804 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:41:25,804 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:41:25,852 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:41:25,852 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:41:26,191 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:41:26,195 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:41:26,197 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:41:26,197 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:41:26,442 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:41:26,443 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:41:26,753 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:41:26,771 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:41:26,771 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:41:26,772 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:41:26,944 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:41:26,945 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:41:27,316 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:41:27,319 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:41:27,319 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:41:27,319 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:41:27,370 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:27,371 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:41:27,407 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:54,212 - INFO - app - [BarclaysMarginChecker] User 30: free_margin=10000.0, total_pending_margin=237515.95, num_pending_orders=1
2025-07-22 03:41:54,212 - INFO - app - [BarclaysMarginChecker] Considering cancellation: user 30, order 1194-001, order_margin=237515.95, free_margin=10000.0, total_pending_margin=237515.95
2025-07-22 03:41:54,217 - WARNING - app - [BarclaysMarginChecker] Cancelling order 1194-001 for user 30 (order_margin=237515.95) due to insufficient margin.
2025-07-22 03:41:54,598 - INFO - app - [BarclaysMarginChecker] Created rejected order record: order_id=1194-001, rejected_id=1197-002
2025-07-22 03:41:54,655 - INFO - app - [BarclaysMarginChecker] Successfully cancelled order 1194-001 for user 30
2025-07-22 03:41:57,425 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:41:57,426 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:41:57,426 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:41:57,426 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:41:57,439 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:41:57,439 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:41:57,440 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:41:57,449 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:41:57,449 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:41:57,487 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:41:57,491 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:41:57,491 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:41:57,617 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:41:57,911 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:41:57,914 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:41:57,919 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:41:57,924 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:41:57,924 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.348705'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.348705'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3485449999999999'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3485449999999999'}], 'margin_call': False}
2025-07-22 03:41:57,928 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:41:57,930 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:41:57,932 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:41:57,995 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:57,996 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:41:58,057 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,057 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:41:58,109 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,109 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:41:58,246 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:41:58,537 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.157898058834456754846570446% which is below threshold 100.0%
2025-07-22 03:41:58,537 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '299.825683826619846251881177', 'margin': '9494.47', 'free_margin': '-9194.644316173380153748118823', 'profit_loss': '-9602.194316173380153748118823', 'margin_level': '3.157898058834456754846570446', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9525.854000000000000000000000', 'current_price': '118682.79'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-69.40028743034559431647165693', 'current_price': '96.088'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.940028743034559431647165693', 'current_price': '96.088'}], 'margin_call': True}
2025-07-22 03:41:58,540 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.157898058834456754846570446
2025-07-22 03:41:58,609 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:41:58,609 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:41:58,664 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,664 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:41:58,703 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,703 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:41:58,739 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,739 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:41:58,760 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,761 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:41:58,784 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,784 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:41:58,802 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,802 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:41:58,819 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,819 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:41:58,841 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:58,841 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:41:58,926 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:41:59,207 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.967476442824368074763080676% which is below threshold 100.0%
2025-07-22 03:41:59,207 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '235.534000000000000000000000', 'margin': '5936.62', 'free_margin': '-5701.086000000000000000000000', 'profit_loss': '-6154.086000000000000000000000', 'margin_level': '3.967476442824368074763080676', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6154.086000000000000000000000', 'current_price': '118682.79'}], 'margin_call': True}
2025-07-22 03:41:59,212 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.967476442824368074763080676
2025-07-22 03:41:59,303 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:41:59,303 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:41:59,422 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:41:59,717 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.34636122177320210121933062% which is below threshold 100.0%
2025-07-22 03:41:59,718 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100116.8049999999997000000000', 'margin': '146484.47', 'free_margin': '-46367.6650000000003000000000', 'profit_loss': '-84229.00500000000030000000000', 'margin_level': '68.34636122177320210121933062', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.7250000000003000000000000', 'current_price': '38.845499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84116.28000000000000000000000', 'current_price': '118682.79'}], 'margin_call': True}
2025-07-22 03:41:59,722 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.34636122177320210121933062
2025-07-22 03:41:59,724 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:41:59,724 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:41:59,773 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:59,773 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 03:41:59,812 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:59,812 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:41:59,844 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:59,844 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:41:59,846 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:41:59,846 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:41:59,857 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:41:59,860 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:41:59,860 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:41:59,892 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:41:59,893 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:41:59,894 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:41:59,894 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:41:59,895 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:41:59,895 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:42:00,067 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:42:00,068 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:42:00,398 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 03:42:00,401 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:42:00,404 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:42:00,404 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:42:00,553 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:42:00,554 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:42:00,899 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:42:00,903 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 03:42:00,904 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:42:00,904 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:42:01,094 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:42:01,095 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 03:42:01,405 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:42:01,407 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 03:42:01,407 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:42:01,407 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:42:01,519 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:01,519 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:42:01,560 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:10,985 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:42:11,272 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:42:31,584 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:42:31,584 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:42:31,584 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:42:31,584 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:42:31,619 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 03:42:31,619 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 03:42:31,620 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:42:31,632 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:42:31,632 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:42:31,667 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:42:31,685 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:42:31,686 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:42:31,884 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:42:32,250 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:42:32,253 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:42:32,255 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:42:32,256 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 03:42:32,257 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.348715'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.348715'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.348555'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.348555'}], 'margin_call': False}
2025-07-22 03:42:32,258 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 03:42:32,259 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:42:32,259 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:42:32,293 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:32,294 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:42:32,325 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:32,325 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:42:32,364 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:32,364 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:42:32,490 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 03:42:32,854 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.097595263559233259105083664% which is below threshold 100.0%
2025-07-22 03:42:32,854 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '294.100253020052334015754437', 'margin': '9494.47', 'free_margin': '-9200.369746979947665984245563', 'profit_loss': '-9607.919746979947665984245563', 'margin_level': '3.097595263559233259105083664', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9531.654000000000000000000000', 'current_price': '118668.29'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-69.33249725449787816749596648', 'current_price': '96.089'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-6.933249725449787816749596648', 'current_price': '96.089'}], 'margin_call': True}
2025-07-22 03:42:32,860 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.097595263559233259105083664
2025-07-22 03:42:32,931 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 03:42:32,931 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:42:33,023 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:33,023 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:42:33,087 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:33,087 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:42:33,143 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:33,144 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:42:33,204 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:33,204 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:42:33,275 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:33,275 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:42:33,331 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:33,331 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:42:33,383 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:33,383 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:42:33,441 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:42:33,442 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:42:33,635 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 03:42:33,937 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.943051770199204261010473973% which is below threshold 100.0%
2025-07-22 03:42:33,938 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '234.084000000000000000000000', 'margin': '5936.62', 'free_margin': '-5702.536000000000000000000000', 'profit_loss': '-6155.536000000000000000000000', 'margin_level': '3.943051770199204261010473973', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6155.536000000000000000000000', 'current_price': '118668.29'}], 'margin_call': True}
2025-07-22 03:42:33,945 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.943051770199204261010473973
2025-07-22 03:42:34,022 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 03:42:34,022 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:42:34,124 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:42:34,488 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.28690099366847557287130847% which is below threshold 100.0%
2025-07-22 03:42:34,489 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100029.7050000000000000000000', 'margin': '146484.47', 'free_margin': '-46454.7650000000000000000000', 'profit_loss': '-84316.10500000000000000000000', 'margin_level': '68.28690099366847557287130847', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.825000000000000000000000', 'current_price': '38.8435'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84203.28000000000000000000000', 'current_price': '118668.29'}], 'margin_call': True}
2025-07-22 03:42:34,492 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.28690099366847557287130847
2025-07-22 03:42:34,498 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:42:34,499 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:42:34,907 - INFO - app - Application shutdown initiated
2025-07-22 03:42:34,907 - INFO - app - Scheduler shutdown completed
2025-07-22 03:42:35,782 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 03:42:36,128 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 03:42:36,128 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 03:42:36,131 - INFO - app - Redis connection closed
2025-07-22 03:42:36,132 - INFO - app - Application shutdown completed
2025-07-22 03:54:35,654 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:54:35,707 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:54:35,726 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:54:35,726 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-22 03:54:36,136 - INFO - app - Application starting up - Trading system initialized
2025-07-22 03:54:36,136 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 03:54:36,136 - INFO - app - Environment: PRODUCTION
2025-07-22 03:54:36,197 - INFO - app - Application startup initiated
2025-07-22 03:54:36,197 - INFO - app - Initializing core services...
2025-07-22 03:54:36,242 - INFO - app - Firebase initialized
2025-07-22 03:54:36,242 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 03:54:36,276 - INFO - app - Redis initialized
2025-07-22 03:54:38,400 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 03:54:38,407 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 03:54:38,413 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 03:54:38,413 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 03:54:38,413 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 03:54:38,414 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 03:54:38,414 - INFO - app - Scheduler initialized
2025-07-22 03:54:38,417 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:54:38,418 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 03:54:39,671 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 03:54:39,731 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:54:39,777 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 03:54:39,777 - INFO - app - Background tasks initialized
2025-07-22 03:54:39,777 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:54:40,558 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:54:40,558 - INFO - app - Application startup completed successfully
2025-07-22 03:54:40,559 - INFO - app - Starting cache validation task
2025-07-22 03:54:40,566 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 03:54:40,578 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 03:54:40,588 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 03:54:40,588 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:54:40,588 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:54:40,589 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:54:40,589 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:54:40,629 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:54:40,632 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:54:40,637 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:54:40,640 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:54:40,644 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:54:40,666 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:54:40,696 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:54:40,702 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:54:40,704 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:54:40,707 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:54:40,708 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:54:40,709 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:54:40,711 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:54:40,712 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:54:40,713 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:54:40,716 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:54:40,717 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:54:40,718 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:54:40,720 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:54:40,724 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:54:40,725 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:54:40,726 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:54:40,727 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:54:40,836 - INFO - app - Validating cache for 37 users
2025-07-22 03:54:40,841 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 03:54:40,851 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:54:40,852 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:54:40,852 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:54:40,956 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 03:54:40,997 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,007 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:41,007 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:54:41,086 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,105 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:54:41,105 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:54:41,143 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:54:41,199 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,227 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:54:41,227 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:54:41,288 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,344 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:41,345 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:54:41,368 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,446 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,526 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,616 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,686 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 03:54:41,711 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:54:41,993 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:54:41,998 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:54:41,999 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:54:42,000 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:54:42,032 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 03:54:42,095 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 03:54:42,166 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 03:54:42,238 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 03:54:42,242 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:54:42,539 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.70605114617342267521282337% which is below threshold 100.0%
2025-07-22 03:54:42,540 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.4137148704454920878558638', 'margin': '967.17', 'free_margin': '-476.7562851295545079121441362', 'profit_loss': '-4.646285129554507912144136242', 'margin_level': '50.70605114617342267521282337', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-4.646285129554507912144136242', 'current_price': '0.8913000000'}], 'margin_call': True}
2025-07-22 03:54:42,542 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.70605114617342267521282337
2025-07-22 03:54:42,662 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:54:42,672 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:54:42,684 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:54:42,735 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:54:42,771 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:54:42,798 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 03:54:43,072 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:54:43,082 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:54:43,096 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:54:43,096 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-22 03:54:43,103 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:54:43,104 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-22 03:54:43,110 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:54:43,132 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:54:43,132 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-22 03:54:43,139 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:54:43,157 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:54:43,161 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:54:43,161 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-22 03:54:43,175 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:54:43,175 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-22 03:54:43,178 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:54:43,182 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 03:54:43,191 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:54:43,191 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-22 03:54:43,195 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 03:54:43,195 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-22 03:54:46,337 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 11 at root9678@gmail.com
2025-07-22 03:54:46,350 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:54:46,350 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:54:46,484 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 03:54:46,586 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:46,590 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:54:46,608 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 03:54:46,722 - WARNING - app - User 24: Missing balance/margin cache, refreshing...
2025-07-22 03:54:46,730 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:46,731 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:54:46,844 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-22 03:54:46,961 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:46,961 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:54:46,981 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 03:54:47,064 - WARNING - app - User 27: Missing balance/margin cache, refreshing...
2025-07-22 03:54:47,083 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:47,084 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:54:47,133 - WARNING - app - User 28: Missing balance/margin cache, refreshing...
2025-07-22 03:54:47,170 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:47,170 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:54:47,203 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 03:54:47,253 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:47,253 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:54:47,303 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 03:54:47,333 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 30 by invalidating refresh token.
2025-07-22 03:54:47,380 - WARNING - app - User 31: Missing balance/margin cache, refreshing...
2025-07-22 03:54:47,673 - WARNING - app - User 33: Missing balance/margin cache, refreshing...
2025-07-22 03:54:47,792 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-22 03:54:47,807 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:54:48,106 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:54:48,121 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:54:48,125 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:54:48,125 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:54:48,163 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 03:54:48,233 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 03:54:48,314 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 03:54:48,380 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:54:48,702 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:54:48,718 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:54:48,723 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 03:54:48,726 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:54:48,726 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:54:48,814 - INFO - app - Cache validation completed
2025-07-22 03:54:48,857 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:48,857 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:54:49,059 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:54:49,351 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:54:49,356 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:54:49,358 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:54:49,358 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:54:49,462 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:49,462 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:54:49,710 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:49,710 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:54:49,913 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:49,913 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:54:50,142 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:54:50,432 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-74500.01500000000030000000000', 'margin': '308.75', 'free_margin': '-74808.76500000000030000000000', 'profit_loss': '-84137.77500000000030000000000', 'margin_level': '-24129.55951417004058299595142', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.8750000000003000000000000', 'current_price': '38.842499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84024.90000000000000000000000', 'current_price': '118698.02'}], 'margin_call': False}
2025-07-22 03:54:50,444 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -24129.55951417004058299595142
2025-07-22 03:54:50,444 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:54:50,444 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:54:50,645 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:54:50,946 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:54:50,955 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:54:50,961 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:54:50,961 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:54:52,413 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 03:54:52,779 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 03:54:52,787 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 03:54:52,792 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 03:54:52,792 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:54:52,909 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:52,913 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 03:54:53,034 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:53,034 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 03:54:53,258 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:53,258 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 03:54:53,660 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:53,660 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:54:53,807 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:53,807 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:54:53,808 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:54:53,809 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:54:53,825 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:54:53,913 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:54:53,914 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:54:54,117 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:54,117 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:54:54,121 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:54:54,121 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:54:54,132 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:54:54,132 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:54:54,397 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:54:54,398 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:54:55,510 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:54:55,551 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:54:55,551 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:54:55,552 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:54:55,566 - INFO - app - Starting stale cache cleanup task
2025-07-22 03:54:55,580 - INFO - app - Found 27 static orders cache entries to check
2025-07-22 03:54:55,583 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 03:54:55,585 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 03:54:55,592 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 03:54:55,598 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 03:54:55,604 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 03:54:55,607 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 03:54:55,640 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 03:54:55,648 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 03:54:55,661 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 03:54:55,663 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 03:54:55,667 - WARNING - app - Found stale cache entry for user live:27, will be refreshed on next access
2025-07-22 03:54:55,669 - WARNING - app - Found stale cache entry for user live:28, will be refreshed on next access
2025-07-22 03:54:55,672 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 03:54:55,674 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 03:54:55,678 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 03:54:55,687 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 03:54:55,690 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 03:54:55,694 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 03:54:55,701 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 03:54:55,704 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 03:54:55,705 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 03:54:55,705 - INFO - app - Completed stale cache cleanup task
2025-07-22 03:54:55,934 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:54:55,935 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:54:56,241 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:54:56,252 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:54:56,257 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:54:56,257 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:54:56,395 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:56,395 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:54:56,529 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:56,529 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:54:56,652 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:54:58,348 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 1 symbols for user 1
2025-07-22 03:54:58,349 - INFO - app.api.v1.endpoints.favorites - Symbols: ['AUDCAD']
2025-07-22 03:55:00,005 - INFO - app - [SCHEDULER] Starting daily_swap_charge_job...
2025-07-22 03:55:00,005 - INFO - app - Executing daily swap charge job...
2025-07-22 03:55:02,016 - INFO - app - Daily swap charge job completed successfully
2025-07-22 03:55:26,730 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:55:26,731 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:55:26,731 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:55:26,731 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:55:26,835 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:55:26,836 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:55:26,836 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:55:26,977 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:26,977 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:55:27,157 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:55:27,157 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:55:27,173 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:55:27,241 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:55:27,242 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:55:27,357 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:27,357 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:55:27,565 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:55:27,850 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:55:27,864 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:55:27,867 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:55:27,867 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:55:28,038 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:55:28,315 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.68336140502566973468523562% which is below threshold 100.0%
2025-07-22 03:55:28,315 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.1942665009867699729551933', 'margin': '967.17', 'free_margin': '-476.9757334990132300270448067', 'profit_loss': '-4.865733499013230027044806666', 'margin_level': '50.68336140502566973468523562', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-4.865733499013230027044806666', 'current_price': '0.891'}], 'margin_call': True}
2025-07-22 03:55:28,318 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.68336140502566973468523562
2025-07-22 03:55:28,320 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:55:28,321 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:55:28,421 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:28,422 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:55:28,552 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:28,552 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:55:28,648 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:28,648 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:55:28,733 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:28,733 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:55:28,861 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:28,861 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:55:28,980 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:28,980 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:55:29,192 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:55:29,478 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:55:29,482 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:55:29,491 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:55:29,495 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:55:29,818 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:55:30,106 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:55:30,126 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:55:30,129 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:55:30,129 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:55:30,226 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:30,226 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:55:30,358 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:55:30,651 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:55:30,656 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:55:30,657 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:55:30,657 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:55:30,765 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:30,765 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:55:30,966 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:30,967 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:55:31,075 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:31,076 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:55:31,309 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:55:31,612 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-74500.72500000000020000000000', 'margin': '308.75', 'free_margin': '-74809.47500000000020000000000', 'profit_loss': '-84138.48500000000020000000000', 'margin_level': '-24129.78947368421059109311741', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-112.9250000000002000000000000', 'current_price': '38.841499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84025.56000000000000000000000', 'current_price': '118697.91'}], 'margin_call': False}
2025-07-22 03:55:31,615 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -24129.78947368421059109311741
2025-07-22 03:55:31,615 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:55:31,616 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:55:31,911 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:55:32,204 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:55:32,211 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:55:32,212 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:55:32,212 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:55:32,412 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 03:55:32,703 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 03:55:32,717 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 03:55:32,720 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 03:55:32,720 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:55:32,844 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:32,845 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 03:55:32,936 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:32,937 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 03:55:33,043 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:33,043 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 03:55:33,153 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:33,153 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:55:33,262 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:33,263 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:55:33,266 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:55:33,266 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:55:33,298 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:55:33,329 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:55:33,330 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:55:33,453 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:33,453 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:55:33,456 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:55:33,456 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:55:33,459 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:55:33,459 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:55:33,626 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:55:33,626 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:55:33,929 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:55:33,935 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:55:33,936 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:55:33,936 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:55:34,250 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:55:34,251 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:55:34,648 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:55:34,652 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:55:34,654 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:55:34,654 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:55:34,746 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:34,746 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:55:34,843 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:34,843 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:55:34,969 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:55:38,420 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:55:38,715 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:56:05,039 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:56:05,039 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:56:05,039 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:56:05,039 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:56:05,148 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:56:05,148 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:56:05,148 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:56:05,260 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:05,261 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:56:05,366 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:56:05,366 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:56:05,394 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:56:05,457 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:56:05,457 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:56:05,593 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:05,593 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:56:05,783 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:56:06,089 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:56:06,096 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:56:06,099 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:56:06,099 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:56:06,261 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:56:06,556 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.68336140502566973468523562% which is below threshold 100.0%
2025-07-22 03:56:06,556 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.1942665009867699729551933', 'margin': '967.17', 'free_margin': '-476.9757334990132300270448067', 'profit_loss': '-4.865733499013230027044806666', 'margin_level': '50.68336140502566973468523562', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-4.865733499013230027044806666', 'current_price': '0.891'}], 'margin_call': True}
2025-07-22 03:56:06,560 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.68336140502566973468523562
2025-07-22 03:56:06,562 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:56:06,562 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:56:06,666 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:06,667 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:56:06,831 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:06,831 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:56:06,948 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:06,948 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:56:07,072 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:07,072 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:56:07,171 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:07,171 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:56:07,312 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:07,313 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:56:07,557 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:56:07,843 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:56:07,850 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:56:07,852 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:56:07,852 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:56:08,088 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:56:08,378 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:56:08,380 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:56:08,383 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:56:08,383 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:56:08,473 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:08,474 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:56:08,690 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:56:08,986 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:56:08,994 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:56:09,005 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:56:09,005 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:56:09,162 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:09,162 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:56:09,280 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:09,281 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:56:09,413 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:09,414 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:56:09,609 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:56:09,902 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-74500.87500000000020000000000', 'margin': '308.75', 'free_margin': '-74809.62500000000020000000000', 'profit_loss': '-84138.63500000000020000000000', 'margin_level': '-24129.83805668016200809716599', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.0750000000002000000000000', 'current_price': '38.838499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84025.56000000000000000000000', 'current_price': '118697.91'}], 'margin_call': False}
2025-07-22 03:56:09,906 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -24129.83805668016200809716599
2025-07-22 03:56:09,906 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:56:09,906 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:56:10,122 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:56:10,411 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:56:10,414 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:56:10,416 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:56:10,416 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:56:10,664 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 03:56:10,961 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 03:56:10,968 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 03:56:10,970 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 03:56:10,971 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:56:11,151 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:11,151 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 03:56:11,286 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:11,287 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 03:56:11,490 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:11,490 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 03:56:11,618 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:11,618 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:56:11,739 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:11,739 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:56:11,740 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:56:11,741 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:56:11,750 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:56:11,780 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:56:11,781 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:56:11,872 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:11,872 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:56:11,873 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:56:11,873 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:56:11,874 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:56:11,875 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:56:12,044 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:56:12,044 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:56:12,340 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:56:12,346 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:56:12,347 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:56:12,348 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:56:12,481 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:56:12,481 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:56:12,775 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:56:12,779 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:56:12,782 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:56:12,782 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:56:12,911 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:12,911 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:56:13,015 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:13,015 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:56:13,117 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:38,428 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:56:38,708 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:56:43,191 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:56:43,192 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:56:43,192 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:56:43,193 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:56:43,413 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:56:43,414 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:56:43,414 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:56:43,682 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:43,683 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:56:43,849 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:56:43,850 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:56:43,876 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:56:43,932 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:56:43,932 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:56:44,039 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:44,040 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:56:44,251 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:56:44,596 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:56:44,606 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:56:44,610 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:56:44,610 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:56:44,892 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:56:45,508 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.67130258075375147593684391% which is below threshold 100.0%
2025-07-22 03:56:45,509 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.0776371702760581498183732', 'margin': '967.17', 'free_margin': '-477.0923628297239418501816268', 'profit_loss': '-4.982362829723941850181626821', 'margin_level': '50.67130258075375147593684391', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-4.982362829723941850181626821', 'current_price': '0.89084'}], 'margin_call': True}
2025-07-22 03:56:45,515 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.67130258075375147593684391
2025-07-22 03:56:45,518 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:56:45,518 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:56:45,642 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:45,642 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:56:45,745 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:45,746 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:56:45,855 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:45,856 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:56:45,983 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:45,984 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:56:46,142 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:46,142 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:56:46,260 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:46,260 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:56:46,486 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:56:46,776 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:56:46,782 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:56:46,784 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:56:46,785 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:56:46,971 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:56:47,260 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:56:47,263 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:56:47,267 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:56:47,267 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:56:47,394 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:47,394 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:56:47,650 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:56:47,937 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:56:47,941 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:56:47,944 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:56:47,944 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:56:48,074 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:48,074 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:56:48,187 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:48,187 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:56:48,299 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:48,299 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:56:48,576 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:56:48,868 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-73539.31500000000020000000000', 'margin': '308.75', 'free_margin': '-73848.06500000000020000000000', 'profit_loss': '-83177.07500000000020000000000', 'margin_level': '-23818.40161943319844534412955', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.3750000000002000000000000', 'current_price': '38.832499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83063.70000000000000000000000', 'current_price': '118858.22'}], 'margin_call': False}
2025-07-22 03:56:48,878 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -23818.40161943319844534412955
2025-07-22 03:56:48,878 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:56:48,878 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:56:49,127 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:56:49,429 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:56:49,432 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:56:49,434 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:56:49,434 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:56:49,677 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 03:56:49,966 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 03:56:49,969 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 03:56:49,971 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 03:56:49,971 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:56:50,095 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:50,095 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 03:56:50,187 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:50,188 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 03:56:50,295 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:50,295 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 03:56:50,405 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:50,405 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:56:50,518 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:50,518 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:56:50,520 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:56:50,521 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:56:50,541 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:56:50,574 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:56:50,575 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:56:50,717 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:50,717 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:56:50,721 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:56:50,722 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:56:50,723 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:56:50,723 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:56:50,940 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:56:50,941 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:56:51,234 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:56:51,236 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:56:51,236 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:56:51,236 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:56:51,457 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:56:51,459 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:56:51,736 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:56:51,745 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:56:51,747 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:56:51,747 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:56:51,871 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:51,871 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:56:51,977 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:51,977 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:56:52,080 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:56:52,173 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 1
2025-07-22 03:56:52,176 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 1
2025-07-22 03:56:52,177 - INFO - app.api.v1.endpoints.users - Refresh token validated successfully for user ID: 1
2025-07-22 03:56:52,181 - INFO - app.api.v1.endpoints.users - Refresh token validated successfully for user ID: 1
2025-07-22 03:56:52,254 - WARNING - app.api.v1.endpoints.users - Refresh token valid, but user ID 1 not found or inactive.
2025-07-22 03:56:52,257 - WARNING - app.api.v1.endpoints.users - Refresh token valid, but user ID 1 not found or inactive.
2025-07-22 03:56:52,261 - INFO - app.api.v1.endpoints.users - Invalidated refresh token for invalid user ID 1.
2025-07-22 03:56:52,262 - ERROR - app.api.v1.endpoints.users - Unexpected error during refresh token process for token: eyJhbGciOiJIUzI1NiIs... : 401: User not found or inactive
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\users.py", line 345, in refresh_access_token
     raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: User not found or inactive
2025-07-22 03:56:52,291 - INFO - app.api.v1.endpoints.users - Invalidated refresh token for invalid user ID 1.
2025-07-22 03:56:52,292 - ERROR - app.api.v1.endpoints.users - Unexpected error during refresh token process for token: eyJhbGciOiJIUzI1NiIs... : 401: User not found or inactive
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\users.py", line 345, in refresh_access_token
     raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: User not found or inactive
2025-07-22 03:57:22,141 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:57:22,142 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:57:22,142 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:57:22,144 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:57:22,233 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:57:22,234 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:57:22,234 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:57:22,339 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:22,339 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:57:22,437 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:57:22,437 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:57:22,459 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:57:22,521 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:57:22,522 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:57:22,632 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:22,633 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:57:22,976 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:57:23,280 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:57:23,283 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:57:23,288 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:57:23,289 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:57:23,618 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:57:23,927 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.67055796357271935150392148% which is below threshold 100.0%
2025-07-22 03:57:23,927 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.0704354562862697519404774', 'margin': '967.17', 'free_margin': '-477.0995645437137302480595226', 'profit_loss': '-4.989564543713730248059522591', 'margin_level': '50.67055796357271935150392148', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-4.989564543713730248059522591', 'current_price': '0.89083'}], 'margin_call': True}
2025-07-22 03:57:23,931 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.67055796357271935150392148
2025-07-22 03:57:23,932 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:57:23,932 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:57:24,037 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:24,038 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:57:24,179 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:24,180 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:57:24,306 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:24,306 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:57:24,428 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:24,428 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:57:24,534 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:24,534 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:57:24,661 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:24,661 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:57:24,870 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:57:25,165 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:57:25,167 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:57:25,168 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:57:25,169 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:57:25,468 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:57:25,754 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:57:25,760 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:57:25,764 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:57:25,764 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:57:25,893 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:25,894 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:57:26,039 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:57:26,327 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:57:26,334 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:57:26,336 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:57:26,337 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:57:26,447 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:26,448 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:57:26,577 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:26,577 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:57:26,693 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:26,693 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:57:26,931 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:57:27,225 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-73396.52500000000030000000000', 'margin': '308.75', 'free_margin': '-73705.27500000000030000000000', 'profit_loss': '-83034.28500000000030000000000', 'margin_level': '-23772.15384615384625101214575', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.3250000000003000000000000', 'current_price': '38.833499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-82920.96000000000000000000000', 'current_price': '118882.01'}], 'margin_call': False}
2025-07-22 03:57:27,228 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -23772.15384615384625101214575
2025-07-22 03:57:27,228 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:57:27,229 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:57:27,473 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:57:27,762 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:57:27,771 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:57:27,801 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:57:27,801 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:57:28,059 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 03:57:28,346 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 03:57:28,354 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 03:57:28,355 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 03:57:28,355 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:57:28,477 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:28,477 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 03:57:28,608 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:28,608 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 03:57:28,720 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:28,720 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 03:57:28,819 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:28,819 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:57:28,923 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:28,924 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:57:28,925 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:57:28,925 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:57:28,946 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:57:28,977 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:57:28,977 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:57:29,096 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:29,097 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:57:29,099 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:57:29,099 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:57:29,102 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:57:29,103 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:57:29,345 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:57:29,346 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:57:29,640 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:57:29,644 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:57:29,645 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:57:29,645 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:57:29,871 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:57:29,872 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:57:30,161 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:57:30,171 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:57:30,191 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:57:30,194 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:57:30,347 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:30,347 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:57:30,462 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:30,462 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:57:30,575 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:57:38,426 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:57:38,725 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:58:00,652 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:58:00,652 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:58:00,653 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:58:00,653 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:58:00,760 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:58:00,760 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:58:00,760 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:58:00,869 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:00,869 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:58:00,966 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:58:00,966 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:58:00,987 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:58:01,057 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:58:01,058 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:58:01,200 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:01,200 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:58:01,356 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:58:01,636 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:58:01,642 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:58:01,645 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:58:01,645 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:58:01,829 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:58:02,128 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.66749061174748848116150857% which is below threshold 100.0%
2025-07-22 03:58:02,128 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.0407689496381843432497624', 'margin': '967.17', 'free_margin': '-477.1292310503618156567502376', 'profit_loss': '-5.019231050361815656750237556', 'margin_level': '50.66749061174748848116150857', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-5.019231050361815656750237556', 'current_price': '0.89079'}], 'margin_call': True}
2025-07-22 03:58:02,132 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.66749061174748848116150857
2025-07-22 03:58:02,135 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:58:02,135 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:58:02,253 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:02,253 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:58:02,417 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:02,417 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:58:02,534 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:02,534 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:58:02,638 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:02,638 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:58:02,757 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:02,757 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:58:02,855 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:02,855 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:58:03,059 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:58:03,363 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:58:03,368 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:58:03,371 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:58:03,371 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:58:03,653 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:58:03,951 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:58:03,954 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:58:03,957 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:58:03,957 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:58:04,055 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:04,055 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:58:04,250 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:58:04,554 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:58:04,558 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:58:04,566 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:58:04,567 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:58:04,728 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:04,728 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:58:04,847 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:04,848 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:58:04,961 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:04,961 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:58:05,205 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:58:05,497 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-73539.77500000000000000000000', 'margin': '308.75', 'free_margin': '-73848.52500000000000000000000', 'profit_loss': '-83177.53500000000000000000000', 'margin_level': '-23818.55060728744939271255061', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.775000000000000000000000', 'current_price': '38.8245'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83063.76000000000000000000000', 'current_price': '118858.21'}], 'margin_call': False}
2025-07-22 03:58:05,503 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -23818.55060728744939271255061
2025-07-22 03:58:05,503 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:58:05,503 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:58:05,713 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:58:06,004 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:58:06,006 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:58:06,008 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:58:06,009 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:58:06,221 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 03:58:06,502 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 03:58:06,507 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 03:58:06,508 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 03:58:06,509 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:58:06,613 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:06,614 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 03:58:06,727 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:06,728 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 03:58:06,868 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:06,869 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 03:58:06,998 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:06,998 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:58:07,119 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:07,120 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:58:07,123 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:58:07,123 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:58:07,132 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:58:07,177 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:58:07,177 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:58:07,343 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:07,343 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:58:07,347 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:58:07,347 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:58:07,349 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:58:07,349 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:58:07,664 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:58:07,666 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:58:07,960 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:58:07,966 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:58:07,966 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:58:07,966 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:58:08,209 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:58:08,210 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:58:08,501 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:58:08,507 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:58:08,509 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:58:08,509 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:58:08,611 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:08,611 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:58:08,703 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:08,704 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:58:08,834 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:38,419 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:58:38,709 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:58:38,918 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:58:38,918 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:58:38,919 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:58:38,919 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:58:39,014 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:58:39,014 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:58:39,014 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:58:39,124 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:39,124 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:58:39,257 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:58:39,257 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:58:39,270 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:58:39,335 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:58:39,335 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:58:39,428 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:39,428 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:58:39,599 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:58:39,896 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:58:39,904 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:58:39,907 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:58:39,908 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:58:40,089 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:58:40,391 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.67130627033983506315283544% which is below threshold 100.0%
2025-07-22 03:58:40,391 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.0776728548457827802952785', 'margin': '967.17', 'free_margin': '-477.0923271451542172197047215', 'profit_loss': '-4.982327145154217219704721532', 'margin_level': '50.67130627033983506315283544', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-4.982327145154217219704721532', 'current_price': '0.89084'}], 'margin_call': True}
2025-07-22 03:58:40,392 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.67130627033983506315283544
2025-07-22 03:58:40,393 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:58:40,393 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:58:40,492 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:40,492 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:58:40,599 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:40,600 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:58:40,726 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:40,726 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:58:40,840 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:40,841 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:58:40,982 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:40,982 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:58:41,100 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:41,100 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:58:41,244 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:58:41,540 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:58:41,545 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:58:41,547 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:58:41,548 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:58:41,704 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:58:41,993 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:58:42,164 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:58:42,178 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:58:42,179 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:58:42,309 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:42,309 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:58:42,469 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:58:42,754 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:58:42,769 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:58:42,772 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:58:42,772 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:58:42,918 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:42,918 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:58:43,059 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:43,059 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:58:43,189 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:43,189 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:58:43,325 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:58:43,620 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-73630.11500000000000000000000', 'margin': '308.75', 'free_margin': '-73938.86500000000000000000000', 'profit_loss': '-83267.87500000000000000000000', 'margin_level': '-23847.81052631578947368421053', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.575000000000000000000000', 'current_price': '38.8285'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83154.30000000000000000000000', 'current_price': '118843.12'}], 'margin_call': False}
2025-07-22 03:58:43,624 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -23847.81052631578947368421053
2025-07-22 03:58:43,625 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:58:43,625 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:58:43,872 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:58:44,161 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:58:44,164 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:58:44,170 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:58:44,171 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:58:44,412 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 03:58:44,705 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 03:58:44,707 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 03:58:44,710 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 03:58:44,711 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:58:44,808 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:44,808 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 03:58:44,933 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:44,933 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 03:58:45,037 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:45,037 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 03:58:45,124 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:45,125 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:58:45,219 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:45,219 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:58:45,220 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:58:45,221 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:58:45,231 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:58:45,274 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:58:45,274 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:58:45,386 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:45,386 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:58:45,388 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:58:45,388 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:58:45,389 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:58:45,390 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:58:45,548 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:58:45,548 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:58:45,843 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:58:45,850 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:58:45,850 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:58:45,850 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:58:46,008 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:58:46,009 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:58:46,320 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:58:46,322 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:58:46,325 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:58:46,325 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:58:46,440 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:46,441 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:58:46,620 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:58:46,620 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:58:46,721 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:16,784 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:59:16,785 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:59:16,785 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:59:16,785 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:59:16,915 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:59:16,916 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:59:16,916 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:59:17,025 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:17,025 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:59:17,137 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:59:17,137 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:59:17,159 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:59:17,221 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:59:17,221 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:59:17,351 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:17,351 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:59:17,527 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:59:17,837 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:59:17,841 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:59:17,842 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:59:17,843 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:59:18,074 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:59:18,379 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.66524576033011504809672692% which is below threshold 100.0%
2025-07-22 03:59:18,380 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.0190574201847737106771138', 'margin': '967.17', 'free_margin': '-477.1509425798152262893228862', 'profit_loss': '-5.040942579815226289322886212', 'margin_level': '50.66524576033011504809672692', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-5.040942579815226289322886212', 'current_price': '0.89076'}], 'margin_call': True}
2025-07-22 03:59:18,382 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.66524576033011504809672692
2025-07-22 03:59:18,384 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:59:18,384 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:59:18,502 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:18,502 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:59:18,619 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:18,619 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:59:18,761 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:18,761 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:59:18,908 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:18,908 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:59:19,171 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:19,171 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:59:19,288 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:19,289 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:59:19,484 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:59:19,779 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:59:19,783 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:59:19,786 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:59:19,787 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:59:20,052 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:59:20,344 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:59:20,347 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:59:20,348 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:59:20,348 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:59:20,453 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:20,453 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:59:20,693 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:59:20,982 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:59:20,986 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:59:20,990 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:59:20,990 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:59:21,107 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:21,107 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:59:21,222 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:21,222 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:59:21,365 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:21,366 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:59:21,629 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:59:21,930 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-73582.52500000000000000000000', 'margin': '308.75', 'free_margin': '-73891.27500000000000000000000', 'profit_loss': '-83220.28500000000000000000000', 'margin_level': '-23832.39676113360323886639676', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.625000000000000000000000', 'current_price': '38.8275'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83106.66000000000000000000000', 'current_price': '118851.06'}], 'margin_call': False}
2025-07-22 03:59:21,942 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -23832.39676113360323886639676
2025-07-22 03:59:21,942 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:59:21,942 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:59:22,170 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:59:22,454 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:59:22,456 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:59:22,459 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:59:22,459 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:59:22,657 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 03:59:22,946 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 03:59:22,949 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 03:59:22,950 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 03:59:22,950 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 03:59:23,038 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:23,038 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 03:59:23,128 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:23,128 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 03:59:23,215 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:23,216 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 03:59:23,305 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:23,305 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 03:59:23,404 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:23,404 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 03:59:23,406 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 03:59:23,406 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 03:59:23,418 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:59:23,447 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 03:59:23,447 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 03:59:23,540 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:23,540 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 03:59:23,542 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 03:59:23,542 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 03:59:23,544 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 03:59:23,544 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 03:59:23,794 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 03:59:23,795 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 03:59:24,088 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 03:59:24,100 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 03:59:24,101 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 03:59:24,101 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 03:59:24,302 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:59:24,304 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 03:59:24,596 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:59:24,600 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:59:24,604 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:59:24,604 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 03:59:24,703 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:24,703 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 03:59:24,790 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:24,790 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 03:59:24,894 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:38,426 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 03:59:38,715 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 03:59:48,876 - INFO - app - Starting cache validation task
2025-07-22 03:59:49,008 - INFO - app - Validating cache for 37 users
2025-07-22 03:59:49,008 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,092 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,130 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,227 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,298 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,369 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,460 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,532 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,615 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,696 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,771 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,843 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 03:59:49,918 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,001 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,082 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,168 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,249 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,323 - WARNING - app - User 24: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,396 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,467 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,540 - WARNING - app - User 27: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,620 - WARNING - app - User 28: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,706 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,787 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,869 - WARNING - app - User 31: Missing balance/margin cache, refreshing...
2025-07-22 03:59:50,952 - WARNING - app - User 33: Missing balance/margin cache, refreshing...
2025-07-22 03:59:51,040 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 03:59:51,136 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 03:59:51,218 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 03:59:51,296 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 03:59:51,430 - INFO - app - Cache validation completed
2025-07-22 03:59:54,956 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:59:54,956 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 03:59:54,956 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 03:59:54,956 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 03:59:55,067 - INFO - app - [AUTO-CUTOFF] Found 26 live users and 11 demo users.
2025-07-22 03:59:55,067 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-22 03:59:55,067 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-22 03:59:55,166 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:55,166 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 03:59:55,259 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 03:59:55,259 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 03:59:55,268 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 03:59:55,324 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 03:59:55,325 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 03:59:55,417 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:55,418 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 03:59:55,574 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 03:59:55,992 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 03:59:55,995 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 03:59:55,997 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 03:59:55,997 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 03:59:56,126 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 03:59:56,412 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.67432172259634696591957146% which is below threshold 100.0%
2025-07-22 03:59:56,412 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '490.1068374044350889502843193', 'margin': '967.17', 'free_margin': '-477.0631625955649110497156807', 'profit_loss': '-4.953162595564911049715680685', 'margin_level': '50.67432172259634696591957146', 'positions': [{'order_id': '1000099-001', 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.89752000'), 'margin': Decimal('6.55364428'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 11, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-15T00:15:22', 'profit_loss': '-4.953162595564911049715680685', 'current_price': '0.89088'}], 'margin_call': True}
2025-07-22 03:59:56,419 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 50.67432172259634696591957146
2025-07-22 03:59:56,430 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 03:59:56,430 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-22 03:59:56,510 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:56,510 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 03:59:56,588 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:56,588 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 03:59:56,674 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:56,674 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 03:59:56,764 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:56,764 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 03:59:56,842 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:56,842 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 03:59:56,918 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:56,918 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 03:59:57,037 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 19...
2025-07-22 03:59:57,321 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 19: {'balance': '9610.04000000', 'equity': '9610.04000000', 'margin': '13.82', 'free_margin': '9596.22000000', 'profit_loss': '0.0', 'margin_level': '69537.19247467438494934876990', 'positions': [], 'margin_call': False}
2025-07-22 03:59:57,324 - INFO - app - [AUTO-CUTOFF] User 19 margin_level: 69537.19247467438494934876990
2025-07-22 03:59:57,327 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 19
2025-07-22 03:59:57,327 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 03:59:57,548 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-22 03:59:57,830 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-22 03:59:57,834 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-22 03:59:57,835 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-22 03:59:57,835 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 03:59:57,927 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:57,927 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 03:59:58,055 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-22 03:59:58,330 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-22 03:59:58,333 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-22 03:59:58,334 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-22 03:59:58,335 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 03:59:58,428 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:58,429 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-22 03:59:58,546 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:58,546 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 03:59:58,671 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-22 03:59:58,671 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 03:59:58,908 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 03:59:59,188 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '9637.76000000', 'equity': '-73598.76500000000000000000000', 'margin': '308.75', 'free_margin': '-73907.51500000000000000000000', 'profit_loss': '-83236.52500000000000000000000', 'margin_level': '-23837.65668016194331983805668', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-113.425000000000000000000000', 'current_price': '38.8315'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83123.10000000000000000000000', 'current_price': '118848.32'}], 'margin_call': False}
2025-07-22 03:59:59,200 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: -23837.65668016194331983805668
2025-07-22 03:59:59,200 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 03:59:59,200 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-22 03:59:59,379 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-22 03:59:59,661 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-22 03:59:59,674 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-22 03:59:59,675 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-22 03:59:59,675 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-22 03:59:59,885 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-22 04:00:00,170 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-22 04:00:00,172 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-22 04:00:00,174 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-22 04:00:00,174 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 04:00:00,264 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:00,265 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-22 04:00:00,370 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:00,371 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-22 04:00:00,495 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:00,495 - INFO - app - [AUTO-CUTOFF] Processing user 33 (live), group: Classic
2025-07-22 04:00:00,598 - WARNING - app - [AUTO-CUTOFF] User 33 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:00,598 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 04:00:00,724 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:00,724 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 04:00:00,727 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 04:00:00,727 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 04:00:00,759 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 04:00:00,792 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 04:00:00,792 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 04:00:00,934 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:00,934 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 04:00:00,936 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 04:00:00,936 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 04:00:00,939 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 04:00:00,939 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 04:00:01,252 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 04:00:01,252 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 04:00:01,537 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 04:00:01,549 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-22 04:00:01,549 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 04:00:01,549 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 04:00:01,788 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 04:00:01,789 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 04:00:02,083 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9696.78000000', 'equity': '9696.78000000', 'margin': '6.51', 'free_margin': '9690.27000000', 'profit_loss': '0.0', 'margin_level': '148952.0737327188940092165899', 'positions': [], 'margin_call': False}
2025-07-22 04:00:02,089 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 148952.0737327188940092165899
2025-07-22 04:00:02,090 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 04:00:02,090 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 04:00:02,204 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:02,204 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 04:00:02,365 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:02,365 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 04:00:02,517 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 04:00:23,257 - INFO - app - Application shutdown initiated
2025-07-22 04:00:23,261 - INFO - app - Scheduler shutdown completed
2025-07-22 04:00:23,674 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 04:00:24,383 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 04:00:24,384 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 04:00:24,394 - INFO - app - Redis connection closed
2025-07-22 04:00:24,394 - INFO - app - Application shutdown completed
2025-07-22 21:29:30,909 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:29:30,959 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:29:30,971 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:29:30,971 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:29:31,435 - INFO - app - Application starting up - Trading system initialized
2025-07-22 21:29:31,435 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 21:29:31,435 - INFO - app - Environment: PRODUCTION
2025-07-22 21:29:31,508 - INFO - app - Application startup initiated
2025-07-22 21:29:31,508 - INFO - app - Initializing core services...
2025-07-22 21:29:31,563 - INFO - app - Firebase initialized
2025-07-22 21:29:31,563 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 21:29:35,636 - WARNING - app - Redis initialization failed
2025-07-22 21:29:35,636 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 21:29:35,640 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 21:29:35,640 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 21:29:35,641 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 21:29:35,642 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 21:29:35,642 - INFO - app - Scheduler initialized
2025-07-22 21:29:35,642 - INFO - app - Background tasks initialized
2025-07-22 21:29:35,642 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:29:36,939 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:29:36,939 - INFO - app - Application startup completed successfully
2025-07-22 21:29:36,939 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:29:36,939 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 21:29:37,655 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:30:35,643 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:30:35,936 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:31:18,557 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 21:31:27,872 - INFO - app - Application shutdown initiated
2025-07-22 21:31:27,872 - INFO - app - Scheduler shutdown completed
2025-07-22 21:31:27,873 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 21:31:28,249 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 21:31:28,249 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 21:31:28,249 - INFO - app - Application shutdown completed
2025-07-22 21:32:50,104 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:32:50,145 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:32:50,161 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:32:50,161 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:32:50,501 - INFO - app - Application starting up - Trading system initialized
2025-07-22 21:32:50,502 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 21:32:50,502 - INFO - app - Environment: PRODUCTION
2025-07-22 21:32:50,572 - INFO - app - Application startup initiated
2025-07-22 21:32:50,573 - INFO - app - Initializing core services...
2025-07-22 21:32:50,630 - INFO - app - Firebase initialized
2025-07-22 21:32:50,630 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 21:32:50,657 - INFO - app - Redis initialized
2025-07-22 21:32:51,446 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 21:32:51,450 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 21:32:51,455 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 21:32:51,455 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 21:32:51,455 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 21:32:51,456 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 21:32:51,456 - INFO - app - Scheduler initialized
2025-07-22 21:32:51,459 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:32:51,460 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 21:32:52,630 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:32:52,654 - INFO - app - Starting stale cache cleanup task
2025-07-22 21:32:52,688 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 21:32:52,688 - INFO - app - Background tasks initialized
2025-07-22 21:32:52,688 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:32:53,443 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:32:53,444 - INFO - app - Application startup completed successfully
2025-07-22 21:32:53,444 - INFO - app - Starting cache validation task
2025-07-22 21:32:53,448 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 21:32:53,451 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 21:32:53,453 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 21:32:53,453 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:32:53,453 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:32:53,453 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:32:53,453 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:32:53,459 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 21:32:53,461 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 21:32:53,463 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 21:32:53,464 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 21:32:53,468 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 21:32:53,492 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 21:32:53,513 - INFO - app - Validating cache for 30 users
2025-07-22 21:32:53,514 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:32:53,515 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:32:53,515 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:32:53,521 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 21:32:53,536 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 21:32:53,536 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,540 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:32:53,540 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:32:53,543 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 21:32:53,546 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 21:32:53,546 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,547 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 21:32:53,549 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 21:32:53,549 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 21:32:53,552 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 21:32:53,552 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 21:32:53,553 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 21:32:53,555 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 21:32:53,555 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:32:53,556 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 21:32:53,557 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 21:32:53,559 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 21:32:53,562 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 21:32:53,562 - INFO - app - Completed stale cache cleanup task
2025-07-22 21:32:53,563 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:32:53,563 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:32:53,564 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,576 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,590 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,599 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,610 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,621 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,631 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,641 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,653 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,663 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,672 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,680 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,688 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,694 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,726 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,745 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,757 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,770 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-22 21:32:53,774 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:32:54,177 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:32:54,179 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:32:54,181 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 21:32:54,182 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:32:54,184 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:32:54,185 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3477900000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3477900000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3477800000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3477800000'}], 'margin_call': False}
2025-07-22 21:32:54,187 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:32:54,188 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:32:54,188 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:32:54,195 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 21:32:54,210 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 21:32:54,224 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 21:32:54,226 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:54,226 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:32:54,237 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 21:32:54,261 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:54,261 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:32:54,267 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 21:32:54,282 - INFO - app - Cache validation completed
2025-07-22 21:32:54,295 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:54,295 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:32:54,489 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:32:54,877 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.240953686059171652562668406% which is below threshold 100.0%
2025-07-22 21:32:54,877 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '402.656075436782234801066783', 'margin': '9494.47', 'free_margin': '-9091.813924563217765198933217', 'profit_loss': '-9499.363924563217765198933217', 'margin_level': '4.240953686059171652562668406', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9420.582000000000000000000000', 'current_price': '118945.9700000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-71.61993142110705927175747020', 'current_price': '96.0590000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-7.161993142110705927175747020', 'current_price': '96.0590000000'}], 'margin_call': True}
2025-07-22 21:32:54,879 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 4.240953686059171652562668406
2025-07-22 21:32:54,905 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:32:54,905 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:32:54,925 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:54,925 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:32:54,947 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:54,947 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:32:54,970 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:54,970 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:32:54,993 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:54,993 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:32:55,016 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:55,016 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:32:55,039 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:55,039 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:32:55,064 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:55,064 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:32:55,097 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:55,097 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:32:55,293 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:32:55,295 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:32:55,331 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:32:55,334 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:32:55,359 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:32:55,361 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:32:55,362 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:32:55,368 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:32:55,567 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:32:55,593 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:32:55,593 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:32:55,603 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:32:55,606 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:32:55,627 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:32:55,627 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:32:55,629 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:32:55,629 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:32:55,634 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:32:55,639 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:32:55,642 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:32:55,651 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:32:55,652 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:32:55,655 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:32:55,655 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:32:55,660 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:32:55,660 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:32:55,661 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:32:55,674 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:32:55,674 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:32:55,694 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.410792673271996523274186322% which is below threshold 100.0%
2025-07-22 21:32:55,695 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '261.852000000000000000000000', 'margin': '5936.62', 'free_margin': '-5674.768000000000000000000000', 'profit_loss': '-6127.768000000000000000000000', 'margin_level': '4.410792673271996523274186322', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6127.768000000000000000000000', 'current_price': '118945.9700000000'}], 'margin_call': True}
2025-07-22 21:32:55,696 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.410792673271996523274186322
2025-07-22 21:32:55,712 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:32:55,712 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:32:55,804 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:32:56,207 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.97406257468795156237381342% which is below threshold 100.0%
2025-07-22 21:32:56,208 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '101036.2900000000000000000000', 'margin': '146484.47', 'free_margin': '-45448.1800000000000000000000', 'profit_loss': '-83309.52000000000000000000000', 'margin_level': '68.97406257468795156237381342', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-93.90000000000000000000000000', 'current_price': '39.2220000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83215.62000000000000000000000', 'current_price': '118832.9000000000'}], 'margin_call': True}
2025-07-22 21:32:56,212 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.97406257468795156237381342
2025-07-22 21:32:56,213 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:32:56,213 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:32:56,231 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:56,231 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:32:56,244 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:56,244 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:32:56,264 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:56,264 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:32:56,265 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:32:56,265 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:32:56,268 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:32:56,270 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:32:56,270 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:32:56,283 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:56,283 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:32:56,284 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:32:56,284 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:32:56,284 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:32:56,284 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:32:56,372 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:32:56,373 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:32:56,820 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:32:56,835 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:32:56,837 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:32:56,838 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:32:56,933 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:32:56,934 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:32:57,248 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:32:57,251 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:32:57,251 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:32:57,251 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:32:57,322 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:32:57,322 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:32:57,651 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:32:57,653 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:32:57,653 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:32:57,653 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:32:57,677 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:32:57,677 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:32:57,709 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:08,450 - INFO - app - Starting stale cache cleanup task
2025-07-22 21:33:08,453 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 21:33:08,459 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 21:33:08,463 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 21:33:08,464 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 21:33:08,465 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 21:33:08,466 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 21:33:08,467 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 21:33:08,468 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 21:33:08,469 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 21:33:08,469 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 21:33:08,470 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 21:33:08,470 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 21:33:08,470 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 21:33:08,471 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 21:33:08,471 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 21:33:08,472 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 21:33:08,472 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 21:33:08,473 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 21:33:08,473 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 21:33:08,473 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 21:33:08,474 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 21:33:08,474 - INFO - app - Completed stale cache cleanup task
2025-07-22 21:33:27,714 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:33:27,714 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:33:27,715 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:33:27,715 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:33:27,736 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:33:27,737 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:33:27,737 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:33:27,742 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:33:27,742 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:33:27,749 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:33:27,752 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:33:27,752 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:33:27,807 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:33:28,160 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:33:28,163 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:33:28,166 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:33:28,168 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:33:28,169 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3528850000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3528850000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352725'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352725'}], 'margin_call': False}
2025-07-22 21:33:28,177 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:33:28,178 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:33:28,178 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:33:28,196 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,196 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:33:28,213 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,214 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:33:28,231 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,231 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:33:28,287 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:33:28,597 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.887320842440728543597924013% which is below threshold 100.0%
2025-07-22 21:33:28,597 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '369.080511189282239353341816', 'margin': '9494.47', 'free_margin': '-9125.389488810717760646658184', 'profit_loss': '-9532.939488810717760646658184', 'margin_level': '3.887320842440728543597924013', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9485.810000000000000000000000', 'current_price': '118782.9'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.84498982792523695150744024', 'current_price': '96.482'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.284498982792523695150744024', 'current_price': '96.482'}], 'margin_call': True}
2025-07-22 21:33:28,600 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.887320842440728543597924013
2025-07-22 21:33:28,623 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:33:28,623 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:33:28,641 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,641 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:33:28,655 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,655 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:33:28,685 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,685 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:33:28,706 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,706 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:33:28,724 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,724 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:33:28,741 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,741 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:33:28,758 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,758 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:33:28,775 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:28,775 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:33:28,822 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:33:29,184 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.135939305530756558445714902% which is below threshold 100.0%
2025-07-22 21:33:29,184 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '245.535000000000000000000000', 'margin': '5936.62', 'free_margin': '-5691.085000000000000000000000', 'profit_loss': '-6144.085000000000000000000000', 'margin_level': '4.135939305530756558445714902', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6144.085000000000000000000000', 'current_price': '118782.8'}], 'margin_call': True}
2025-07-22 21:33:29,188 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.135939305530756558445714902
2025-07-22 21:33:29,229 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:33:29,231 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:33:29,309 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:33:29,628 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.76839230807197493358852307% which is below threshold 100.0%
2025-07-22 21:33:29,628 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100735.0149999999997000000000', 'margin': '146484.47', 'free_margin': '-45749.4550000000003000000000', 'profit_loss': '-83610.79500000000030000000000', 'margin_level': '68.76839230807197493358852307', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.57500000000030000000000000', 'current_price': '39.208499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83516.22000000000000000000000', 'current_price': '118782.8'}], 'margin_call': True}
2025-07-22 21:33:29,630 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.76839230807197493358852307
2025-07-22 21:33:29,633 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:33:29,633 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:33:29,652 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:29,652 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:33:29,667 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:29,667 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:33:29,693 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:29,693 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:33:29,694 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:33:29,694 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:33:29,702 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:33:29,703 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:33:29,704 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:33:29,720 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:29,720 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:33:29,721 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:33:29,721 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:33:29,721 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:33:29,721 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:33:29,787 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:33:29,787 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:33:30,205 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:33:30,208 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:33:30,210 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:33:30,211 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:33:30,287 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:33:30,288 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:33:30,613 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:33:30,615 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:33:30,616 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:33:30,616 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:33:30,699 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:33:30,700 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:33:31,023 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:33:31,033 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:33:31,035 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:33:31,035 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:33:31,066 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:31,066 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:33:31,083 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:33:51,461 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:33:51,807 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:34:01,090 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:34:01,091 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:34:01,091 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:34:01,091 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:34:01,104 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:34:01,104 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:34:01,104 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:34:01,109 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:34:01,109 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:34:01,126 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:34:01,133 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:34:01,133 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:34:01,288 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:34:02,056 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:34:02,075 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:34:02,081 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:34:02,084 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:34:02,084 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352865'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352865'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352705'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352705'}], 'margin_call': False}
2025-07-22 21:34:02,086 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:34:02,087 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:34:02,087 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:34:02,128 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,128 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:34:02,170 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,170 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:34:02,209 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,209 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:34:02,273 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:34:02,664 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.815278906450620617615747019% which is below threshold 100.0%
2025-07-22 21:34:02,664 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '362.240511189282239353341816', 'margin': '9494.47', 'free_margin': '-9132.229488810717760646658184', 'profit_loss': '-9539.779488810717760646658184', 'margin_level': '3.815278906450620617615747019', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9492.650000000000000000000000', 'current_price': '118765.8'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.84498982792523695150744024', 'current_price': '96.482'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.284498982792523695150744024', 'current_price': '96.482'}], 'margin_call': True}
2025-07-22 21:34:02,665 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.815278906450620617615747019
2025-07-22 21:34:02,687 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:34:02,687 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:34:02,705 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,705 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:34:02,719 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,719 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:34:02,733 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,733 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:34:02,748 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,748 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:34:02,763 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,763 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:34:02,777 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,777 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:34:02,790 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,790 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:34:02,804 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:02,804 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:34:02,851 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:34:03,279 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.107303482452978294046107044% which is below threshold 100.0%
2025-07-22 21:34:03,279 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '243.835000000000000000000000', 'margin': '5936.62', 'free_margin': '-5692.785000000000000000000000', 'profit_loss': '-6145.785000000000000000000000', 'margin_level': '4.107303482452978294046107044', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6145.785000000000000000000000', 'current_price': '118765.8'}], 'margin_call': True}
2025-07-22 21:34:03,283 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.107303482452978294046107044
2025-07-22 21:34:03,311 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:34:03,311 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:34:03,367 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:34:03,685 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.69889688647540589115009939% which is below threshold 100.0%
2025-07-22 21:34:03,685 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100633.2150000000000000000000', 'margin': '146484.47', 'free_margin': '-45851.2550000000000000000000', 'profit_loss': '-83712.59500000000000000000000', 'margin_level': '68.69889688647540589115009939', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.375000000000000000000000', 'current_price': '39.2125'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83618.22000000000000000000000', 'current_price': '118765.8'}], 'margin_call': True}
2025-07-22 21:34:03,687 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.69889688647540589115009939
2025-07-22 21:34:03,688 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:34:03,688 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:34:03,706 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:03,706 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:34:03,724 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:03,725 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:34:03,743 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:03,743 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:34:03,744 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:34:03,744 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:34:03,751 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:34:03,753 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:34:03,753 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:34:03,782 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:03,782 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:34:03,783 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:34:03,783 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:34:03,784 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:34:03,784 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:34:03,936 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:34:03,936 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:34:04,303 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:34:04,305 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:34:04,307 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:34:04,308 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:34:04,481 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:34:04,482 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:34:04,815 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:34:04,816 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:34:04,816 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:34:04,816 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:34:04,878 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:34:04,879 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:34:05,185 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:34:05,187 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:34:05,187 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:34:05,187 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:34:05,209 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:05,209 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:34:05,227 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:35,232 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:34:35,233 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:34:35,233 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:34:35,233 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:34:35,248 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:34:35,248 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:34:35,249 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:34:35,259 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:34:35,259 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:34:35,280 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:34:35,283 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:34:35,283 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:34:35,439 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:34:35,741 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:34:35,744 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:34:35,748 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:34:35,751 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:34:35,751 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352875'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352875'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352715'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352715'}], 'margin_call': False}
2025-07-22 21:34:35,759 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:34:35,761 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:34:35,761 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:34:35,810 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:35,810 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:34:35,857 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:35,858 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:34:35,912 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:35,912 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:34:36,109 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:34:36,418 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.747104151368291030210336364% which is below threshold 100.0%
2025-07-22 21:34:36,418 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '355.767679520416981376011323', 'margin': '9494.47', 'free_margin': '-9138.702320479583018623988677', 'profit_loss': '-9546.252320479583018623988677', 'margin_level': '3.747104151368291030210336364', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9498.970000000000000000000000', 'current_price': '118750.0'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.98392770871183511271697933', 'current_price': '96.48'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.298392770871183511271697933', 'current_price': '96.48'}], 'margin_call': True}
2025-07-22 21:34:36,427 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.747104151368291030210336364
2025-07-22 21:34:36,516 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:34:36,516 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:34:36,556 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:36,556 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:34:36,591 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:36,591 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:34:36,622 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:36,622 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:34:36,657 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:36,657 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:34:36,695 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:36,695 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:34:36,731 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:36,731 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:34:36,776 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:36,776 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:34:36,824 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:36,825 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:34:36,972 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:34:37,274 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.080689011592454965957059741% which is below threshold 100.0%
2025-07-22 21:34:37,275 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '242.255000000000000000000000', 'margin': '5936.62', 'free_margin': '-5694.365000000000000000000000', 'profit_loss': '-6147.365000000000000000000000', 'margin_level': '4.080689011592454965957059741', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6147.365000000000000000000000', 'current_price': '118750.0'}], 'margin_call': True}
2025-07-22 21:34:37,286 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.080689011592454965957059741
2025-07-22 21:34:37,347 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:34:37,354 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:34:37,511 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:34:37,812 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.63421426175757730495253183% which is below threshold 100.0%
2025-07-22 21:34:37,813 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100538.4649999999998000000000', 'margin': '146484.47', 'free_margin': '-45946.0050000000002000000000', 'profit_loss': '-83807.34500000000020000000000', 'margin_level': '68.63421426175757730495253183', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.32500000000020000000000000', 'current_price': '39.213499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83713.02000000000000000000000', 'current_price': '118750.0'}], 'margin_call': True}
2025-07-22 21:34:37,815 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.63421426175757730495253183
2025-07-22 21:34:37,817 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:34:37,817 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:34:37,866 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:37,866 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:34:37,919 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:37,920 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:34:37,971 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:37,972 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:34:37,973 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:34:37,974 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:34:37,994 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:34:37,997 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:34:37,997 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:34:38,048 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:38,049 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:34:38,050 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:34:38,050 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:34:38,053 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:34:38,053 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:34:38,215 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:34:38,216 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:34:38,531 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:34:38,548 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:34:38,550 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:34:38,551 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:34:38,799 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:34:38,800 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:34:39,102 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:34:39,105 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:34:39,105 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:34:39,105 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:34:39,241 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:34:39,243 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:34:39,543 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:34:39,545 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:34:39,545 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:34:39,545 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:34:39,600 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:39,600 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:34:39,654 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:34:51,458 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:34:51,813 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:35:09,665 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:35:09,665 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:35:09,665 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:35:09,665 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:35:09,676 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:35:09,676 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:35:09,676 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:35:09,684 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:35:09,685 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:35:09,710 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:35:09,714 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:35:09,714 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:35:09,829 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:35:10,149 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:35:10,153 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:35:10,157 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:35:10,161 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:35:10,161 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352945'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352945'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352785'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352785'}], 'margin_call': False}
2025-07-22 21:35:10,164 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:35:10,165 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:35:10,166 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:35:10,214 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:10,214 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:35:10,268 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:10,268 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:35:10,314 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:10,315 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:35:10,484 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:35:10,863 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.757595605352409805687913564% which is below threshold 100.0%
2025-07-22 21:35:10,863 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '356.763787471502943278097247', 'margin': '9494.47', 'free_margin': '-9137.706212528497056721902753', 'profit_loss': '-9545.256212528497056721902753', 'margin_level': '3.757595605352409805687913564', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9497.370000000000000000000000', 'current_price': '118754.0'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-43.53292048045186974718432066', 'current_price': '96.472'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.353292048045186974718432066', 'current_price': '96.472'}], 'margin_call': True}
2025-07-22 21:35:10,865 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.757595605352409805687913564
2025-07-22 21:35:10,881 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:35:10,881 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:35:10,908 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:10,908 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:35:10,937 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:10,937 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:35:10,955 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:10,955 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:35:10,990 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:10,990 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:35:11,017 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:11,018 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:35:11,046 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:11,047 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:35:11,083 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:11,084 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:35:11,109 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:11,109 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:35:11,179 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:35:11,578 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.087426852316638086992261590% which is below threshold 100.0%
2025-07-22 21:35:11,578 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '242.655000000000000000000000', 'margin': '5936.62', 'free_margin': '-5693.965000000000000000000000', 'profit_loss': '-6146.965000000000000000000000', 'margin_level': '4.087426852316638086992261590', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6146.965000000000000000000000', 'current_price': '118754.0'}], 'margin_call': True}
2025-07-22 21:35:11,584 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.087426852316638086992261590
2025-07-22 21:35:11,675 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:35:11,675 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:35:11,808 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:35:12,193 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.65080305099919465865562404% which is below threshold 100.0%
2025-07-22 21:35:12,194 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100562.7650000000000000000000', 'margin': '146484.47', 'free_margin': '-45921.7050000000000000000000', 'profit_loss': '-83783.04500000000000000000000', 'margin_level': '68.65080305099919465865562404', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.025000000000000000000000', 'current_price': '39.2195'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83689.02000000000000000000000', 'current_price': '118754.0'}], 'margin_call': True}
2025-07-22 21:35:12,197 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.65080305099919465865562404
2025-07-22 21:35:12,198 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:35:12,199 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:35:12,237 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:12,237 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:35:12,269 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:12,269 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:35:12,306 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:12,306 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:35:12,307 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:35:12,307 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:35:12,330 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:35:12,336 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:35:12,336 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:35:12,387 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:12,388 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:35:12,389 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:35:12,389 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:35:12,390 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:35:12,390 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:35:12,509 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:35:12,510 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:35:12,856 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:35:12,859 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:35:12,861 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:35:12,861 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:35:12,951 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:35:12,952 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:35:13,273 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:35:13,276 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:35:13,276 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:35:13,276 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:35:13,342 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:35:13,343 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:35:13,727 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:35:13,730 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:35:13,730 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:35:13,730 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:35:13,930 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:13,931 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:35:13,982 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:43,990 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:35:43,991 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:35:43,991 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:35:43,991 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:35:44,005 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:35:44,005 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:35:44,006 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:35:44,017 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:35:44,017 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:35:44,034 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:35:44,041 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:35:44,041 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:35:44,223 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:35:44,555 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:35:44,558 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:35:44,563 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:35:44,575 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:35:44,575 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352915'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352915'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352755'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352755'}], 'margin_call': False}
2025-07-22 21:35:44,578 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:35:44,580 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:35:44,580 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:35:44,654 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:44,654 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:35:44,714 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:44,715 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:35:44,750 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:44,751 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:35:44,873 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:35:45,178 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.758818732482680438480003065% which is below threshold 100.0%
2025-07-22 21:35:45,178 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '356.879916909948349427352347', 'margin': '9494.47', 'free_margin': '-9137.590083090051650572647653', 'profit_loss': '-9545.140083090051650572647653', 'margin_level': '3.758818732482680438480003065', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9497.330000000000000000000000', 'current_price': '118754.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-43.46371190004695506604332115', 'current_price': '96.473'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.346371190004695506604332115', 'current_price': '96.473'}], 'margin_call': True}
2025-07-22 21:35:45,181 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.758818732482680438480003065
2025-07-22 21:35:45,203 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:35:45,203 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:35:45,226 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:45,227 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:35:45,246 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:45,246 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:35:45,272 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:45,272 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:35:45,295 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:45,295 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:35:45,315 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:45,315 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:35:45,333 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:45,333 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:35:45,351 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:45,351 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:35:45,372 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:45,372 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:35:45,434 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:35:45,786 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.087595298334742665018141636% which is below threshold 100.0%
2025-07-22 21:35:45,786 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '242.665000000000000000000000', 'margin': '5936.62', 'free_margin': '-5693.955000000000000000000000', 'profit_loss': '-6146.955000000000000000000000', 'margin_level': '4.087595298334742665018141636', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6146.955000000000000000000000', 'current_price': '118754.1'}], 'margin_call': True}
2025-07-22 21:35:45,788 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.087595298334742665018141636
2025-07-22 21:35:45,805 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:35:45,806 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:35:45,856 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:35:46,152 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.65138331728953929382411665% which is below threshold 100.0%
2025-07-22 21:35:46,153 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100563.6150000000000000000000', 'margin': '146484.47', 'free_margin': '-45920.8550000000000000000000', 'profit_loss': '-83782.19500000000000000000000', 'margin_level': '68.65138331728953929382411665', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-93.775000000000000000000000', 'current_price': '39.2245'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83688.42000000000000000000000', 'current_price': '118754.1'}], 'margin_call': True}
2025-07-22 21:35:46,154 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.65138331728953929382411665
2025-07-22 21:35:46,156 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:35:46,156 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:35:46,191 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:46,191 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:35:46,213 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:46,213 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:35:46,240 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:46,240 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:35:46,241 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:35:46,241 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:35:46,250 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:35:46,252 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:35:46,252 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:35:46,274 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:46,274 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:35:46,275 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:35:46,275 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:35:46,276 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:35:46,276 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:35:46,350 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:35:46,351 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:35:46,653 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:35:46,656 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:35:46,657 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:35:46,657 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:35:46,705 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:35:46,705 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:35:47,008 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:35:47,011 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:35:47,011 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:35:47,011 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:35:47,106 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:35:47,107 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:35:47,406 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:35:47,409 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:35:47,409 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:35:47,409 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:35:47,461 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:47,462 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:35:47,504 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:35:51,459 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:35:51,762 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:36:17,510 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:36:17,511 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:36:17,511 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:36:17,511 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:36:17,516 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:36:17,516 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:36:17,516 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:36:17,522 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:36:17,523 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:36:17,530 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:36:17,532 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:36:17,532 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:36:17,579 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:36:17,935 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:36:17,936 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:36:17,937 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:36:17,938 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:36:17,938 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3529250000000002'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3529250000000002'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352765'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352765'}], 'margin_call': False}
2025-07-22 21:36:17,939 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:36:17,939 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:36:17,939 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:36:17,957 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:17,957 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:36:17,973 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:17,973 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:36:17,988 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:17,988 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:36:18,050 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:36:18,450 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.709938135489796818142511641% which is below threshold 100.0%
2025-07-22 21:36:18,451 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '352.238963292638111959495325', 'margin': '9494.47', 'free_margin': '-9142.231036707361888040504675', 'profit_loss': '-9549.781036707361888040504675', 'margin_level': '3.709938135489796818142511641', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9501.970000000000000000000000', 'current_price': '118742.5'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-43.46457882487444367318606835', 'current_price': '96.473'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.346457882487444367318606835', 'current_price': '96.473'}], 'margin_call': True}
2025-07-22 21:36:18,454 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.709938135489796818142511641
2025-07-22 21:36:18,482 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:36:18,482 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:36:18,496 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:18,496 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:36:18,511 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:18,511 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:36:18,527 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:18,527 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:36:18,543 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:18,543 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:36:18,557 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:18,557 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:36:18,572 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:18,572 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:36:18,587 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:18,588 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:36:18,602 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:18,602 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:36:18,666 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:36:18,979 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.068055560234611614016056274% which is below threshold 100.0%
2025-07-22 21:36:18,980 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '241.505000000000000000000000', 'margin': '5936.62', 'free_margin': '-5695.115000000000000000000000', 'profit_loss': '-6148.115000000000000000000000', 'margin_level': '4.068055560234611614016056274', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6148.115000000000000000000000', 'current_price': '118742.5'}], 'margin_call': True}
2025-07-22 21:36:18,982 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.068055560234611614016056274
2025-07-22 21:36:19,000 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:36:19,001 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:36:19,048 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:36:19,372 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.60369908154768898027210666% which is below threshold 100.0%
2025-07-22 21:36:19,372 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100493.7650000000000000000000', 'margin': '146484.47', 'free_margin': '-45990.7050000000000000000000', 'profit_loss': '-83852.04500000000000000000000', 'margin_level': '68.60369908154768898027210666', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.025000000000000000000000', 'current_price': '39.2195'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83758.02000000000000000000000', 'current_price': '118742.5'}], 'margin_call': True}
2025-07-22 21:36:19,374 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.60369908154768898027210666
2025-07-22 21:36:19,375 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:36:19,375 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:36:19,395 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:19,395 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:36:19,407 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:19,408 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:36:19,422 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:19,422 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:36:19,423 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:36:19,423 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:36:19,427 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:36:19,428 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:36:19,428 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:36:19,440 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:19,441 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:36:19,441 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:36:19,441 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:36:19,442 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:36:19,442 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:36:19,491 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:36:19,491 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:36:19,876 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:36:19,878 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:36:19,878 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:36:19,878 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:36:19,931 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:36:19,932 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:36:20,286 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:36:20,288 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:36:20,289 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:36:20,289 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:36:20,344 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:36:20,345 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:36:20,696 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:36:20,699 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:36:20,699 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:36:20,699 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:36:20,727 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:20,727 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:36:20,742 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:50,749 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:36:50,749 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:36:50,749 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:36:50,749 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:36:50,754 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:36:50,754 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:36:50,754 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:36:50,758 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:36:50,758 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:36:50,763 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:36:50,765 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:36:50,765 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:36:50,818 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:36:51,116 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:36:51,119 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:36:51,121 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:36:51,122 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:36:51,122 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352935'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352935'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352775'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352775'}], 'margin_call': False}
2025-07-22 21:36:51,123 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:36:51,124 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:36:51,124 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:36:51,146 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,147 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:36:51,170 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,170 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:36:51,185 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,185 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:36:51,241 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:36:51,538 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:36:51,839 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:36:51,840 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.709944831484410705003461331% which is below threshold 100.0%
2025-07-22 21:36:51,840 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '352.239599041837929063342135', 'margin': '9494.47', 'free_margin': '-9142.230400958162070936657865', 'profit_loss': '-9549.780400958162070936657865', 'margin_level': '3.709944831484410705003461331', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9501.970000000000000000000000', 'current_price': '118742.5'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-43.46400087105642812423442306', 'current_price': '96.473'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.346400087105642812423442306', 'current_price': '96.473'}], 'margin_call': True}
2025-07-22 21:36:51,841 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.709944831484410705003461331
2025-07-22 21:36:51,856 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:36:51,856 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:36:51,872 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,873 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:36:51,889 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,889 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:36:51,903 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,904 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:36:51,922 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,922 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:36:51,936 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,936 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:36:51,952 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,952 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:36:51,966 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,966 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:36:51,981 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:51,981 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:36:52,026 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:36:52,335 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.068055560234611614016056274% which is below threshold 100.0%
2025-07-22 21:36:52,335 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '241.505000000000000000000000', 'margin': '5936.62', 'free_margin': '-5695.115000000000000000000000', 'profit_loss': '-6148.115000000000000000000000', 'margin_level': '4.068055560234611614016056274', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6148.115000000000000000000000', 'current_price': '118742.5'}], 'margin_call': True}
2025-07-22 21:36:52,337 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.068055560234611614016056274
2025-07-22 21:36:52,361 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:36:52,361 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:36:52,412 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:36:52,709 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.60352841499170505924621224% which is below threshold 100.0%
2025-07-22 21:36:52,709 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100493.5149999999997000000000', 'margin': '146484.47', 'free_margin': '-45990.9550000000003000000000', 'profit_loss': '-83852.29500000000030000000000', 'margin_level': '68.60352841499170505924621224', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.27500000000030000000000000', 'current_price': '39.214499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83758.02000000000000000000000', 'current_price': '118742.5'}], 'margin_call': True}
2025-07-22 21:36:52,711 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.60352841499170505924621224
2025-07-22 21:36:52,713 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:36:52,713 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:36:52,774 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:52,774 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:36:52,833 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:52,834 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:36:52,874 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:52,874 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:36:52,875 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:36:52,875 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:36:52,880 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:36:52,882 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:36:52,882 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:36:52,907 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:52,907 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:36:52,909 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:36:52,909 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:36:52,911 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:36:52,911 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:36:52,995 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:36:52,995 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:36:53,307 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:36:53,310 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:36:53,311 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:36:53,312 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:36:53,539 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:36:53,541 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:36:53,974 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:36:53,980 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:36:53,980 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:36:53,980 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:36:54,120 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:36:54,121 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:36:54,431 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:36:54,433 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:36:54,433 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:36:54,433 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:36:54,481 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:54,481 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:36:54,509 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:36:54,862 - INFO - app - Application shutdown initiated
2025-07-22 21:36:54,862 - INFO - app - Scheduler shutdown completed
2025-07-22 21:36:55,241 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 21:36:55,931 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 21:36:55,931 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 21:36:55,935 - INFO - app - Redis connection closed
2025-07-22 21:36:55,935 - INFO - app - Application shutdown completed
2025-07-22 21:39:18,091 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:39:18,119 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:39:18,133 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:39:18,133 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:41:55,618 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:41:55,666 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:41:55,678 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:41:55,679 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:41:55,979 - INFO - app - Application starting up - Trading system initialized
2025-07-22 21:41:55,979 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 21:41:55,979 - INFO - app - Environment: PRODUCTION
2025-07-22 21:41:56,041 - INFO - app - Application startup initiated
2025-07-22 21:41:56,041 - INFO - app - Initializing core services...
2025-07-22 21:41:56,073 - INFO - app - Firebase initialized
2025-07-22 21:41:56,074 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 21:41:56,102 - INFO - app - Redis initialized
2025-07-22 21:41:56,692 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 21:41:56,695 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 21:41:56,698 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 21:41:56,698 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 21:41:56,698 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 21:41:56,699 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 21:41:56,699 - INFO - app - Scheduler initialized
2025-07-22 21:41:56,702 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:41:56,703 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 21:41:57,697 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:41:57,709 - INFO - app - Starting stale cache cleanup task
2025-07-22 21:41:57,746 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 21:41:57,746 - INFO - app - Background tasks initialized
2025-07-22 21:41:57,746 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:41:58,470 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:41:58,470 - INFO - app - Application startup completed successfully
2025-07-22 21:41:58,470 - INFO - app - Starting cache validation task
2025-07-22 21:41:58,472 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 21:41:58,475 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 21:41:58,477 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 21:41:58,477 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:41:58,477 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:41:58,477 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:41:58,477 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:41:58,497 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 21:41:58,518 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:41:58,519 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:41:58,519 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:41:58,522 - INFO - app - Validating cache for 30 users
2025-07-22 21:41:58,534 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,548 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:41:58,548 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:41:58,556 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 21:41:58,558 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,560 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 21:41:58,563 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 21:41:58,565 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 21:41:58,566 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 21:41:58,567 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 21:41:58,568 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:41:58,570 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 21:41:58,571 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,572 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 21:41:58,573 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:41:58,573 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:41:58,574 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 21:41:58,575 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 21:41:58,577 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 21:41:58,579 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 21:41:58,580 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 21:41:58,581 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 21:41:58,584 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 21:41:58,584 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,585 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 21:41:58,586 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 21:41:58,588 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 21:41:58,589 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 21:41:58,592 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 21:41:58,593 - INFO - app - Completed stale cache cleanup task
2025-07-22 21:41:58,595 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,607 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,615 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,625 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,634 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,642 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,652 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,661 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,668 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,676 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,684 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,691 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,700 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,708 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,716 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,722 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,778 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,787 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,798 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,809 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 21:41:58,814 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:41:59,114 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 21:41:59,115 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:41:59,118 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:41:59,120 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:41:59,123 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:41:59,123 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3528500000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3528500000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3528400000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3528400000'}], 'margin_call': False}
2025-07-22 21:41:59,125 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:41:59,127 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:41:59,127 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:41:59,133 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 21:41:59,148 - INFO - app - Cache validation completed
2025-07-22 21:41:59,157 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,157 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:41:59,186 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,186 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:41:59,207 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,207 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:41:59,386 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:41:59,700 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.931592386300351358989723671% which is below threshold 100.0%
2025-07-22 21:41:59,701 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '373.283859639570969673871617', 'margin': '9494.47', 'free_margin': '-9121.186140360429030326128383', 'profit_loss': '-9528.736140360429030326128383', 'margin_level': '3.931592386300351358989723671', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9481.970000000000000000000000', 'current_price': '118792.5000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.51467305493548211466216584', 'current_price': '96.4870000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.251467305493548211466216584', 'current_price': '96.4870000000'}], 'margin_call': True}
2025-07-22 21:41:59,703 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.931592386300351358989723671
2025-07-22 21:41:59,738 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:41:59,738 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:41:59,765 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,765 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:41:59,791 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,791 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:41:59,821 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,821 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:41:59,851 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,851 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:41:59,882 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,882 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:41:59,910 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,910 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:41:59,939 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,939 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:41:59,972 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:41:59,972 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:42:00,179 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:42:00,490 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.152278569286900626956079385% which is below threshold 100.0%
2025-07-22 21:42:00,490 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '246.505000000000000000000000', 'margin': '5936.62', 'free_margin': '-5690.115000000000000000000000', 'profit_loss': '-6143.115000000000000000000000', 'margin_level': '4.152278569286900626956079385', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6143.115000000000000000000000', 'current_price': '118792.5000000000'}], 'margin_call': True}
2025-07-22 21:42:00,493 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.152278569286900626956079385
2025-07-22 21:42:00,492 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:42:00,498 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:42:00,518 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:42:00,542 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:42:00,542 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:42:00,577 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:42:00,590 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:42:00,620 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:42:00,666 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:42:00,856 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:42:00,885 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:42:00,891 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:42:00,898 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:42:00,902 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:42:00,903 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:42:00,909 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:42:00,909 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:42:00,926 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:42:00,927 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:42:00,945 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:42:00,946 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:42:00,958 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:42:00,965 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:42:00,965 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:42:00,966 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:42:00,966 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:42:00,969 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:42:00,974 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:42:00,974 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:42:00,980 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:42:00,980 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:42:01,167 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.80875494856212402584383177% which is below threshold 100.0%
2025-07-22 21:42:01,168 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100794.1400000000000000000000', 'margin': '146484.47', 'free_margin': '-45690.3300000000000000000000', 'profit_loss': '-83551.67000000000000000000000', 'margin_level': '68.80875494856212402584383177', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-93.65000000000000000000000000', 'current_price': '39.2270000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83458.02000000000000000000000', 'current_price': '118792.5000000000'}], 'margin_call': True}
2025-07-22 21:42:01,170 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.80875494856212402584383177
2025-07-22 21:42:01,172 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:42:01,172 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:42:01,213 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:01,214 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:42:01,241 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:01,241 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:42:01,281 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:01,281 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:42:01,282 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:42:01,282 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:42:01,288 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:42:01,290 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:42:01,291 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:42:01,319 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:01,320 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:42:01,321 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:42:01,321 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:42:01,322 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:42:01,322 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:42:01,493 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:42:01,494 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:42:02,454 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:42:02,456 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:42:02,457 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:42:02,457 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:42:02,575 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:42:02,576 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:42:02,907 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:42:02,913 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:42:02,913 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:42:02,914 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:42:03,073 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:42:03,074 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:42:03,379 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:42:03,383 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:42:03,383 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:42:03,383 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:42:03,447 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:03,447 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:42:03,511 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:13,486 - INFO - app - Starting stale cache cleanup task
2025-07-22 21:42:13,487 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 21:42:13,490 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 21:42:13,492 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 21:42:13,493 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 21:42:13,493 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 21:42:13,494 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 21:42:13,495 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 21:42:13,495 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 21:42:13,496 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 21:42:13,496 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 21:42:13,496 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 21:42:13,497 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 21:42:13,497 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 21:42:13,498 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 21:42:13,499 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 21:42:13,500 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 21:42:13,501 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 21:42:13,502 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 21:42:13,503 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 21:42:13,504 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 21:42:13,505 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 21:42:13,505 - INFO - app - Completed stale cache cleanup task
2025-07-22 21:42:33,539 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:42:33,539 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:42:33,539 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:42:33,539 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:42:33,547 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:42:33,547 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:42:33,547 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:42:33,552 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:42:33,552 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:42:33,563 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:42:33,567 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:42:33,567 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:42:33,677 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:42:33,995 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:42:33,996 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:42:33,998 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:42:33,999 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:42:33,999 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352915'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352915'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352755'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352755'}], 'margin_call': False}
2025-07-22 21:42:34,000 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:42:34,002 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:42:34,002 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:42:34,056 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:34,056 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:42:34,132 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:34,132 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:42:34,199 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:34,199 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:42:34,397 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:42:34,713 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.956267159907141313951375348% which is below threshold 100.0%
2025-07-22 21:42:34,714 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '375.626598617235559910719147', 'margin': '9494.47', 'free_margin': '-9118.843401382764440089280853', 'profit_loss': '-9526.393401382764440089280853', 'margin_level': '3.956267159907141313951375348', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9478.210000000000000000000000', 'current_price': '118801.9000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-43.80309216614949099025532147', 'current_price': '96.468'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.380309216614949099025532147', 'current_price': '96.468'}], 'margin_call': True}
2025-07-22 21:42:34,716 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.956267159907141313951375348
2025-07-22 21:42:34,810 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:42:34,810 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:42:34,845 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:34,845 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:42:34,875 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:34,875 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:42:34,912 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:34,912 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:42:34,956 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:34,956 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:42:34,998 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:34,998 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:42:35,039 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:35,040 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:42:35,082 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:35,082 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:42:35,121 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:35,121 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:42:35,261 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:42:35,574 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.168112494988730961388803730% which is below threshold 100.0%
2025-07-22 21:42:35,575 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '247.445000000000000000000000', 'margin': '5936.62', 'free_margin': '-5689.175000000000000000000000', 'profit_loss': '-6142.175000000000000000000000', 'margin_level': '4.168112494988730961388803730', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6142.175000000000000000000000', 'current_price': '118801.9000000000'}], 'margin_call': True}
2025-07-22 21:42:35,579 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.168112494988730961388803730
2025-07-22 21:42:35,640 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:42:35,642 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:42:35,823 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:42:36,190 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.84573839124379533202393400% which is below threshold 100.0%
2025-07-22 21:42:36,190 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100848.3150000000000000000000', 'margin': '146484.47', 'free_margin': '-45636.1550000000000000000000', 'profit_loss': '-83497.49500000000000000000000', 'margin_level': '68.84573839124379533202393400', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-95.875000000000000000000000', 'current_price': '39.1825'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83401.62000000000000000000000', 'current_price': '118801.9000000000'}], 'margin_call': True}
2025-07-22 21:42:36,193 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.84573839124379533202393400
2025-07-22 21:42:36,195 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:42:36,196 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:42:36,249 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:36,249 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:42:36,291 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:36,291 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:42:36,331 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:36,331 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:42:36,333 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:42:36,333 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:42:36,347 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:42:36,349 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:42:36,349 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:42:36,393 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:36,393 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:42:36,395 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:42:36,395 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:42:36,397 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:42:36,397 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:42:36,546 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:42:36,546 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:42:36,879 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:42:36,881 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:42:36,884 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:42:36,884 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:42:37,117 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:42:37,118 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:42:37,429 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:42:37,432 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:42:37,432 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:42:37,432 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:42:37,546 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:42:37,547 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:42:37,849 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:42:37,852 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:42:37,853 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:42:37,853 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:42:37,888 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:37,888 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:42:37,920 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:42:56,713 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:42:57,079 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:43:04,409 - INFO - app - Application shutdown initiated
2025-07-22 21:43:04,409 - INFO - app - Scheduler shutdown completed
2025-07-22 21:43:05,607 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 21:43:06,977 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 21:43:06,978 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 21:43:06,987 - INFO - app - Redis connection closed
2025-07-22 21:43:06,987 - INFO - app - Application shutdown completed
2025-07-22 21:43:08,617 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:43:08,645 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:43:08,658 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:43:08,658 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:43:08,947 - INFO - app - Application starting up - Trading system initialized
2025-07-22 21:43:08,947 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 21:43:08,947 - INFO - app - Environment: PRODUCTION
2025-07-22 21:43:09,006 - INFO - app - Application startup initiated
2025-07-22 21:43:09,006 - INFO - app - Initializing core services...
2025-07-22 21:43:09,038 - INFO - app - Firebase initialized
2025-07-22 21:43:09,039 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 21:43:09,058 - INFO - app - Redis initialized
2025-07-22 21:43:09,681 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 21:43:09,687 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 21:43:09,689 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 21:43:09,689 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 21:43:09,689 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 21:43:09,690 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 21:43:09,690 - INFO - app - Scheduler initialized
2025-07-22 21:43:09,692 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:43:09,692 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 21:43:10,905 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:43:10,907 - INFO - app - Starting stale cache cleanup task
2025-07-22 21:43:10,945 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 21:43:10,945 - INFO - app - Background tasks initialized
2025-07-22 21:43:10,945 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:43:11,612 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:43:11,612 - INFO - app - Application startup completed successfully
2025-07-22 21:43:11,627 - INFO - app - Starting cache validation task
2025-07-22 21:43:11,630 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 21:43:11,632 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 21:43:11,635 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 21:43:11,635 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:43:11,635 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:43:11,635 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:43:11,635 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:43:11,674 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 21:43:11,676 - INFO - app - Validating cache for 30 users
2025-07-22 21:43:11,679 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:43:11,679 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:43:11,679 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:43:11,707 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:43:11,707 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:43:11,716 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 21:43:11,718 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 21:43:11,721 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 21:43:11,722 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 21:43:11,723 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 21:43:11,723 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 21:43:11,724 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 21:43:11,725 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 21:43:11,726 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 21:43:11,727 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 21:43:11,728 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 21:43:11,730 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 21:43:11,731 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 21:43:11,731 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:43:11,732 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 21:43:11,734 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 21:43:11,735 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 21:43:11,736 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:43:11,736 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:43:11,736 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 21:43:11,737 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 21:43:11,737 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 21:43:11,739 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 21:43:11,739 - INFO - app - Completed stale cache cleanup task
2025-07-22 21:43:11,765 - INFO - app - Cache validation completed
2025-07-22 21:43:11,837 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:43:12,182 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:43:12,185 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:43:12,188 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:43:12,190 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:43:12,191 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352815'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352815'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352655'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352655'}], 'margin_call': False}
2025-07-22 21:43:12,193 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:43:12,195 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:43:12,195 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:43:12,239 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:12,239 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:43:12,281 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:12,282 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:43:12,323 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:12,324 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:43:12,509 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:43:12,819 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.969738896349036884826570077% which is below threshold 100.0%
2025-07-22 21:43:12,819 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '376.905668592190402318793248', 'margin': '9494.47', 'free_margin': '-9117.564331407809597681206752', 'profit_loss': '-9525.114331407809597681206752', 'margin_level': '3.969738896349036884826570077', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9478.210000000000000000000000', 'current_price': '118801.9000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.64030127982690698291522933', 'current_price': '96.485'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.264030127982690698291522933', 'current_price': '96.485'}], 'margin_call': True}
2025-07-22 21:43:12,822 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.969738896349036884826570077
2025-07-22 21:43:12,867 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:43:12,867 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:43:12,909 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:12,909 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:43:12,952 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:12,952 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:43:12,988 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:12,988 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:43:13,017 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:13,017 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:43:13,046 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:13,047 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:43:13,081 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:13,081 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:43:13,111 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:13,111 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:43:13,141 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:13,141 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:43:13,270 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:43:13,564 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.168112494988730961388803730% which is below threshold 100.0%
2025-07-22 21:43:13,564 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '247.445000000000000000000000', 'margin': '5936.62', 'free_margin': '-5689.175000000000000000000000', 'profit_loss': '-6142.175000000000000000000000', 'margin_level': '4.168112494988730961388803730', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6142.175000000000000000000000', 'current_price': '118801.9000000000'}], 'margin_call': True}
2025-07-22 21:43:13,566 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.168112494988730961388803730
2025-07-22 21:43:13,602 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:43:13,602 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:43:13,634 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:43:13,657 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:43:13,703 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:43:13,812 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:43:13,813 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:43:13,855 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:43:13,859 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:43:13,869 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:43:14,018 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:43:14,019 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:43:14,033 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:43:14,033 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:43:14,041 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:43:14,041 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:43:14,050 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:43:14,069 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:43:14,069 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:43:14,098 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:43:14,107 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:43:14,111 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:43:14,111 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:43:14,122 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:43:14,123 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:43:14,130 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:43:14,142 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:43:14,143 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:43:14,143 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:43:14,151 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:43:14,151 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:43:14,187 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.84614799097815625096639937% which is below threshold 100.0%
2025-07-22 21:43:14,188 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100848.9150000000000000000000', 'margin': '146484.47', 'free_margin': '-45635.5550000000000000000000', 'profit_loss': '-83496.89500000000000000000000', 'margin_level': '68.84614799097815625096639937', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-95.275000000000000000000000', 'current_price': '39.1945'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83401.62000000000000000000000', 'current_price': '118801.9000000000'}], 'margin_call': True}
2025-07-22 21:43:14,191 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.84614799097815625096639937
2025-07-22 21:43:14,193 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:43:14,193 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:43:14,238 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:14,239 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:43:14,303 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:14,303 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:43:14,358 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:14,358 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:43:14,359 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:43:14,359 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:43:14,371 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:43:14,373 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:43:14,373 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:43:14,404 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:14,405 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:43:14,407 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:43:14,407 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:43:14,408 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:43:14,408 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:43:14,527 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:43:14,528 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:43:15,408 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:43:15,413 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:43:15,415 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:43:15,415 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:43:15,562 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:43:15,563 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:43:16,229 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:43:16,237 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:43:16,237 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:43:16,237 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:43:16,381 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:43:16,384 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:43:16,756 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:43:16,763 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:43:16,763 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:43:16,763 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:43:16,828 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:16,828 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:43:16,870 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:26,629 - INFO - app - Starting stale cache cleanup task
2025-07-22 21:43:26,631 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 21:43:26,636 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 21:43:26,638 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 21:43:26,640 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 21:43:26,642 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 21:43:26,643 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 21:43:26,644 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 21:43:26,646 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 21:43:26,648 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 21:43:26,650 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 21:43:26,651 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 21:43:26,652 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 21:43:26,654 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 21:43:26,656 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 21:43:26,657 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 21:43:26,660 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 21:43:26,663 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 21:43:26,664 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 21:43:26,665 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 21:43:26,667 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 21:43:26,672 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 21:43:26,672 - INFO - app - Completed stale cache cleanup task
2025-07-22 21:43:46,881 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:43:46,881 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:43:46,882 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:43:46,882 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:43:46,895 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:43:46,895 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:43:46,896 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:43:46,907 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:43:46,908 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:43:46,930 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:43:46,934 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:43:46,934 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:43:47,084 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:43:47,461 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:43:47,464 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:43:47,466 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:43:47,467 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:43:47,468 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352835'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352835'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3526749999999998'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3526749999999998'}], 'margin_call': False}
2025-07-22 21:43:47,469 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:43:47,470 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:43:47,470 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:43:47,516 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:47,516 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:43:47,554 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:47,554 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:43:47,593 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:47,593 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:43:47,704 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:43:48,078 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.791736001168839179322411551% which is below threshold 100.0%
2025-07-22 21:43:48,078 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '360.005237110175085229012568', 'margin': '9494.47', 'free_margin': '-9134.464762889824914770987432', 'profit_loss': '-9542.014762889824914770987432', 'margin_level': '3.791736001168839179322411551', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9495.330000000000000000000000', 'current_price': '118759.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.44069353620446797362493791', 'current_price': '96.488'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.244069353620446797362493791', 'current_price': '96.488'}], 'margin_call': True}
2025-07-22 21:43:48,080 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.791736001168839179322411551
2025-07-22 21:43:48,127 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:43:48,127 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:43:48,197 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:48,197 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:43:48,278 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:48,278 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:43:48,337 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:48,337 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:43:48,392 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:48,392 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:43:48,450 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:48,450 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:43:48,506 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:48,506 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:43:48,561 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:48,561 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:43:48,617 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:48,617 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:43:48,820 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:43:49,180 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.096017599239971566312143947% which is below threshold 100.0%
2025-07-22 21:43:49,181 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '243.165000000000000000000000', 'margin': '5936.62', 'free_margin': '-5693.455000000000000000000000', 'profit_loss': '-6146.455000000000000000000000', 'margin_level': '4.096017599239971566312143947', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6146.455000000000000000000000', 'current_price': '118759.1'}], 'margin_call': True}
2025-07-22 21:43:49,184 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.096017599239971566312143947
2025-07-22 21:43:49,234 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:43:49,234 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:43:49,445 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:43:49,815 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.67104410453886340306245433% which is below threshold 100.0%
2025-07-22 21:43:49,815 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100592.4150000000000000000000', 'margin': '146484.47', 'free_margin': '-45892.0550000000000000000000', 'profit_loss': '-83753.39500000000000000000000', 'margin_level': '68.67104410453886340306245433', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.975000000000000000000000', 'current_price': '39.2005'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83658.42000000000000000000000', 'current_price': '118759.1'}], 'margin_call': True}
2025-07-22 21:43:49,818 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.67104410453886340306245433
2025-07-22 21:43:49,819 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:43:49,820 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:43:49,867 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:49,867 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:43:49,921 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:49,921 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:43:49,975 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:49,975 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:43:49,977 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:43:49,977 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:43:49,991 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:43:49,993 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:43:49,993 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:43:50,037 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:50,038 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:43:50,040 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:43:50,040 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:43:50,042 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:43:50,043 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:43:50,181 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:43:50,182 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:43:50,533 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:43:50,536 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:43:50,538 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:43:50,538 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:43:50,674 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:43:50,675 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:43:51,043 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:43:51,046 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:43:51,046 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:43:51,046 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:43:51,239 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:43:51,240 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:43:51,555 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:43:51,559 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:43:51,559 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:43:51,560 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:43:51,619 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:51,619 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:43:51,666 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:43:58,608 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 21:43:58,625 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 21:43:58,625 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 21:43:58,626 - INFO - app - Application shutdown initiated
2025-07-22 21:43:58,627 - INFO - app - Scheduler shutdown completed
2025-07-22 21:43:58,649 - INFO - app - Redis connection closed
2025-07-22 21:43:58,650 - INFO - app - Application shutdown completed
2025-07-22 21:45:31,804 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:45:31,833 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:45:31,846 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:45:31,846 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:45:32,098 - INFO - app - Application starting up - Trading system initialized
2025-07-22 21:45:32,099 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 21:45:32,099 - INFO - app - Environment: PRODUCTION
2025-07-22 21:45:32,160 - INFO - app - Application startup initiated
2025-07-22 21:45:32,160 - INFO - app - Initializing core services...
2025-07-22 21:45:32,191 - INFO - app - Firebase initialized
2025-07-22 21:45:32,191 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 21:45:32,213 - INFO - app - Redis initialized
2025-07-22 21:45:33,078 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 21:45:33,082 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 21:45:33,084 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 21:45:33,084 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 21:45:33,084 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 21:45:33,085 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 21:45:33,085 - INFO - app - Scheduler initialized
2025-07-22 21:45:33,086 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:45:33,087 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 21:45:34,164 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 21:45:34,175 - INFO - app - Starting stale cache cleanup task
2025-07-22 21:45:34,216 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 21:45:34,216 - INFO - app - Background tasks initialized
2025-07-22 21:45:34,216 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 21:45:34,828 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 21:45:34,828 - INFO - app - Application startup completed successfully
2025-07-22 21:45:34,828 - INFO - app - Starting cache validation task
2025-07-22 21:45:34,833 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 21:45:34,836 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 21:45:34,839 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 21:45:34,839 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:45:34,839 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:45:34,839 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:45:34,839 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:45:34,857 - INFO - app - Validating cache for 30 users
2025-07-22 21:45:34,860 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:45:34,860 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:45:34,860 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:45:34,861 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 21:45:34,883 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:45:34,884 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:45:34,890 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 21:45:34,900 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 21:45:34,903 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 21:45:34,904 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 21:45:34,905 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:45:34,906 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 21:45:34,910 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:45:34,910 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:45:34,910 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 21:45:34,911 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 21:45:34,912 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 21:45:34,914 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 21:45:34,915 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 21:45:34,917 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 21:45:34,919 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 21:45:34,920 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 21:45:34,921 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 21:45:34,924 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 21:45:34,925 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 21:45:34,926 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 21:45:34,927 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 21:45:34,928 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 21:45:34,935 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 21:45:34,935 - INFO - app - Completed stale cache cleanup task
2025-07-22 21:45:34,964 - INFO - app - Cache validation completed
2025-07-22 21:45:35,076 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:45:35,374 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:45:35,377 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:45:35,381 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:45:35,382 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:45:35,382 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3527600000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3527600000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3527500000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3527500000'}], 'margin_call': False}
2025-07-22 21:45:35,385 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:45:35,386 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:45:35,386 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:45:35,400 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:35,400 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:45:35,414 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:35,414 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:45:35,428 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:35,429 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:45:35,585 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:45:35,883 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.014191409749152247760311265% which is below threshold 100.0%
2025-07-22 21:45:35,883 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '381.126199141210335417928425', 'margin': '9494.47', 'free_margin': '-9113.343800858789664582071575', 'profit_loss': '-9520.893800858789664582071575', 'margin_level': '4.014191409749152247760311265', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9475.330000000000000000000000', 'current_price': '118809.1000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-41.42163714435424052915597716', 'current_price': '96.5030000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.142163714435424052915597716', 'current_price': '96.5030000000'}], 'margin_call': True}
2025-07-22 21:45:35,885 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 4.014191409749152247760311265
2025-07-22 21:45:35,909 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:45:35,910 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:45:35,932 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:35,932 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:45:35,954 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:35,954 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:45:35,977 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:35,977 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:45:35,998 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:35,998 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:45:36,018 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:36,018 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:45:36,041 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:36,041 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:45:36,061 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:36,061 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:45:36,081 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:36,081 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:45:36,204 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:45:36,501 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.180240608292260579252167058% which is below threshold 100.0%
2025-07-22 21:45:36,501 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '248.165000000000000000000000', 'margin': '5936.62', 'free_margin': '-5688.455000000000000000000000', 'profit_loss': '-6141.455000000000000000000000', 'margin_level': '4.180240608292260579252167058', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6141.455000000000000000000000', 'current_price': '118809.1000000000'}], 'margin_call': True}
2025-07-22 21:45:36,503 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.180240608292260579252167058
2025-07-22 21:45:36,535 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:45:36,535 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:45:36,584 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:45:36,595 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:45:36,603 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:45:36,614 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:45:36,613 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:45:36,639 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 21:45:36,813 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:45:36,913 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:45:36,928 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:45:36,942 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:45:36,943 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:45:36,952 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:45:36,950 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:45:36,958 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:45:36,959 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:45:36,959 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:45:36,975 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:45:36,976 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:45:36,977 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:45:36,979 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:45:36,979 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:45:36,979 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:45:36,979 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:45:36,998 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:45:36,998 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:45:37,006 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 21:45:37,045 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 21:45:37,045 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 21:45:37,108 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.87627063810928216486020668% which is below threshold 100.0%
2025-07-22 21:45:37,108 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100893.0400000000000000000000', 'margin': '146484.47', 'free_margin': '-45591.4300000000000000000000', 'profit_loss': '-83452.77000000000000000000000', 'margin_level': '68.87627063810928216486020668', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.35000000000000000000000000', 'current_price': '39.2130000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83358.42000000000000000000000', 'current_price': '118809.1000000000'}], 'margin_call': True}
2025-07-22 21:45:37,110 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.87627063810928216486020668
2025-07-22 21:45:37,111 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:45:37,111 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:45:37,131 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:37,131 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:45:37,148 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:37,148 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:45:37,173 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:37,173 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:45:37,173 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:45:37,174 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:45:37,180 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:45:37,181 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:45:37,182 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:45:37,202 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:37,202 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:45:37,203 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:45:37,203 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:45:37,203 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:45:37,204 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:45:37,298 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:45:37,299 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:45:37,741 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:45:37,742 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:45:37,743 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:45:37,743 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:45:37,852 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:45:37,853 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:45:38,158 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:45:38,160 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:45:38,160 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:45:38,160 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:45:38,269 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:45:38,272 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:45:38,579 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:45:38,582 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:45:38,582 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:45:38,583 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:45:38,615 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:38,615 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:45:38,686 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:45:49,839 - INFO - app - Starting stale cache cleanup task
2025-07-22 21:45:49,842 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 21:45:49,852 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 21:45:49,856 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 21:45:49,859 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 21:45:49,861 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 21:45:49,863 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 21:45:49,866 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 21:45:49,869 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 21:45:49,872 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 21:45:49,873 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 21:45:49,876 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 21:45:49,879 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 21:45:49,881 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 21:45:49,883 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 21:45:49,886 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 21:45:49,889 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 21:45:49,892 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 21:45:49,894 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 21:45:49,897 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 21:45:49,900 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 21:45:49,904 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 21:45:49,904 - INFO - app - Completed stale cache cleanup task
2025-07-22 21:46:08,696 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:46:08,696 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 21:46:08,697 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 21:46:08,697 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 21:46:08,704 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 21:46:08,705 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 21:46:08,705 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 21:46:08,710 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 21:46:08,710 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 21:46:08,723 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:46:08,725 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 21:46:08,725 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 21:46:08,789 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:46:09,191 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:46:09,198 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:46:09,204 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:46:09,218 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 21:46:09,218 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3528850000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3528850000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352705'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352705'}], 'margin_call': False}
2025-07-22 21:46:09,221 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:46:09,224 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:46:09,224 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 21:46:09,254 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,254 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 21:46:09,277 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,277 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 21:46:09,296 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,296 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 21:46:09,361 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 21:46:09,696 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.902127173787548746355844665% which is below threshold 100.0%
2025-07-22 21:46:09,696 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '370.486293877106679458131765', 'margin': '9494.47', 'free_margin': '-9123.983706122893320541868235', 'profit_loss': '-9531.533706122893320541868235', 'margin_level': '3.902127173787548746355844665', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9484.330000000000000000000000', 'current_price': '118786.6000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.91246011172120049260748573', 'current_price': '96.481'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.291246011172120049260748573', 'current_price': '96.481'}], 'margin_call': True}
2025-07-22 21:46:09,698 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.902127173787548746355844665
2025-07-22 21:46:09,725 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 21:46:09,725 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 21:46:09,740 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,740 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 21:46:09,757 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,757 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 21:46:09,773 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,773 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 21:46:09,798 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,798 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 21:46:09,819 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,819 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 21:46:09,835 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,835 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 21:46:09,849 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,849 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 21:46:09,862 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:09,862 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 21:46:09,904 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 21:46:10,303 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.142340254218730523429156658% which is below threshold 100.0%
2025-07-22 21:46:10,304 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '245.915000000000000000000000', 'margin': '5936.62', 'free_margin': '-5690.705000000000000000000000', 'profit_loss': '-6143.705000000000000000000000', 'margin_level': '4.142340254218730523429156658', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6143.705000000000000000000000', 'current_price': '118786.6000000000'}], 'margin_call': True}
2025-07-22 21:46:10,305 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.142340254218730523429156658
2025-07-22 21:46:10,321 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 21:46:10,321 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 21:46:10,388 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 21:46:10,726 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.78368403148811611224043068% which is below threshold 100.0%
2025-07-22 21:46:10,727 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100757.4150000000000000000000', 'margin': '146484.47', 'free_margin': '-45727.0550000000000000000000', 'profit_loss': '-83588.39500000000000000000000', 'margin_level': '68.78368403148811611224043068', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.975000000000000000000000', 'current_price': '39.2005'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83493.42000000000000000000000', 'current_price': '118786.6000000000'}], 'margin_call': True}
2025-07-22 21:46:10,731 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.78368403148811611224043068
2025-07-22 21:46:10,734 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 21:46:10,735 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 21:46:10,801 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:10,801 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 21:46:10,841 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:10,841 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 21:46:10,879 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:10,879 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 21:46:10,881 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 21:46:10,882 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 21:46:10,892 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 21:46:10,895 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 21:46:10,895 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 21:46:10,929 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:10,929 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 21:46:10,930 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 21:46:10,930 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 21:46:10,931 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 21:46:10,931 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 21:46:11,044 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 21:46:11,045 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 21:46:11,433 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 21:46:11,436 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 21:46:11,440 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 21:46:11,440 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 21:46:11,586 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 21:46:11,586 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 21:46:11,910 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:46:11,914 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 21:46:11,915 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 21:46:11,915 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 21:46:12,032 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 21:46:12,033 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 21:46:12,351 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 21:46:12,353 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 21:46:12,353 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 21:46:12,353 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 21:46:12,390 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:12,390 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 21:46:12,419 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 21:46:27,391 - INFO - app - Application shutdown initiated
2025-07-22 21:46:27,391 - INFO - app - Scheduler shutdown completed
2025-07-22 21:46:27,409 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 21:46:29,762 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 21:46:29,762 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 21:46:29,764 - INFO - app - Redis connection closed
2025-07-22 21:46:29,764 - INFO - app - Application shutdown completed
2025-07-22 22:13:59,659 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:13:59,699 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:13:59,720 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:13:59,720 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:22,758 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:22,783 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:22,799 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:22,800 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:23,347 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:14:23,347 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:14:23,347 - INFO - app - Environment: PRODUCTION
2025-07-22 22:14:23,407 - INFO - app - Application startup initiated
2025-07-22 22:14:23,407 - INFO - app - Initializing core services...
2025-07-22 22:14:23,464 - INFO - app - Firebase initialized
2025-07-22 22:14:23,464 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:14:23,496 - INFO - app - Redis initialized
2025-07-22 22:14:24,153 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:14:24,157 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:14:24,160 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:14:24,161 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:14:24,161 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:14:24,162 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:14:24,162 - INFO - app - Scheduler initialized
2025-07-22 22:14:24,164 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:14:24,164 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:14:25,037 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:14:25,052 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:14:25,089 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:14:25,089 - INFO - app - Background tasks initialized
2025-07-22 22:14:25,089 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:14:25,698 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:14:25,698 - INFO - app - Application startup completed successfully
2025-07-22 22:14:25,700 - INFO - app - Starting cache validation task
2025-07-22 22:14:25,702 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:14:25,704 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:14:25,706 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:14:25,706 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:14:25,706 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:14:25,706 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:14:25,706 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:14:25,720 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:14:27,226 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:14:27,226 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:14:27,227 - INFO - app - Application shutdown initiated
2025-07-22 22:14:27,227 - INFO - app - Scheduler shutdown completed
2025-07-22 22:14:27,239 - INFO - app - Redis connection closed
2025-07-22 22:14:27,239 - INFO - app - Application shutdown completed
2025-07-22 22:14:29,220 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:29,261 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:29,284 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:29,284 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:29,846 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:14:29,846 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:14:29,846 - INFO - app - Environment: PRODUCTION
2025-07-22 22:14:29,954 - INFO - app - Application startup initiated
2025-07-22 22:14:29,955 - INFO - app - Initializing core services...
2025-07-22 22:14:30,004 - INFO - app - Firebase initialized
2025-07-22 22:14:30,004 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:14:30,047 - INFO - app - Redis initialized
2025-07-22 22:14:33,063 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:14:33,073 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:14:33,076 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:14:33,076 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:14:33,077 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:14:33,078 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:14:33,078 - INFO - app - Scheduler initialized
2025-07-22 22:14:33,080 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:14:33,080 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:14:33,968 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:14:34,048 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:14:34,591 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:14:34,591 - INFO - app - Background tasks initialized
2025-07-22 22:14:34,592 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:14:35,213 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:14:35,213 - INFO - app - Application startup completed successfully
2025-07-22 22:14:35,215 - INFO - app - Starting cache validation task
2025-07-22 22:14:35,230 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:14:35,236 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:14:35,243 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:14:35,244 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:14:35,244 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:14:35,244 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:14:35,244 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:14:35,398 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:14:35,410 - INFO - app - Validating cache for 30 users
2025-07-22 22:14:35,413 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:14:35,414 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:14:35,414 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:14:35,773 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 22:14:35,801 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:14:35,801 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:14:35,828 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:14:35,830 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 22:14:35,836 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:14:35,839 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:14:35,849 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:14:35,855 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:14:35,857 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:14:35,861 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:14:35,863 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:14:35,865 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:14:35,865 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 22:14:35,869 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:14:35,872 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:14:35,883 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:14:35,888 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:14:35,890 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:14:35,892 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:14:35,899 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:14:35,901 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:14:35,901 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:14:35,905 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:14:35,907 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 22:14:35,909 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 22:14:35,910 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:14:35,914 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:14:35,926 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:14:35,926 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:14:35,932 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 22:14:35,959 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,004 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,034 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,053 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,071 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,090 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,113 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,132 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,151 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,178 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,209 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,229 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,253 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,285 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,366 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,742 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,873 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 22:14:36,924 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 22:14:37,055 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 22:14:37,475 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 22:14:37,666 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 22:14:37,821 - INFO - app - Cache validation completed
2025-07-22 22:14:37,868 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:14:38,233 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:14:38,268 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:14:38,303 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:14:38,325 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:14:38,325 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3529200000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3529200000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3529100000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3529100000'}], 'margin_call': False}
2025-07-22 22:14:38,333 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:14:38,335 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:14:38,336 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:14:38,557 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:38,558 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:14:38,706 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:38,707 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:14:38,803 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:38,804 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:14:38,823 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 0 symbols for user 30
2025-07-22 22:14:38,824 - INFO - app.api.v1.endpoints.favorites - Symbols: []
2025-07-22 22:14:39,549 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:14:39,879 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.724973650368283763767095667% which is below threshold 100.0%
2025-07-22 22:14:39,879 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '353.666505742121591465737768', 'margin': '9494.47', 'free_margin': '-9140.803494257878408534262232', 'profit_loss': '-9548.353494257878408534262232', 'margin_level': '3.724973650368283763767095667', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9502.650000000000000000000000', 'current_price': '118740.8000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-41.54863114352582594023839329', 'current_price': '96.5010000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.154863114352582594023839329', 'current_price': '96.5010000000'}], 'margin_call': True}
2025-07-22 22:14:39,884 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.724973650368283763767095667
2025-07-22 22:14:39,950 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:14:39,950 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:14:40,008 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:40,009 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:14:40,085 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:40,086 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:14:40,154 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:40,154 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:14:40,252 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:40,253 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:14:40,318 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:40,318 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:14:40,389 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:40,389 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:14:40,462 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:40,462 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:14:40,528 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:40,528 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:14:40,983 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:40,984 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:40,986 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:14:40,987 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:41,076 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:41,108 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:41,124 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:41,141 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:14:41,295 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.065191977926833787576095489% which is below threshold 100.0%
2025-07-22 22:14:41,295 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '241.335000000000000000000000', 'margin': '5936.62', 'free_margin': '-5695.285000000000000000000000', 'profit_loss': '-6148.285000000000000000000000', 'margin_level': '4.065191977926833787576095489', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6148.285000000000000000000000', 'current_price': '118740.8000000000'}], 'margin_call': True}
2025-07-22 22:14:41,310 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.065191977926833787576095489
2025-07-22 22:14:41,391 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:14:41,392 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:14:41,496 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:41,503 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:41,505 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:41,517 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:41,522 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:41,523 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:41,524 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:41,524 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:41,533 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:41,533 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:41,545 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:41,546 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:41,590 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:41,629 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:41,630 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:41,676 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:41,689 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:14:41,711 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:41,711 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:41,717 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:14:41,717 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:14:41,789 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:14:42,092 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.59627508636239732443992186% which is below threshold 100.0%
2025-07-22 22:14:42,093 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100482.8900000000000000000000', 'margin': '146484.47', 'free_margin': '-46001.5800000000000000000000', 'profit_loss': '-83862.92000000000000000000000', 'margin_level': '68.59627508636239732443992186', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.70000000000000000000000000', 'current_price': '39.2060000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83768.22000000000000000000000', 'current_price': '118740.8000000000'}], 'margin_call': True}
2025-07-22 22:14:42,095 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.59627508636239732443992186
2025-07-22 22:14:42,097 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:14:42,097 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:14:42,147 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:42,147 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:14:42,181 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:42,181 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:14:42,218 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:42,218 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:14:42,222 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:14:42,222 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:14:42,237 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:14:42,239 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:14:42,240 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:14:42,297 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:42,297 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:14:42,299 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:14:42,299 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:14:42,300 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:14:42,300 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:14:42,494 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:14:42,495 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:14:42,961 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:14:42,963 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:14:42,964 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:14:42,964 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:14:43,083 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:14:43,084 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:14:43,383 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:14:43,385 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:14:43,385 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:14:43,385 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:14:43,540 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:14:43,541 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:14:43,842 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:14:43,844 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:14:43,844 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:14:43,844 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:14:43,876 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:43,876 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:14:43,902 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:14:49,555 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 30 by invalidating refresh token.
2025-07-22 22:14:50,220 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:14:50,227 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:14:50,229 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:14:50,230 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:14:50,231 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:14:50,232 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:14:50,233 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:14:50,234 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:14:50,234 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:14:50,235 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:14:50,235 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:14:50,236 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:14:50,238 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:14:50,239 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:14:50,240 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:14:50,241 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:14:50,242 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:14:50,243 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:14:50,244 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 22:14:50,245 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:14:50,246 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:14:50,247 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:14:50,247 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:14:54,175 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 1 symbols for user 1
2025-07-22 22:14:54,176 - INFO - app.api.v1.endpoints.favorites - Symbols: ['AUDCAD']
2025-07-22 22:15:13,904 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:15:13,904 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:15:13,904 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:15:13,905 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:15:13,914 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:15:13,914 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:15:13,914 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:15:13,922 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:15:13,922 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:15:13,939 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:15:13,943 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:15:13,944 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:15:14,158 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:15:14,477 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:15:14,482 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:15:14,488 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:15:14,491 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:15:14,492 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352795'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352795'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352635'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352635'}], 'margin_call': False}
2025-07-22 22:15:14,494 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:15:14,496 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:15:14,496 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:15:14,546 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:15:14,547 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:15:14,605 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:15:14,605 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:15:14,654 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:15:14,654 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:15:14,730 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:15:15,033 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.706450187542964187449079980% which is below threshold 100.0%
2025-07-22 22:15:15,033 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '351.907801121210471888096664', 'margin': '9494.47', 'free_margin': '-9142.562198878789528111903336', 'profit_loss': '-9550.112198878789528111903336', 'margin_level': '3.706450187542964187449079980', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9503.810000000000000000000000', 'current_price': '118737.9'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.09290807162684373809394220', 'current_price': '96.493'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.209290807162684373809394220', 'current_price': '96.493'}], 'margin_call': True}
2025-07-22 22:15:15,034 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.706450187542964187449079980
2025-07-22 22:15:15,054 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:15:15,054 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:15:15,075 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:15:15,075 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:15:15,089 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:15:15,089 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:15:15,107 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:15:15,107 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:15:15,215 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:15:15,215 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:15:15,239 - INFO - app - Application shutdown initiated
2025-07-22 22:15:15,239 - INFO - app - Scheduler shutdown completed
2025-07-22 22:15:15,628 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:15:16,025 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:15:16,025 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:15:16,028 - INFO - app - Redis connection closed
2025-07-22 22:15:16,028 - INFO - app - Application shutdown completed
2025-07-22 22:29:58,835 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:29:58,869 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:29:58,884 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:29:58,885 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:29:59,211 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:29:59,212 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:29:59,212 - INFO - app - Environment: PRODUCTION
2025-07-22 22:29:59,256 - INFO - app - Application startup initiated
2025-07-22 22:29:59,256 - INFO - app - Initializing core services...
2025-07-22 22:29:59,292 - INFO - app - Firebase initialized
2025-07-22 22:29:59,293 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:29:59,313 - INFO - app - Redis initialized
2025-07-22 22:29:59,909 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:29:59,912 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:29:59,914 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:29:59,915 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:29:59,915 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:29:59,915 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:29:59,915 - INFO - app - Scheduler initialized
2025-07-22 22:29:59,917 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:29:59,917 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:30:00,801 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:30:00,803 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:30:00,844 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:30:00,844 - INFO - app - Background tasks initialized
2025-07-22 22:30:00,844 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:30:01,442 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:30:01,442 - INFO - app - Application startup completed successfully
2025-07-22 22:30:01,442 - INFO - app - Starting cache validation task
2025-07-22 22:30:01,445 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:30:01,446 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:30:01,449 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:30:01,449 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:30:01,449 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:30:01,449 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:30:01,449 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:30:01,495 - INFO - app - Found 25 static orders cache entries to check
2025-07-22 22:30:01,500 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:30:01,501 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:30:01,501 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:30:01,502 - INFO - app - Validating cache for 30 users
2025-07-22 22:30:01,513 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,520 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:30:01,520 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:30:01,538 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,540 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:30:01,548 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:30:01,554 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:30:01,574 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:30:01,579 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:30:01,582 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:30:01,586 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:30:01,587 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:30:01,591 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,592 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:30:01,602 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:30:01,607 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:30:01,607 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:30:01,610 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:30:01,614 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:30:01,621 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:30:01,626 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:30:01,633 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:30:01,647 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:30:01,657 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 22:30:01,662 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:30:01,668 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:30:01,673 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,674 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:30:01,674 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:30:01,732 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,795 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,831 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,850 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,867 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,882 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,898 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,915 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,931 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,943 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,955 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 22:30:01,987 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,006 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,020 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:30:02,026 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,318 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:30:02,323 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:30:02,326 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:30:02,331 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:30:02,331 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3527100000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3527100000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3527000000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3527000000'}], 'margin_call': False}
2025-07-22 22:30:02,333 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:30:02,335 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:30:02,335 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:30:02,335 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,360 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,391 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:02,391 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:30:02,409 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,446 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,468 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,482 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:02,482 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:30:02,489 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,513 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 22:30:02,515 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:02,515 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:30:02,532 - INFO - app - Cache validation completed
2025-07-22 22:30:02,761 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:30:03,053 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.929023598013728038132716866% which is below threshold 100.0%
2025-07-22 22:30:03,053 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '373.039966806334004462099363', 'margin': '9494.47', 'free_margin': '-9121.430033193665995537900637', 'profit_loss': '-9528.980033193665995537900637', 'margin_level': '3.929023598013728038132716866', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9483.810000000000000000000000', 'current_price': '118787.9000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-41.06366653969635957990966970', 'current_price': '96.5080000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.106366653969635957990966970', 'current_price': '96.5080000000'}], 'margin_call': True}
2025-07-22 22:30:03,054 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.929023598013728038132716866
2025-07-22 22:30:03,089 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:30:03,089 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:30:03,127 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:03,127 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:30:03,215 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:03,215 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:30:03,239 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:03,240 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:30:03,264 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:03,265 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:30:03,286 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:03,286 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:30:03,310 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:03,310 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:30:03,331 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:03,331 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:30:03,353 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:03,353 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:30:03,501 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:30:03,840 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.144530052454090037765597259% which is below threshold 100.0%
2025-07-22 22:30:03,840 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '246.045000000000000000000000', 'margin': '5936.62', 'free_margin': '-5690.575000000000000000000000', 'profit_loss': '-6143.575000000000000000000000', 'margin_level': '4.144530052454090037765597259', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6143.575000000000000000000000', 'current_price': '118787.9000000000'}], 'margin_call': True}
2025-07-22 22:30:03,843 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.144530052454090037765597259
2025-07-22 22:30:03,877 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:30:03,878 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:30:03,879 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:30:03,879 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:30:03,888 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:30:03,938 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:30:03,984 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:30:04,007 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:30:04,013 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:30:04,185 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:30:04,233 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:30:04,233 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:30:04,237 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:30:04,251 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:30:04,253 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:30:04,253 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:30:04,254 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:30:04,254 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:30:04,259 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:30:04,259 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:30:04,265 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:30:04,265 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:30:04,286 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:30:04,287 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:30:04,292 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:30:04,300 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:30:04,300 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:30:04,300 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:30:04,300 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:30:04,305 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:30:04,305 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:30:04,495 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.78906002800160317336028864% which is below threshold 100.0%
2025-07-22 22:30:04,496 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100765.2900000000000000000000', 'margin': '146484.47', 'free_margin': '-45719.1800000000000000000000', 'profit_loss': '-83580.52000000000000000000000', 'margin_level': '68.78906002800160317336028864', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.90000000000000000000000000', 'current_price': '39.2020000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83485.62000000000000000000000', 'current_price': '118787.9000000000'}], 'margin_call': True}
2025-07-22 22:30:04,498 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.78906002800160317336028864
2025-07-22 22:30:04,499 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:30:04,499 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:30:04,518 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:04,518 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:30:04,537 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:04,537 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:30:04,561 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:04,561 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:30:04,562 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:30:04,562 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:30:04,566 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:30:04,568 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:30:04,568 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:30:04,586 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:04,586 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:30:04,587 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:30:04,587 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:30:04,588 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:30:04,588 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:30:04,706 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:30:04,707 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:30:05,144 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:30:05,145 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:30:05,146 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:30:05,146 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:30:05,248 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:30:05,248 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:30:05,535 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:30:05,538 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:30:05,538 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:30:05,538 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:30:05,681 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:30:05,681 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:30:05,980 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:30:05,981 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:30:05,982 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:30:05,982 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:30:06,017 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:06,017 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:30:06,046 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:11,148 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 1 by invalidating refresh token.
2025-07-22 22:30:15,903 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 0 symbols for user 30
2025-07-22 22:30:15,904 - INFO - app.api.v1.endpoints.favorites - Symbols: []
2025-07-22 22:30:16,444 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:30:16,450 - INFO - app - Found 25 static orders cache entries to check
2025-07-22 22:30:16,464 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:30:16,478 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:30:16,484 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:30:16,491 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:30:16,497 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:30:16,501 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:30:16,505 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:30:16,511 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:30:16,520 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:30:16,524 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:30:16,528 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:30:16,532 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:30:16,534 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:30:16,538 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:30:16,544 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:30:16,547 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 22:30:16,550 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:30:16,553 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:30:16,582 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:30:16,582 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:30:36,052 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:30:36,052 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:30:36,052 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:30:36,052 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:30:36,468 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:30:36,468 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:30:36,468 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:30:36,490 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:30:36,490 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:30:36,563 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:30:36,571 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:30:36,571 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:30:36,729 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:30:37,062 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:30:37,065 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:30:37,067 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:30:37,069 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:30:37,070 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352965'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352965'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352805'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352805'}], 'margin_call': False}
2025-07-22 22:30:37,071 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:30:37,072 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:30:37,072 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:30:37,107 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:37,108 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:30:37,141 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:37,141 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:30:37,190 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:37,190 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:30:37,315 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:30:37,898 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.707645599417068515343122228% which is below threshold 100.0%
2025-07-22 22:30:37,898 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '352.021299142973745068698137', 'margin': '9494.47', 'free_margin': '-9142.448700857026254931301863', 'profit_loss': '-9549.998700857026254931301863', 'margin_level': '3.707645599417068515343122228', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9506.850000000000000000000000', 'current_price': '118730.3000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-39.22609168820568630118351245', 'current_price': '96.535'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.922609168820568630118351245', 'current_price': '96.535'}], 'margin_call': True}
2025-07-22 22:30:37,902 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.707645599417068515343122228
2025-07-22 22:30:37,954 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:30:37,954 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:30:38,014 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:38,014 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:30:38,052 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:38,052 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:30:38,094 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:38,095 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:30:38,134 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:38,134 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:30:38,178 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:38,178 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:30:38,218 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:38,219 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:30:38,261 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:38,261 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:30:38,292 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:38,293 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:30:38,480 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:30:38,769 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.047505146025853094858690635% which is below threshold 100.0%
2025-07-22 22:30:38,769 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '240.285000000000000000000000', 'margin': '5936.62', 'free_margin': '-5696.335000000000000000000000', 'profit_loss': '-6149.335000000000000000000000', 'margin_level': '4.047505146025853094858690635', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6149.335000000000000000000000', 'current_price': '118730.3000000000'}], 'margin_call': True}
2025-07-22 22:30:38,771 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.047505146025853094858690635
2025-07-22 22:30:38,808 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:30:38,808 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:30:38,968 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:30:39,291 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.55526391295951031532557683% which is below threshold 100.0%
2025-07-22 22:30:39,291 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100422.8150000000000000000000', 'margin': '146484.47', 'free_margin': '-46061.6550000000000000000000', 'profit_loss': '-83922.99500000000000000000000', 'margin_level': '68.55526391295951031532557683', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-91.775000000000000000000000', 'current_price': '39.2645'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83831.22000000000000000000000', 'current_price': '118730.3000000000'}], 'margin_call': True}
2025-07-22 22:30:39,294 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.55526391295951031532557683
2025-07-22 22:30:39,308 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:30:39,309 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:30:39,355 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:39,356 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:30:39,402 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:39,402 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:30:39,434 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:39,434 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:30:39,435 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:30:39,436 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:30:39,445 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:30:39,446 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:30:39,447 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:30:39,477 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:39,477 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:30:39,479 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:30:39,479 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:30:39,480 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:30:39,480 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:30:39,587 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:30:39,588 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:30:39,918 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:30:39,919 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:30:39,920 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:30:39,920 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:30:40,085 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:30:40,086 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:30:40,426 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:30:40,428 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:30:40,428 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:30:40,429 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:30:40,574 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:30:40,576 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:30:40,882 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:30:40,884 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:30:40,885 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:30:40,885 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:30:40,970 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:40,970 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:30:41,017 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:30:42,105 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 30 by invalidating refresh token.
2025-07-22 22:30:49,054 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 1 symbols for user 1
2025-07-22 22:30:49,055 - INFO - app.api.v1.endpoints.favorites - Symbols: ['AUDCAD']
2025-07-22 22:30:59,930 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:31:00,233 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:31:09,169 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:31:09,192 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:31:11,053 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:31:11,054 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:31:11,054 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:31:11,054 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:31:11,068 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:31:11,068 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:31:11,068 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:31:11,074 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:31:11,074 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:31:11,106 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:31:11,110 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:31:11,110 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:31:11,338 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:31:11,344 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:31:11,669 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:31:11,983 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:31:12,007 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:31:12,018 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:31:12,025 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:31:12,025 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352965'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352965'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352805'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352805'}], 'margin_call': False}
2025-07-22 22:31:12,040 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:31:12,054 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:31:12,054 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:31:12,162 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:12,162 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:31:12,208 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:12,208 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:31:12,251 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:12,251 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:31:12,378 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:31:12,700 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.458122013248510696881468708% which is below threshold 100.0%
2025-07-22 22:31:12,700 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '328.330357111275873562201982', 'margin': '9494.47', 'free_margin': '-9166.139642888724126437798018', 'profit_loss': '-9573.689642888724126437798018', 'margin_level': '3.458122013248510696881468708', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9530.090000000000000000000000', 'current_price': '118672.2'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-39.63603898974920585254365260', 'current_price': '96.529'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.963603898974920585254365260', 'current_price': '96.529'}], 'margin_call': True}
2025-07-22 22:31:12,704 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.458122013248510696881468708
2025-07-22 22:31:12,749 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:31:12,749 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:31:12,802 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:12,802 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:31:12,843 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:12,843 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:31:12,885 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:12,885 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:31:12,943 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:12,943 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:31:12,987 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:12,988 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:31:13,027 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:13,027 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:31:13,070 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:13,070 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:31:13,109 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:13,110 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:31:13,241 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:31:13,599 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.954522944032126024572905121% which is below threshold 100.0%
2025-07-22 22:31:13,600 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '234.765000000000000000000000', 'margin': '5936.62', 'free_margin': '-5701.855000000000000000000000', 'profit_loss': '-6154.855000000000000000000000', 'margin_level': '3.954522944032126024572905121', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6154.855000000000000000000000', 'current_price': '118675.1'}], 'margin_call': True}
2025-07-22 22:31:13,604 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.954522944032126024572905121
2025-07-22 22:31:13,647 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:31:13,647 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:31:13,790 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:31:14,088 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.32940379277066012526788676% which is below threshold 100.0%
2025-07-22 22:31:14,089 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100091.9649999999998000000000', 'margin': '146484.47', 'free_margin': '-46392.5050000000002000000000', 'profit_loss': '-84253.84500000000020000000000', 'margin_level': '68.32940379277066012526788676', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-91.42500000000020000000000000', 'current_price': '39.271499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84162.42000000000000000000000', 'current_price': '118675.1'}], 'margin_call': True}
2025-07-22 22:31:14,098 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.32940379277066012526788676
2025-07-22 22:31:14,115 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:31:14,115 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:31:14,324 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:14,325 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:31:14,382 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:14,382 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:31:14,617 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:31:14,623 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:31:14,950 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:31:14,952 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:31:14,961 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:31:15,256 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:31:15,258 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:31:15,259 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:31:15,259 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:31:15,261 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:31:15,261 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:31:15,270 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:31:15,272 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:31:15,272 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:31:15,315 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:15,315 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:31:15,316 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:31:15,316 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:31:15,317 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:31:15,317 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:31:15,467 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:31:15,468 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:31:15,762 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:31:15,765 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:31:15,766 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:31:15,766 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:31:16,115 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:31:16,116 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:31:16,411 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:31:16,413 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:31:16,413 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:31:16,413 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:31:16,598 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:31:16,599 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:31:16,889 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:31:16,892 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:31:16,892 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:31:16,892 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:31:16,925 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:16,925 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:31:16,960 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:31:21,995 - INFO - app - Application shutdown initiated
2025-07-22 22:31:21,995 - INFO - app - Scheduler shutdown completed
2025-07-22 22:31:23,408 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:31:25,551 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:31:25,552 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:31:25,555 - INFO - app - Redis connection closed
2025-07-22 22:31:25,555 - INFO - app - Application shutdown completed
2025-07-22 22:32:40,506 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:32:40,592 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:32:40,606 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:32:40,606 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:32:40,953 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:32:40,953 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:32:40,953 - INFO - app - Environment: PRODUCTION
2025-07-22 22:32:41,023 - INFO - app - Application startup initiated
2025-07-22 22:32:41,023 - INFO - app - Initializing core services...
2025-07-22 22:32:41,060 - INFO - app - Firebase initialized
2025-07-22 22:32:41,060 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:32:41,082 - INFO - app - Redis initialized
2025-07-22 22:32:41,758 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:32:41,761 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:32:41,764 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:32:41,764 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:32:41,764 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:32:41,766 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:32:41,766 - INFO - app - Scheduler initialized
2025-07-22 22:32:41,768 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:32:41,769 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:32:42,612 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:32:42,617 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:32:42,650 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:32:42,650 - INFO - app - Background tasks initialized
2025-07-22 22:32:42,650 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:32:43,237 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:32:43,237 - INFO - app - Application startup completed successfully
2025-07-22 22:32:43,238 - INFO - app - Starting cache validation task
2025-07-22 22:32:43,240 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:32:43,242 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:32:43,244 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:32:43,244 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:32:43,244 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:32:43,245 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:32:43,245 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:32:43,285 - INFO - app - Found 25 static orders cache entries to check
2025-07-22 22:32:43,299 - INFO - app - Validating cache for 30 users
2025-07-22 22:32:43,300 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:32:43,300 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:32:43,300 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:32:43,312 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:32:43,312 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:32:43,315 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:32:43,320 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:32:43,320 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:32:43,323 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:32:43,325 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:32:43,327 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:32:43,327 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:32:43,328 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:32:43,329 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:32:43,331 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:32:43,332 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:32:43,332 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:32:43,333 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:32:43,334 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:32:43,335 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:32:43,336 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:32:43,337 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:32:43,341 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:32:43,343 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 22:32:43,345 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:32:43,345 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:32:43,349 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:32:43,349 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:32:43,363 - WARNING - app - User 29: Missing static orders cache, refreshing...
2025-07-22 22:32:43,399 - INFO - app - Cache validation completed
2025-07-22 22:32:43,502 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:32:43,809 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:32:43,814 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:32:43,819 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:32:43,823 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:32:43,823 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3529000000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3529000000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3528900000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3528900000'}], 'margin_call': False}
2025-07-22 22:32:43,825 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:32:43,829 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:32:43,830 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:32:43,877 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:43,878 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:32:43,912 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:43,912 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:32:43,955 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:43,955 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:32:44,289 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:32:44,587 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.693686501310209816331267285% which is below threshold 100.0%
2025-07-22 22:32:44,588 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '350.695956760947477948627273', 'margin': '9494.47', 'free_margin': '-9143.774043239052522051372727', 'profit_loss': '-9551.324043239052522051372727', 'margin_level': '3.693686501310209816331267285', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9508.930000000000000000000000', 'current_price': '118725.1000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-38.54003930822956550124793428', 'current_price': '96.5450000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.854003930822956550124793428', 'current_price': '96.5450000000'}], 'margin_call': True}
2025-07-22 22:32:44,590 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.693686501310209816331267285
2025-07-22 22:32:44,625 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:32:44,626 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:32:44,653 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:44,654 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:32:44,680 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:44,680 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:32:44,704 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:44,704 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:32:44,730 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:44,730 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:32:44,757 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:44,757 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:32:44,784 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:44,785 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:32:44,815 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:44,815 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:32:44,873 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:44,873 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:32:45,116 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:32:45,124 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:32:45,137 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:32:45,137 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:32:45,154 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:32:45,157 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:32:45,165 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:32:45,436 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:32:45,436 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:32:45,454 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:32:45,454 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:32:45,454 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:32:45,454 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:32:45,467 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.038745953084415037512928232% which is below threshold 100.0%
2025-07-22 22:32:45,467 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '239.765000000000000000000000', 'margin': '5936.62', 'free_margin': '-5696.855000000000000000000000', 'profit_loss': '-6149.855000000000000000000000', 'margin_level': '4.038745953084415037512928232', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6149.855000000000000000000000', 'current_price': '118725.1000000000'}], 'margin_call': True}
2025-07-22 22:32:45,469 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:32:45,471 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.038745953084415037512928232
2025-07-22 22:32:45,472 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:32:45,472 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:32:45,488 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:32:45,488 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:32:45,490 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:32:45,493 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:32:45,495 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:32:45,504 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:32:45,504 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:32:45,509 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:32:45,509 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:32:45,510 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:32:45,510 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:32:45,516 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:32:45,516 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:32:45,655 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:32:45,978 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.53527885925381714525778740% which is below threshold 100.0%
2025-07-22 22:32:45,978 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100393.5400000000000000000000', 'margin': '146484.47', 'free_margin': '-46090.9300000000000000000000', 'profit_loss': '-83952.27000000000000000000000', 'margin_level': '68.53527885925381714525778740', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-89.85000000000000000000000000', 'current_price': '39.3030000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83862.42000000000000000000000', 'current_price': '118725.1000000000'}], 'margin_call': True}
2025-07-22 22:32:45,981 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.53527885925381714525778740
2025-07-22 22:32:45,982 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:32:45,982 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:32:46,015 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:46,015 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:32:46,058 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:46,059 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:32:46,088 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:46,088 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:32:46,089 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:32:46,089 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:32:46,099 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:32:46,102 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:32:46,102 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:32:46,134 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:46,134 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:32:46,135 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:32:46,135 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:32:46,135 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:32:46,135 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:32:46,234 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:32:46,235 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:32:47,113 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:32:47,119 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:32:47,121 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:32:47,121 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:32:47,243 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:32:47,244 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:32:47,613 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:32:47,617 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:32:47,617 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:32:47,617 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:32:47,759 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:32:47,759 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:32:48,130 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:32:48,134 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:32:48,134 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:32:48,135 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:32:48,184 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:48,185 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:32:48,228 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:32:50,715 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 1 symbols for user 1
2025-07-22 22:32:50,715 - INFO - app.api.v1.endpoints.favorites - Symbols: ['AUDCAD']
2025-07-22 22:32:58,238 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:32:58,240 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:32:58,243 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:32:58,245 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:32:58,245 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:32:58,246 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:32:58,247 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:32:58,248 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:32:58,249 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:32:58,251 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:32:58,253 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:32:58,254 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:32:58,256 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:32:58,257 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:32:58,258 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:32:58,259 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:32:58,262 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:32:58,264 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:32:58,265 - WARNING - app - Found stale cache entry for user demo:1, will be refreshed on next access
2025-07-22 22:32:58,266 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:32:58,267 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:32:58,269 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:32:58,269 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:32:58,980 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:32:58,994 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:33:18,232 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:33:18,232 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:33:18,233 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:33:18,233 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:33:18,248 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:33:18,248 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:33:18,248 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:33:18,255 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:33:18,255 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:33:18,271 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:33:18,276 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:33:18,276 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:33:18,430 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:33:18,754 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:33:18,759 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:33:18,762 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:33:18,766 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:33:18,766 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352985'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352985'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352825'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352825'}], 'margin_call': False}
2025-07-22 22:33:18,771 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:33:18,773 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:33:18,773 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:33:18,824 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:18,825 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:33:18,863 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:18,863 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:33:18,910 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:18,910 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:33:19,019 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:33:19,320 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.569807520594290065779140110% which is below threshold 100.0%
2025-07-22 22:33:19,320 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '338.934304100568692008380724', 'margin': '9494.47', 'free_margin': '-9155.535695899431307991619276', 'profit_loss': '-9563.085695899431307991619276', 'margin_level': '3.569807520594290065779140110', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9518.810000000000000000000000', 'current_price': '118700.4'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-40.25063263584664362874479606', 'current_price': '96.52'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.025063263584664362874479606', 'current_price': '96.52'}], 'margin_call': True}
2025-07-22 22:33:19,323 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.569807520594290065779140110
2025-07-22 22:33:19,368 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:33:19,370 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:33:19,424 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:19,424 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:33:19,467 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:19,467 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:33:19,499 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:19,499 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:33:19,523 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:19,523 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:33:19,540 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:19,540 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:33:19,558 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:19,558 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:33:19,578 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:19,578 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:33:19,593 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:19,593 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:33:19,639 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:33:19,942 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.997139786612584265120556815% which is below threshold 100.0%
2025-07-22 22:33:19,942 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '237.295000000000000000000000', 'margin': '5936.62', 'free_margin': '-5699.325000000000000000000000', 'profit_loss': '-6152.325000000000000000000000', 'margin_level': '3.997139786612584265120556815', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6152.325000000000000000000000', 'current_price': '118700.4'}], 'margin_call': True}
2025-07-22 22:33:19,948 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.997139786612584265120556815
2025-07-22 22:33:20,038 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:33:20,038 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:33:20,136 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:33:20,486 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.43316905880875952242582439% which is below threshold 100.0%
2025-07-22 22:33:20,487 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100243.9649999999997000000000', 'margin': '146484.47', 'free_margin': '-46240.5050000000003000000000', 'profit_loss': '-84101.84500000000030000000000', 'margin_level': '68.43316905880875952242582439', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-91.22500000000030000000000000', 'current_price': '39.275499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84010.62000000000000000000000', 'current_price': '118700.4'}], 'margin_call': True}
2025-07-22 22:33:20,491 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.43316905880875952242582439
2025-07-22 22:33:20,493 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:33:20,493 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:33:20,550 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:20,550 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:33:20,588 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:20,589 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:33:20,750 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:33:20,752 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:33:20,757 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:33:21,101 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:33:21,106 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:33:21,106 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:33:21,106 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:33:21,110 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:33:21,110 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:33:21,134 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:33:21,137 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:33:21,138 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:33:21,199 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:21,199 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:33:21,201 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:33:21,201 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:33:21,203 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:33:21,203 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:33:21,352 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:33:21,354 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:33:21,716 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:33:21,720 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:33:21,724 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:33:21,724 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:33:21,821 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:33:21,821 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:33:22,157 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:33:22,159 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:33:22,160 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:33:22,160 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:33:22,308 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:33:22,309 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:33:22,640 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:33:22,646 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:33:22,647 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:33:22,647 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:33:22,741 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:22,742 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:33:22,781 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:33:36,578 - INFO - app - Application shutdown initiated
2025-07-22 22:33:36,580 - INFO - app - Scheduler shutdown completed
2025-07-22 22:33:37,247 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:33:38,614 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:33:38,614 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:33:38,618 - INFO - app - Redis connection closed
2025-07-22 22:33:38,618 - INFO - app - Application shutdown completed
2025-07-22 22:37:16,077 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:16,096 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:16,109 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:16,109 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:44,948 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:44,975 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:44,987 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:44,987 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:45,381 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:37:45,381 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:37:45,381 - INFO - app - Environment: PRODUCTION
2025-07-22 22:37:45,439 - INFO - app - Application startup initiated
2025-07-22 22:37:45,439 - INFO - app - Initializing core services...
2025-07-22 22:37:45,473 - INFO - app - Firebase initialized
2025-07-22 22:37:45,474 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:37:45,503 - INFO - app - Redis initialized
2025-07-22 22:37:46,064 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:37:46,067 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:37:46,069 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:37:46,069 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:37:46,069 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:37:46,070 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:37:46,070 - INFO - app - Scheduler initialized
2025-07-22 22:37:46,071 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:37:46,072 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:37:47,139 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:37:47,151 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:37:47,191 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:37:47,192 - INFO - app - Background tasks initialized
2025-07-22 22:37:47,192 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:37:47,840 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:37:47,840 - INFO - app - Application startup completed successfully
2025-07-22 22:37:47,841 - INFO - app - Starting cache validation task
2025-07-22 22:37:47,844 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:37:47,846 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:37:47,848 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:37:47,848 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:37:47,848 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:37:47,849 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:37:47,849 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:37:47,884 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:37:47,892 - INFO - app - Validating cache for 30 users
2025-07-22 22:37:47,896 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:37:47,897 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:37:47,897 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:37:47,911 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,919 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:37:47,919 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:37:47,923 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:37:47,925 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,926 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:37:47,927 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:37:47,930 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:37:47,931 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:37:47,932 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:37:47,933 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:37:47,935 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:37:47,935 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:37:47,935 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:37:47,936 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:37:47,937 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:37:47,938 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,938 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:37:47,941 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:37:47,943 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:37:47,945 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:37:47,946 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:37:47,949 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:37:47,950 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,950 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:37:47,954 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:37:47,958 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:37:47,961 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:37:47,961 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:37:47,962 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,968 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,976 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,983 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,989 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 22:37:47,996 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,004 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,012 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,020 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,027 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,035 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,044 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,051 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,101 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,115 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,128 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,140 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,152 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,175 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 22:37:48,192 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:37:48,193 - INFO - app - Cache validation completed
2025-07-22 22:37:48,565 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:37:48,568 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:37:48,571 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:37:48,573 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:37:48,573 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3529300000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3529300000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3529200000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3529200000'}], 'margin_call': False}
2025-07-22 22:37:48,574 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:37:48,576 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:37:48,576 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:37:48,616 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:48,616 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:37:48,649 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:48,649 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:37:48,692 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:48,692 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:37:48,849 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:37:49,169 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.794079566792197526355140108% which is below threshold 100.0%
2025-07-22 22:37:49,169 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '360.227746245215156480530871', 'margin': '9494.47', 'free_margin': '-9134.242253754784843519469129', 'profit_loss': '-9541.792253754784843519469129', 'margin_level': '3.794079566792197526355140108', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9498.810000000000000000000000', 'current_price': '118750.4000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-39.07477614071349410860829894', 'current_price': '96.5370000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.907477614071349410860829894', 'current_price': '96.5370000000'}], 'margin_call': True}
2025-07-22 22:37:49,172 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.794079566792197526355140108
2025-07-22 22:37:49,203 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:37:49,203 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:37:49,230 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:49,230 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:37:49,259 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:49,259 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:37:49,292 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:49,293 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:37:49,322 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:49,322 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:37:49,352 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:49,355 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:49,355 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:37:49,400 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:49,400 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:37:49,424 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:49,460 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:49,460 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:37:49,507 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:49,507 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:37:49,530 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:49,540 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:49,583 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:49,587 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:49,605 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:37:49,716 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:49,736 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:49,736 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:49,781 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:49,793 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:37:49,797 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:49,797 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:49,858 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:49,864 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:49,878 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:49,879 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:49,881 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:49,881 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:49,898 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:49,909 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:49,910 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:37:49,919 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:49,919 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:49,922 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:49,922 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:49,922 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:37:49,922 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:37:50,202 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.081362795664873278060579926% which is below threshold 100.0%
2025-07-22 22:37:50,202 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '242.295000000000000000000000', 'margin': '5936.62', 'free_margin': '-5694.325000000000000000000000', 'profit_loss': '-6147.325000000000000000000000', 'margin_level': '4.081362795664873278060579926', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6147.325000000000000000000000', 'current_price': '118750.4000000000'}], 'margin_call': True}
2025-07-22 22:37:50,205 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.081362795664873278060579926
2025-07-22 22:37:50,221 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:37:50,221 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:37:50,307 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:37:50,614 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.84056719459748873037530873% which is below threshold 100.0%
2025-07-22 22:37:50,614 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100840.7400000000000000000000', 'margin': '146484.47', 'free_margin': '-45643.7300000000000000000000', 'profit_loss': '-83505.07000000000000000000000', 'margin_level': '68.84056719459748873037530873', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-90.85000000000000000000000000', 'current_price': '39.2830000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83414.22000000000000000000000', 'current_price': '118799.8000000000'}], 'margin_call': True}
2025-07-22 22:37:50,618 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.84056719459748873037530873
2025-07-22 22:37:50,624 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:37:50,625 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:37:50,689 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:50,689 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:37:50,720 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:50,720 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:37:50,845 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:37:51,230 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16447.54000000', 'equity': '16447.36444466831209389009218', 'margin': '6.57372776', 'free_margin': '16440.79071690831209389009218', 'profit_loss': '-0.1755553316879061099078224953', 'margin_level': '250198.4421190620174676976915', 'positions': [{'order_id': '1207-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52172000'), 'margin': Decimal('6.57372776'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:32:58', 'profit_loss': '-0.1755553316879061099078224953', 'current_price': '0.5216600000'}], 'margin_call': False}
2025-07-22 22:37:51,232 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250198.4421190620174676976915
2025-07-22 22:37:51,234 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:37:51,234 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:37:51,237 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:37:51,237 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:37:51,264 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:37:51,266 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:37:51,266 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:37:51,310 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:51,310 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:37:51,311 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:37:51,311 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:37:51,312 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:37:51,312 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:37:51,399 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:37:51,399 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:37:51,844 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:37:51,847 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:37:51,849 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:37:51,849 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:37:51,932 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:37:51,933 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:37:52,249 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:37:52,252 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:37:52,252 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:37:52,252 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:37:52,335 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:37:52,336 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:37:52,661 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:37:52,664 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:37:52,664 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:37:52,664 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:37:52,697 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:37:52,697 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:37:52,716 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:02,841 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:38:02,843 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:38:02,846 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:38:02,848 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:38:02,849 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:38:02,850 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:38:02,852 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:38:02,854 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:38:02,855 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:38:02,857 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:38:02,858 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:38:02,859 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:38:02,860 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:38:02,861 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:38:02,862 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:38:02,863 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:38:02,865 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:38:02,866 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:38:02,869 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:38:02,870 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:38:02,873 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:38:02,873 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:38:22,727 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:38:22,727 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:38:22,727 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:38:22,727 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:38:22,739 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:38:22,739 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:38:22,739 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:38:22,749 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:38:22,750 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:38:22,762 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:38:22,767 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:38:22,767 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:38:22,895 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:38:23,281 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:38:23,284 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:38:23,288 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:38:23,293 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:38:23,293 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.353015'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.353015'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352855'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352855'}], 'margin_call': False}
2025-07-22 22:38:23,300 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:38:23,301 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:38:23,301 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:38:23,368 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:23,369 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:38:23,443 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:23,444 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:38:23,530 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:23,530 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:38:23,863 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:38:24,214 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.903952356646674209125319486% which is below threshold 100.0%
2025-07-22 22:38:24,214 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '370.659585316111488783140721', 'margin': '9494.47', 'free_margin': '-9123.810414683888511216859279', 'profit_loss': '-9531.360414683888511216859279', 'margin_level': '3.903952356646674209125319486', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9493.170000000000000000000000', 'current_price': '118764.5'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-34.71855880353501019714479946', 'current_price': '96.601'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.471855880353501019714479946', 'current_price': '96.601'}], 'margin_call': True}
2025-07-22 22:38:24,216 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.903952356646674209125319486
2025-07-22 22:38:24,260 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:38:24,260 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:38:24,307 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:24,307 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:38:24,355 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:24,355 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:38:24,398 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:24,398 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:38:24,440 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:24,440 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:38:24,476 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:24,477 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:38:24,514 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:24,515 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:38:24,558 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:24,558 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:38:24,597 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:24,597 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:38:24,732 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:38:25,066 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.105113684217618779709666443% which is below threshold 100.0%
2025-07-22 22:38:25,066 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '243.705000000000000000000000', 'margin': '5936.62', 'free_margin': '-5692.915000000000000000000000', 'profit_loss': '-6145.915000000000000000000000', 'margin_level': '4.105113684217618779709666443', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6145.915000000000000000000000', 'current_price': '118764.5'}], 'margin_call': True}
2025-07-22 22:38:25,070 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.105113684217618779709666443
2025-07-22 22:38:25,114 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:38:25,114 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:38:25,330 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:38:25,632 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.69582488846769879428174195% which is below threshold 100.0%
2025-07-22 22:38:25,632 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100628.7149999999997000000000', 'margin': '146484.47', 'free_margin': '-45855.7550000000003000000000', 'profit_loss': '-83717.09500000000030000000000', 'margin_level': '68.69582488846769879428174195', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-91.07500000000030000000000000', 'current_price': '39.278499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83626.02000000000000000000000', 'current_price': '118764.5'}], 'margin_call': True}
2025-07-22 22:38:25,635 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.69582488846769879428174195
2025-07-22 22:38:25,636 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:38:25,637 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:38:25,702 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:25,703 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:38:25,749 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:25,749 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:38:25,931 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:38:26,253 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16447.54000000', 'equity': '16447.10002241333719480715716', 'margin': '6.57', 'free_margin': '16440.53002241333719480715716', 'profit_loss': '-0.4399775866628051928428422126', 'margin_level': '250336.3778145104595861058928', 'positions': [{'order_id': '1207-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52172000'), 'margin': Decimal('6.57372776'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:32:58', 'profit_loss': '-0.4399775866628051928428422126', 'current_price': '0.52145'}], 'margin_call': False}
2025-07-22 22:38:26,255 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250336.3778145104595861058928
2025-07-22 22:38:26,258 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:38:26,259 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:38:26,262 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:38:26,263 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:38:26,331 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:38:26,333 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:38:26,333 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:38:26,375 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:26,375 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:38:26,377 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:38:26,377 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:38:26,378 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:38:26,379 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:38:26,532 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:38:26,534 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:38:26,841 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:38:26,843 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:38:26,845 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:38:26,845 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:38:27,001 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:38:27,002 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:38:27,334 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:38:27,338 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:38:27,338 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:38:27,338 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:38:27,480 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:38:27,481 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:38:27,774 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:38:27,777 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:38:27,778 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:38:27,778 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:38:27,856 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:27,856 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:38:27,918 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:46,074 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:38:46,422 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:38:57,934 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:38:57,934 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:38:57,934 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:38:57,934 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:38:57,943 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:38:57,943 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:38:57,943 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:38:57,949 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:38:57,950 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:38:57,963 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:38:57,966 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:38:57,967 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:38:58,021 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:38:58,419 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:38:58,423 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:38:58,429 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:38:58,438 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:38:58,439 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.353015'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.353015'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352855'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352855'}], 'margin_call': False}
2025-07-22 22:38:58,443 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:38:58,444 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:38:58,444 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:38:58,462 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:58,462 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:38:58,477 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:58,477 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:38:58,491 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:58,491 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:38:58,547 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:38:58,914 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.973270798797661267034645662% which is below threshold 100.0%
2025-07-22 22:38:58,914 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '377.241004010604309700224322', 'margin': '9494.47', 'free_margin': '-9117.228995989395690299775678', 'profit_loss': '-9524.778995989395690299775678', 'margin_level': '3.973270798797661267034645662', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9488.610000000000000000000000', 'current_price': '118775.9'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-32.88090544490517299979607097', 'current_price': '96.628'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.288090544490517299979607097', 'current_price': '96.628'}], 'margin_call': True}
2025-07-22 22:38:58,915 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.973270798797661267034645662
2025-07-22 22:38:58,940 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:38:58,940 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:38:58,960 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:58,960 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:38:58,976 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:58,976 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:38:58,993 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:58,993 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:38:59,010 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:59,010 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:38:59,032 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:59,033 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:38:59,049 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:59,049 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:38:59,072 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:59,073 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:38:59,091 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:59,091 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:38:59,147 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:38:59,476 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.124316530281540674659991712% which is below threshold 100.0%
2025-07-22 22:38:59,476 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '244.845000000000000000000000', 'margin': '5936.62', 'free_margin': '-5691.775000000000000000000000', 'profit_loss': '-6144.775000000000000000000000', 'margin_level': '4.124316530281540674659991712', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6144.775000000000000000000000', 'current_price': '118775.9'}], 'margin_call': True}
2025-07-22 22:38:59,478 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.124316530281540674659991712
2025-07-22 22:38:59,497 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:38:59,497 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:38:59,558 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:38:59,937 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.74258752480723710847982725% which is below threshold 100.0%
2025-07-22 22:38:59,938 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100697.2149999999998000000000', 'margin': '146484.47', 'free_margin': '-45787.2550000000002000000000', 'profit_loss': '-83648.59500000000020000000000', 'margin_level': '68.74258752480723710847982725', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-90.97500000000020000000000000', 'current_price': '39.280499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83557.62000000000000000000000', 'current_price': '118775.9'}], 'margin_call': True}
2025-07-22 22:38:59,941 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.74258752480723710847982725
2025-07-22 22:38:59,943 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:38:59,943 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:38:59,961 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:59,961 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:38:59,978 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:38:59,978 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:39:00,068 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:39:00,448 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16447.54000000', 'equity': '16447.12520197441321648030624', 'margin': '6.57', 'free_margin': '16440.55520197441321648030624', 'profit_loss': '-0.4147980255867835196937644807', 'margin_level': '250336.7610650595618946774161', 'positions': [{'order_id': '1207-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52172000'), 'margin': Decimal('6.57372776'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:32:58', 'profit_loss': '-0.4147980255867835196937644807', 'current_price': '0.52147'}], 'margin_call': False}
2025-07-22 22:39:00,449 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250336.7610650595618946774161
2025-07-22 22:39:00,450 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:39:00,450 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:39:00,450 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:39:00,450 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:39:00,456 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:39:00,458 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:39:00,458 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:39:00,483 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:00,484 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:39:00,484 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:39:00,484 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:39:00,485 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:39:00,485 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:39:00,538 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:39:00,538 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:39:00,857 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:39:00,858 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:39:00,862 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:39:00,862 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:39:00,952 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:39:00,953 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:39:01,255 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:39:01,265 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:39:01,265 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:39:01,265 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:39:01,347 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:39:01,348 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:39:01,655 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:39:01,656 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:39:01,656 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:39:01,656 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:39:01,686 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:01,686 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:39:01,705 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:31,706 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:39:31,707 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:39:31,707 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:39:31,707 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:39:31,716 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:39:31,716 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:39:31,716 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:39:31,725 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:39:31,726 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:39:31,747 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:39:31,750 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:39:31,750 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:39:31,884 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:39:32,201 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:39:32,203 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:39:32,205 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:39:32,206 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:39:32,207 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.353015'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.353015'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352855'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352855'}], 'margin_call': False}
2025-07-22 22:39:32,211 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:39:32,212 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:39:32,212 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:39:32,241 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:32,241 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:39:32,273 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:32,273 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:39:32,308 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:32,308 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:39:32,400 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:39:32,708 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.899297608953810456136834768% which is below threshold 100.0%
2025-07-22 22:39:32,709 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '370.217641692836847614774936', 'margin': '9494.47', 'free_margin': '-9124.252358307163152385225064', 'profit_loss': '-9531.802358307163152385225064', 'margin_level': '3.899297608953810456136834768', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9495.410000000000000000000000', 'current_price': '118758.9'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-33.08396209742104762293187596', 'current_price': '96.625'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.308396209742104762293187596', 'current_price': '96.625'}], 'margin_call': True}
2025-07-22 22:39:32,711 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.899297608953810456136834768
2025-07-22 22:39:32,742 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:39:32,743 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:39:32,817 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:32,817 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:39:32,856 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:32,857 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:39:32,896 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:32,896 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:39:32,950 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:32,950 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:39:33,018 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:33,019 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:39:33,083 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:33,084 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:39:33,122 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:33,122 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:39:33,167 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:33,167 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:39:33,364 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:39:33,681 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.095680707203762410260383855% which is below threshold 100.0%
2025-07-22 22:39:33,682 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '243.145000000000000000000000', 'margin': '5936.62', 'free_margin': '-5693.475000000000000000000000', 'profit_loss': '-6146.475000000000000000000000', 'margin_level': '4.095680707203762410260383855', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6146.475000000000000000000000', 'current_price': '118758.9'}], 'margin_call': True}
2025-07-22 22:39:33,685 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.095680707203762410260383855
2025-07-22 22:39:33,723 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:39:33,723 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:39:33,825 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:39:34,138 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.67254597023151996931824923% which is below threshold 100.0%
2025-07-22 22:39:34,139 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100594.6149999999998000000000', 'margin': '146484.47', 'free_margin': '-45889.8550000000002000000000', 'profit_loss': '-83751.19500000000020000000000', 'margin_level': '68.67254597023151996931824923', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-91.57500000000020000000000000', 'current_price': '39.268499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83659.62000000000000000000000', 'current_price': '118758.9'}], 'margin_call': True}
2025-07-22 22:39:34,142 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.67254597023151996931824923
2025-07-22 22:39:34,144 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:39:34,144 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:39:34,194 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:34,195 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:39:34,228 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:34,229 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:39:34,328 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:39:34,653 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16447.54000000', 'equity': '16447.16299517759799045592476', 'margin': '6.57', 'free_margin': '16440.59299517759799045592476', 'profit_loss': '-0.3770048224020095440752445827', 'margin_level': '250337.3363040730287740627817', 'positions': [{'order_id': '1207-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52172000'), 'margin': Decimal('6.57372776'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:32:58', 'profit_loss': '-0.3770048224020095440752445827', 'current_price': '0.5215000000000001'}], 'margin_call': False}
2025-07-22 22:39:34,658 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250337.3363040730287740627817
2025-07-22 22:39:34,662 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:39:34,662 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:39:34,668 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:39:34,669 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:39:34,681 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:39:34,683 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:39:34,683 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:39:34,716 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:34,716 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:39:34,718 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:39:34,718 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:39:34,719 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:39:34,719 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:39:34,825 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:39:34,826 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:39:35,163 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:39:35,167 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:39:35,169 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:39:35,169 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:39:35,230 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:39:35,230 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:39:35,571 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:39:35,574 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:39:35,575 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:39:35,575 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:39:35,775 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:39:35,776 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:39:36,186 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:39:36,191 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:39:36,191 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:39:36,191 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:39:36,232 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:36,232 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:39:36,274 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:39:46,079 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:39:46,381 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:39:47,983 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:39:47,997 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:40:00,324 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:40:00,327 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:40:06,290 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:40:06,290 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:40:06,290 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:40:06,291 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:40:06,298 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:40:06,298 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:40:06,298 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:40:06,303 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:40:06,303 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:40:06,319 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:40:06,321 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:40:06,321 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:40:06,410 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:40:06,706 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:40:06,707 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:40:06,709 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:40:06,709 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:40:06,710 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.353005'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.353005'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3528449999999999'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3528449999999999'}], 'margin_call': False}
2025-07-22 22:40:06,711 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:40:06,712 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:40:06,712 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:40:06,733 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:06,733 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:40:06,751 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:06,751 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:40:06,771 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:06,771 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:40:06,983 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:40:07,292 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.774904608513891716658692207% which is below threshold 100.0%
2025-07-22 22:40:07,292 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '358.407185583968894870644534', 'margin': '9494.47', 'free_margin': '-9136.062814416031105129355466', 'profit_loss': '-9543.612814416031105129355466', 'margin_level': '3.774904608513891716658692207', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9507.370000000000000000000000', 'current_price': '118729.0'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-32.94801310548282284486860530', 'current_price': '96.627'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.294801310548282284486860530', 'current_price': '96.627'}], 'margin_call': True}
2025-07-22 22:40:07,293 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.774904608513891716658692207
2025-07-22 22:40:07,310 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:40:07,310 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:40:07,336 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:07,336 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:40:07,357 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:07,357 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:40:07,389 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:07,389 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:40:07,420 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:07,421 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:40:07,451 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:07,451 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:40:07,474 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:07,474 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:40:07,499 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:07,499 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:40:07,521 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:07,521 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:40:07,681 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:40:07,979 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.045315347790493580522250035% which is below threshold 100.0%
2025-07-22 22:40:07,979 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '240.155000000000000000000000', 'margin': '5936.62', 'free_margin': '-5696.465000000000000000000000', 'profit_loss': '-6149.465000000000000000000000', 'margin_level': '4.045315347790493580522250035', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6149.465000000000000000000000', 'current_price': '118729.0'}], 'margin_call': True}
2025-07-22 22:40:07,984 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.045315347790493580522250035
2025-07-22 22:40:08,090 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:40:08,090 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:40:08,186 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:40:08,545 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.55000738303521185556393794% which is below threshold 100.0%
2025-07-22 22:40:08,545 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100415.1150000000000000000000', 'margin': '146484.47', 'free_margin': '-46069.3550000000000000000000', 'profit_loss': '-83930.69500000000000000000000', 'margin_level': '68.55000738303521185556393794', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-91.675000000000000000000000', 'current_price': '39.2665'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83839.02000000000000000000000', 'current_price': '118729.0'}], 'margin_call': True}
2025-07-22 22:40:08,547 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.55000738303521185556393794
2025-07-22 22:40:08,548 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:40:08,548 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:40:08,590 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:08,590 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:40:08,625 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:08,625 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:40:08,704 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:40:08,705 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:40:08,708 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:40:09,029 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:40:09,041 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:40:09,041 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:40:09,041 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:40:09,045 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:40:09,045 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:40:09,082 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:40:09,085 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:40:09,085 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:40:09,131 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:40:09,131 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:40:09,133 - INFO - app - Application shutdown initiated
2025-07-22 22:40:09,133 - INFO - app - Scheduler shutdown completed
2025-07-22 22:40:09,134 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:40:09,134 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:40:09,136 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:40:09,137 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:40:09,138 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:40:10,265 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:40:10,265 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:40:10,281 - INFO - app - Redis connection closed
2025-07-22 22:40:10,281 - INFO - app - Application shutdown completed
2025-07-22 22:42:54,278 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:42:54,313 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:42:54,353 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:42:54,353 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:42:54,814 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:42:54,814 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:42:54,814 - INFO - app - Environment: PRODUCTION
2025-07-22 22:42:54,874 - INFO - app - Application startup initiated
2025-07-22 22:42:54,874 - INFO - app - Initializing core services...
2025-07-22 22:42:54,914 - INFO - app - Firebase initialized
2025-07-22 22:42:54,915 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:42:54,935 - INFO - app - Redis initialized
2025-07-22 22:42:55,547 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:42:55,551 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:42:55,553 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:42:55,553 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:42:55,553 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:42:55,554 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:42:55,554 - INFO - app - Scheduler initialized
2025-07-22 22:42:55,556 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:42:55,557 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:42:56,588 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:42:56,603 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:42:56,646 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:42:56,646 - INFO - app - Background tasks initialized
2025-07-22 22:42:56,646 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:42:57,402 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:42:57,407 - INFO - app - Application startup completed successfully
2025-07-22 22:42:57,408 - INFO - app - Starting cache validation task
2025-07-22 22:42:57,412 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:42:57,414 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:42:57,416 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:42:57,416 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:42:57,416 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:42:57,416 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:42:57,416 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:42:57,427 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:42:57,440 - INFO - app - Validating cache for 30 users
2025-07-22 22:42:57,441 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:42:57,441 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:42:57,441 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:42:57,466 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,472 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:42:57,473 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:42:57,479 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:42:57,488 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:42:57,489 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,490 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:42:57,491 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:42:57,493 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:42:57,494 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:42:57,496 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:42:57,497 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:42:57,498 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:42:57,499 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:42:57,500 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:42:57,501 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:42:57,502 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:42:57,502 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:42:57,503 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:42:57,504 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,505 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:42:57,505 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:42:57,506 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:42:57,507 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:42:57,510 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:42:57,512 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:42:57,515 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:42:57,515 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:42:57,517 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,527 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,539 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,549 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,558 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,566 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,575 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,585 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,595 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,602 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,609 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,617 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,624 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,630 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,661 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,677 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,690 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-22 22:42:57,702 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:42:57,703 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-22 22:42:58,123 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:42:58,129 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:42:58,132 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:42:58,133 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-22 22:42:58,136 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:42:58,137 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3529400000'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3529400000'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3529300000'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3529300000'}], 'margin_call': False}
2025-07-22 22:42:58,140 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:42:58,142 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:42:58,142 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:42:58,196 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-22 22:42:58,220 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:42:58,221 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:42:58,226 - INFO - app - Cache validation completed
2025-07-22 22:42:58,262 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:42:58,262 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:42:58,299 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:42:58,299 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:42:58,550 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:42:58,902 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.997400613896595031918661874% which is below threshold 100.0%
2025-07-22 22:42:58,902 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '379.532002066228046327007776', 'margin': '9494.47', 'free_margin': '-9114.937997933771953672992224', 'profit_loss': '-9522.487997933771953672992224', 'margin_level': '3.997400613896595031918661874', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9487.370000000000000000000000', 'current_price': '118779.0000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-31.92545266706541242999293133', 'current_price': '96.6420000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.192545266706541242999293133', 'current_price': '96.6420000000'}], 'margin_call': True}
2025-07-22 22:42:58,903 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.997400613896595031918661874
2025-07-22 22:42:59,142 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:42:59,153 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:42:59,197 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:42:59,206 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:42:59,214 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:42:59,228 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:42:59,231 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:42:59,413 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:42:59,422 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:42:59,433 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:42:59,433 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:42:59,435 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:42:59,435 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:42:59,471 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:42:59,472 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:42:59,487 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:42:59,487 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:42:59,492 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:42:59,492 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:42:59,501 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:42:59,503 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:42:59,513 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:42:59,514 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:42:59,517 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:42:59,517 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:42:59,517 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:42:59,529 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:42:59,529 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:43:00,065 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:43:00,065 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:43:00,098 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:00,098 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:43:00,118 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:00,118 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:43:00,135 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:00,135 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:43:00,155 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:00,155 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:43:00,174 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:00,174 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:43:00,202 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:00,203 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:43:00,219 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:00,219 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:43:00,234 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:00,234 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:43:00,625 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:43:00,955 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.041777981410297441978769064% which is below threshold 100.0%
2025-07-22 22:43:00,955 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '239.945000000000000000000000', 'margin': '5936.62', 'free_margin': '-5696.675000000000000000000000', 'profit_loss': '-6149.675000000000000000000000', 'margin_level': '4.041777981410297441978769064', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6149.675000000000000000000000', 'current_price': '118726.9000000000'}], 'margin_call': True}
2025-07-22 22:43:01,250 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.041777981410297441978769064
2025-07-22 22:43:02,594 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:43:02,595 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:43:02,689 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:43:03,029 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.33667418805556643649664705% which is below threshold 100.0%
2025-07-22 22:43:03,029 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100102.6149999999998000000000', 'margin': '146484.47', 'free_margin': '-46381.8550000000002000000000', 'profit_loss': '-84243.19500000000020000000000', 'margin_level': '68.33667418805556643649664705', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-91.57500000000020000000000000', 'current_price': '39.268499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84151.62000000000000000000000', 'current_price': '118676.9'}], 'margin_call': True}
2025-07-22 22:43:03,341 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.33667418805556643649664705
2025-07-22 22:43:03,342 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:43:03,342 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:43:03,360 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:03,361 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:43:03,374 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:03,375 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:43:03,442 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:43:04,456 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.77000000', 'equity': '16446.34261829811881437457503', 'margin': '6.57', 'free_margin': '16439.77261829811881437457503', 'profit_loss': '-0.4273817018811856254249666322', 'margin_level': '250324.8495935786729737378239', 'positions': [{'order_id': '1207-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52172000'), 'margin': Decimal('6.57372776'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:32:58', 'profit_loss': '-0.4273817018811856254249666322', 'current_price': '0.52146'}], 'margin_call': False}
2025-07-22 22:43:04,459 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250324.8495935786729737378239
2025-07-22 22:43:04,460 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:43:04,460 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:43:04,462 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:43:04,462 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:43:04,486 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:43:04,487 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:43:04,487 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:43:04,514 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:04,514 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:43:04,515 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:43:04,515 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:43:04,516 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:43:04,516 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:43:04,641 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:43:04,642 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:43:05,081 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:43:05,085 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:43:05,086 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:43:05,087 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:43:05,259 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:43:05,260 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:43:05,568 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:43:05,571 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:43:05,571 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:43:05,571 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:43:05,734 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:43:05,734 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:43:06,041 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:43:06,045 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:43:06,045 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:43:06,045 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:43:06,085 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:06,085 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:43:06,121 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:12,379 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:43:12,399 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:43:12,766 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:43:12,770 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:43:12,775 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:43:12,780 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:43:12,795 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:43:12,807 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:43:12,808 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:43:12,809 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:43:12,810 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:43:12,812 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:43:12,813 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:43:12,818 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:43:12,821 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:43:12,823 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:43:12,825 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:43:12,827 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:43:12,830 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:43:12,831 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:43:12,834 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:43:12,835 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:43:12,837 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:43:12,838 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:43:15,889 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 1 by invalidating refresh token.
2025-07-22 22:43:19,725 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 0 symbols for user 30
2025-07-22 22:43:19,725 - INFO - app.api.v1.endpoints.favorites - Symbols: []
2025-07-22 22:43:36,135 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:43:36,135 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:43:36,135 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:43:36,135 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:43:36,146 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:43:36,146 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:43:36,146 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:43:36,153 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:43:36,153 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:43:36,168 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:43:36,171 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:43:36,171 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:43:36,279 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:43:36,621 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:43:36,623 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:43:36,625 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:43:36,627 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:43:36,628 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352735'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352735'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3525749999999999'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3525749999999999'}], 'margin_call': False}
2025-07-22 22:43:36,630 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:43:36,632 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:43:36,632 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:43:36,664 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:36,665 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:43:36,710 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:36,710 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:43:36,752 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:36,753 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:43:37,002 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:43:37,452 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.514820387839448345960707812% which is below threshold 100.0%
2025-07-22 22:43:37,452 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '333.713567277300071372735615', 'margin': '9494.47', 'free_margin': '-9160.756432722699928627264385', 'profit_loss': '-9568.306432722699928627264385', 'margin_level': '3.514820387839448345960707812', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9531.690000000000000000000000', 'current_price': '118668.2'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-33.28766611154538966114944091', 'current_price': '96.622'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.328766611154538966114944091', 'current_price': '96.622'}], 'margin_call': True}
2025-07-22 22:43:37,455 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.514820387839448345960707812
2025-07-22 22:43:37,466 - INFO - app.api.v1.endpoints.users - Logout successful for user ID 30 by invalidating refresh token.
2025-07-22 22:43:37,660 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:43:37,660 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:43:37,722 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:37,723 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:43:37,768 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:37,768 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:43:37,815 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:37,815 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:43:37,863 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:37,863 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:43:37,898 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:37,898 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:43:37,940 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:37,940 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:43:37,988 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:37,988 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:43:38,058 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:38,058 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:43:38,197 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:43:38,532 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.942900168782910140787181932% which is below threshold 100.0%
2025-07-22 22:43:38,532 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '234.075000000000000000000000', 'margin': '5936.62', 'free_margin': '-5702.545000000000000000000000', 'profit_loss': '-6155.545000000000000000000000', 'margin_level': '3.942900168782910140787181932', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6155.545000000000000000000000', 'current_price': '118668.2'}], 'margin_call': True}
2025-07-22 22:43:38,535 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.942900168782910140787181932
2025-07-22 22:43:38,572 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:43:38,573 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:43:38,743 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:43:39,142 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.30114141109975671823777633% which is below threshold 100.0%
2025-07-22 22:43:39,142 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100050.5649999999998000000000', 'margin': '146484.47', 'free_margin': '-46433.9050000000002000000000', 'profit_loss': '-84295.24500000000020000000000', 'margin_level': '68.30114141109975671823777633', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-91.42500000000020000000000000', 'current_price': '39.271499999999996'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84203.82000000000000000000000', 'current_price': '118668.2'}], 'margin_call': True}
2025-07-22 22:43:39,156 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.30114141109975671823777633
2025-07-22 22:43:39,170 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:43:39,170 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:43:39,263 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:39,264 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:43:39,304 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:39,304 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:43:39,443 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:43:39,445 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:43:39,452 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:43:39,791 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:43:39,795 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:43:39,795 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:43:39,795 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:43:39,797 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:43:39,797 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:43:39,808 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:43:39,812 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:43:39,812 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:43:39,868 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:39,868 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:43:39,870 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:43:39,870 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:43:39,871 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:43:39,871 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:43:40,018 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:43:40,019 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:43:40,323 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:43:40,325 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:43:40,327 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:43:40,327 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:43:40,477 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:43:40,478 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:43:40,770 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:43:40,772 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:43:40,772 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:43:40,772 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:43:40,951 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:43:40,953 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:43:41,249 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:43:41,252 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:43:41,253 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:43:41,253 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:43:41,304 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:41,304 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:43:41,351 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:43:45,065 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 0 symbols for user 14
2025-07-22 22:43:45,065 - INFO - app.api.v1.endpoints.favorites - Symbols: []
2025-07-22 22:43:55,568 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:43:55,968 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:44:11,365 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:44:11,365 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:44:11,365 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:44:11,365 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:44:11,376 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:44:11,376 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:44:11,376 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:44:11,382 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:44:11,382 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:44:11,408 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:44:11,412 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:44:11,412 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:44:11,573 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:44:11,947 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:44:11,950 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:44:11,955 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:44:11,957 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:44:11,958 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352465'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352465'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.3523049999999999'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.3523049999999999'}], 'margin_call': False}
2025-07-22 22:44:11,959 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:44:11,960 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:44:11,960 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:44:12,002 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,002 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:44:12,042 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,042 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:44:12,078 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,079 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:44:12,225 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:44:12,565 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.521211039031645027299768465% which is below threshold 100.0%
2025-07-22 22:44:12,566 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '334.320325737547827623468327', 'margin': '9494.47', 'free_margin': '-9160.149674262452172376531673', 'profit_loss': '-9567.699674262452172376531673', 'margin_level': '3.521211039031645027299768465', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'swap': 'None', 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9531.090000000000000000000000', 'current_price': '118669.7'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'swap': 'None', 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-33.28152205677470216048333934', 'current_price': '96.622'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.328152205677470216048333934', 'current_price': '96.622'}], 'margin_call': True}
2025-07-22 22:44:12,567 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.521211039031645027299768465
2025-07-22 22:44:12,615 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:44:12,617 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:44:12,671 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,671 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:44:12,715 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,715 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:44:12,756 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,756 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:44:12,797 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,797 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:44:12,840 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,840 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:44:12,880 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,880 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:44:12,921 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,921 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:44:12,958 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:12,958 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:44:13,141 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:44:13,442 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.945426859054478811175382625% which is below threshold 100.0%
2025-07-22 22:44:13,442 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '234.225000000000000000000000', 'margin': '5936.62', 'free_margin': '-5702.395000000000000000000000', 'profit_loss': '-6155.395000000000000000000000', 'margin_level': '3.945426859054478811175382625', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6155.395000000000000000000000', 'current_price': '118669.7'}], 'margin_call': True}
2025-07-22 22:44:13,446 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.945426859054478811175382625
2025-07-22 22:44:13,479 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:44:13,479 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:44:13,572 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:44:13,892 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.30615900784567794114966590% which is below threshold 100.0%
2025-07-22 22:44:13,892 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100057.9149999999997500000000', 'margin': '146484.47', 'free_margin': '-46426.5550000000002500000000', 'profit_loss': '-84287.89500000000025000000000', 'margin_level': '68.30615900784567794114966590', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-93.07500000000025000000000000', 'current_price': '39.238499999999995'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84194.82000000000000000000000', 'current_price': '118669.7'}], 'margin_call': True}
2025-07-22 22:44:13,895 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.30615900784567794114966590
2025-07-22 22:44:13,898 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:44:13,899 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:44:13,925 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:13,926 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:44:13,952 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:13,952 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:44:14,025 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:44:14,026 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:44:14,028 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:44:14,417 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:44:14,418 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:44:14,419 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:44:14,419 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:44:14,420 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:44:14,420 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:44:14,435 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:44:14,439 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:44:14,439 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:44:14,470 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:14,470 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:44:14,471 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:44:14,471 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:44:14,472 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:44:14,472 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:44:14,578 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:44:14,579 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:44:14,917 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:44:14,923 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:44:14,924 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:44:14,924 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:44:15,119 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:44:15,121 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:44:15,527 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:44:15,529 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:44:15,529 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:44:15,530 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:44:15,740 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:44:15,741 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:44:16,140 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:44:16,141 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:44:16,141 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:44:16,141 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:44:16,165 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:16,165 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:44:16,193 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:46,198 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:44:46,198 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:44:46,198 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:44:46,198 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:44:46,206 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:44:46,206 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:44:46,206 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:44:46,213 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:44:46,213 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:44:46,225 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:44:46,226 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:44:46,227 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:44:46,278 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:44:46,659 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:44:46,663 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:44:46,667 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:44:46,669 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:44:46,669 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352455'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352455'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352295'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352295'}], 'margin_call': False}
2025-07-22 22:44:46,671 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:44:46,672 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:44:46,672 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:44:46,699 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:46,699 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:44:46,712 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:46,712 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:44:46,727 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:46,727 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:44:46,774 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:44:47,275 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.721629305047705956460482038% which is below threshold 100.0%
2025-07-22 22:44:47,275 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '353.348977878962927724353529', 'margin': '9494.47', 'free_margin': '-9141.121022121037072275646471', 'profit_loss': '-9548.671022121037072275646471', 'margin_level': '3.721629305047705956460482038', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9511.090000000000000000000000', 'current_price': '118719.7000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-34.16456556457915661422406470', 'current_price': '96.609'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.416456556457915661422406470', 'current_price': '96.609'}], 'margin_call': True}
2025-07-22 22:44:47,277 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.721629305047705956460482038
2025-07-22 22:44:47,310 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:44:47,310 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:44:47,345 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:47,345 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:44:47,362 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:47,362 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:44:47,377 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:47,378 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:44:47,391 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:47,391 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:44:47,406 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:47,406 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:44:47,420 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:47,420 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:44:47,434 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:47,434 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:44:47,449 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:47,450 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:44:47,498 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:44:47,894 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 4.029649868106767824115405736% which is below threshold 100.0%
2025-07-22 22:44:47,894 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '239.225000000000000000000000', 'margin': '5936.62', 'free_margin': '-5697.395000000000000000000000', 'profit_loss': '-6150.395000000000000000000000', 'margin_level': '4.029649868106767824115405736', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6150.395000000000000000000000', 'current_price': '118719.7000000000'}], 'margin_call': True}
2025-07-22 22:44:47,898 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 4.029649868106767824115405736
2025-07-22 22:44:47,973 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:44:47,973 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:44:48,050 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:44:48,396 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.49945594915283510941467037% which is below threshold 100.0%
2025-07-22 22:44:48,397 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100341.0650000000000000000000', 'margin': '146484.47', 'free_margin': '-46143.4050000000000000000000', 'profit_loss': '-84004.74500000000000000000000', 'margin_level': '68.49945594915283510941467037', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-93.725000000000000000000000', 'current_price': '39.2255'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-83911.02000000000000000000000', 'current_price': '118717.0000000000'}], 'margin_call': True}
2025-07-22 22:44:48,398 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.49945594915283510941467037
2025-07-22 22:44:48,400 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:44:48,400 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:44:48,436 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:48,436 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:44:48,454 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:48,454 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:44:48,538 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:44:48,539 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:44:48,541 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:44:49,013 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:44:49,016 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:44:49,016 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:44:49,016 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:44:49,017 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:44:49,017 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:44:49,025 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:44:49,026 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:44:49,026 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:44:49,048 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:49,048 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:44:49,049 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:44:49,049 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:44:49,049 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:44:49,049 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:44:49,126 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:44:49,127 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:44:49,491 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:44:49,492 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:44:49,494 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:44:49,494 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:44:49,590 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:44:49,591 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:44:49,936 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:44:49,944 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:44:49,944 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:44:49,944 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:44:50,071 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:44:50,071 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:44:50,381 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:44:50,385 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:44:50,386 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:44:50,386 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:44:50,432 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:50,433 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:44:50,459 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:44:55,554 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:44:55,874 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:45:00,214 - INFO - app - Application shutdown initiated
2025-07-22 22:45:00,216 - INFO - app - Scheduler shutdown completed
2025-07-22 22:45:00,726 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:45:01,402 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:45:01,402 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:45:01,407 - INFO - app - Redis connection closed
2025-07-22 22:45:01,408 - INFO - app - Application shutdown completed
2025-07-22 22:45:03,578 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:03,603 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:03,620 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:03,621 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:09,064 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:09,088 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:09,098 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:09,098 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:09,495 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:45:09,495 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:45:09,496 - INFO - app - Environment: PRODUCTION
2025-07-22 22:45:09,550 - INFO - app - Application startup initiated
2025-07-22 22:45:09,550 - INFO - app - Initializing core services...
2025-07-22 22:45:09,588 - INFO - app - Firebase initialized
2025-07-22 22:45:09,589 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:45:09,634 - INFO - app - Redis initialized
2025-07-22 22:45:10,173 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:45:10,177 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:45:10,180 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:45:10,180 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:45:10,180 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:45:10,181 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:45:10,182 - INFO - app - Scheduler initialized
2025-07-22 22:45:10,184 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:45:10,184 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:45:11,144 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:45:11,155 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:45:11,209 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:45:11,209 - INFO - app - Background tasks initialized
2025-07-22 22:45:11,209 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:45:11,815 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:45:11,815 - INFO - app - Application startup completed successfully
2025-07-22 22:45:11,816 - INFO - app - Starting cache validation task
2025-07-22 22:45:11,818 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:45:11,819 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:45:11,821 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:45:11,821 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:45:11,821 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:45:11,821 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:45:11,821 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:45:11,828 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:45:11,848 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:45:11,848 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:45:11,848 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:45:11,849 - INFO - app - Validating cache for 30 users
2025-07-22 22:45:11,873 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:45:11,873 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:45:11,879 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:45:11,895 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:45:11,896 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:45:11,898 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:45:11,900 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:45:11,901 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:45:11,902 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:45:11,906 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:45:11,907 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:45:11,909 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:45:11,911 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:45:11,911 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:45:11,912 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:45:11,914 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:45:11,915 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:45:11,915 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:45:11,916 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:45:11,919 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:45:11,921 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:45:11,924 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:45:11,927 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:45:11,932 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:45:11,933 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:45:11,968 - INFO - app - Cache validation completed
2025-07-22 22:45:12,077 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:45:12,381 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:45:12,385 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:45:12,388 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:45:12,391 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:45:12,391 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.3524150000000001'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.3524150000000001'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352255'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352255'}], 'margin_call': False}
2025-07-22 22:45:12,393 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:45:12,394 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:45:12,394 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:45:12,443 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:12,443 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:45:12,499 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:12,499 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:45:12,551 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:12,552 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:45:12,733 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:45:13,027 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.514945624994675319081460840% which is below threshold 100.0%
2025-07-22 22:45:13,028 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '333.725457881431949767593575', 'margin': '9494.47', 'free_margin': '-9160.744542118568050232406425', 'profit_loss': '-9568.294542118568050232406425', 'margin_level': '3.514945624994675319081460840', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'swap': 'None', 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9531.090000000000000000000000', 'current_price': '118669.7'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'swap': 'None', 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-33.82231101688004566582402349', 'current_price': '96.614'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.382231101688004566582402349', 'current_price': '96.614'}], 'margin_call': True}
2025-07-22 22:45:13,037 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.514945624994675319081460840
2025-07-22 22:45:13,073 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:45:13,073 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:45:13,115 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:13,116 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:45:13,161 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:13,161 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:45:13,210 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:13,210 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:45:13,257 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:13,257 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:45:13,302 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:13,302 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:45:13,346 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:13,346 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:45:13,394 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:13,394 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:45:13,451 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:13,452 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:45:13,592 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:45:13,895 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.945426859054478811175382625% which is below threshold 100.0%
2025-07-22 22:45:13,896 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '234.225000000000000000000000', 'margin': '5936.62', 'free_margin': '-5702.395000000000000000000000', 'profit_loss': '-6155.395000000000000000000000', 'margin_level': '3.945426859054478811175382625', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6155.395000000000000000000000', 'current_price': '118669.7'}], 'margin_call': True}
2025-07-22 22:45:13,898 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.945426859054478811175382625
2025-07-22 22:45:13,930 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:45:13,931 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:45:14,197 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:45:14,437 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:14,468 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:14,514 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:14,547 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:14,561 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:14,594 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:14,603 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.30564700817772675833827299% which is below threshold 100.0%
2025-07-22 22:45:14,603 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '100057.1649999999997000000000', 'margin': '146484.47', 'free_margin': '-46427.3050000000003000000000', 'profit_loss': '-84288.64500000000030000000000', 'margin_level': '68.30564700817772675833827299', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-93.82500000000030000000000000', 'current_price': '39.223499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84194.82000000000000000000000', 'current_price': '118669.7'}], 'margin_call': True}
2025-07-22 22:45:14,607 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.30564700817772675833827299
2025-07-22 22:45:14,611 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:45:14,611 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:45:14,662 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:45:14,703 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:14,704 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:45:14,752 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:14,752 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:45:14,923 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:14,958 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:14,958 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:14,967 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:14,977 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:14,992 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:14,992 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:14,994 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:15,003 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:15,003 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:15,004 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:15,005 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:15,017 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:15,017 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:15,019 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:45:15,020 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:45:15,022 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:45:15,026 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:15,026 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:15,028 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:15,028 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:15,037 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:45:15,037 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:45:15,164 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:45:15,505 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:45:15,507 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:45:15,507 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:45:15,507 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:45:15,510 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:45:15,510 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:45:15,527 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:45:15,531 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:45:15,531 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:45:15,569 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:15,569 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:45:15,570 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:45:15,570 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:45:15,572 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:45:15,572 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:45:15,672 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:45:15,674 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:45:15,992 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:45:15,996 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:45:15,998 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:45:15,998 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:45:16,198 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:45:16,198 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:45:16,502 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:45:16,504 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:45:16,504 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:45:16,504 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:45:16,600 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:45:16,601 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:45:16,927 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:45:16,929 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:45:16,929 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:45:16,930 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:45:16,956 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:16,956 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:45:16,982 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:26,827 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:45:26,829 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:45:26,832 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:45:26,834 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:45:26,835 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:45:26,837 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:45:26,838 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:45:26,842 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:45:26,844 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:45:26,845 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:45:26,849 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:45:26,851 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:45:26,852 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:45:26,853 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:45:26,855 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:45:26,856 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:45:26,857 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:45:26,858 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:45:26,860 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:45:26,861 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:45:26,864 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:45:26,864 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:45:46,997 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:45:46,997 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:45:46,997 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:45:46,997 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:45:47,001 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:45:47,001 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:45:47,001 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:45:47,006 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:45:47,006 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:45:47,013 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:45:47,015 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:45:47,015 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:45:47,072 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:45:47,379 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:45:47,380 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:45:47,381 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:45:47,382 - ERROR - app.services.portfolio_calculator - Could not convert PnL from None to USD
2025-07-22 22:45:47,382 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [{'order_id': Decimal('4731664142'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34376000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:07', 'profit_loss': '0.0', 'current_price': '1.352425'}, {'order_id': Decimal('8676137902'), 'order_company_name': 'GBPUSD', 'order_type': 'SELL', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34361000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:21', 'profit_loss': '0.0', 'current_price': '1.352425'}, {'order_id': Decimal('3301052276'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34379000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:24', 'profit_loss': '0.0', 'current_price': '1.352265'}, {'order_id': Decimal('2972795665'), 'order_company_name': 'GBPUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.25000000'), 'order_price': Decimal('1.34378000'), 'margin': Decimal('0E-8'), 'contract_value': Decimal('0E-8'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('2.50000000'), 'created_at': '2025-06-19T11:41:30', 'profit_loss': '0.0', 'current_price': '1.352265'}], 'margin_call': False}
2025-07-22 22:45:47,384 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:45:47,384 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:45:47,385 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:45:47,412 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:47,412 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:45:47,448 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:47,449 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:45:47,487 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:47,487 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:45:47,622 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:45:47,999 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.324768801689893851521140411% which is below threshold 100.0%
2025-07-22 22:45:47,999 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '315.669176445806464764519220', 'margin': '9494.47', 'free_margin': '-9178.800823554193535235480780', 'profit_loss': '-9586.350823554193535235480780', 'margin_level': '3.324768801689893851521140411', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9548.850000000000000000000000', 'current_price': '118625.3'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-34.09165777653957748680070940', 'current_price': '96.61'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.409165777653957748680070940', 'current_price': '96.61'}], 'margin_call': True}
2025-07-22 22:45:48,003 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.324768801689893851521140411
2025-07-22 22:45:48,062 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:45:48,062 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:45:48,102 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:48,102 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:45:48,137 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:48,137 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:45:48,182 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:48,182 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:45:48,221 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:48,221 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:45:48,257 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:48,257 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:45:48,298 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:48,299 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:45:48,336 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:48,336 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:45:48,373 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:48,373 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:45:48,499 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:45:48,814 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.870636827016046167684642103% which is below threshold 100.0%
2025-07-22 22:45:48,814 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '229.785000000000000000000000', 'margin': '5936.62', 'free_margin': '-5706.835000000000000000000000', 'profit_loss': '-6159.835000000000000000000000', 'margin_level': '3.870636827016046167684642103', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6159.835000000000000000000000', 'current_price': '118625.3'}], 'margin_call': True}
2025-07-22 22:45:48,817 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.870636827016046167684642103
2025-07-22 22:45:48,855 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:45:48,856 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:45:48,932 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:45:49,230 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.12381885943267569592872200% which is below threshold 100.0%
2025-07-22 22:45:49,231 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '99790.81500000000000000000000', 'margin': '146484.47', 'free_margin': '-46693.65500000000000000000000', 'profit_loss': '-84554.99500000000000000000000', 'margin_level': '68.12381885943267569592872200', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-93.775000000000000000000000', 'current_price': '39.2245'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84461.22000000000000000000000', 'current_price': '118625.3'}], 'margin_call': True}
2025-07-22 22:45:49,234 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.12381885943267569592872200
2025-07-22 22:45:49,237 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:45:49,238 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:45:49,295 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:49,295 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:45:49,334 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:49,334 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:45:49,397 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:45:49,398 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:45:49,400 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:45:49,735 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:45:49,737 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:45:49,737 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:45:49,737 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:45:49,738 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:45:49,738 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:45:49,748 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:45:49,750 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:45:49,750 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:45:49,772 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:49,772 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:45:49,774 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:45:49,774 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:45:49,775 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:45:49,776 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:45:49,882 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:45:49,883 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:45:50,215 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:45:50,216 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:45:50,227 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:45:50,227 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:45:50,406 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:45:50,408 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:45:50,756 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:45:50,759 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:45:50,759 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:45:50,760 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:45:50,824 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:45:50,825 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:45:51,169 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:45:51,171 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:45:51,172 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:45:51,172 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:45:51,194 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:45:51,195 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:45:51,216 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:10,191 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:46:10,521 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:46:20,337 - INFO - app - Application shutdown initiated
2025-07-22 22:46:20,337 - INFO - app - Scheduler shutdown completed
2025-07-22 22:46:20,338 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:46:20,346 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:46:20,346 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:46:20,873 - INFO - app - Redis connection closed
2025-07-22 22:46:20,874 - INFO - app - Application shutdown completed
2025-07-22 22:46:23,024 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:46:23,055 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:46:23,066 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:46:23,066 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:46:23,540 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:46:23,541 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:46:23,541 - INFO - app - Environment: PRODUCTION
2025-07-22 22:46:23,596 - INFO - app - Application startup initiated
2025-07-22 22:46:23,596 - INFO - app - Initializing core services...
2025-07-22 22:46:23,633 - INFO - app - Firebase initialized
2025-07-22 22:46:23,633 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:46:23,659 - INFO - app - Redis initialized
2025-07-22 22:46:24,527 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:46:24,531 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:46:24,538 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:46:24,538 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:46:24,538 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:46:24,540 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:46:24,540 - INFO - app - Scheduler initialized
2025-07-22 22:46:24,542 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:46:24,543 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:46:25,451 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:46:25,471 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:46:25,516 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:46:25,516 - INFO - app - Background tasks initialized
2025-07-22 22:46:25,516 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:46:26,159 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:46:26,159 - INFO - app - Application startup completed successfully
2025-07-22 22:46:26,160 - INFO - app - Starting cache validation task
2025-07-22 22:46:26,162 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:46:26,164 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:46:26,166 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:46:26,166 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:46:26,166 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:46:26,166 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:46:26,166 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:46:26,187 - INFO - app - Found 22 static orders cache entries to check
2025-07-22 22:46:26,192 - INFO - app - Validating cache for 30 users
2025-07-22 22:46:26,197 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:46:26,197 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:46:26,197 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:46:26,202 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:46:26,213 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:46:26,213 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:46:26,217 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:46:26,219 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:46:26,221 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:46:26,223 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:46:26,223 - WARNING - app - User 9: Missing static orders cache, refreshing...
2025-07-22 22:46:26,225 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:46:26,229 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:46:26,230 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:46:26,231 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:46:26,233 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:46:26,235 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:46:26,237 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:46:26,238 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:46:26,241 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:46:26,242 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:46:26,242 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:46:26,243 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:46:26,244 - WARNING - app - User 10: Missing static orders cache, refreshing...
2025-07-22 22:46:26,245 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:46:26,248 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:46:26,250 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:46:26,252 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:46:26,252 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:46:26,260 - WARNING - app - User 11: Missing static orders cache, refreshing...
2025-07-22 22:46:26,279 - WARNING - app - User 13: Missing static orders cache, refreshing...
2025-07-22 22:46:26,410 - INFO - app - Cache validation completed
2025-07-22 22:46:26,468 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:46:26,761 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 12.30511818639018917559673488% which is below threshold 100.0%
2025-07-22 22:46:26,761 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '1017.840000000000000000000000', 'margin': '8271.68', 'free_margin': '-7253.840000000000000000000000', 'profit_loss': '-7418.750000000000000000000000', 'margin_level': '12.30511818639018917559673488', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7418.750000000000000000000000', 'current_price': '118600.0'}], 'margin_call': True}
2025-07-22 22:46:26,795 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 12.30511818639018917559673488
2025-07-22 22:46:28,571 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:46:28,634 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:46:28,648 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:46:28,676 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:46:28,676 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:46:28,702 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:46:28,749 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:46:28,858 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:46:28,871 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:46:28,871 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:46:28,919 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:46:28,924 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:46:28,932 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:46:28,941 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:46:28,941 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:46:28,944 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:46:28,945 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:46:28,946 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:46:28,954 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:46:28,954 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:46:28,965 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:46:28,965 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:46:28,976 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:46:28,992 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:46:28,992 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:46:28,999 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:46:29,008 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:46:29,008 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:46:30,659 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-22 22:46:30,663 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:46:30,663 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:46:30,734 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:30,734 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:46:30,760 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:30,760 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:46:30,785 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:30,785 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:46:30,933 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:46:31,226 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.224475861255656484714739822% which is below threshold 100.0%
2025-07-22 22:46:31,227 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '306.146893304159928244295558', 'margin': '9494.47', 'free_margin': '-9188.323106695840071755704442', 'profit_loss': '-9595.873106695840071755704442', 'margin_level': '3.224475861255656484714739822', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'swap': 'None', 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9558.970000000000000000000000', 'current_price': '118600.0'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'swap': 'None', 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-33.54827881440006523245858418', 'current_price': '96.618'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.354827881440006523245858418', 'current_price': '96.618'}], 'margin_call': True}
2025-07-22 22:46:31,228 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.224475861255656484714739822
2025-07-22 22:46:31,253 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:46:31,253 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:46:31,281 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:31,281 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:46:31,310 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:31,310 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:46:31,336 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:31,337 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:46:31,361 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:31,362 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:46:31,398 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:31,398 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:46:31,452 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:31,452 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:46:31,505 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:31,505 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:46:31,553 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:31,553 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:46:31,704 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:46:32,005 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.858677159730621127847158821% which is below threshold 100.0%
2025-07-22 22:46:32,005 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '229.075000000000000000000000', 'margin': '5936.62', 'free_margin': '-5707.545000000000000000000000', 'profit_loss': '-6160.545000000000000000000000', 'margin_level': '3.858677159730621127847158821', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6160.545000000000000000000000', 'current_price': '118618.2'}], 'margin_call': True}
2025-07-22 22:46:32,006 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.858677159730621127847158821
2025-07-22 22:46:32,042 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:46:32,042 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:46:32,260 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:46:32,555 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.09449834511467304349737552% which is below threshold 100.0%
2025-07-22 22:46:32,555 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '99747.86499999999970000000000', 'margin': '146484.47', 'free_margin': '-46736.60500000000030000000000', 'profit_loss': '-84597.94500000000030000000000', 'margin_level': '68.09449834511467304349737552', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.12500000000030000000000000', 'current_price': '39.217499999999994'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84503.82000000000000000000000', 'current_price': '118618.2'}], 'margin_call': True}
2025-07-22 22:46:32,557 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.09449834511467304349737552
2025-07-22 22:46:32,558 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:46:32,558 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:46:32,605 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:32,605 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:46:32,647 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:32,647 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:46:32,755 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:46:32,756 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:46:32,947 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:46:33,251 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:46:33,253 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:46:33,253 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:46:33,253 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:46:33,254 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:46:33,254 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:46:33,265 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:46:33,266 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:46:33,266 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:46:33,287 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:33,287 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:46:33,288 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:46:33,288 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:46:33,289 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:46:33,289 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:46:33,373 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:46:33,374 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:46:33,765 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:46:33,769 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:46:33,770 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:46:33,770 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:46:33,931 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:46:33,932 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:46:34,278 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:46:34,279 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:46:34,279 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:46:34,279 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:46:34,486 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:46:34,488 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:46:34,867 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:46:34,870 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:46:34,870 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:46:34,870 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:46:34,907 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:34,908 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:46:34,947 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:46:41,166 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:46:41,168 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:46:41,172 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-22 22:46:41,175 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:46:41,178 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:46:41,180 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:46:41,182 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:46:41,184 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:46:41,185 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:46:41,186 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:46:41,187 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:46:41,188 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:46:41,189 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:46:41,190 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:46:41,191 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:46:41,192 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:46:41,193 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:46:41,194 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:46:41,194 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:46:41,195 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:46:41,195 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:46:41,196 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-22 22:46:41,197 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:46:41,197 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:47:04,950 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:47:04,950 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:47:04,950 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:47:04,950 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:47:04,957 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:47:04,957 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:47:04,957 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:47:04,961 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:47:04,962 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:47:04,971 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:47:04,973 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:47:04,973 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:47:05,071 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:47:05,404 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 12.27719157414213315795582034% which is below threshold 100.0%
2025-07-22 22:47:05,405 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '1015.530000000000000000000000', 'margin': '8271.68', 'free_margin': '-7256.150000000000000000000000', 'profit_loss': '-7421.060000000000000000000000', 'margin_level': '12.27719157414213315795582034', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7421.060000000000000000000000', 'current_price': '118593.4'}], 'margin_call': True}
2025-07-22 22:47:05,407 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 12.27719157414213315795582034
2025-07-22 22:47:09,181 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-22 22:47:09,187 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:47:09,188 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:47:09,286 - INFO - app - Application shutdown initiated
2025-07-22 22:47:09,286 - INFO - app - Scheduler shutdown completed
2025-07-22 22:47:09,293 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:47:09,315 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:47:09,315 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:47:09,325 - INFO - app - Redis connection closed
2025-07-22 22:47:09,325 - INFO - app - Application shutdown completed
2025-07-22 22:47:21,201 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:47:21,221 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:47:21,234 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:47:21,234 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:47:21,476 - INFO - app - Application starting up - Trading system initialized
2025-07-22 22:47:21,476 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-22 22:47:21,476 - INFO - app - Environment: PRODUCTION
2025-07-22 22:47:21,522 - INFO - app - Application startup initiated
2025-07-22 22:47:21,522 - INFO - app - Initializing core services...
2025-07-22 22:47:21,562 - INFO - app - Firebase initialized
2025-07-22 22:47:21,562 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-22 22:47:21,605 - INFO - app - Redis initialized
2025-07-22 22:47:22,099 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-22 22:47:22,103 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-22 22:47:22,106 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-22 22:47:22,106 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-22 22:47:22,106 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-22 22:47:22,107 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-22 22:47:22,107 - INFO - app - Scheduler initialized
2025-07-22 22:47:22,108 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:47:22,108 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-22 22:47:23,130 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-22 22:47:23,154 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:47:23,200 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-22 22:47:23,200 - INFO - app - Background tasks initialized
2025-07-22 22:47:23,200 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-22 22:47:24,044 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-22 22:47:24,044 - INFO - app - Application startup completed successfully
2025-07-22 22:47:24,044 - INFO - app - Starting cache validation task
2025-07-22 22:47:24,047 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-22 22:47:24,049 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-22 22:47:24,051 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-22 22:47:24,051 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:47:24,051 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-22 22:47:24,051 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-22 22:47:24,051 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-22 22:47:24,060 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:47:24,103 - INFO - app - Validating cache for 30 users
2025-07-22 22:47:24,104 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-22 22:47:24,104 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-22 22:47:24,104 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-22 22:47:24,115 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-22 22:47:24,117 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:47:24,118 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-22 22:47:24,118 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-22 22:47:24,119 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:47:24,120 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:47:24,121 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:47:24,121 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:47:24,122 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:47:24,123 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:47:24,124 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:47:24,125 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:47:24,126 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:47:24,127 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:47:24,127 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:47:24,129 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:47:24,129 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-22 22:47:24,129 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-22 22:47:24,130 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:47:24,131 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:47:24,133 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:47:24,135 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:47:24,137 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:47:24,138 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:47:24,139 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-22 22:47:24,140 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:47:24,140 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:47:24,168 - INFO - app - Cache validation completed
2025-07-22 22:47:24,203 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:47:24,506 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 12.48875681844558783705365778% which is below threshold 100.0%
2025-07-22 22:47:24,506 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '1033.030000000000000000000000', 'margin': '8271.68', 'free_margin': '-7238.650000000000000000000000', 'profit_loss': '-7403.560000000000000000000000', 'margin_level': '12.48875681844558783705365778', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7403.560000000000000000000000', 'current_price': '118643.4000000000'}], 'margin_call': True}
2025-07-22 22:47:24,512 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 12.48875681844558783705365778
2025-07-22 22:47:24,515 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:47:24,515 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-22 22:47:24,558 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:24,558 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-22 22:47:24,588 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:24,588 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-22 22:47:24,630 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:24,630 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-22 22:47:24,845 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-22 22:47:25,148 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.398665839021043250535711382% which is below threshold 100.0%
2025-07-22 22:47:25,148 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '322.685190258751902587519026', 'margin': '9494.46652136', 'free_margin': '-9171.781331101248097412480974', 'profit_loss': '-9579.334809741248097412480974', 'margin_level': '3.398665839021043250535711382', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9541.610000000000000000000000', 'current_price': '118643.4000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-34.29528158295281582952815830', 'current_price': '96.607'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.429528158295281582952815830', 'current_price': '96.607'}], 'margin_call': True}
2025-07-22 22:47:25,151 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 3.398665839021043250535711382
2025-07-22 22:47:25,184 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-22 22:47:25,184 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-22 22:47:25,230 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:25,230 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-22 22:47:25,267 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:25,267 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-22 22:47:25,302 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:25,303 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-22 22:47:25,342 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:25,342 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-22 22:47:25,369 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:25,369 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-22 22:47:25,398 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:25,398 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-22 22:47:25,423 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:25,423 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-22 22:47:25,459 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:25,459 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-22 22:47:25,562 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-22 22:47:25,860 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.901125556292974790368930469% which is below threshold 100.0%
2025-07-22 22:47:25,860 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '231.595000000000000000000000', 'margin': '5936.62', 'free_margin': '-5705.025000000000000000000000', 'profit_loss': '-6158.025000000000000000000000', 'margin_level': '3.901125556292974790368930469', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6158.025000000000000000000000', 'current_price': '118643.4000000000'}], 'margin_call': True}
2025-07-22 22:47:25,865 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.901125556292974790368930469
2025-07-22 22:47:25,895 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-22 22:47:25,895 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-22 22:47:26,033 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:47:26,039 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:47:26,040 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:47:26,040 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:47:26,061 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-22 22:47:26,095 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:47:26,102 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:47:26,106 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-22 22:47:26,265 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:47:26,274 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:47:26,277 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:47:26,281 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:47:26,284 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:47:26,285 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:47:26,294 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:47:26,295 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:47:26,297 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:47:26,297 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:47:26,298 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:47:26,298 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:47:26,327 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:47:26,332 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:47:26,340 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:47:26,340 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:47:26,343 - INFO - app.core.config - .env file loaded successfully.
2025-07-22 22:47:26,347 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:47:26,348 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:47:26,356 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-22 22:47:26,356 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-22 22:47:26,364 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 68.19775161148482156504372102% which is below threshold 100.0%
2025-07-22 22:47:26,364 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '99899.11500000000000000000000', 'margin': '146484.47', 'free_margin': '-46585.35500000000000000000000', 'profit_loss': '-84446.69500000000000000000000', 'margin_level': '68.19775161148482156504372102', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-94.075000000000000000000000', 'current_price': '39.2185'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-84352.62000000000000000000000', 'current_price': '118643.4000000000'}], 'margin_call': True}
2025-07-22 22:47:26,365 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 68.19775161148482156504372102
2025-07-22 22:47:26,366 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-22 22:47:26,366 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-22 22:47:26,385 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:26,386 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-22 22:47:26,401 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:26,402 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-22 22:47:26,479 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-22 22:47:26,480 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:47:26,587 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user None, falling back to DB and updating cache.
2025-07-22 22:47:26,893 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:47:26,894 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-22 22:47:26,894 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-22 22:47:26,894 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-22 22:47:26,896 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-22 22:47:26,896 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-22 22:47:26,902 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-22 22:47:26,904 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-22 22:47:26,904 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-22 22:47:26,926 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:26,926 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-22 22:47:26,927 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-22 22:47:26,927 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-22 22:47:26,927 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-22 22:47:26,928 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-22 22:47:26,992 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-22 22:47:26,992 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-22 22:47:27,295 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-22 22:47:27,298 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-22 22:47:27,299 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-22 22:47:27,299 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-22 22:47:27,359 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-22 22:47:27,360 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-22 22:47:27,674 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:47:27,679 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-22 22:47:27,679 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-22 22:47:27,679 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-22 22:47:27,792 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-22 22:47:27,793 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-22 22:47:28,088 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-22 22:47:28,089 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-22 22:47:28,089 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-22 22:47:28,089 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-22 22:47:28,106 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:28,106 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-22 22:47:28,125 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-22 22:47:39,057 - INFO - app - Starting stale cache cleanup task
2025-07-22 22:47:39,061 - INFO - app - Found 26 static orders cache entries to check
2025-07-22 22:47:39,065 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-22 22:47:39,067 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-22 22:47:39,070 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-22 22:47:39,073 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-22 22:47:39,074 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-22 22:47:39,076 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-22 22:47:39,077 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-22 22:47:39,079 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-22 22:47:39,081 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-22 22:47:39,082 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-22 22:47:39,084 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-22 22:47:39,086 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-22 22:47:39,087 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-22 22:47:39,088 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-22 22:47:39,090 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-22 22:47:39,093 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-22 22:47:39,094 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-22 22:47:39,096 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-22 22:47:39,097 - WARNING - app - Found stale cache entry for user live:1, will be refreshed on next access
2025-07-22 22:47:39,099 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-22 22:47:39,101 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-22 22:47:39,102 - INFO - app - Completed stale cache cleanup task
2025-07-22 22:47:43,088 - INFO - app - Application shutdown initiated
2025-07-22 22:47:43,088 - INFO - app - Scheduler shutdown completed
2025-07-22 22:47:44,083 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-22 22:47:46,264 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-22 22:47:46,264 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-22 22:47:46,271 - INFO - app - Redis connection closed
2025-07-22 22:47:46,271 - INFO - app - Application shutdown completed
2025-07-23 02:21:29,689 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:21:29,737 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:21:29,753 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:21:29,753 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:21:30,384 - INFO - app - Application starting up - Trading system initialized
2025-07-23 02:21:30,384 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 02:21:30,384 - INFO - app - Environment: PRODUCTION
2025-07-23 02:21:30,452 - INFO - app - Application startup initiated
2025-07-23 02:21:30,452 - INFO - app - Initializing core services...
2025-07-23 02:21:30,505 - INFO - app - Firebase initialized
2025-07-23 02:21:30,505 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 02:21:30,579 - INFO - app - Redis initialized
2025-07-23 02:21:31,430 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 02:21:31,435 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 02:21:31,439 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 02:21:31,439 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-23 02:21:31,440 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 02:21:31,441 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 02:21:31,441 - INFO - app - Scheduler initialized
2025-07-23 02:21:31,443 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:21:31,443 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 02:21:32,793 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:21:32,812 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:21:32,873 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 02:21:32,873 - INFO - app - Background tasks initialized
2025-07-23 02:21:32,873 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:21:33,712 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:21:33,713 - INFO - app - Application startup completed successfully
2025-07-23 02:21:33,713 - INFO - app - Starting cache validation task
2025-07-23 02:21:33,717 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 02:21:33,721 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 02:21:33,724 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-23 02:21:33,724 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:21:33,724 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:21:33,724 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:21:33,724 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:21:33,745 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:21:33,775 - INFO - app - Validating cache for 30 users
2025-07-23 02:21:33,781 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:21:33,781 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:21:33,781 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:21:33,817 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,831 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:21:33,836 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:21:33,836 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:21:33,840 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:21:33,848 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,848 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:21:33,850 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:21:33,853 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:21:33,862 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:21:33,864 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:21:33,866 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:21:33,867 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:21:33,868 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:21:33,871 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:21:33,874 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:21:33,874 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:21:33,876 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:21:33,878 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:21:33,879 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:21:33,882 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:21:33,884 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,884 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:21:33,900 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:21:33,901 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:21:33,904 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:21:33,906 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:21:33,907 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,909 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:21:33,909 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:21:33,918 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,930 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,940 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,949 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,959 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,968 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,977 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,987 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-23 02:21:33,997 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,007 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,027 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,039 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,052 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,062 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,123 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,138 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,156 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:21:34,532 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 11.78382142442647684629966343% which is below threshold 100.0%
2025-07-23 02:21:34,532 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '974.720000000000000000000000', 'margin': '8271.68', 'free_margin': '-7296.960000000000000000000000', 'profit_loss': '-7461.870000000000000000000000', 'margin_level': '11.78382142442647684629966343', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'swap': 'None', 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7461.870000000000000000000000', 'current_price': '118476.8000000000'}], 'margin_call': True}
2025-07-23 02:21:34,534 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 11.78382142442647684629966343
2025-07-23 02:21:34,536 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:21:34,536 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:21:34,538 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,552 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,570 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,574 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:34,574 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:21:34,587 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,604 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,620 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:34,620 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:21:34,633 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-23 02:21:34,650 - INFO - app - Cache validation completed
2025-07-23 02:21:34,664 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:34,664 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:21:34,918 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:21:35,250 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.610164917836239786191733314% which is below threshold 100.0%
2025-07-23 02:21:35,250 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '247.821325074486435628038262', 'margin': '9494.47', 'free_margin': '-9246.648674925513564371961738', 'profit_loss': '-9654.198674925513564371961738', 'margin_level': '2.610164917836239786191733314', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9608.250000000000000000000000', 'current_price': '118476.8000000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-41.77152265955778579269248863', 'current_price': '96.4990000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.177152265955778579269248863', 'current_price': '96.4990000000'}], 'margin_call': True}
2025-07-23 02:21:35,282 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 2.610164917836239786191733314
2025-07-23 02:21:35,311 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:21:35,311 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:21:35,341 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:35,341 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:21:35,369 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:35,369 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:21:35,397 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:35,397 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:21:35,424 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:35,425 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:21:35,455 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:35,455 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:21:35,483 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:35,484 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:21:35,514 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:35,515 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:21:35,560 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:35,561 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:21:35,858 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:21:35,874 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:21:35,876 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:21:35,883 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:21:35,884 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:21:35,889 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:21:35,899 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:21:35,902 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:21:36,174 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.620494490130747799252773464% which is below threshold 100.0%
2025-07-23 02:21:36,174 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '214.935000000000000000000000', 'margin': '5936.62', 'free_margin': '-5721.685000000000000000000000', 'profit_loss': '-6174.685000000000000000000000', 'margin_level': '3.620494490130747799252773464', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6174.685000000000000000000000', 'current_price': '118476.8000000000'}], 'margin_call': True}
2025-07-23 02:21:36,179 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:21:36,182 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:21:36,183 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:21:36,185 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.620494490130747799252773464
2025-07-23 02:21:36,186 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:21:36,191 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:21:36,200 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:21:36,200 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:21:36,201 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:21:36,205 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:21:36,205 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:21:36,207 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:21:36,207 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:21:36,207 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:21:36,207 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:21:36,220 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:21:36,220 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:21:36,227 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:21:36,227 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
pp, API Prefix: /api/v1
2025-07-23 02:21:36,227 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:21:36,239 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:21:36,239 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:21:36,349 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:21:36,686 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 66.01414470762668561384015657% which is below threshold 100.0%
2025-07-23 02:21:36,686 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96700.47000000000000000000000', 'margin': '146484.47', 'free_margin': '-49784.00000000000000000000000', 'profit_loss': '-87645.34000000000000000000000', 'margin_level': '66.01414470762668561384015657', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.50000000000000000000000000', 'current_price': '39.3700000000'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87558.84000000000000000000000', 'current_price': '118109.0300000000'}], 'margin_call': True}
2025-07-23 02:21:36,688 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 66.01414470762668561384015657
2025-07-23 02:21:36,690 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:21:36,690 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:21:36,723 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:36,723 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:21:36,755 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:36,755 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:21:36,879 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:21:37,195 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.87503917635035391195730', 'margin': '6.57', 'free_margin': '16439.30503917635035391195730', 'profit_loss': '-0.3649608236496460880426965442', 'margin_level': '250317.7327119688029514757580', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.3649608236496460880426965442', 'current_price': '0.5217300000'}], 'margin_call': False}
2025-07-23 02:21:37,198 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250317.7327119688029514757580
2025-07-23 02:21:37,199 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:21:37,199 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:21:37,202 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:21:37,202 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:21:37,218 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:21:37,220 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:21:37,220 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:21:37,262 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:37,262 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:21:37,265 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:21:37,265 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:21:37,266 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:21:37,267 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:21:37,370 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:21:37,371 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:21:37,824 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:21:37,829 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:21:37,859 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:21:37,859 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:21:37,972 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:21:37,973 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:21:38,319 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:21:38,323 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:21:38,323 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:21:38,323 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:21:38,459 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:21:38,459 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:21:38,832 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:21:38,835 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:21:38,835 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:21:38,836 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:21:38,974 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:38,974 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:21:39,009 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:21:48,721 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:21:48,725 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:21:48,729 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:21:48,732 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:21:48,737 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:21:48,740 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:21:48,743 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:21:48,745 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:21:48,747 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:21:48,750 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:21:48,752 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:21:48,754 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:21:48,762 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:21:48,764 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:21:48,766 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:21:48,768 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:21:48,771 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:21:48,775 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:21:48,777 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:21:48,780 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:21:48,784 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:21:48,788 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:21:48,789 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:22:09,013 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:22:09,013 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:22:09,013 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:22:09,013 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:22:09,045 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:22:09,045 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:22:09,046 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:22:09,062 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:22:09,062 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:22:09,082 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:22:09,085 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:22:09,086 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:22:09,248 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:22:09,554 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.02457179194552980772950598% which is below threshold 100.0%
2025-07-23 02:22:09,554 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '829.200500000000000000000000', 'margin': '8271.68', 'free_margin': '-7442.479500000000000000000000', 'profit_loss': '-7607.389500000000000000000000', 'margin_level': '10.02457179194552980772950598', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'swap': 'None', 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7607.389500000000000000000000', 'current_price': '118061.03'}], 'margin_call': True}
2025-07-23 02:22:09,556 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.02457179194552980772950598
2025-07-23 02:22:13,618 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:22:13,624 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:22:13,624 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:22:13,793 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:13,794 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:22:13,831 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:13,831 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:22:13,891 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:13,891 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:22:14,044 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:22:14,371 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.8933027400299970511177587480% which is below threshold 100.0%
2025-07-23 02:22:14,372 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '84.814360661326061019260269', 'margin': '9494.47', 'free_margin': '-9409.655639338673938980739731', 'profit_loss': '-9817.205639338673938980739731', 'margin_level': '0.8933027400299970511177587480', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9774.558000000000000000000000', 'current_price': '118061.03'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-38.77058121697630816430884609', 'current_price': '96.543'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.877058121697630816430884609', 'current_price': '96.543'}], 'margin_call': True}
2025-07-23 02:22:14,375 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.8933027400299970511177587480
2025-07-23 02:22:14,434 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:22:14,434 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:22:14,484 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:14,484 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:22:14,523 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:14,523 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:22:14,570 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:14,571 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:22:14,616 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:14,616 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:22:14,665 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:14,665 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:22:14,717 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:14,717 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:22:14,755 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:14,755 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:22:14,804 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:14,804 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:22:14,910 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:22:15,288 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.920146480657343741051305288% which is below threshold 100.0%
2025-07-23 02:22:15,289 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '173.358000000000000000000000', 'margin': '5936.62', 'free_margin': '-5763.262000000000000000000000', 'profit_loss': '-6216.262000000000000000000000', 'margin_level': '2.920146480657343741051305288', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6216.262000000000000000000000', 'current_price': '118061.03'}], 'margin_call': True}
2025-07-23 02:22:15,291 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.920146480657343741051305288
2025-07-23 02:22:15,360 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:22:15,360 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:22:15,475 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:22:15,822 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 65.81762216841143620890323732% which is below threshold 100.0%
2025-07-23 02:22:15,822 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96412.59499999999975000000000', 'margin': '146484.47', 'free_margin': '-50071.87500000000025000000000', 'profit_loss': '-87933.21500000000025000000000', 'margin_level': '65.81762216841143620890323732', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.37500000000025000000000000', 'current_price': '39.372499999999995'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87846.84000000000000000000000', 'current_price': '118061.03'}], 'margin_call': True}
2025-07-23 02:22:15,832 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 65.81762216841143620890323732
2025-07-23 02:22:15,838 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:22:15,838 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:22:15,931 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:15,931 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:22:15,991 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:15,991 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:22:16,113 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:22:16,521 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.62269553477926239953569', 'margin': '6.57', 'free_margin': '16439.05269553477926239953569', 'profit_loss': '-0.6173044652207376004643123005', 'margin_level': '250313.8918650651333698559466', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.6173044652207376004643123005', 'current_price': '0.52153'}], 'margin_call': False}
2025-07-23 02:22:16,525 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250313.8918650651333698559466
2025-07-23 02:22:16,528 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:22:16,528 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:22:16,532 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:22:16,532 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:22:16,560 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:22:16,587 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:22:16,588 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:22:16,660 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:16,660 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:22:16,663 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:22:16,663 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:22:16,664 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:22:16,665 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:22:16,869 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:22:16,870 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:22:17,235 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:22:17,237 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:22:17,240 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:22:17,240 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:22:17,473 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:22:17,476 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:22:17,847 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:22:17,853 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:22:17,853 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:22:17,853 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:22:18,001 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:22:18,002 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:22:18,357 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:22:18,361 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:22:18,361 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:22:18,361 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:22:18,446 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:18,446 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:22:18,499 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:31,445 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:22:31,874 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:22:48,504 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:22:48,504 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:22:48,504 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:22:48,504 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:22:48,518 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:22:48,518 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:22:48,518 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:22:48,526 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:22:48,526 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:22:48,544 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:22:48,547 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:22:48,548 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:22:48,658 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:22:49,083 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.01306264265542187318658362% which is below threshold 100.0%
2025-07-23 02:22:49,083 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '828.248500000000000000000000', 'margin': '8271.68', 'free_margin': '-7443.431500000000000000000000', 'profit_loss': '-7608.341500000000000000000000', 'margin_level': '10.01306264265542187318658362', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'swap': 'None', 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7608.341500000000000000000000', 'current_price': '118058.31'}], 'margin_call': True}
2025-07-23 02:22:49,087 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.01306264265542187318658362
2025-07-23 02:22:53,277 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:22:53,286 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:22:53,286 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:22:53,448 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:53,449 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:22:53,497 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:53,497 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:22:53,555 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:53,555 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:22:53,684 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:22:53,999 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.8577048396363988513598421292% which is below threshold 100.0%
2025-07-23 02:22:53,999 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '81.434528687825998022704803', 'margin': '9494.47', 'free_margin': '-9413.035471312174001977295197', 'profit_loss': '-9820.585471312174001977295197', 'margin_level': '0.8577048396363988513598421292', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9778.010000000000000000000000', 'current_price': '118052.4'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-38.70497392015818361572290594', 'current_price': '96.544'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-3.870497392015818361572290594', 'current_price': '96.544'}], 'margin_call': True}
2025-07-23 02:22:54,002 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.8577048396363988513598421292
2025-07-23 02:22:54,059 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:22:54,059 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:22:54,125 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:54,126 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:22:54,175 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:54,175 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:22:54,217 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:54,218 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:22:54,272 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:54,272 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:22:54,315 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:54,315 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:22:54,356 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:54,356 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:22:54,395 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:54,395 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:22:54,470 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:54,471 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:22:54,671 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:22:55,121 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.920146480657343741051305288% which is below threshold 100.0%
2025-07-23 02:22:55,122 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '173.358000000000000000000000', 'margin': '5936.62', 'free_margin': '-5763.262000000000000000000000', 'profit_loss': '-6216.262000000000000000000000', 'margin_level': '2.920146480657343741051305288', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6216.262000000000000000000000', 'current_price': '118061.03'}], 'margin_call': True}
2025-07-23 02:22:55,124 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.920146480657343741051305288
2025-07-23 02:22:55,172 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:22:55,172 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:22:55,338 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:22:55,735 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 65.78223957802489233158982655% which is below threshold 100.0%
2025-07-23 02:22:55,735 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96360.76500000000000000000000', 'margin': '146484.47', 'free_margin': '-50123.70500000000000000000000', 'profit_loss': '-87985.04500000000000000000000', 'margin_level': '65.78223957802489233158982655', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.425000000000000000000000', 'current_price': '39.3715'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87898.62000000000000000000000', 'current_price': '118052.4'}], 'margin_call': True}
2025-07-23 02:22:55,737 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 65.78223957802489233158982655
2025-07-23 02:22:55,739 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:22:55,739 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:22:55,822 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:55,822 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:22:55,890 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:55,891 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:22:56,059 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:22:56,456 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.68583874752419039448951', 'margin': '6.57', 'free_margin': '16439.11583874752419039448951', 'profit_loss': '-0.5541612524758096055104898634', 'margin_level': '250314.8529489729709344671158', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.5541612524758096055104898634', 'current_price': '0.52158'}], 'margin_call': False}
2025-07-23 02:22:56,489 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250314.8529489729709344671158
2025-07-23 02:22:56,491 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:22:56,492 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:22:56,494 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:22:56,495 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:22:56,526 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:22:56,530 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:22:56,531 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:22:56,585 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:56,585 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:22:56,587 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:22:56,587 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:22:56,588 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:22:56,588 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:22:56,675 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:22:56,675 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:22:57,069 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:22:57,072 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:22:57,075 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:22:57,075 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:22:57,381 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:22:57,383 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:22:57,698 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:22:57,703 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:22:57,704 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:22:57,704 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:22:57,932 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:22:57,933 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:22:58,295 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:22:58,329 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:22:58,330 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:22:58,330 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:22:58,404 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:22:58,405 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:22:58,458 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:28,470 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:23:28,471 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:23:28,471 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:23:28,471 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:23:28,481 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:23:28,481 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:23:28,481 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:23:28,489 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:23:28,489 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:23:28,511 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:23:28,514 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:23:28,514 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:23:28,757 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:23:29,070 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.06680021470849936167743433% which is below threshold 100.0%
2025-07-23 02:23:29,070 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '832.693500000000000000000000', 'margin': '8271.68', 'free_margin': '-7438.986500000000000000000000', 'profit_loss': '-7603.896500000000000000000000', 'margin_level': '10.06680021470849936167743433', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'swap': 'None', 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7603.896500000000000000000000', 'current_price': '118071.01'}], 'margin_call': True}
2025-07-23 02:23:29,073 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.06680021470849936167743433
2025-07-23 02:23:33,006 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:23:33,018 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:23:33,019 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:23:33,193 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:33,194 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:23:33,228 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:33,228 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:23:33,263 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:33,263 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:23:33,356 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:23:33,726 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.9156041699352232747969166789% which is below threshold 100.0%
2025-07-23 02:23:33,726 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '86.931763233248793258610815', 'margin': '9494.47', 'free_margin': '-9407.538236766751206741389185', 'profit_loss': '-9815.088236766751206741389185', 'margin_level': '0.9156041699352232747969166789', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9770.566000000000000000000000', 'current_price': '118071.01'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-40.47476069704655158308107666', 'current_price': '96.518'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.047476069704655158308107666', 'current_price': '96.518'}], 'margin_call': True}
2025-07-23 02:23:33,728 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.9156041699352232747969166789
2025-07-23 02:23:33,781 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:23:33,781 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:23:33,820 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:33,820 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:23:33,880 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:33,881 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:23:33,927 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:33,927 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:23:33,973 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:33,973 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:23:34,033 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:34,035 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:23:34,124 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:34,125 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:23:34,182 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:34,182 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:23:34,226 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:34,227 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:23:34,357 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:23:34,753 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.936957393264180628034133901% which is below threshold 100.0%
2025-07-23 02:23:34,754 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '174.356000000000000000000000', 'margin': '5936.62', 'free_margin': '-5762.264000000000000000000000', 'profit_loss': '-6215.264000000000000000000000', 'margin_level': '2.936957393264180628034133901', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6215.264000000000000000000000', 'current_price': '118071.01'}], 'margin_call': True}
2025-07-23 02:23:34,757 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.936957393264180628034133901
2025-07-23 02:23:34,824 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:23:34,824 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:23:35,015 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:23:35,362 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 65.85826128872227888731139895% which is below threshold 100.0%
2025-07-23 02:23:35,363 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96472.12500000000000000000000', 'margin': '146484.47', 'free_margin': '-50012.34500000000000000000000', 'profit_loss': '-87873.68500000000000000000000', 'margin_level': '65.85826128872227888731139895', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.725000000000000000000000', 'current_price': '39.3655'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87786.96000000000000000000000', 'current_price': '118071.01'}], 'margin_call': True}
2025-07-23 02:23:35,366 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 65.85826128872227888731139895
2025-07-23 02:23:35,369 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:23:35,369 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:23:35,434 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:35,434 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:23:35,470 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:35,470 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:23:35,601 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:23:35,944 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.57232708052124988961915', 'margin': '6.57', 'free_margin': '16439.00232708052124988961915', 'profit_loss': '-0.6676729194787501103808454542', 'margin_level': '250313.1252219257420074523463', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.6676729194787501103808454542', 'current_price': '0.52149'}], 'margin_call': False}
2025-07-23 02:23:35,972 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250313.1252219257420074523463
2025-07-23 02:23:35,975 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:23:35,976 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:23:35,979 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:23:35,979 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:23:36,013 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:23:36,016 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:23:36,017 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:23:36,074 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:36,074 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:23:36,076 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:23:36,076 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:23:36,078 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:23:36,078 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:23:36,238 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:23:36,239 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:23:36,691 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:23:36,693 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:23:36,695 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:23:36,695 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:23:36,823 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:23:36,824 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:23:37,205 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:23:37,208 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:23:37,208 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:23:37,208 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:23:37,412 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:23:37,413 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:23:37,819 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:23:37,826 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:23:37,826 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:23:37,827 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:23:37,899 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:23:37,899 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:23:37,946 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:07,950 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:24:07,950 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:24:07,951 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:24:07,951 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:24:07,968 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:24:07,968 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:24:07,969 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:24:07,979 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:24:07,979 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:24:07,996 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:24:08,000 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:24:08,000 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:24:08,265 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:24:08,642 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 9.989325022244574258191806259% which is below threshold 100.0%
2025-07-23 02:24:08,643 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '826.285000000000000000000000', 'margin': '8271.68', 'free_margin': '-7445.395000000000000000000000', 'profit_loss': '-7610.305000000000000000000000', 'margin_level': '9.989325022244574258191806259', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'swap': 'None', 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7610.305000000000000000000000', 'current_price': '118052.7'}], 'margin_call': True}
2025-07-23 02:24:08,647 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 9.989325022244574258191806259
2025-07-23 02:24:09,492 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:24:09,493 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:24:09,534 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:09,534 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:24:09,566 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:09,567 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:24:09,599 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:09,599 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:24:09,719 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:24:10,081 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.8345088234572911887263184464% which is below threshold 100.0%
2025-07-23 02:24:10,081 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '79.232189890505474726263687', 'margin': '9494.47', 'free_margin': '-9415.237810109494525273736313', 'profit_loss': '-9822.787810109494525273736313', 'margin_level': '0.8345088234572911887263184464', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9777.890000000000000000000000', 'current_price': '118052.7'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-40.81619100863138661248755744', 'current_price': '96.513'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.081619100863138661248755744', 'current_price': '96.513'}], 'margin_call': True}
2025-07-23 02:24:10,084 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.8345088234572911887263184464
2025-07-23 02:24:10,134 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:24:10,134 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:24:10,200 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:10,201 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:24:10,263 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:10,263 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:24:10,720 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:10,721 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:24:10,791 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:10,791 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:24:10,860 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:10,860 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:24:10,973 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:10,973 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:24:11,096 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:11,096 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:24:11,148 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:11,148 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:24:11,421 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:24:11,731 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.949910892056422678224309456% which is below threshold 100.0%
2025-07-23 02:24:11,747 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '175.125000000000000000000000', 'margin': '5936.62', 'free_margin': '-5761.495000000000000000000000', 'profit_loss': '-6214.495000000000000000000000', 'margin_level': '2.949910892056422678224309456', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6214.495000000000000000000000', 'current_price': '118078.7'}], 'margin_call': True}
2025-07-23 02:24:11,757 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.949910892056422678224309456
2025-07-23 02:24:11,950 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:24:11,950 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:24:12,264 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:24:12,638 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 65.88996430816181401345821847% which is below threshold 100.0%
2025-07-23 02:24:12,638 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96518.56500000000000000000000', 'margin': '146484.47', 'free_margin': '-49965.90500000000000000000000', 'profit_loss': '-87827.24500000000000000000000', 'margin_level': '65.88996430816181401345821847', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.425000000000000000000000', 'current_price': '39.3715'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87740.82000000000000000000000', 'current_price': '118078.7'}], 'margin_call': True}
2025-07-23 02:24:12,652 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 65.88996430816181401345821847
2025-07-23 02:24:12,664 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:24:12,664 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:24:12,819 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:12,819 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:24:12,935 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:12,935 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:24:13,153 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:24:13,562 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.58495603799540827267796', 'margin': '6.57', 'free_margin': '16439.01495603799540827267796', 'profit_loss': '-0.6550439620045917273220390297', 'margin_level': '250313.3174435006911457028609', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.6550439620045917273220390297', 'current_price': '0.5215000000000001'}], 'margin_call': False}
2025-07-23 02:24:13,564 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250313.3174435006911457028609
2025-07-23 02:24:13,566 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:24:13,566 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:24:13,568 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:24:13,568 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:24:13,595 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:24:13,598 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:24:13,598 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:24:13,642 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:13,642 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:24:13,644 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:24:13,644 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:24:13,645 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:24:13,646 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:24:13,813 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:24:13,814 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:24:14,123 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:24:14,138 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:24:14,174 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:24:14,182 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:24:14,534 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:24:14,536 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:24:14,847 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:24:14,851 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:24:14,851 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:24:14,851 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:24:14,992 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:24:14,993 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:24:15,403 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:24:15,406 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:24:15,407 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:24:15,407 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:24:15,464 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:15,464 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:24:15,511 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:24,452 - INFO - app - Application shutdown initiated
2025-07-23 02:24:24,453 - INFO - app - Scheduler shutdown completed
2025-07-23 02:24:24,934 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 02:24:25,641 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 02:24:25,641 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 02:24:25,645 - INFO - app - Redis connection closed
2025-07-23 02:24:25,645 - INFO - app - Application shutdown completed
2025-07-23 02:24:28,172 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:24:28,211 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:24:28,232 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:24:28,232 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:24:28,719 - INFO - app - Application starting up - Trading system initialized
2025-07-23 02:24:28,719 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 02:24:28,720 - INFO - app - Environment: PRODUCTION
2025-07-23 02:24:28,810 - INFO - app - Application startup initiated
2025-07-23 02:24:28,811 - INFO - app - Initializing core services...
2025-07-23 02:24:28,849 - INFO - app - Firebase initialized
2025-07-23 02:24:28,849 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 02:24:28,870 - INFO - app - Redis initialized
2025-07-23 02:24:29,580 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 02:24:29,585 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 02:24:29,589 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 02:24:29,589 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-23 02:24:29,589 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 02:24:29,591 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 02:24:29,591 - INFO - app - Scheduler initialized
2025-07-23 02:24:29,593 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:24:29,594 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 02:24:30,554 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:24:30,576 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:24:30,632 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 02:24:30,632 - INFO - app - Background tasks initialized
2025-07-23 02:24:30,632 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:24:31,374 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:24:31,375 - INFO - app - Application startup completed successfully
2025-07-23 02:24:31,375 - INFO - app - Starting cache validation task
2025-07-23 02:24:31,379 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 02:24:31,381 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 02:24:31,384 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-23 02:24:31,384 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:24:31,384 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:24:31,385 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:24:31,385 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:24:31,419 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:24:31,466 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:24:31,466 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:24:31,466 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:24:31,468 - INFO - app - Validating cache for 30 users
2025-07-23 02:24:31,478 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:24:31,486 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:24:31,486 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:24:31,490 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:24:31,493 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:24:31,496 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:24:31,498 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:24:31,499 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:24:31,501 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:24:31,503 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:24:31,506 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:24:31,509 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:24:31,511 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:24:31,512 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:24:31,514 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:24:31,518 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:24:31,519 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:24:31,521 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:24:31,525 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:24:31,525 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:24:31,526 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:24:31,527 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:24:31,531 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:24:31,534 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:24:31,537 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:24:31,537 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:24:31,589 - INFO - app - Cache validation completed
2025-07-23 02:24:31,673 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:24:31,987 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.09933894928237069132268173% which is below threshold 100.0%
2025-07-23 02:24:31,988 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '835.385000000000000000000000', 'margin': '8271.68', 'free_margin': '-7436.295000000000000000000000', 'profit_loss': '-7601.205000000000000000000000', 'margin_level': '10.09933894928237069132268173', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7601.205000000000000000000000', 'current_price': '118078.7'}], 'margin_call': True}
2025-07-23 02:24:32,024 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.09933894928237069132268173
2025-07-23 02:24:33,873 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:24:33,945 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:24:33,970 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:24:33,972 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:24:33,980 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:24:34,006 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:24:34,223 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:24:34,242 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:24:34,244 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:24:34,298 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:24:34,300 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:24:34,300 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:24:34,301 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:24:34,320 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:24:34,320 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:24:34,320 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:24:34,321 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:24:34,322 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:24:34,322 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:24:34,323 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:24:34,323 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:24:34,328 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:24:34,344 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:24:34,352 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:24:34,353 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:24:34,358 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:24:34,358 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:24:35,882 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:24:35,913 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:24:35,913 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:24:36,113 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:36,113 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:24:36,153 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:36,154 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:24:36,198 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:36,198 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:24:36,317 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:24:36,703 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.9424633261146794768724696797% which is below threshold 100.0%
2025-07-23 02:24:36,703 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '89.481897758960408527813572', 'margin': '9494.47', 'free_margin': '-9404.988102241039591472186428', 'profit_loss': '-9812.538102241039591472186428', 'margin_level': '0.9424633261146794768724696797', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9767.490000000000000000000000', 'current_price': '118078.7'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-40.95282021912690133835129847', 'current_price': '96.511'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.095282021912690133835129847', 'current_price': '96.511'}], 'margin_call': True}
2025-07-23 02:24:36,705 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.9424633261146794768724696797
2025-07-23 02:24:36,757 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:24:36,757 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:24:36,811 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:36,812 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:24:36,861 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:36,861 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:24:36,915 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:36,915 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:24:36,966 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:36,967 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:24:37,018 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:37,018 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:24:37,071 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:37,072 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:24:37,116 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:37,116 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:24:37,159 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:37,159 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:24:37,304 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:24:37,622 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.949910892056422678224309456% which is below threshold 100.0%
2025-07-23 02:24:37,622 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '175.125000000000000000000000', 'margin': '5936.62', 'free_margin': '-5761.495000000000000000000000', 'profit_loss': '-6214.495000000000000000000000', 'margin_level': '2.949910892056422678224309456', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6214.495000000000000000000000', 'current_price': '118078.7'}], 'margin_call': True}
2025-07-23 02:24:37,626 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.949910892056422678224309456
2025-07-23 02:24:37,940 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:24:37,941 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:24:38,105 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:24:38,404 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 65.88996430816181401345821847% which is below threshold 100.0%
2025-07-23 02:24:38,404 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96518.56500000000000000000000', 'margin': '146484.47', 'free_margin': '-49965.90500000000000000000000', 'profit_loss': '-87827.24500000000000000000000', 'margin_level': '65.88996430816181401345821847', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.425000000000000000000000', 'current_price': '39.3715'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87740.82000000000000000000000', 'current_price': '118078.7'}], 'margin_call': True}
2025-07-23 02:24:38,410 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 65.88996430816181401345821847
2025-07-23 02:24:38,412 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:24:38,412 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:24:38,466 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:38,466 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:24:38,565 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:38,566 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:24:38,686 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:24:39,219 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.57231991926327740633279', 'margin': '6.57', 'free_margin': '16439.00231991926327740633279', 'profit_loss': '-0.6676800807367225936672133216', 'margin_level': '250313.1251129263816956823865', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.6676800807367225936672133216', 'current_price': '0.52149'}], 'margin_call': False}
2025-07-23 02:24:39,221 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250313.1251129263816956823865
2025-07-23 02:24:39,224 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:24:39,224 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:24:39,226 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:24:39,226 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:24:39,246 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:24:39,249 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:24:39,249 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:24:39,297 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:39,297 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:24:39,299 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:24:39,299 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:24:39,300 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:24:39,300 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:24:39,427 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:24:39,429 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:24:40,280 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:24:40,307 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:24:40,332 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:24:40,333 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:24:40,470 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:24:40,471 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:24:40,794 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:24:40,798 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:24:40,798 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:24:40,798 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:24:40,984 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:24:40,984 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:24:41,305 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:24:41,307 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:24:41,307 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:24:41,307 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:24:41,355 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:41,356 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:24:41,399 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:24:46,377 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:24:46,379 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:24:46,382 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:24:46,384 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:24:46,387 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:24:46,388 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:24:46,390 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:24:46,392 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:24:46,393 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:24:46,395 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:24:46,397 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:24:46,399 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:24:46,400 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:24:46,402 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:24:46,404 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:24:46,405 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:24:46,407 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:24:46,412 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:24:46,414 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:24:46,418 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:24:46,422 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:24:46,427 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:24:46,427 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:25:11,405 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:25:11,405 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:25:11,406 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:25:11,406 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:25:11,414 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:25:11,414 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:25:11,414 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:25:11,422 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:25:11,422 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:25:11,443 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:25:11,447 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:25:11,448 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:25:11,698 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:25:12,025 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.13619361484003249642152501% which is below threshold 100.0%
2025-07-23 02:25:12,025 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '838.433500000000000000000000', 'margin': '8271.68', 'free_margin': '-7433.246500000000000000000000', 'profit_loss': '-7598.156500000000000000000000', 'margin_level': '10.13619361484003249642152501', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7598.156500000000000000000000', 'current_price': '118087.41'}], 'margin_call': True}
2025-07-23 02:25:12,027 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.13619361484003249642152501
2025-07-23 02:25:15,824 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:25:15,829 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:25:15,829 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:25:16,015 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:16,015 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:25:16,053 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:16,053 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:25:16,093 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:16,093 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:25:16,240 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:25:16,648 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.195364663975859290070316890% which is below threshold 100.0%
2025-07-23 02:25:16,648 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '113.493539411788767537939216', 'margin': '9494.47', 'free_margin': '-9380.976460588211232462060784', 'profit_loss': '-9788.526460588211232462060784', 'margin_level': '1.195364663975859290070316890', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9744.006000000000000000000000', 'current_price': '118137.4100000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-40.47314598928293860187344050', 'current_price': '96.518'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.047314598928293860187344050', 'current_price': '96.518'}], 'margin_call': True}
2025-07-23 02:25:16,651 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 1.195364663975859290070316890
2025-07-23 02:25:16,707 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:25:16,707 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:25:16,754 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:16,754 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:25:16,793 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:16,794 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:25:16,836 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:16,836 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:25:16,928 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:16,928 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:25:16,987 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:16,988 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:25:17,030 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:17,030 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:25:17,066 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:17,067 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:25:17,102 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:17,102 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:25:17,254 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:25:17,560 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.048805549285620437218484592% which is below threshold 100.0%
2025-07-23 02:25:17,560 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '180.996000000000000000000000', 'margin': '5936.62', 'free_margin': '-5755.624000000000000000000000', 'profit_loss': '-6208.624000000000000000000000', 'margin_level': '3.048805549285620437218484592', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6208.624000000000000000000000', 'current_price': '118137.4100000000'}], 'margin_call': True}
2025-07-23 02:25:17,562 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.048805549285620437218484592
2025-07-23 02:25:17,597 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:25:17,597 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:25:17,783 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:25:18,163 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 66.13020137902673232186319819% which is below threshold 100.0%
2025-07-23 02:25:18,163 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96870.47500000000000000000000', 'margin': '146484.47', 'free_margin': '-49613.99500000000000000000000', 'profit_loss': '-87475.33500000000000000000000', 'margin_level': '66.13020137902673232186319819', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.775000000000000000000000', 'current_price': '39.3645'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87388.56000000000000000000000', 'current_price': '118137.4100000000'}], 'margin_call': True}
2025-07-23 02:25:18,168 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 66.13020137902673232186319819
2025-07-23 02:25:18,171 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:25:18,172 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:25:18,227 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:18,228 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:25:18,267 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:18,267 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:25:18,435 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:25:18,794 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.55974140649637338379060', 'margin': '6.57', 'free_margin': '16438.98974140649637338379060', 'profit_loss': '-0.6802585935036266162093976664', 'margin_level': '250312.9336591551959419146210', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.6802585935036266162093976664', 'current_price': '0.52148'}], 'margin_call': False}
2025-07-23 02:25:18,796 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250312.9336591551959419146210
2025-07-23 02:25:18,797 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:25:18,798 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:25:18,799 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:25:18,799 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:25:18,822 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:25:18,824 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:25:18,824 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:25:18,870 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:18,870 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:25:18,872 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:25:18,872 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:25:18,874 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:25:18,874 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:25:19,074 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:25:19,076 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:25:19,404 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:25:19,407 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:25:19,430 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:25:19,430 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:25:19,680 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:25:19,681 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:25:20,013 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:25:20,016 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:25:20,016 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:25:20,016 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:25:20,207 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:25:20,208 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:25:20,530 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:25:20,533 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:25:20,533 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:25:20,533 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:25:20,588 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:20,588 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:25:20,617 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:29,597 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:25:29,955 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:25:50,630 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:25:50,631 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:25:50,631 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:25:50,631 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:25:50,640 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:25:50,641 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:25:50,641 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:25:50,648 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:25:50,648 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:25:50,666 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:25:50,669 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:25:50,670 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:25:50,833 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:25:51,146 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.05871842237610739293589694% which is below threshold 100.0%
2025-07-23 02:25:51,147 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '832.025000000000000000000000', 'margin': '8271.68', 'free_margin': '-7439.655000000000000000000000', 'profit_loss': '-7604.565000000000000000000000', 'margin_level': '10.05871842237610739293589694', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7604.565000000000000000000000', 'current_price': '118069.1'}], 'margin_call': True}
2025-07-23 02:25:51,149 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.05871842237610739293589694
2025-07-23 02:25:55,135 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:25:55,140 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:25:55,141 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:25:55,368 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:55,369 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:25:55,421 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:55,422 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:25:55,470 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:55,470 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:25:55,603 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:25:55,957 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.9083659390329246639735885415% which is below threshold 100.0%
2025-07-23 02:25:55,958 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '86.244531571699322343573172', 'margin': '9494.47', 'free_margin': '-9408.225468428300677656426828', 'profit_loss': '-9815.775468428300677656426828', 'margin_level': '0.9083659390329246639735885415', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9771.330000000000000000000000', 'current_price': '118069.1'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-40.40497129845516150584257100', 'current_price': '96.519'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.040497129845516150584257100', 'current_price': '96.519'}], 'margin_call': True}
2025-07-23 02:25:55,959 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.9083659390329246639735885415
2025-07-23 02:25:56,015 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:25:56,016 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:25:56,071 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:56,072 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:25:56,117 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:56,117 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:25:56,192 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:56,192 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:25:56,260 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:56,260 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:25:56,412 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:56,413 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:25:56,480 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:56,480 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:25:56,534 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:56,534 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:25:56,604 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:56,605 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:25:56,819 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:25:57,117 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.933740074318383187739825018% which is below threshold 100.0%
2025-07-23 02:25:57,117 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '174.165000000000000000000000', 'margin': '5936.62', 'free_margin': '-5762.455000000000000000000000', 'profit_loss': '-6215.455000000000000000000000', 'margin_level': '2.933740074318383187739825018', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6215.455000000000000000000000', 'current_price': '118069.1'}], 'margin_call': True}
2025-07-23 02:25:57,119 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.933740074318383187739825018
2025-07-23 02:25:57,159 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:25:57,160 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:25:57,327 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:25:57,696 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 65.85043793379598533551031041% which is below threshold 100.0%
2025-07-23 02:25:57,697 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96460.66500000000000000000000', 'margin': '146484.47', 'free_margin': '-50023.80500000000000000000000', 'profit_loss': '-87885.14500000000000000000000', 'margin_level': '65.85043793379598533551031041', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.725000000000000000000000', 'current_price': '39.3655'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87798.42000000000000000000000', 'current_price': '118069.1'}], 'margin_call': True}
2025-07-23 02:25:57,700 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 65.85043793379598533551031041
2025-07-23 02:25:57,702 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:25:57,702 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:25:57,755 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:57,755 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:25:57,802 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:57,803 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:25:57,997 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:25:58,311 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.58493503216866405954333', 'margin': '6.57', 'free_margin': '16439.01493503216866405954333', 'profit_loss': '-0.6550649678313359404566670872', 'margin_level': '250313.3171237773008228240994', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.6550649678313359404566670872', 'current_price': '0.5215000000000001'}], 'margin_call': False}
2025-07-23 02:25:58,313 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250313.3171237773008228240994
2025-07-23 02:25:58,316 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:25:58,316 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:25:58,318 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:25:58,318 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:25:58,331 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:25:58,333 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:25:58,333 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:25:58,375 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:25:58,375 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:25:58,377 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:25:58,377 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:25:58,378 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:25:58,378 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:25:58,569 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:25:58,571 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:25:58,886 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:25:58,891 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:25:58,895 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:25:58,896 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:25:59,135 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:25:59,137 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:25:59,540 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:25:59,544 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:25:59,544 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:25:59,545 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:25:59,742 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:25:59,743 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:26:00,153 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:26:00,155 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:26:00,155 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:26:00,155 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:26:00,218 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:00,218 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:26:00,269 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:29,595 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:26:29,949 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:26:30,286 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:26:30,287 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:26:30,287 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:26:30,287 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:26:30,295 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:26:30,296 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:26:30,296 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:26:30,301 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:26:30,301 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:26:30,318 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:26:30,321 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:26:30,321 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:26:30,510 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:26:30,875 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.23224423575380092073194321% which is below threshold 100.0%
2025-07-23 02:26:30,875 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '846.378500000000000000000000', 'margin': '8271.68', 'free_margin': '-7425.301500000000000000000000', 'profit_loss': '-7590.211500000000000000000000', 'margin_level': '10.23224423575380092073194321', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7590.211500000000000000000000', 'current_price': '118110.11'}], 'margin_call': True}
2025-07-23 02:26:30,890 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.23224423575380092073194321
2025-07-23 02:26:34,869 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:26:34,896 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:26:34,897 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:26:35,054 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,054 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:26:35,088 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,089 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:26:35,124 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,124 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:26:35,231 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:26:35,553 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 1.078733097459909341999150484% which is below threshold 100.0%
2025-07-23 02:26:35,553 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '102.419990318401854503306743', 'margin': '9494.47', 'free_margin': '-9392.050009681598145496693257', 'profit_loss': '-9799.600009681598145496693257', 'margin_level': '1.078733097459909341999150484', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9754.926000000000000000000000', 'current_price': '118110.11'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-40.61273607418013226972114270', 'current_price': '96.516'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.061273607418013226972114270', 'current_price': '96.516'}], 'margin_call': True}
2025-07-23 02:26:35,558 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 1.078733097459909341999150484
2025-07-23 02:26:35,618 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:26:35,618 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:26:35,674 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,674 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:26:35,710 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,710 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:26:35,745 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,746 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:26:35,782 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,782 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:26:35,820 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,820 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:26:35,893 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,893 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:26:35,943 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,943 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:26:35,976 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:35,976 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:26:36,102 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:26:36,505 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 3.002819786343070636153231974% which is below threshold 100.0%
2025-07-23 02:26:36,505 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '178.266000000000000000000000', 'margin': '5936.62', 'free_margin': '-5758.354000000000000000000000', 'profit_loss': '-6211.354000000000000000000000', 'margin_level': '3.002819786343070636153231974', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6211.354000000000000000000000', 'current_price': '118110.11'}], 'margin_call': True}
2025-07-23 02:26:36,510 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 3.002819786343070636153231974
2025-07-23 02:26:36,565 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:26:36,566 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:26:36,788 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:26:36,792 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 26, falling back to DB and updating cache.
2025-07-23 02:26:37,118 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '0.0', 'equity': '-87639.28500000000000000000000', 'margin': '0.0', 'free_margin': '-87639.28500000000000000000000', 'profit_loss': '-87639.28500000000000000000000', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.925000000000000000000000', 'current_price': '39.3615'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87552.36000000000000000000000', 'current_price': '118110.11'}], 'margin_call': False}
2025-07-23 02:26:37,123 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 0.0
2025-07-23 02:26:37,123 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:26:37,123 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:26:37,200 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:37,200 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:26:37,246 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:37,247 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:26:37,396 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:26:37,398 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 1, falling back to DB and updating cache.
2025-07-23 02:26:37,747 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '-0.6550649678313359404566670872', 'margin': '0.0', 'free_margin': '-0.6550649678313359404566670872', 'profit_loss': '-0.6550649678313359404566670872', 'margin_level': '0.0', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.6550649678313359404566670872', 'current_price': '0.5215000000000001'}], 'margin_call': False}
2025-07-23 02:26:37,778 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-23 02:26:37,778 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:26:37,778 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:26:37,781 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:26:37,781 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:26:37,814 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:26:37,817 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:26:37,817 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:26:37,861 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:37,862 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:26:37,864 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:26:37,864 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:26:37,866 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:26:37,866 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:26:38,081 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:26:38,082 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:26:38,484 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:26:38,486 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:26:38,489 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:26:38,489 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:26:38,595 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:26:38,595 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:26:38,599 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:26:38,964 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:26:38,969 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:26:38,970 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:26:38,970 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:26:39,173 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:26:39,175 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:26:39,182 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:26:39,578 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:26:39,580 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:26:39,580 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:26:39,580 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:26:39,649 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:26:39,650 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:26:39,725 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:09,734 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:27:09,735 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:27:09,735 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:27:09,735 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:27:09,749 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:27:09,749 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:27:09,749 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:27:09,758 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:27:09,758 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:27:09,789 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:27:09,793 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:27:09,793 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:27:10,007 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:27:10,398 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.15650387829316414561491740% which is below threshold 100.0%
2025-07-23 02:27:10,398 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '840.113500000000000000000000', 'margin': '8271.68', 'free_margin': '-7431.566500000000000000000000', 'profit_loss': '-7596.476500000000000000000000', 'margin_level': '10.15650387829316414561491740', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7596.476500000000000000000000', 'current_price': '118092.21'}], 'margin_call': True}
2025-07-23 02:27:10,402 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.15650387829316414561491740
2025-07-23 02:27:14,668 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:27:14,682 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:27:14,683 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:27:14,879 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:14,879 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:27:14,948 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:14,948 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:27:14,996 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:14,996 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:27:15,135 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:27:15,506 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.9993680446978285552858225683% which is below threshold 100.0%
2025-07-23 02:27:15,506 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '94.884699193421922833045838', 'margin': '9494.47', 'free_margin': '-9399.585300806578077166954162', 'profit_loss': '-9807.135300806578077166954162', 'margin_level': '0.9993680446978285552858225683', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9762.086000000000000000000000', 'current_price': '118092.21'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-40.95390982416188833359469281', 'current_price': '96.511'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.095390982416188833359469281', 'current_price': '96.511'}], 'margin_call': True}
2025-07-23 02:27:15,507 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.9993680446978285552858225683
2025-07-23 02:27:15,552 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:27:15,552 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:27:15,597 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:15,597 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:27:15,638 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:15,638 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:27:15,676 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:15,676 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:27:15,718 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:15,718 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:27:15,776 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:15,776 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:27:15,817 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:15,817 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:27:15,850 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:15,850 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:27:15,885 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:15,885 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:27:16,016 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:27:16,338 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.972667949102351169520703700% which is below threshold 100.0%
2025-07-23 02:27:16,339 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '176.476000000000000000000000', 'margin': '5936.62', 'free_margin': '-5760.144000000000000000000000', 'profit_loss': '-6213.144000000000000000000000', 'margin_level': '2.972667949102351169520703700', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6213.144000000000000000000000', 'current_price': '118092.21'}], 'margin_call': True}
2025-07-23 02:27:16,341 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.972667949102351169520703700
2025-07-23 02:27:16,379 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:27:16,380 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:27:16,500 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:27:16,501 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 26, falling back to DB and updating cache.
2025-07-23 02:27:16,854 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '0.0', 'equity': '-87851.53500000000000000000000', 'margin': '0.0', 'free_margin': '-87851.53500000000000000000000', 'profit_loss': '-87851.53500000000000000000000', 'margin_level': '0.0', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-86.775000000000000000000000', 'current_price': '39.3645'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87764.76000000000000000000000', 'current_price': '118074.71'}], 'margin_call': False}
2025-07-23 02:27:16,861 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 0.0
2025-07-23 02:27:16,861 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:27:16,861 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:27:16,930 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:16,931 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:27:16,990 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:16,990 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:27:17,176 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:27:17,178 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 1, falling back to DB and updating cache.
2025-07-23 02:27:17,480 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '0.0', 'equity': '-0.7055483366344128073473198178', 'margin': '0.0', 'free_margin': '-0.7055483366344128073473198178', 'profit_loss': '-0.7055483366344128073473198178', 'margin_level': '0.0', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.7055483366344128073473198178', 'current_price': '0.52146'}], 'margin_call': False}
2025-07-23 02:27:17,481 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 0.0
2025-07-23 02:27:17,482 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:27:17,482 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:27:17,484 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:27:17,485 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:27:17,499 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:27:17,502 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:27:17,502 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:27:17,556 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:17,556 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:27:17,558 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:27:17,558 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:27:17,560 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:27:17,560 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:27:17,762 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:27:17,763 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:27:18,076 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:27:18,078 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:27:18,080 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:27:18,081 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:27:18,254 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:27:18,255 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:27:18,262 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:27:18,589 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:27:18,591 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:27:18,591 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:27:18,592 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:27:18,720 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:27:18,721 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:27:18,725 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:27:19,102 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:27:19,106 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:27:19,107 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:27:19,107 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:27:19,190 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:19,190 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:27:19,235 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:27:29,591 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:27:29,955 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:27:42,423 - INFO - app - Application shutdown initiated
2025-07-23 02:27:42,423 - INFO - app - Scheduler shutdown completed
2025-07-23 02:27:42,787 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 02:27:45,117 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 02:27:45,117 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 02:27:45,123 - INFO - app - Redis connection closed
2025-07-23 02:27:45,124 - INFO - app - Application shutdown completed
2025-07-23 02:35:39,860 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:35:39,921 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:35:39,936 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:35:39,936 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:35:40,370 - INFO - app - Application starting up - Trading system initialized
2025-07-23 02:35:40,370 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 02:35:40,370 - INFO - app - Environment: PRODUCTION
2025-07-23 02:35:40,435 - INFO - app - Application startup initiated
2025-07-23 02:35:40,436 - INFO - app - Initializing core services...
2025-07-23 02:35:40,495 - INFO - app - Firebase initialized
2025-07-23 02:35:40,495 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 02:35:40,523 - INFO - app - Redis initialized
2025-07-23 02:35:41,496 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 02:35:41,502 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 02:35:41,514 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 02:35:41,514 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-23 02:35:41,515 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 02:35:41,517 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 02:35:41,517 - INFO - app - Scheduler initialized
2025-07-23 02:35:41,523 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:35:41,524 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 02:35:42,801 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:35:42,821 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:35:42,864 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 02:35:42,864 - INFO - app - Background tasks initialized
2025-07-23 02:35:42,864 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:35:43,720 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:35:43,720 - INFO - app - Application startup completed successfully
2025-07-23 02:35:43,721 - INFO - app - Starting cache validation task
2025-07-23 02:35:43,724 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 02:35:43,726 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 02:35:43,727 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-23 02:35:43,727 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:35:43,728 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:35:43,728 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:35:43,728 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:35:43,757 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:35:43,782 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:35:43,782 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:35:43,782 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:35:43,784 - INFO - app - Validating cache for 30 users
2025-07-23 02:35:43,815 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,821 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:35:43,826 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:35:43,826 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:35:43,834 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:35:43,837 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,839 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:35:43,844 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:35:43,847 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:35:43,850 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:35:43,853 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:35:43,855 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:35:43,858 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:35:43,861 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:35:43,863 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:35:43,866 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:35:43,868 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:35:43,869 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:35:43,869 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,869 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:35:43,873 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:35:43,876 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:35:43,880 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:35:43,885 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:35:43,886 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:35:43,892 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:35:43,892 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,897 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:35:43,901 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:35:43,901 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:35:43,907 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,926 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,939 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,952 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,963 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,977 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,988 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-23 02:35:43,999 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,017 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,027 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,067 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,078 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,086 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,126 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,138 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,149 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,166 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,178 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,189 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,201 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 02:35:44,208 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:35:44,551 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 10.13627824093775387829316415% which is below threshold 100.0%
2025-07-23 02:35:44,551 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '838.440500000000000000000000', 'margin': '8271.68', 'free_margin': '-7433.239500000000000000000000', 'profit_loss': '-7598.149500000000000000000000', 'margin_level': '10.13627824093775387829316415', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7598.149500000000000000000000', 'current_price': '118087.4300000000'}], 'margin_call': True}
2025-07-23 02:35:44,553 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 10.13627824093775387829316415
2025-07-23 02:35:44,553 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-23 02:35:45,704 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:35:45,727 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:35:45,741 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:35:45,745 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:35:45,746 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:35:45,790 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:35:45,860 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:35:46,104 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:35:46,123 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:35:46,126 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:35:46,133 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:35:46,133 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:35:46,141 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:35:46,143 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:35:46,143 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:35:46,146 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:35:46,146 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:35:46,152 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:35:46,161 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:35:46,162 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:35:46,175 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:35:46,176 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:35:46,188 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:35:46,203 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:35:46,203 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:35:46,228 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:35:46,240 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:35:46,240 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://roo...
2025-07-23 02:35:48,961 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 9 at kodideladinesh123@gmail.com
2025-07-23 02:35:48,970 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:35:48,970 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:35:49,043 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-23 02:35:49,063 - INFO - app - Cache validation completed
2025-07-23 02:35:49,067 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,067 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:35:49,119 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,119 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:35:49,147 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,148 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:35:49,240 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:35:49,562 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.1938301326244698350346397851% which is below threshold 100.0%
2025-07-23 02:35:49,562 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '18.403143792990501146413364', 'margin': '9494.47', 'free_margin': '-9476.066856207009498853586636', 'profit_loss': '-9883.616856207009498853586636', 'margin_level': '0.1938301326244698350346397851', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9837.254000000000000000000000', 'current_price': '117904.2900000000'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-42.14805109728136259416966918', 'current_price': '96.4940000000'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.214805109728136259416966918', 'current_price': '96.4940000000'}], 'margin_call': True}
2025-07-23 02:35:49,564 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.1938301326244698350346397851
2025-07-23 02:35:49,618 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:35:49,618 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:35:49,642 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,642 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:35:49,660 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,660 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:35:49,678 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,678 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:35:49,696 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,696 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:35:49,713 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,713 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:35:49,731 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,731 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:35:49,749 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,749 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:35:49,767 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:49,767 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:35:49,843 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:35:50,141 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.571901182827939130346897730% which is below threshold 100.0%
2025-07-23 02:35:50,141 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '152.684000000000000000000000', 'margin': '5936.62', 'free_margin': '-5783.936000000000000000000000', 'profit_loss': '-6236.936000000000000000000000', 'margin_level': '2.571901182827939130346897730', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6236.936000000000000000000000', 'current_price': '117854.29'}], 'margin_call': True}
2025-07-23 02:35:50,146 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.571901182827939130346897730
2025-07-23 02:35:50,174 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:35:50,175 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:35:50,246 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:35:50,582 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 64.97016714468093443625798694% which is below threshold 100.0%
2025-07-23 02:35:50,582 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '95171.20500000000000000000000', 'margin': '146484.47', 'free_margin': '-51313.26500000000000000000000', 'profit_loss': '-89174.60500000000000000000000', 'margin_level': '64.97016714468093443625798694', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-87.325000000000000000000000', 'current_price': '39.3535'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-89087.28000000000000000000000', 'current_price': '117854.29'}], 'margin_call': True}
2025-07-23 02:35:50,584 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 64.97016714468093443625798694
2025-07-23 02:35:50,586 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:35:50,586 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:35:50,619 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:50,619 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:35:50,654 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:50,654 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:35:50,861 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:35:51,198 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.74890683151453983473160', 'margin': '6.57', 'free_margin': '16439.17890683151453983473160', 'profit_loss': '-0.4910931684854601652684034568', 'margin_level': '250315.8128893685622501481218', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.4910931684854601652684034568', 'current_price': '0.52163'}], 'margin_call': False}
2025-07-23 02:35:51,199 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250315.8128893685622501481218
2025-07-23 02:35:51,201 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:35:51,201 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:35:51,203 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:35:51,203 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:35:51,219 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:35:51,221 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:35:51,221 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:35:51,248 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:51,248 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:35:51,249 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:35:51,249 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:35:51,250 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:35:51,250 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:35:51,382 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:35:51,383 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:35:51,911 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:35:51,914 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:35:51,916 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:35:51,917 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:35:52,050 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:35:52,050 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:35:52,422 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:35:52,425 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:35:52,426 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:35:52,426 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:35:52,520 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:35:52,521 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:35:52,877 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:35:52,881 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:35:52,881 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:35:52,881 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:35:52,940 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:52,940 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:35:52,965 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:35:53,638 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 1
2025-07-23 02:35:53,639 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 1
2025-07-23 02:35:53,640 - INFO - app.api.v1.endpoints.users - Refresh token validated successfully for user ID: 1
2025-07-23 02:35:53,641 - INFO - app.api.v1.endpoints.users - Refresh token validated successfully for user ID: 1
2025-07-23 02:35:53,644 - WARNING - app.api.v1.endpoints.users - Refresh token valid, but user ID 1 not found or inactive.
2025-07-23 02:35:53,646 - WARNING - app.api.v1.endpoints.users - Refresh token valid, but user ID 1 not found or inactive.
2025-07-23 02:35:53,647 - INFO - app.api.v1.endpoints.users - Invalidated refresh token for invalid user ID 1.
2025-07-23 02:35:53,647 - ERROR - app.api.v1.endpoints.users - Unexpected error during refresh token process for token: eyJhbGciOiJIUzI1NiIs... : 401: User not found or inactive
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\users.py", line 345, in refresh_access_token
     raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: User not found or inactive
2025-07-23 02:35:53,657 - INFO - app.api.v1.endpoints.users - Invalidated refresh token for invalid user ID 1.
2025-07-23 02:35:53,658 - ERROR - app.api.v1.endpoints.users - Unexpected error during refresh token process for token: eyJhbGciOiJIUzI1NiIs... : 401: User not found or inactive
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\users.py", line 345, in refresh_access_token
     raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: User not found or inactive
2025-07-23 02:35:55,160 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 1
2025-07-23 02:35:55,161 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 1
2025-07-23 02:35:55,161 - WARNING - app.api.v1.endpoints.users - Refresh token validation failed for user ID 1. Data found: False, User ID match: False
2025-07-23 02:35:55,162 - ERROR - app.api.v1.endpoints.users - Unexpected error during refresh token process for token: eyJhbGciOiJIUzI1NiIs... : 401: Invalid or expired refresh token
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\users.py", line 326, in refresh_access_token
     raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: Invalid or expired refresh token
2025-07-23 02:35:55,164 - WARNING - app.api.v1.endpoints.users - Refresh token validation failed for user ID 1. Data found: False, User ID match: False
2025-07-23 02:35:55,165 - ERROR - app.api.v1.endpoints.users - Unexpected error during refresh token process for token: eyJhbGciOiJIUzI1NiIs... : 401: Invalid or expired refresh token
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\users.py", line 326, in refresh_access_token
     raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: Invalid or expired refresh token
2025-07-23 02:35:58,721 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:35:58,722 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:35:58,724 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:35:58,724 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:35:58,726 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:35:58,727 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:35:58,728 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:35:58,729 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:35:58,730 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:35:58,731 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:35:58,732 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:35:58,733 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:35:58,734 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:35:58,735 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:35:58,736 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:35:58,737 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:35:58,738 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:35:58,740 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:35:58,741 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:35:58,744 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:35:58,746 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:35:58,748 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:35:58,748 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:36:22,967 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:36:22,967 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:36:22,968 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:36:22,968 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:36:22,979 - INFO - app - [AUTO-CUTOFF] Found 19 live users and 11 demo users.
2025-07-23 02:36:22,979 - INFO - app - [AUTO-CUTOFF] Processing 30 users for dynamic portfolio update...
2025-07-23 02:36:22,979 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:36:22,988 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:36:22,988 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:36:23,019 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:36:23,022 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:36:23,022 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:36:23,190 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:36:23,499 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 9.938210859220859607721768734% which is below threshold 100.0%
2025-07-23 02:36:23,499 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '822.057000000000000000000000', 'margin': '8271.68', 'free_margin': '-7449.623000000000000000000000', 'profit_loss': '-7614.533000000000000000000000', 'margin_level': '9.938210859220859607721768734', 'positions': [{'order_id': '1000347-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.35000000'), 'order_price': Decimal('139205.60000000'), 'margin': Decimal('8271.68000000'), 'contract_value': Decimal('0.35000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 9, 'order_status': 'OPEN', 'commission': Decimal('206.79000000'), 'created_at': '2025-07-17T04:29:22', 'profit_loss': '-7614.533000000000000000000000', 'current_price': '118040.62'}], 'margin_call': True}
2025-07-23 02:36:23,501 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 9.938210859220859607721768734
2025-07-23 02:36:23,559 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:36:23,560 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:36:23,638 - WARNING - app - [AUTO-CUTOFF] User 10 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:23,638 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:36:23,680 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:23,680 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:36:23,716 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:23,717 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:36:23,852 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:36:24,275 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 0.7437044454115645493975003344% which is below threshold 100.0%
2025-07-23 02:36:24,276 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '70.610795458267372673180850', 'margin': '9494.47', 'free_margin': '-9423.859204541732627326819150', 'profit_loss': '-9831.409204541732627326819150', 'margin_level': '0.7437044454115645493975003344', 'positions': [{'order_id': '1000330-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('141908.50000000'), 'margin': Decimal('9422.73000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('235.57000000'), 'created_at': '2025-07-15T23:00:09', 'profit_loss': '-9782.722000000000000000000000', 'current_price': '118040.62'}, {'order_id': '1000332-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('65.21517371'), 'contract_value': Decimal('10000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('1.00000000'), 'created_at': '2025-07-16T01:49:52', 'profit_loss': '-44.26109503793875211529013592', 'current_price': '96.463'}, {'order_id': '1000333-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('97.09700000'), 'margin': Decimal('6.52134765'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 14, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-16T01:51:54', 'profit_loss': '-4.426109503793875211529013592', 'current_price': '96.463'}], 'margin_call': True}
2025-07-23 02:36:24,291 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.7437044454115645493975003344
2025-07-23 02:36:24,338 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:36:24,338 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:36:24,386 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:24,386 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:36:24,422 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:24,422 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:36:24,461 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:24,461 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:36:24,497 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:24,497 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:36:24,534 - WARNING - app - [AUTO-CUTOFF] User 20 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:24,534 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:36:24,572 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:24,573 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:36:24,612 - WARNING - app - [AUTO-CUTOFF] User 22 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:24,612 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:36:24,648 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:24,649 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:36:24,809 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 25...
2025-07-23 02:36:25,191 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 2.885766648362199365969187854% which is below threshold 100.0%
2025-07-23 02:36:25,192 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 25: {'balance': '6389.62000000', 'equity': '171.317000000000000000000000', 'margin': '5936.62', 'free_margin': '-5765.303000000000000000000000', 'profit_loss': '-6218.303000000000000000000000', 'margin_level': '2.885766648362199365969187854', 'positions': [{'order_id': '1031-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.10000000'), 'order_price': Decimal('179986.15000000'), 'margin': Decimal('5936.62000000'), 'contract_value': Decimal('0.10000000'), 'stop_loss': Decimal('118576.15000000'), 'take_profit': Decimal('118976.15000000'), 'order_user_id': 25, 'order_status': 'OPEN', 'commission': Decimal('23.75000000'), 'created_at': '2025-07-18T02:09:29', 'profit_loss': '-6218.303000000000000000000000', 'current_price': '118040.62'}], 'margin_call': True}
2025-07-23 02:36:25,194 - INFO - app - [AUTO-CUTOFF] User 25 margin_level: 2.885766648362199365969187854
2025-07-23 02:36:25,248 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 25
2025-07-23 02:36:25,248 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:36:25,465 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 26...
2025-07-23 02:36:25,805 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 65.73344259633802818824411898% which is below threshold 100.0%
2025-07-23 02:36:25,806 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 26: {'balance': '184345.81000000', 'equity': '96289.28500000000000000000000', 'margin': '146484.47', 'free_margin': '-50195.18500000000000000000000', 'profit_loss': '-88056.52500000000000000000000', 'margin_level': '65.73344259633802818824411898', 'positions': [{'order_id': Decimal('7987141755'), 'order_company_name': 'XAGUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('41.09800000'), 'margin': Decimal('19.54000000'), 'contract_value': Decimal('50.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-14T03:43:34', 'profit_loss': '-87.225000000000000000000000', 'current_price': '39.3555'}, {'order_id': Decimal('1116628265'), 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('6.00000000'), 'order_price': Decimal('132091.90000000'), 'margin': Decimal('146464.93000000'), 'contract_value': Decimal('6.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 26, 'order_status': 'OPEN', 'commission': Decimal('3661.62000000'), 'created_at': '2025-07-14T03:46:06', 'profit_loss': '-87969.30000000000000000000000', 'current_price': '118040.62'}], 'margin_call': True}
2025-07-23 02:36:25,829 - INFO - app - [AUTO-CUTOFF] User 26 margin_level: 65.73344259633802818824411898
2025-07-23 02:36:25,831 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 26
2025-07-23 02:36:25,831 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:36:25,878 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:25,878 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Royal+
2025-07-23 02:36:25,921 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:25,921 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:36:26,054 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 1...
2025-07-23 02:36:26,421 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 1: {'balance': '16446.24000000', 'equity': '16445.78677683865270594171818', 'margin': '6.57', 'free_margin': '16439.21677683865270594171818', 'profit_loss': '-0.4532231613472940582818216223', 'margin_level': '250316.3892973919742152468521', 'positions': [{'order_id': '1221-001', 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.52194000'), 'margin': Decimal('6.57314831'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 1, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-22T22:43:12', 'profit_loss': '-0.4532231613472940582818216223', 'current_price': '0.52166'}], 'margin_call': False}
2025-07-23 02:36:26,425 - INFO - app - [AUTO-CUTOFF] User 1 margin_level: 250316.3892973919742152468521
2025-07-23 02:36:26,429 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 1
2025-07-23 02:36:26,430 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:36:26,439 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:36:26,439 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:36:26,479 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:36:26,482 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:36:26,482 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:36:26,524 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:26,524 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:36:26,526 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:36:26,526 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:36:26,527 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:36:26,528 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:36:26,643 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:36:26,645 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:36:27,034 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:36:27,038 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:36:27,040 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:36:27,041 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:36:27,195 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:36:27,196 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:36:27,550 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:36:27,552 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:36:27,552 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:36:27,552 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:36:27,684 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:36:27,685 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 11, falling back to DB and updating cache.
2025-07-23 02:36:28,013 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:36:28,015 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:36:28,015 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:36:28,016 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:36:28,061 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:28,061 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:36:28,101 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:36:28,777 - INFO - app - Application shutdown initiated
2025-07-23 02:36:28,778 - INFO - app - Scheduler shutdown completed
2025-07-23 02:36:29,860 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 02:36:31,037 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 02:36:31,037 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 02:36:31,040 - INFO - app - Redis connection closed
2025-07-23 02:36:31,040 - INFO - app - Application shutdown completed
2025-07-23 02:36:56,639 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:36:56,668 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:36:56,682 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:36:56,682 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:36:56,946 - INFO - app - Application starting up - Trading system initialized
2025-07-23 02:36:56,946 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 02:36:56,946 - INFO - app - Environment: PRODUCTION
2025-07-23 02:36:57,013 - INFO - app - Application startup initiated
2025-07-23 02:36:57,013 - INFO - app - Initializing core services...
2025-07-23 02:36:57,051 - INFO - app - Firebase initialized
2025-07-23 02:36:57,051 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 02:36:57,106 - INFO - app - Redis initialized
2025-07-23 02:36:59,392 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 02:36:59,400 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 02:36:59,403 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 02:36:59,403 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-23 02:36:59,403 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 02:36:59,404 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 02:36:59,404 - INFO - app - Scheduler initialized
2025-07-23 02:36:59,407 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:36:59,408 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 02:37:00,430 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:37:00,443 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:37:00,503 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 02:37:00,504 - INFO - app - Background tasks initialized
2025-07-23 02:37:00,504 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:37:01,349 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:37:01,358 - INFO - app - Application startup completed successfully
2025-07-23 02:37:01,364 - INFO - app - Starting cache validation task
2025-07-23 02:37:01,379 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 02:37:01,391 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 02:37:01,403 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-23 02:37:01,403 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:37:01,403 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:37:01,403 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:37:01,403 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:37:01,429 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:37:01,436 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:37:01,439 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:37:01,445 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:37:01,448 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:37:01,450 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:37:01,454 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:37:01,457 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:37:01,486 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:37:01,510 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:37:01,512 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:37:01,514 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:37:01,515 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:37:01,517 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:37:01,519 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:37:01,520 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:37:01,523 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:37:01,525 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:37:01,529 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:37:01,533 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:37:01,535 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:37:01,535 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:37:01,752 - INFO - app - Validating cache for 37 users
2025-07-23 02:37:01,818 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:37:01,818 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:37:01,819 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:37:01,929 - WARNING - app - User 24: Missing balance/margin cache, refreshing...
2025-07-23 02:37:02,252 - WARNING - app - User 27: Missing balance/margin cache, refreshing...
2025-07-23 02:37:02,430 - WARNING - app - User 28: Missing balance/margin cache, refreshing...
2025-07-23 02:37:02,565 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:37:02,975 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '100000.00000000', 'equity': '100000.00000000', 'margin': '0.0', 'free_margin': '100000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:02,981 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 0.0
2025-07-23 02:37:02,981 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:37:02,982 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:37:02,992 - WARNING - app - User 31: Missing balance/margin cache, refreshing...
2025-07-23 02:37:03,087 - INFO - app - Cache validation completed
2025-07-23 02:37:03,095 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:37:03,095 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:37:03,105 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:37:03,225 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:37:03,225 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:37:03,486 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:03,487 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:37:03,785 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:37:03,797 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:37:03,859 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:37:03,861 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:37:03,925 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:37:03,955 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:37:03,973 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:37:04,019 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:37:04,146 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:37:04,162 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:37:04,186 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:37:04,187 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:37:04,197 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:37:04,197 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:37:04,200 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:37:04,205 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:37:04,220 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:37:04,220 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:37:04,229 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:37:04,229 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:37:04,240 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:37:04,266 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:37:04,266 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:37:04,266 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:37:04,272 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:37:04,280 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:37:04,281 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:37:04,289 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:37:04,289 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:37:04,409 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:04,414 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:37:04,414 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:37:04,415 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:37:04,649 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:37:05,023 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:05,025 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:37:05,025 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:37:05,025 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:37:05,131 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:05,132 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:37:05,423 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:37:05,742 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '94.25000000', 'equity': '94.25000000', 'margin': '0.0', 'free_margin': '94.25000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:05,812 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 0.0
2025-07-23 02:37:05,812 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:37:05,812 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:37:06,013 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:06,013 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:37:06,235 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:06,236 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:37:06,458 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:06,459 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:37:06,665 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:06,665 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:37:06,971 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:06,971 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:37:07,274 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:37:07,585 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '0.0', 'free_margin': '8712.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:07,619 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 0.0
2025-07-23 02:37:07,620 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:37:07,620 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:37:07,999 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:07,999 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:37:08,257 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:37:08,612 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5961.56000000', 'equity': '5961.56000000', 'margin': '0.0', 'free_margin': '5961.56000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:08,621 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 0.0
2025-07-23 02:37:08,621 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:37:08,621 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:37:08,900 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:08,900 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:37:09,047 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:09,048 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:37:09,224 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:09,224 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:37:09,398 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:09,398 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:37:09,702 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:37:09,703 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 27, falling back to DB and updating cache.
2025-07-23 02:37:10,554 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-23 02:37:10,587 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-23 02:37:10,589 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:37:10,590 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:37:11,180 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:37:11,182 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 28, falling back to DB and updating cache.
2025-07-23 02:37:11,577 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-23 02:37:11,611 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-23 02:37:11,617 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:37:11,617 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:37:11,816 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:11,817 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:37:12,111 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:12,112 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:37:12,298 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:12,299 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:37:12,605 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:12,606 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:37:12,609 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:37:12,609 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:37:12,675 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:37:12,807 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:37:12,808 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:37:12,958 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:12,958 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:37:12,963 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:37:12,963 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:37:12,965 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:37:12,965 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:37:13,295 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 02:37:13,479 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:37:13,480 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:37:13,800 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:37:13,837 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:37:13,857 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:37:13,861 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:37:14,313 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:37:14,314 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:37:14,650 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:14,658 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:37:14,658 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:37:14,658 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:37:14,800 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:14,800 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:37:15,063 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:15,064 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:37:15,368 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:15,368 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:37:15,943 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 02:37:15,987 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:37:15,988 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:37:16,291 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '9902.02000000', 'margin': '9494.47', 'free_margin': '407.55000000', 'profit_loss': '0.0', 'margin_level': '104.2924986860772639231047125', 'positions': [], 'margin_call': False}
2025-07-23 02:37:16,296 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 104.2924986860772639231047125
2025-07-23 02:37:16,297 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:37:16,365 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:37:16,366 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:37:16,368 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:37:16,369 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:37:16,374 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:37:16,375 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:37:16,376 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:37:16,377 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:37:16,378 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:37:16,378 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:37:16,379 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:37:16,380 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:37:16,380 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:37:16,381 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:37:16,382 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:37:16,383 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:37:16,384 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:37:16,385 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:37:16,385 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:37:16,386 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:37:16,387 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:37:16,388 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:37:16,388 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:37:46,376 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:37:46,376 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:37:46,377 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:37:46,377 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:37:46,597 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:37:46,597 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:37:46,598 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:37:47,033 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:37:47,520 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '100000.00000000', 'equity': '100000.00000000', 'margin': '0.0', 'free_margin': '100000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:47,526 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 0.0
2025-07-23 02:37:47,526 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:37:47,527 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:37:47,724 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:37:47,725 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:37:47,754 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:37:47,856 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:37:47,856 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:37:48,004 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:48,004 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:37:48,468 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:37:48,850 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:48,860 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:37:48,860 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:37:48,860 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:37:49,218 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:37:49,521 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:49,527 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:37:49,527 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:37:49,527 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:37:49,670 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:49,670 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:37:50,062 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:37:50,380 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '94.25000000', 'equity': '94.25000000', 'margin': '0.0', 'free_margin': '94.25000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:50,384 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 0.0
2025-07-23 02:37:50,385 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:37:50,385 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:37:50,566 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:50,567 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:37:50,743 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:50,743 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:37:50,904 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:50,904 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:37:51,102 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:51,103 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:37:51,264 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:51,264 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:37:51,689 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:37:52,025 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '0.0', 'free_margin': '8712.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:52,060 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 0.0
2025-07-23 02:37:52,060 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:37:52,060 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:37:52,277 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:52,277 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:37:52,838 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:37:53,155 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5961.56000000', 'equity': '5961.56000000', 'margin': '0.0', 'free_margin': '5961.56000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:53,178 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 0.0
2025-07-23 02:37:53,179 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:37:53,179 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:37:53,391 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:53,392 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:37:53,572 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:53,572 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:37:53,700 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:53,700 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:37:53,972 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:53,972 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:37:54,516 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:37:54,518 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 27, falling back to DB and updating cache.
2025-07-23 02:37:54,864 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-23 02:37:54,909 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-23 02:37:54,914 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:37:54,915 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:37:55,262 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:37:55,263 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 28, falling back to DB and updating cache.
2025-07-23 02:37:55,616 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-23 02:37:55,628 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-23 02:37:55,638 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:37:55,639 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:37:55,883 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:55,884 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:37:56,000 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:56,000 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:37:56,052 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 02:37:56,225 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:56,225 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:37:56,368 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:56,368 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:37:56,372 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:37:56,372 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:37:56,393 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:37:56,428 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:37:56,429 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:37:56,603 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:56,603 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:37:56,606 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:37:56,607 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:37:56,610 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:37:56,610 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:37:57,067 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:37:57,068 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:37:57,455 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:37:57,463 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:37:57,469 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:37:57,469 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:37:57,876 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:37:57,877 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:37:58,271 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:37:58,282 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:37:58,283 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:37:58,283 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:37:58,435 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:58,435 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:37:58,573 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:58,573 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:37:58,774 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:37:58,774 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:37:59,278 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:37:59,280 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:37:59,590 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '9902.02000000', 'margin': '9494.47', 'free_margin': '407.55000000', 'profit_loss': '0.0', 'margin_level': '104.2924986860772639231047125', 'positions': [], 'margin_call': False}
2025-07-23 02:37:59,594 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:37:59,909 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:37:59,912 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 104.2924986860772639231047125
2025-07-23 02:37:59,929 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:38:16,519 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 1
2025-07-23 02:38:16,520 - INFO - app.api.v1.endpoints.users - Refresh token decoded. User ID from token payload: 1
2025-07-23 02:38:16,521 - WARNING - app.api.v1.endpoints.users - Refresh token validation failed for user ID 1. Data found: False, User ID match: False
2025-07-23 02:38:16,522 - ERROR - app.api.v1.endpoints.users - Unexpected error during refresh token process for token: eyJhbGciOiJIUzI1NiIs... : 401: Invalid or expired refresh token
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\users.py", line 326, in refresh_access_token
     raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: Invalid or expired refresh token
2025-07-23 02:38:16,532 - WARNING - app.api.v1.endpoints.users - Refresh token validation failed for user ID 1. Data found: False, User ID match: False
2025-07-23 02:38:16,535 - ERROR - app.api.v1.endpoints.users - Unexpected error during refresh token process for token: eyJhbGciOiJIUzI1NiIs... : 401: Invalid or expired refresh token
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\users.py", line 326, in refresh_access_token
     raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: Invalid or expired refresh token
2025-07-23 02:38:30,005 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:38:30,005 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:38:30,005 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:38:30,005 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:38:30,144 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:38:30,145 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:38:30,145 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:38:30,616 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:38:30,939 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '100000.00000000', 'equity': '100000.00000000', 'margin': '0.0', 'free_margin': '100000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:38:30,942 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 0.0
2025-07-23 02:38:30,942 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:38:30,942 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:38:31,212 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:38:31,212 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:38:31,229 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:38:31,345 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:38:31,345 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:38:31,616 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:31,616 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:38:31,974 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:38:32,277 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:38:32,288 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:38:32,288 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:38:32,288 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:38:32,506 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:38:32,808 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '14420.38000000', 'equity': '14420.38000000', 'margin': '0.0', 'free_margin': '14420.38000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:38:32,817 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 0.0
2025-07-23 02:38:32,817 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:38:32,817 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:38:32,940 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:32,940 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:38:33,152 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:38:33,505 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '94.25000000', 'equity': '94.25000000', 'margin': '0.0', 'free_margin': '94.25000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:38:33,507 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 0.0
2025-07-23 02:38:33,507 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:38:33,507 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:38:33,703 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:33,703 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:38:33,908 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:33,909 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:38:34,113 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:34,113 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:38:34,230 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:34,230 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:38:34,341 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:34,341 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:38:34,744 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:38:35,140 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '0.0', 'free_margin': '8712.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:38:35,146 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 0.0
2025-07-23 02:38:35,146 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:38:35,146 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:38:35,355 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:35,355 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:38:35,487 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 02:38:35,619 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:38:35,964 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5961.56000000', 'equity': '5961.56000000', 'margin': '0.0', 'free_margin': '5961.56000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:38:35,966 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 0.0
2025-07-23 02:38:35,966 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:38:35,966 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:38:36,214 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:36,214 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:38:36,467 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:36,468 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:38:36,629 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:36,630 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:38:36,795 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:36,796 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:38:37,170 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:38:37,171 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 27, falling back to DB and updating cache.
2025-07-23 02:38:37,521 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6672.64000000', 'margin': '19.55', 'free_margin': '6653.09000000', 'profit_loss': '0.0', 'margin_level': '34131.15089514066496163682864', 'positions': [], 'margin_call': False}
2025-07-23 02:38:37,536 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34131.15089514066496163682864
2025-07-23 02:38:37,538 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:38:37,538 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:38:37,863 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 02:38:37,887 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:38:37,888 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 28, falling back to DB and updating cache.
2025-07-23 02:38:38,208 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '10023.20000000', 'margin': '9705.52', 'free_margin': '317.68000000', 'profit_loss': '0.0', 'margin_level': '103.2731888657176534590624717', 'positions': [], 'margin_call': False}
2025-07-23 02:38:38,222 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 103.2731888657176534590624717
2025-07-23 02:38:38,225 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:38:38,225 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:38:38,414 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:38,414 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:38:38,615 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:38,615 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:38:38,819 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:38,819 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:38:38,969 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:38,969 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:38:38,982 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:38:38,982 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:38:38,999 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:38:39,037 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:38:39,037 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:38:39,159 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:39,159 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:38:39,160 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:38:39,160 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:38:39,164 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:38:39,164 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:38:39,371 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:38:39,372 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:38:39,744 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:38:39,752 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:38:39,754 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:38:39,754 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:38:40,053 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:38:40,053 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:38:40,465 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9707.74000000', 'equity': '9707.74000000', 'margin': '0.0', 'free_margin': '9707.74000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:38:40,498 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 0.0
2025-07-23 02:38:40,498 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:38:40,499 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:38:40,770 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:40,770 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:38:41,075 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:41,075 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:38:41,231 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:38:41,231 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:38:41,477 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:38:41,478 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:38:41,799 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '9902.02000000', 'margin': '9494.47', 'free_margin': '407.55000000', 'profit_loss': '0.0', 'margin_level': '104.2924986860772639231047125', 'positions': [], 'margin_call': False}
2025-07-23 02:38:41,806 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 104.2924986860772639231047125
2025-07-23 02:38:41,812 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:38:41,940 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 02:38:42,553 - INFO - app - Application shutdown initiated
2025-07-23 02:38:42,553 - INFO - app - Scheduler shutdown completed
2025-07-23 02:38:42,954 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 02:38:43,945 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 02:38:43,945 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 02:38:43,952 - INFO - app - Redis connection closed
2025-07-23 02:38:43,952 - INFO - app - Application shutdown completed
2025-07-23 02:40:44,378 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:40:44,444 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:40:44,466 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:40:44,466 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:40:45,167 - INFO - app - Application starting up - Trading system initialized
2025-07-23 02:40:45,167 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 02:40:45,167 - INFO - app - Environment: PRODUCTION
2025-07-23 02:40:45,263 - INFO - app - Application startup initiated
2025-07-23 02:40:45,263 - INFO - app - Initializing core services...
2025-07-23 02:40:45,306 - INFO - app - Firebase initialized
2025-07-23 02:40:45,306 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 02:40:45,331 - INFO - app - Redis initialized
2025-07-23 02:40:48,148 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 02:40:48,153 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 02:40:48,157 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 02:40:48,158 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-23 02:40:48,158 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 02:40:48,159 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 02:40:48,159 - INFO - app - Scheduler initialized
2025-07-23 02:40:48,160 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:40:48,161 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 02:40:49,380 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:40:49,422 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:40:49,454 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 02:40:49,454 - INFO - app - Background tasks initialized
2025-07-23 02:40:49,454 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:40:50,100 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:40:50,100 - INFO - app - Application startup completed successfully
2025-07-23 02:40:50,101 - INFO - app - Starting cache validation task
2025-07-23 02:40:50,109 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 02:40:50,123 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 02:40:50,133 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-23 02:40:50,133 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:40:50,134 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:40:50,134 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:40:50,134 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:40:50,166 - INFO - app - Found 26 static orders cache entries to check
2025-07-23 02:40:50,169 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:40:50,171 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:40:50,175 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:40:50,178 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:40:50,181 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:40:50,183 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:40:50,186 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:40:50,188 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:40:50,192 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:40:50,195 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:40:50,197 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:40:50,202 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:40:50,205 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:40:50,209 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:40:50,247 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:40:50,252 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:40:50,255 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:40:50,258 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:40:50,262 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:40:50,265 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:40:50,265 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:40:50,435 - INFO - app - Validating cache for 37 users
2025-07-23 02:40:50,474 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-23 02:40:50,603 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:40:50,603 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:40:50,603 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:40:50,662 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 02:40:50,725 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-23 02:40:50,856 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-23 02:40:51,034 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-23 02:40:51,139 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-23 02:40:51,173 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:40:51,500 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:40:51,506 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:40:51,507 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:40:51,508 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:40:51,639 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-23 02:40:51,738 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:40:51,738 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:40:51,785 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-23 02:40:51,796 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:40:51,897 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:40:51,898 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:40:51,905 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-23 02:40:51,987 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-23 02:40:52,002 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:52,002 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:40:52,154 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-23 02:40:52,301 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-23 02:40:52,403 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:40:52,759 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:40:52,762 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:40:52,773 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:40:52,790 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:40:52,799 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:40:52,799 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:40:52,856 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-23 02:40:52,882 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:40:52,918 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:40:52,920 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:40:52,963 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:40:52,957 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:40:53,028 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-23 02:40:53,152 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:40:53,187 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:40:53,187 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:40:53,188 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:40:53,196 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-23 02:40:53,230 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:40:53,234 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:40:53,307 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:40:53,323 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:40:53,337 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:40:53,337 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:40:53,338 - WARNING - app - User 24: Missing static orders cache, refreshing...
2025-07-23 02:40:53,350 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:40:53,355 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:40:53,356 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:40:53,375 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:40:53,376 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:40:53,378 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:40:53,395 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:40:53,395 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:40:53,402 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:40:53,420 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:40:53,420 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:40:53,460 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:40:53,765 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:40:53,765 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:40:53,771 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:40:53,773 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:40:53,773 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:40:53,998 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-23 02:40:54,068 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:54,068 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:40:54,124 - WARNING - app - User 27: Missing static orders cache, refreshing...
2025-07-23 02:40:54,257 - WARNING - app - User 28: Missing static orders cache, refreshing...
2025-07-23 02:40:54,375 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:40:54,704 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:40:54,713 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:40:54,721 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:40:54,721 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:40:54,726 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-23 02:40:54,919 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-23 02:40:54,942 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:54,942 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:40:55,013 - WARNING - app - User 31: Missing static orders cache, refreshing...
2025-07-23 02:40:55,115 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:55,115 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:40:55,187 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-23 02:40:55,276 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:55,276 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:40:55,282 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-23 02:40:55,418 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-23 02:40:55,441 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:55,442 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:40:55,559 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:55,559 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:40:55,563 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 02:40:55,739 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-23 02:40:55,852 - INFO - app - Cache validation completed
2025-07-23 02:40:55,916 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:40:56,228 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:40:56,235 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:40:56,244 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:40:56,244 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:40:56,471 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:56,471 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:40:56,573 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 02:40:56,802 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:40:57,160 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:40:57,178 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:40:57,180 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:40:57,181 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:40:57,429 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:57,429 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:40:57,624 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:57,625 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:40:57,857 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:57,857 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:40:58,081 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:40:58,081 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:40:58,472 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:40:58,838 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.64166075698649493913044176% which is below threshold 100.0%
2025-07-23 02:40:58,839 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '0E-8', 'equity': '9.900444677990859760600001365', 'margin': '19.55', 'free_margin': '-9.649555322009140239399998635', 'profit_loss': '9.900444677990859760600001365', 'margin_level': '50.64166075698649493913044176', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.8349429821269611623320344223', 'current_price': '96.47850000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.620000000000100000000000000', 'current_price': '0.6583950000000001'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.445501695863798598267966943', 'current_price': '96.47850000000001'}], 'margin_call': True}
2025-07-23 02:40:58,841 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 50.64166075698649493913044176
2025-07-23 02:41:02,896 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 27 at dhanush777ss@gmail.com
2025-07-23 02:41:02,918 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:41:02,919 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:41:03,309 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:41:03,628 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:41:03,634 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:41:03,635 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '0E-8', 'equity': '-1177.554000000000000000000000', 'margin': '9705.52', 'free_margin': '-10883.07400000000000000000000', 'profit_loss': '-1177.554000000000000000000000', 'margin_level': '-12.13282750434804111474707177', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.253584999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.253584999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1177.554000000000000000000000', 'current_price': '118068.19'}], 'margin_call': False}
2025-07-23 02:41:03,639 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: -12.13282750434804111474707177
2025-07-23 02:41:03,640 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:41:03,640 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:41:03,808 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:03,808 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:41:04,022 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:04,022 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:41:04,153 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:04,154 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:41:04,295 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:04,295 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:41:04,297 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:41:04,297 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:41:04,325 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:41:04,359 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:41:04,359 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:41:04,510 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:04,510 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:41:04,511 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:41:04,512 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:41:04,513 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:41:04,513 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:41:04,776 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:41:04,776 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:41:05,211 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:41:05,215 - INFO - app - Found 30 static orders cache entries to check
2025-07-23 02:41:05,556 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '8436.59000000', 'equity': '8436.59000000', 'margin': '8271.68', 'free_margin': '164.91000000', 'profit_loss': '0.0', 'margin_level': '101.9936699678904406360013927', 'positions': [], 'margin_call': False}
2025-07-23 02:41:05,562 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 101.9936699678904406360013927
2025-07-23 02:41:05,563 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:41:05,564 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:41:05,564 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:41:05,565 - WARNING - app - Found stale cache entry for user live:24, will be refreshed on next access
2025-07-23 02:41:05,567 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:41:05,571 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:41:05,573 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:41:05,575 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:41:05,578 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:41:05,581 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:41:05,583 - WARNING - app - Found stale cache entry for user live:31, will be refreshed on next access
2025-07-23 02:41:05,586 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:41:05,588 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:41:05,589 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:41:05,593 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:41:05,594 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:41:05,596 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:41:05,597 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:41:05,599 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:41:05,601 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:41:05,603 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:41:05,606 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:41:05,609 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:41:05,613 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:41:05,614 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:41:06,009 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:41:06,009 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:41:06,376 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:41:06,384 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:41:06,388 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:41:06,388 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:41:06,547 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:06,548 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:41:06,681 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:06,681 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:41:06,818 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:06,818 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:41:07,181 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:41:07,182 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:41:07,502 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '9902.02000000', 'equity': '9902.02000000', 'margin': '9494.47', 'free_margin': '407.55000000', 'profit_loss': '0.0', 'margin_level': '104.2924986860772639231047125', 'positions': [], 'margin_call': False}
2025-07-23 02:41:07,516 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 104.2924986860772639231047125
2025-07-23 02:41:07,519 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:41:37,631 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:41:37,631 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:41:37,632 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:41:37,632 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:41:37,812 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:41:37,812 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:41:37,812 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:41:38,242 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:41:38,533 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:41:38,544 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:41:38,546 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:41:38,546 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:41:38,646 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:41:38,646 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:41:38,663 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:41:38,732 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:41:38,732 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:41:38,849 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:38,850 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:41:39,053 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:41:39,418 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:41:39,423 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:41:39,425 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:41:39,425 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:41:39,748 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:41:40,067 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:41:40,067 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:41:40,071 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:41:40,073 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:41:40,073 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:41:40,376 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:40,376 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:41:40,705 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:41:41,095 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:41:41,113 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:41:41,116 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:41:41,117 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:41:41,256 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:41,256 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:41:41,367 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:41,367 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:41:41,500 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:41,500 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:41:41,632 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:41,632 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:41:41,914 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:41,914 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:41:42,371 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:41:42,728 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:41:42,732 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:41:42,735 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:41:42,735 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:41:42,911 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:42,911 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:41:43,215 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:41:43,547 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:41:43,557 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:41:43,559 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:41:43,560 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:41:43,753 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:43,754 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:41:43,916 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:43,916 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:41:44,103 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:44,103 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:41:44,365 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:44,365 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:41:44,828 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:41:45,182 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.26057794063931794338206909% which is below threshold 100.0%
2025-07-23 02:41:45,184 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '0E-8', 'equity': '9.825942987394986657931194508', 'margin': '19.55', 'free_margin': '-9.724057012605013342068805492', 'profit_loss': '9.825942987394986657931194508', 'margin_level': '50.26057794063931794338206909', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.8076701540309426802885435648', 'current_price': '96.4745'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.600000000000000000000000', 'current_price': '0.658375'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.418272833364043977642650943', 'current_price': '96.4745'}], 'margin_call': True}
2025-07-23 02:41:45,216 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 50.26057794063931794338206909
2025-07-23 02:41:45,219 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:41:45,219 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:41:45,438 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:41:45,809 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:41:45,815 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:41:45,816 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '0E-8', 'equity': '-1148.034000000000000000000000', 'margin': '9705.52', 'free_margin': '-10853.55400000000000000000000', 'profit_loss': '-1148.034000000000000000000000', 'margin_level': '-11.82867069461502320329049860', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.2534849999999995'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.2534849999999995'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1148.034000000000000000000000', 'current_price': '118141.9900000000'}], 'margin_call': False}
2025-07-23 02:41:45,819 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: -11.82867069461502320329049860
2025-07-23 02:41:45,819 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:41:45,819 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:41:46,004 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:46,004 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:41:46,147 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:46,147 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:41:46,313 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:46,313 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:41:46,579 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:46,580 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:41:46,583 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:41:46,584 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:41:46,615 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:41:46,722 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:41:46,722 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:41:46,882 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:46,882 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:41:46,885 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:41:46,885 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:41:46,888 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:41:46,888 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:41:47,325 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:41:47,326 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:41:47,333 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:41:47,715 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:41:47,720 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 02:41:47,721 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:41:47,721 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:41:48,075 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:41:48,077 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:41:48,462 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:41:48,477 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:41:48,873 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:41:48,877 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:41:48,884 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:41:48,884 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:41:49,078 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:49,078 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:41:49,382 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:49,383 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:41:49,590 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:41:49,590 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:41:50,099 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:41:50,100 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:41:50,108 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:41:50,510 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:41:50,530 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 02:41:50,530 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:42:20,606 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:42:20,606 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:42:20,606 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:42:20,606 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:42:20,763 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:42:20,763 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:42:20,763 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:42:21,127 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:42:21,540 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:42:21,545 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:42:21,548 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:42:21,548 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:42:21,742 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:42:21,743 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:42:21,767 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:42:21,947 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:42:21,948 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:42:22,208 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:22,208 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:42:22,632 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:42:22,971 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:42:22,980 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:42:22,985 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:42:22,985 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:42:23,315 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:42:23,695 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:42:23,695 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:42:23,698 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:42:23,701 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:42:23,701 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:42:23,915 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:23,915 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:42:24,398 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:42:24,815 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:42:24,845 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:42:24,850 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:42:24,850 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:42:25,015 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:25,015 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:42:25,158 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:25,159 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:42:25,309 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:25,309 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:42:25,464 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:25,464 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:42:25,702 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:25,702 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:42:26,073 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:42:26,454 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:42:26,489 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:42:26,491 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:42:26,492 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:42:26,764 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:26,764 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:42:27,408 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:42:27,702 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:42:27,709 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:42:27,712 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:42:27,712 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:42:27,821 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:27,821 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:42:27,971 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:27,971 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:42:28,134 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:28,134 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:42:28,328 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:28,328 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:42:28,760 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:42:29,128 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 50.03659382546769518241367054% which is below threshold 100.0%
2025-07-23 02:42:29,128 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '0E-8', 'equity': '9.782154092878934408161872590', 'margin': '19.55', 'free_margin': '-9.767845907121065591838127410', 'profit_loss': '9.782154092878934408161872590', 'margin_level': '50.03659382546769518241367054', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.8008086805200122837547343638', 'current_price': '96.4735'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.570000000000100000000000000', 'current_price': '0.6583450000000001'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.411345412358822124407138226', 'current_price': '96.4735'}], 'margin_call': True}
2025-07-23 02:42:29,161 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 50.03659382546769518241367054
2025-07-23 02:42:29,163 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:42:29,164 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:42:29,610 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:42:30,381 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:42:30,400 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:42:30,401 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '0E-8', 'equity': '-1172.778000000000000000000000', 'margin': '9705.52', 'free_margin': '-10878.29800000000000000000000', 'profit_loss': '-1172.778000000000000000000000', 'margin_level': '-12.08361839448066667216182131', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.253385'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.253385'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1172.778000000000000000000000', 'current_price': '118080.13'}], 'margin_call': False}
2025-07-23 02:42:30,438 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: -12.08361839448066667216182131
2025-07-23 02:42:30,438 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:42:30,438 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:42:30,612 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:30,612 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:42:30,773 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:30,773 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:42:30,957 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:30,957 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:42:31,143 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:31,143 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:42:31,145 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:42:31,145 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:42:31,165 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:42:31,267 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:42:31,268 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:42:31,577 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:31,577 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:42:31,580 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:42:31,580 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:42:31,583 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:42:31,584 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:42:31,998 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:42:31,999 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:42:32,004 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:42:32,391 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:42:32,424 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 02:42:32,425 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:42:32,425 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:42:32,877 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:42:32,878 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:42:33,210 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:42:33,222 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:42:33,224 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:42:33,225 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:42:33,372 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:33,373 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:42:33,539 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:33,540 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:42:33,827 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:42:33,827 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:42:34,338 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:42:34,341 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:42:34,350 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:42:34,749 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:42:34,783 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 02:42:34,784 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:42:48,167 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:42:48,571 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:43:04,939 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:43:04,940 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:43:04,940 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:43:04,940 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:43:05,260 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:43:05,260 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:43:05,260 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:43:05,502 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:43:05,877 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:43:05,899 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:43:05,903 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:43:05,903 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:43:06,059 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:43:06,059 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:43:06,100 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:43:06,193 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:43:06,193 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:43:06,330 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:06,330 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:43:06,630 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:43:07,001 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:43:07,034 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:43:07,037 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:43:07,037 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:43:07,459 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:43:07,756 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:43:07,756 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:43:07,790 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:43:07,806 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:43:07,806 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:43:07,971 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:07,972 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:43:08,322 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:43:08,742 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:43:08,777 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:43:08,780 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:43:08,780 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:43:09,018 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:09,018 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:43:09,206 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:09,206 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:43:09,412 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:09,412 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:43:09,664 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:09,665 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:43:09,868 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:09,868 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:43:10,228 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:43:10,584 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:43:10,596 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:43:10,598 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:43:10,598 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:43:10,833 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:10,833 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:43:11,150 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:43:11,513 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:43:11,523 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:43:11,526 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:43:11,526 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:43:11,815 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:11,815 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:43:12,124 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:12,124 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:43:12,303 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:12,304 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:43:12,534 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:12,534 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:43:12,817 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:43:13,163 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 49.51459496210002170759351448% which is below threshold 100.0%
2025-07-23 02:43:13,163 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '0E-8', 'equity': '9.680103315090554243834532080', 'margin': '19.55', 'free_margin': '-9.869896684909445756165467920', 'profit_loss': '9.680103315090554243834532080', 'margin_level': '49.51459496210002170759351448', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.7598217575848562186949816435', 'current_price': '96.4675'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.550000000000000000000000', 'current_price': '0.658325'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.370281557505698025139550436', 'current_price': '96.4675'}], 'margin_call': True}
2025-07-23 02:43:13,164 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 49.51459496210002170759351448
2025-07-23 02:43:13,165 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:43:13,166 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:43:13,385 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:43:13,788 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:43:13,794 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:43:13,795 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '0E-8', 'equity': '-1176.382000000000000000000000', 'margin': '9705.52', 'free_margin': '-10881.90200000000000000000000', 'profit_loss': '-1176.382000000000000000000000', 'margin_level': '-12.12075190201040232774750863', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.253374999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.253374999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1176.382000000000000000000000', 'current_price': '118071.12'}], 'margin_call': False}
2025-07-23 02:43:13,799 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: -12.12075190201040232774750863
2025-07-23 02:43:13,799 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:43:13,799 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:43:14,069 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:14,069 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:43:14,333 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:14,333 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:43:14,546 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:14,546 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:43:14,798 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:14,798 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:43:14,803 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:43:14,809 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:43:14,882 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:43:14,948 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:43:14,948 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:43:15,097 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:15,098 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:43:15,101 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:43:15,101 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:43:15,106 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:43:15,106 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:43:15,359 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:43:15,360 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:43:15,366 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:43:15,709 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:43:15,715 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 02:43:15,715 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:43:15,715 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:43:16,041 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:43:16,042 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:43:16,423 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:43:16,457 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:43:16,458 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:43:16,459 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:43:16,730 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:16,730 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:43:16,935 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:16,936 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:43:17,210 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:17,210 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:43:17,601 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:43:17,602 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:43:17,609 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:43:17,959 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:43:17,992 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 02:43:17,992 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:43:48,143 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:43:48,143 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:43:48,143 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:43:48,143 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:43:48,160 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:43:48,474 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:43:48,652 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:43:48,653 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:43:48,653 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:43:49,160 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:43:49,497 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:43:49,501 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:43:49,503 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:43:49,503 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:43:49,790 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:43:49,791 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:43:49,851 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:43:49,908 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:43:49,908 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:43:50,020 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:50,021 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:43:50,257 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:43:50,623 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:43:50,636 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:43:50,641 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:43:50,641 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:43:50,991 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:43:51,353 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:43:51,354 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:43:51,362 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:43:51,366 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:43:51,366 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:43:51,611 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:51,612 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:43:52,099 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:43:52,421 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:43:52,453 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:43:52,455 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:43:52,455 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:43:52,605 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:52,605 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:43:52,785 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:52,786 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:43:52,945 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:52,946 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:43:53,088 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:53,089 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:43:53,185 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:53,186 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:43:53,571 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:43:53,901 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:43:53,905 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:43:53,908 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:43:53,909 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:43:54,208 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:54,209 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:43:54,634 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:43:54,925 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:43:54,931 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:43:54,933 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:43:54,933 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:43:55,045 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:55,045 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:43:55,204 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:55,205 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:43:55,368 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:55,369 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:43:55,482 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:55,482 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:43:55,792 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:43:56,161 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 49.16702242665963891229059185% which is below threshold 100.0%
2025-07-23 02:43:56,162 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '0E-8', 'equity': '9.612152884411959407352810706', 'margin': '19.55', 'free_margin': '-9.937847115588040592647189294', 'profit_loss': '9.612152884411959407352810706', 'margin_level': '49.16702242665963891229059185', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.7257751025394290549993516642', 'current_price': '96.4625'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.550000000000000000000000', 'current_price': '0.658325'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.336377781872530352353459042', 'current_price': '96.4625'}], 'margin_call': True}
2025-07-23 02:43:56,195 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 49.16702242665963891229059185
2025-07-23 02:43:56,197 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:43:56,197 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:43:56,801 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:43:57,190 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:43:57,195 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:43:57,196 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '0E-8', 'equity': '-1188.306000000000000000000000', 'margin': '9705.52', 'free_margin': '-10893.82600000000000000000000', 'profit_loss': '-1188.306000000000000000000000', 'margin_level': '-12.24360982203941674428572606', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.253444999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.253444999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1188.306000000000000000000000', 'current_price': '118041.31'}], 'margin_call': False}
2025-07-23 02:43:57,199 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: -12.24360982203941674428572606
2025-07-23 02:43:57,199 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:43:57,199 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:43:57,341 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:57,341 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:43:57,476 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:57,476 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:43:57,616 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:57,617 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:43:57,794 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:57,794 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:43:57,796 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:43:57,797 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:43:57,807 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:43:57,837 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:43:57,837 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:43:58,003 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:58,003 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:43:58,006 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:43:58,006 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:43:58,008 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:43:58,008 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:43:58,355 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:43:58,357 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:43:58,362 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:43:58,671 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:43:58,706 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 02:43:58,707 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:43:58,707 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:43:59,109 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:43:59,111 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:43:59,416 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:43:59,444 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:43:59,447 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:43:59,448 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:43:59,575 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:59,576 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:43:59,697 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:59,697 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:43:59,811 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:43:59,812 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:44:00,159 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:44:00,161 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:44:00,167 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:44:00,555 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:44:00,560 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 02:44:00,560 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:44:30,661 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:44:30,661 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:44:30,661 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:44:30,662 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:44:31,056 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:44:31,056 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:44:31,056 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:44:31,677 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:44:31,993 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:44:32,007 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:44:32,009 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:44:32,009 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:44:32,111 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:44:32,111 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:44:32,149 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:44:32,218 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:44:32,219 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:44:32,379 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:32,379 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:44:32,767 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:44:33,120 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:44:33,125 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:44:33,127 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:44:33,128 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:44:33,592 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:44:33,898 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:44:33,898 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:44:33,906 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:44:33,924 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:44:33,927 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:44:34,129 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:34,129 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:44:34,484 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:44:34,827 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:44:34,835 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:44:34,839 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:44:34,839 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:44:35,065 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:35,065 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:44:35,288 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:35,288 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:44:35,578 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:35,579 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:44:35,884 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:35,884 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:44:36,129 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:36,130 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:44:36,629 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:44:37,011 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:44:37,018 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:44:37,020 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:44:37,020 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:44:37,320 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:37,320 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:44:37,751 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:44:38,055 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:44:38,089 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:44:38,093 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:44:38,093 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:44:38,276 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:38,276 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:44:38,472 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:38,472 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:44:38,646 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:38,646 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:44:38,785 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:38,786 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:44:39,038 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:44:39,380 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 49.03189254751508761508968860% which is below threshold 100.0%
2025-07-23 02:44:39,380 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '0E-8', 'equity': '9.585734993039199628750034122', 'margin': '19.55', 'free_margin': '-9.964265006960800371249965878', 'profit_loss': '9.585734993039199628750034122', 'margin_level': '49.03189254751508761508968860', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.7325826440641634591761526493', 'current_price': '96.46350000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.510000000000000000000000', 'current_price': '0.658285'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.343152348975036169573881473', 'current_price': '96.46350000000001'}], 'margin_call': True}
2025-07-23 02:44:39,383 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 49.03189254751508761508968860
2025-07-23 02:44:39,385 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:44:39,386 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:44:39,881 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:44:40,190 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:44:40,193 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:44:40,194 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '0E-8', 'equity': '-1211.234000000000000000000000', 'margin': '9705.52', 'free_margin': '-10916.75400000000000000000000', 'profit_loss': '-1211.234000000000000000000000', 'margin_level': '-12.47984652033069840667990999', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.253505'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.253505'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1211.234000000000000000000000', 'current_price': '117983.99'}], 'margin_call': False}
2025-07-23 02:44:40,227 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: -12.47984652033069840667990999
2025-07-23 02:44:40,228 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:44:40,228 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:44:40,492 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:40,492 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:44:40,699 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:40,708 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:44:40,984 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:40,985 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:44:41,152 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:41,152 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:44:41,156 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:44:41,156 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:44:41,201 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:44:41,242 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:44:41,242 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:44:41,385 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:41,385 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:44:41,387 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:44:41,387 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:44:41,389 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:44:41,390 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:44:41,848 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:44:41,851 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:44:41,859 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:44:42,233 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:44:42,238 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 02:44:42,238 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:44:42,238 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:44:42,655 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:44:42,657 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:44:43,059 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:44:43,112 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:44:43,124 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:44:43,124 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:44:43,301 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:43,302 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:44:43,448 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:43,449 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:44:43,627 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:44:43,628 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:44:43,923 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:44:43,924 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:44:43,929 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_balance_margin cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:44:44,280 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '0.0', 'equity': '0.0', 'margin': '0.0', 'free_margin': '0.0', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:44:44,314 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 02:44:44,315 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:44:48,160 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:44:48,481 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:44:50,885 - INFO - app - Application shutdown initiated
2025-07-23 02:44:50,886 - INFO - app - Scheduler shutdown completed
2025-07-23 02:44:51,914 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 02:44:52,267 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 02:44:52,267 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 02:44:52,271 - INFO - app - Redis connection closed
2025-07-23 02:44:52,271 - INFO - app - Application shutdown completed
2025-07-23 02:53:26,634 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:53:26,677 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:53:26,693 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:53:26,693 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:53:27,054 - INFO - app - Application starting up - Trading system initialized
2025-07-23 02:53:27,054 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 02:53:27,054 - INFO - app - Environment: PRODUCTION
2025-07-23 02:53:27,140 - INFO - app - Application startup initiated
2025-07-23 02:53:27,140 - INFO - app - Initializing core services...
2025-07-23 02:53:27,187 - INFO - app - Firebase initialized
2025-07-23 02:53:27,187 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 02:53:27,247 - INFO - app - Redis initialized
2025-07-23 02:53:29,430 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 02:53:29,437 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 02:53:29,444 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 02:53:29,444 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-23 02:53:29,445 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 02:53:29,446 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 02:53:29,447 - INFO - app - Scheduler initialized
2025-07-23 02:53:29,452 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:53:29,453 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 02:53:30,620 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 02:53:30,632 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:53:30,661 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 02:53:30,661 - INFO - app - Background tasks initialized
2025-07-23 02:53:30,661 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:53:31,426 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:53:31,426 - INFO - app - Application startup completed successfully
2025-07-23 02:53:31,426 - INFO - app - Starting cache validation task
2025-07-23 02:53:31,436 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 02:53:31,446 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 02:53:31,456 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-23 02:53:31,457 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:53:31,457 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:53:31,457 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:53:31,457 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:53:31,489 - INFO - app - Found 30 static orders cache entries to check
2025-07-23 02:53:31,492 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:53:31,493 - WARNING - app - Found stale cache entry for user live:24, will be refreshed on next access
2025-07-23 02:53:31,494 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:53:31,496 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:53:31,498 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:53:31,499 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:53:31,501 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:53:31,502 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:53:31,504 - WARNING - app - Found stale cache entry for user live:31, will be refreshed on next access
2025-07-23 02:53:31,505 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:53:31,506 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:53:31,507 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:53:31,509 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:53:31,513 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:53:31,515 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:53:31,520 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:53:31,530 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:53:31,536 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:53:31,537 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:53:31,541 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:53:31,544 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:53:31,547 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:53:31,548 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:53:31,786 - INFO - app - Validating cache for 37 users
2025-07-23 02:53:31,799 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-23 02:53:31,811 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:53:31,812 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:53:31,812 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:53:31,951 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 02:53:32,016 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-23 02:53:32,159 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-23 02:53:32,333 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-23 02:53:32,472 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-23 02:53:32,491 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:53:32,867 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:53:32,878 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:53:32,885 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:53:32,885 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:53:32,940 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-23 02:53:32,990 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:53:32,991 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:53:33,018 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:53:33,039 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-23 02:53:33,094 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:53:33,095 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:53:33,195 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-23 02:53:33,270 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:33,271 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:53:33,365 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-23 02:53:33,512 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-23 02:53:33,687 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-23 02:53:33,698 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:53:34,087 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:53:34,091 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:53:34,092 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:53:34,092 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:53:34,136 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-23 02:53:34,221 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-23 02:53:34,412 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-23 02:53:34,580 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:53:34,962 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:53:34,963 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:53:34,971 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:53:34,982 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:53:34,982 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:53:35,054 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-23 02:53:35,111 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:35,111 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:53:35,152 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-23 02:53:35,237 - WARNING - app - User 24: Missing balance/margin cache, refreshing...
2025-07-23 02:53:35,438 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-23 02:53:35,651 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:53:35,655 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-23 02:53:35,777 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:53:35,789 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:53:35,847 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:53:35,926 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:53:35,936 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:53:35,941 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:53:36,037 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:53:36,048 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:53:36,049 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:53:36,050 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:53:36,156 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 02:53:36,207 - WARNING - app - User 27: Missing balance/margin cache, refreshing...
2025-07-23 02:53:36,245 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:36,246 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:53:36,316 - WARNING - app - User 28: Missing balance/margin cache, refreshing...
2025-07-23 02:53:36,372 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:36,373 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:53:36,432 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-23 02:53:36,466 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:53:36,503 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:53:36,503 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:53:36,505 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:53:36,511 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:53:36,521 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:36,521 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:53:36,524 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-23 02:53:36,547 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:53:36,548 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:53:36,551 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:53:36,551 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:53:36,584 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:53:36,588 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:53:36,607 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:53:36,607 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:53:36,610 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:53:36,610 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:53:36,610 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:53:36,620 - WARNING - app - User 31: Missing balance/margin cache, refreshing...
2025-07-23 02:53:36,640 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:36,640 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:53:36,642 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:53:36,643 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:53:36,656 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 02:53:36,676 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 02:53:36,676 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 02:53:36,696 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-23 02:53:36,755 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:36,755 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:53:36,793 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-23 02:53:36,976 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-23 02:53:37,058 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 02:53:37,105 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:53:37,478 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:53:37,496 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:53:37,503 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:53:37,503 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:53:37,530 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-23 02:53:37,635 - INFO - app - Cache validation completed
2025-07-23 02:53:37,651 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:37,651 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:53:37,740 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 02:53:37,918 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:53:38,289 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:53:38,292 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:53:38,294 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:53:38,295 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:53:38,400 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:38,400 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:53:38,602 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:38,602 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:53:38,797 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:38,797 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:53:38,883 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:38,883 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:53:39,136 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:53:39,460 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6682.653854187286367175416203', 'margin': '19.55', 'free_margin': '6663.103854187286367175416203', 'profit_loss': '10.01385418728636717541620308', 'margin_level': '34182.37265568944433337808799', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.8214828365289447997651925217', 'current_price': '96.4765'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.760000000000100000000000000', 'current_price': '0.6585350000000001'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.432371350757322375651010560', 'current_price': '96.4765'}], 'margin_call': False}
2025-07-23 02:53:39,464 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34182.37265568944433337808799
2025-07-23 02:53:39,466 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:53:39,466 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:53:39,854 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:53:40,254 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:53:40,257 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:53:40,257 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.24306580172932516753352731% which is below threshold 100.0%
2025-07-23 02:53:40,257 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8855.614000000000000000000000', 'margin': '9705.52', 'free_margin': '-849.906000000000000000000000', 'profit_loss': '-1167.586000000000000000000000', 'margin_level': '91.24306580172932516753352731', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.252784999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.252784999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1167.586000000000000000000000', 'current_price': '118093.11'}], 'margin_call': True}
2025-07-23 02:53:40,259 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.24306580172932516753352731
2025-07-23 02:53:44,122 - INFO - app - [AUTO-CUTOFF] Sent margin call warning email (HTML) to user 28 at rividih114@luxpolar.com
2025-07-23 02:53:44,143 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:53:44,143 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:53:44,312 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:44,312 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:53:44,413 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:44,413 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:53:44,581 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:44,581 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:53:44,751 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:44,751 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:53:44,755 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:53:44,755 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:53:44,789 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:53:44,830 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:53:44,830 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:53:45,044 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:45,044 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:53:45,047 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:53:45,047 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:53:45,051 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:53:45,051 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:53:45,325 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:53:45,327 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:53:45,966 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:53:45,974 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 02:53:45,974 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:53:45,975 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:53:46,205 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:53:46,206 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:53:46,585 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:53:46,593 - INFO - app - Starting stale cache cleanup task
2025-07-23 02:53:46,596 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:53:46,597 - INFO - app - Found 30 static orders cache entries to check
2025-07-23 02:53:46,599 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:53:46,599 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:53:46,602 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 02:53:46,603 - WARNING - app - Found stale cache entry for user live:24, will be refreshed on next access
2025-07-23 02:53:46,607 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 02:53:46,610 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 02:53:46,613 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 02:53:46,616 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 02:53:46,620 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 02:53:46,623 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 02:53:46,625 - WARNING - app - Found stale cache entry for user live:31, will be refreshed on next access
2025-07-23 02:53:46,627 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 02:53:46,630 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 02:53:46,632 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 02:53:46,648 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 02:53:46,650 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 02:53:46,652 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 02:53:46,655 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 02:53:46,657 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 02:53:46,664 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 02:53:46,667 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 02:53:46,676 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 02:53:46,679 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 02:53:46,683 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 02:53:46,684 - INFO - app - Completed stale cache cleanup task
2025-07-23 02:53:46,752 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:46,752 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:53:46,903 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:46,903 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:53:46,994 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:53:46,994 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:53:47,283 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:53:47,287 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:53:47,605 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:53:47,615 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 02:53:47,615 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:54:17,747 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:54:17,748 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:54:17,748 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:54:17,748 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:54:17,841 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:54:17,841 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:54:17,841 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:54:18,193 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:54:18,535 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:54:18,537 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:54:18,539 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:54:18,539 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:54:18,736 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:54:18,736 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:54:18,762 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:54:18,846 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:54:18,847 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:54:19,124 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:19,124 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:54:19,611 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:54:19,969 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:54:19,977 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:54:19,989 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:54:19,989 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:54:20,361 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:54:20,661 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:54:20,661 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:54:20,677 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:54:20,680 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:54:20,680 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:54:20,835 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:20,835 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:54:21,144 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:54:21,499 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:54:21,507 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:54:21,509 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:54:21,509 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:54:21,752 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:21,752 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:54:21,962 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:21,963 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:54:22,199 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:22,199 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:54:22,338 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:22,339 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:54:22,477 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:22,477 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:54:22,721 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:54:23,020 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:54:23,025 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:54:23,028 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:54:23,028 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:54:23,291 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:23,291 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:54:23,623 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:54:23,931 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:54:23,940 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:54:23,942 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:54:23,942 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:54:24,062 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:24,062 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:54:24,179 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:24,179 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:54:24,303 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:24,304 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:54:24,437 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:24,437 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:54:24,694 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:54:25,086 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6682.654832835046620523951891', 'margin': '19.55', 'free_margin': '6663.104832835046620523951891', 'profit_loss': '10.01483283504662052395189144', 'margin_level': '34182.37766156034076994348793', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.8419666625711594380964082402', 'current_price': '96.4795'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.720000000000000000000000', 'current_price': '0.658495'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.452866172475461085855483202', 'current_price': '96.4795'}], 'margin_call': False}
2025-07-23 02:54:25,088 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34182.37766156034076994348793
2025-07-23 02:54:25,089 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:54:25,089 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:54:25,412 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:54:25,807 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:54:25,813 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:54:25,813 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.18874619803987833727610679% which is below threshold 100.0%
2025-07-23 02:54:25,814 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8850.342000000000000000000000', 'margin': '9705.52', 'free_margin': '-855.178000000000000000000000', 'profit_loss': '-1172.858000000000000000000000', 'margin_level': '91.18874619803987833727610679', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.2529449999999995'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.2529449999999995'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1172.858000000000000000000000', 'current_price': '118079.93'}], 'margin_call': True}
2025-07-23 02:54:25,818 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.18874619803987833727610679
2025-07-23 02:54:25,820 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:54:25,821 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:54:26,034 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:26,034 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:54:26,211 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:26,211 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:54:26,419 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:26,419 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:54:26,554 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:26,554 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:54:26,556 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:54:26,556 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:54:26,580 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:54:26,614 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:54:26,614 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:54:26,834 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:26,834 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:54:26,836 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:54:26,836 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:54:26,838 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:54:26,838 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:54:27,126 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:54:27,128 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:54:27,442 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:54:27,456 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 02:54:27,456 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:54:27,456 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:54:27,757 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:54:27,759 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:54:28,060 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:54:28,064 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:54:28,066 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:54:28,066 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:54:28,256 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:28,257 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:54:28,566 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:28,566 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:54:28,716 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:54:28,716 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:54:28,985 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:54:28,986 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:54:29,286 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:54:29,302 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 02:54:29,303 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:54:29,447 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:54:29,753 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:54:59,370 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:54:59,371 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:54:59,371 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:54:59,371 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:54:59,489 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:54:59,489 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:54:59,489 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:54:59,884 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:55:00,207 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:55:00,210 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:55:00,212 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:55:00,212 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:55:00,465 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:55:00,465 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:55:00,486 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:55:00,583 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:55:00,584 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:55:00,819 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:00,819 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:55:01,182 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:55:01,540 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:55:01,545 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:55:01,549 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:55:01,549 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:55:01,815 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:55:02,152 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:55:02,152 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:55:02,158 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:55:02,160 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:55:02,160 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:55:02,272 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:02,272 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:55:02,587 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:55:02,974 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:55:02,979 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:55:02,980 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:55:02,980 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:55:03,176 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:03,176 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:55:03,335 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:03,335 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 02:55:03,587 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:03,587 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 02:55:03,706 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:03,706 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 02:55:03,820 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:03,820 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 02:55:04,232 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 02:55:04,608 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 02:55:04,611 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 02:55:04,613 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 02:55:04,614 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 02:55:04,759 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:04,759 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 02:55:05,085 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 02:55:05,427 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 02:55:05,432 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 02:55:05,435 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 02:55:05,435 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 02:55:05,673 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:05,673 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 02:55:05,781 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:05,781 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 02:55:05,891 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:05,891 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 02:55:06,113 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:06,114 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 02:55:06,447 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 02:55:06,769 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6682.966682638163823876705503', 'margin': '19.55', 'free_margin': '6663.416682638163823876705503', 'profit_loss': '10.32668263816382387670550334', 'margin_level': '34183.97280121822927814171613', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '0.957941041969613203104203780', 'current_price': '96.49650000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '6.800000000000000000000000', 'current_price': '0.658575'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.568741596194210673601299561', 'current_price': '96.49650000000001'}], 'margin_call': False}
2025-07-23 02:55:06,772 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34183.97280121822927814171613
2025-07-23 02:55:06,773 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 02:55:06,774 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 02:55:07,095 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 02:55:07,462 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:55:07,467 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 02:55:07,467 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.18858134340045664735119808% which is below threshold 100.0%
2025-07-23 02:55:07,468 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8850.326000000000000000000000', 'margin': '9705.52', 'free_margin': '-855.194000000000000000000000', 'profit_loss': '-1172.874000000000000000000000', 'margin_level': '91.18858134340045664735119808', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.252745'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.252745'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1172.874000000000000000000000', 'current_price': '118079.89'}], 'margin_call': True}
2025-07-23 02:55:07,470 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.18858134340045664735119808
2025-07-23 02:55:07,472 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 02:55:07,472 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 02:55:07,618 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:07,618 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 02:55:07,757 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:07,757 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 02:55:07,936 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:07,950 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 02:55:08,133 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:08,133 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 02:55:08,136 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 02:55:08,137 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 02:55:08,163 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:55:08,196 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 02:55:08,196 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 02:55:08,328 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:08,328 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 02:55:08,333 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 02:55:08,333 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 02:55:08,336 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 02:55:08,336 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 02:55:08,568 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 02:55:08,568 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 02:55:08,910 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:55:08,919 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 02:55:08,919 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 02:55:08,920 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 02:55:09,276 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:55:09,280 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 02:55:09,629 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:55:09,632 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:55:09,635 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:55:09,635 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 02:55:09,800 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:09,800 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 02:55:10,036 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:10,036 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 02:55:10,241 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:10,241 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 02:55:10,542 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 02:55:10,542 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 02:55:10,873 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 02:55:10,880 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 02:55:10,881 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 02:55:29,447 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 02:55:29,796 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 02:55:40,992 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:55:40,993 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 02:55:40,993 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 02:55:40,993 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 02:55:41,152 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 02:55:41,153 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 02:55:41,153 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 02:55:41,523 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 02:55:41,850 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 02:55:41,853 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 02:55:41,856 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 02:55:41,856 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 02:55:41,957 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 02:55:41,958 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 02:55:41,984 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 02:55:42,084 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 02:55:42,085 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 02:55:42,259 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:42,259 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 02:55:42,752 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 02:55:43,052 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 02:55:43,086 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 02:55:43,101 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 02:55:43,104 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 02:55:43,473 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 02:55:43,826 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 02:55:43,826 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 02:55:43,836 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 02:55:43,839 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 02:55:43,839 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 02:55:43,954 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:43,954 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 02:55:44,131 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 02:55:44,543 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 02:55:44,548 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 02:55:44,551 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 02:55:44,551 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 02:55:44,917 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 02:55:44,917 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 02:55:45,203 - INFO - app - Application shutdown initiated
2025-07-23 02:55:45,204 - INFO - app - Scheduler shutdown completed
2025-07-23 02:55:46,495 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 02:55:47,416 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 02:55:47,416 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 02:55:47,563 - INFO - app - Redis connection closed
2025-07-23 02:55:47,564 - INFO - app - Application shutdown completed
2025-07-23 03:40:31,669 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:40:31,714 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:40:31,726 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:40:31,726 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:40:58,868 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:40:58,893 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:40:58,907 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:40:58,907 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:40:59,388 - INFO - app - Application starting up - Trading system initialized
2025-07-23 03:40:59,389 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 03:40:59,389 - INFO - app - Environment: PRODUCTION
2025-07-23 03:40:59,471 - INFO - app - Application startup initiated
2025-07-23 03:40:59,471 - INFO - app - Initializing core services...
2025-07-23 03:40:59,527 - INFO - app - Firebase initialized
2025-07-23 03:40:59,528 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 03:40:59,585 - INFO - app - Redis initialized
2025-07-23 03:41:01,985 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 03:41:01,996 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 03:41:02,004 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 03:41:02,004 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-23 03:41:02,004 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 03:41:02,005 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 03:41:02,005 - INFO - app - Scheduler initialized
2025-07-23 03:41:02,009 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 03:41:02,010 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 03:41:03,481 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 03:41:03,485 - INFO - app - Starting stale cache cleanup task
2025-07-23 03:41:03,548 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 03:41:03,548 - INFO - app - Background tasks initialized
2025-07-23 03:41:03,548 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:41:04,177 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:41:04,177 - INFO - app - Application startup completed successfully
2025-07-23 03:41:04,178 - INFO - app - Starting cache validation task
2025-07-23 03:41:04,183 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 03:41:04,192 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 03:41:04,203 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-23 03:41:04,204 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:41:04,204 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:41:04,204 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:41:04,204 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:41:04,223 - INFO - app - Found 29 static orders cache entries to check
2025-07-23 03:41:04,225 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 03:41:04,226 - WARNING - app - Found stale cache entry for user live:24, will be refreshed on next access
2025-07-23 03:41:04,227 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 03:41:04,228 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 03:41:04,230 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 03:41:04,231 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 03:41:04,233 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 03:41:04,235 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 03:41:04,236 - WARNING - app - Found stale cache entry for user live:31, will be refreshed on next access
2025-07-23 03:41:04,238 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 03:41:04,269 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 03:41:04,280 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 03:41:04,284 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 03:41:04,285 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 03:41:04,286 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 03:41:04,287 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 03:41:04,289 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 03:41:04,290 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 03:41:04,291 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 03:41:04,292 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 03:41:04,293 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 03:41:04,293 - INFO - app - Completed stale cache cleanup task
2025-07-23 03:41:04,430 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:41:04,430 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:41:04,430 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:41:04,440 - INFO - app - Validating cache for 37 users
2025-07-23 03:41:04,450 - WARNING - app - User 4: Missing balance/margin cache, refreshing...
2025-07-23 03:41:04,540 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 03:41:04,578 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-23 03:41:04,660 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-23 03:41:04,739 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-23 03:41:04,774 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:41:04,778 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 4, falling back to DB and updating cache.
2025-07-23 03:41:05,387 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '244.67000000', 'margin': '7.37', 'free_margin': '237.30000000', 'profit_loss': '0.0', 'margin_level': '3319.810040705563093622795115', 'positions': [], 'margin_call': False}
2025-07-23 03:41:05,390 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3319.810040705563093622795115
2025-07-23 03:41:05,398 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:41:05,398 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:41:05,411 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-23 03:41:05,548 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:41:05,548 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:41:05,552 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-23 03:41:05,563 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:41:05,662 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:41:05,663 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:41:05,672 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-23 03:41:05,756 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-23 03:41:05,788 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:05,788 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:41:05,846 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-23 03:41:05,937 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-23 03:41:06,040 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-23 03:41:06,139 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-23 03:41:06,175 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:41:06,483 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:41:06,485 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:41:06,498 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:41:06,523 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:41:06,531 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:41:06,535 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:41:06,536 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:41:06,549 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:41:06,554 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:41:06,552 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:41:06,584 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-23 03:41:06,584 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:41:06,688 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-23 03:41:06,775 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-23 03:41:06,858 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-23 03:41:06,992 - WARNING - app - User 24: Missing balance/margin cache, refreshing...
2025-07-23 03:41:07,025 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:41:07,078 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:41:07,097 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:41:07,100 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:41:07,101 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:41:07,124 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:41:07,127 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:41:07,127 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:41:07,132 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:41:07,149 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:41:07,155 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:41:07,156 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:41:07,165 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:41:07,165 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:41:07,175 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:41:07,175 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:41:07,181 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:41:07,193 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:41:07,199 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:41:07,199 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:41:07,205 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:41:07,205 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:41:07,328 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:41:07,328 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:41:07,336 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:41:07,338 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:41:07,338 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:41:07,413 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-23 03:41:07,462 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:07,463 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:41:07,507 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-23 03:41:07,580 - WARNING - app - User 27: Missing balance/margin cache, refreshing...
2025-07-23 03:41:07,652 - WARNING - app - User 28: Missing balance/margin cache, refreshing...
2025-07-23 03:41:07,695 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:41:07,988 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:41:07,993 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:41:07,994 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:41:07,994 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:41:07,997 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-23 03:41:08,068 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-23 03:41:08,111 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:08,111 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:41:08,147 - WARNING - app - User 31: Missing balance/margin cache, refreshing...
2025-07-23 03:41:08,210 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:08,212 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:41:08,228 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-23 03:41:08,305 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-23 03:41:08,319 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:08,319 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:41:08,384 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-23 03:41:08,416 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:08,416 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:41:08,473 - WARNING - app - User 4: Missing static orders cache, refreshing...
2025-07-23 03:41:08,516 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:08,516 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:41:08,583 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 03:41:08,696 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-23 03:41:08,817 - INFO - app - Cache validation completed
2025-07-23 03:41:08,854 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:41:09,158 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:41:09,165 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:41:09,169 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:41:09,169 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:41:09,346 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:09,346 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:41:09,524 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:41:09,839 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:41:09,853 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:41:09,854 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:41:09,854 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:41:09,946 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:09,946 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:41:10,041 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:10,041 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:41:10,135 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:10,136 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:41:10,246 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:10,246 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:41:10,418 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:41:10,734 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6683.683808213190687255417523', 'margin': '19.55', 'free_margin': '6664.133808213190687255417523', 'profit_loss': '11.04380821319068725541752320', 'margin_level': '34187.64096272731809337809475', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.061019785143112762339249981', 'current_price': '96.51150000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.310000000000000000000000', 'current_price': '0.659085'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.672788428047574493078273222', 'current_price': '96.51150000000001'}], 'margin_call': False}
2025-07-23 03:41:10,742 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34187.64096272731809337809475
2025-07-23 03:41:10,748 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:41:10,748 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:41:10,957 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:41:11,267 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:41:11,269 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:41:11,269 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.59993488241742843247966106% which is below threshold 100.0%
2025-07-23 03:41:11,269 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8890.250000000000000000000000', 'margin': '9705.52', 'free_margin': '-815.270000000000000000000000', 'profit_loss': '-1132.950000000000000000000000', 'margin_level': '91.59993488241742843247966106', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.255195'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.255195'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1132.950000000000000000000000', 'current_price': '118179.7'}], 'margin_call': True}
2025-07-23 03:41:11,270 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.59993488241742843247966106
2025-07-23 03:41:11,271 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:41:11,271 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:41:11,364 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:11,364 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:41:11,481 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:11,481 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:41:11,582 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:11,583 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:41:11,683 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:11,683 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:41:11,684 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:41:11,684 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:41:11,699 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:41:11,738 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:41:11,738 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:41:11,833 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:11,833 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:41:11,834 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:41:11,834 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:41:11,835 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:41:11,835 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:41:11,980 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:41:11,980 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:41:12,278 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:41:12,281 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:41:12,281 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:41:12,281 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:41:12,441 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:41:12,442 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:41:12,741 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:41:12,743 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:41:12,744 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:41:12,744 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:41:12,855 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:12,855 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:41:12,967 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:12,967 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:41:13,094 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:13,095 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:41:13,246 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:41:13,247 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:41:13,543 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:41:13,561 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:41:13,561 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:41:19,184 - INFO - app - Starting stale cache cleanup task
2025-07-23 03:41:19,187 - INFO - app - Found 30 static orders cache entries to check
2025-07-23 03:41:19,192 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 03:41:19,194 - WARNING - app - Found stale cache entry for user live:24, will be refreshed on next access
2025-07-23 03:41:19,197 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 03:41:19,200 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 03:41:19,202 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 03:41:19,204 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 03:41:19,206 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 03:41:19,207 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 03:41:19,208 - WARNING - app - Found stale cache entry for user live:31, will be refreshed on next access
2025-07-23 03:41:19,209 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 03:41:19,210 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 03:41:19,212 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 03:41:19,218 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 03:41:19,219 - WARNING - app - Found stale cache entry for user live:4, will be refreshed on next access
2025-07-23 03:41:19,220 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 03:41:19,220 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 03:41:19,222 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 03:41:19,224 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 03:41:19,226 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 03:41:19,227 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 03:41:19,230 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 03:41:19,233 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 03:41:19,233 - INFO - app - Completed stale cache cleanup task
2025-07-23 03:41:21,742 - INFO - app.api.v1.endpoints.favorites - Direct SQL query found 8 symbols for user 4
2025-07-23 03:41:21,742 - INFO - app.api.v1.endpoints.favorites - Symbols: ['AUDCAD', 'AUDCHF', 'AUDJPY', 'AUDNZD', 'XAGUSD', 'US30', 'JP225', 'D30']
2025-07-23 03:41:22,650 - ERROR - app - Error in barclays_pending_order_margin_checker loop: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\main.py", line 1485, in barclays_pending_order_margin_checker
    live_users = await crud_user.get_all_users_with_pending_orders(db)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\user.py", line 473, in get_all_users_with_pending_orders
    result = await db.execute(
             ^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2365, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\orm\session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3273, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 147, in __init__
    Connection._handle_dbapi_exception_noconnection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        err, dialect, engine
        ^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 2436, in _handle_dbapi_exception_noconnection
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 145, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\base.py", line 3297, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 713, in checkout
    rec = pool._do_get()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 179, in _do_get
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\impl.py", line 177, in _do_get
    return self._create_connection()
           ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 675, in __init__
    self.__connect()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 901, in __connect
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\pool\base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\engine\default.py", line 625, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\dialects\mysql\aiomysql.py", line 270, in connect
    await_only(creator_fn(*arg, **kw)),
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 75, in _connect
    await conn._connect()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 540, in _connect
    await self._request_authentication()
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 844, in _request_authentication
    auth_packet = await self._read_packet()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\aiomysql\connection.py", line 652, in _read_packet
    packet.raise_for_error()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\protocol.py", line 219, in raise_for_error
    err.raise_mysql_exception(self._data)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\venv\Lib\site-packages\pymysql\err.py", line 150, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1226, "User 'u436589492_testingserver' has exceeded the 'max_user_connections' resource (current value: 50)")
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-23 03:41:43,634 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:41:43,635 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:41:43,635 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:41:43,635 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:41:43,779 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:41:43,780 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:41:43,780 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:41:44,905 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:41:45,223 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '245.4277952140071651129640609', 'margin': '7.37', 'free_margin': '238.0577952140071651129640609', 'profit_loss': '0.7577952140071651129640609035', 'margin_level': '3330.092201004167776295306118', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.7577952140071651129640609035', 'current_price': '0.5835049999999999'}], 'margin_call': False}
2025-07-23 03:41:45,225 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3330.092201004167776295306118
2025-07-23 03:41:45,226 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:41:45,226 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:41:45,327 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:41:45,327 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:41:45,342 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:41:45,419 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:41:45,420 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:41:45,577 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:45,577 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:41:45,920 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:41:46,225 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:41:46,237 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:41:46,239 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:41:46,239 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:41:46,655 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:41:46,958 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:41:46,958 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:41:46,969 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:41:46,974 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:41:46,974 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:41:47,180 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:47,180 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:41:47,548 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:41:47,854 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:41:47,856 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:41:47,859 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:41:47,859 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:41:47,967 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:47,967 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:41:48,100 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:48,101 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:41:48,282 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:48,282 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:41:48,415 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:48,415 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:41:48,569 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:48,570 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:41:48,759 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:41:49,045 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:41:49,047 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:41:49,048 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:41:49,048 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:41:49,147 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:49,147 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:41:49,304 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:41:49,631 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:41:49,647 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:41:49,649 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:41:49,649 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:41:49,757 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:49,757 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:41:49,870 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:49,870 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:41:49,980 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:49,980 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:41:50,081 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:50,082 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:41:50,244 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:41:50,548 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6683.778389960730849530476353', 'margin': '19.55', 'free_margin': '6664.228389960730849530476353', 'profit_loss': '11.13838996073084953047635308', 'margin_level': '34188.12475683238286204847239', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.088321666382106880655625747', 'current_price': '96.5155'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.350000000000100000000000000', 'current_price': '0.6591250000000001'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.700068294348642649820727335', 'current_price': '96.5155'}], 'margin_call': False}
2025-07-23 03:41:50,559 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34188.12475683238286204847239
2025-07-23 03:41:50,565 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:41:50,565 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:41:50,762 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:41:51,074 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:41:51,077 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:41:51,077 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.68116700599246614297842877% which is below threshold 100.0%
2025-07-23 03:41:51,077 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8898.134000000000000000000000', 'margin': '9705.52', 'free_margin': '-807.386000000000000000000000', 'profit_loss': '-1125.066000000000000000000000', 'margin_level': '91.68116700599246614297842877', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.254905'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.254905'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1125.066000000000000000000000', 'current_price': '118199.41'}], 'margin_call': True}
2025-07-23 03:41:51,079 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.68116700599246614297842877
2025-07-23 03:41:51,080 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:41:51,080 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:41:51,203 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:51,204 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:41:51,305 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:51,306 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:41:51,412 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:51,412 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:41:51,521 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:51,522 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:41:51,524 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:41:51,525 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:41:51,542 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:41:51,578 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:41:51,578 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:41:51,668 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:51,668 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:41:51,671 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:41:51,671 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:41:51,672 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:41:51,673 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:41:51,822 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:41:51,822 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:41:52,122 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:41:52,134 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:41:52,134 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:41:52,134 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:41:52,341 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:41:52,342 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:41:52,638 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:41:52,642 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:41:52,644 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:41:52,644 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:41:52,744 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:52,745 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:41:52,863 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:52,863 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:41:52,954 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:41:52,954 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:41:53,089 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:41:53,090 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:41:53,396 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:41:53,402 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:41:53,402 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:42:02,005 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:42:02,318 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:42:23,504 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:42:23,504 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:42:23,504 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:42:23,504 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:42:23,597 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:42:23,597 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:42:23,597 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:42:23,746 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:42:24,056 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '245.3900030277034869051824191', 'margin': '7.37', 'free_margin': '238.0200030277034869051824191', 'profit_loss': '0.7200030277034869051824191351', 'margin_level': '3329.579416929491002784021969', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.7200030277034869051824191351', 'current_price': '0.583475'}], 'margin_call': False}
2025-07-23 03:42:24,059 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3329.579416929491002784021969
2025-07-23 03:42:24,060 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:42:24,060 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:42:24,153 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:42:24,153 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:42:24,174 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:42:24,264 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:42:24,264 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:42:24,370 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:24,371 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:42:24,543 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:42:24,834 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:42:24,837 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:42:24,839 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:42:24,839 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:42:25,007 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:42:25,306 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:42:25,307 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:42:25,312 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:42:25,315 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:42:25,315 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:42:25,425 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:25,425 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:42:25,603 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:42:25,911 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:42:25,917 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:42:25,920 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:42:25,920 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:42:26,053 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:26,053 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:42:26,171 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:26,171 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:42:26,274 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:26,274 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:42:26,414 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:26,415 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:42:26,571 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:26,571 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:42:26,829 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:42:27,123 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:42:27,126 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:42:27,127 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:42:27,127 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:42:27,225 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:27,226 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:42:27,367 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:42:27,670 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:42:27,677 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:42:27,682 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:42:27,682 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:42:27,810 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:27,810 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:42:27,915 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:27,915 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:42:28,017 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:28,017 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:42:28,151 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:28,151 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:42:28,337 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:42:28,679 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6683.866009398008523775048834', 'margin': '19.55', 'free_margin': '6664.316009398008523775048834', 'profit_loss': '11.22600939800852377504883413', 'margin_level': '34188.57293809723030063963598', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.102070840220265821574439603', 'current_price': '96.51750000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.410000000000000000000000', 'current_price': '0.659185'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.713938557788257953474394525', 'current_price': '96.51750000000001'}], 'margin_call': False}
2025-07-23 03:42:28,681 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34188.57293809723030063963598
2025-07-23 03:42:28,682 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:42:28,682 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:42:28,846 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:42:29,154 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:42:29,155 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:42:29,155 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.57487697722533156389353687% which is below threshold 100.0%
2025-07-23 03:42:29,155 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8887.818000000000000000000000', 'margin': '9705.52', 'free_margin': '-817.702000000000000000000000', 'profit_loss': '-1135.382000000000000000000000', 'margin_level': '91.57487697722533156389353687', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.254915'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.254915'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1135.382000000000000000000000', 'current_price': '118173.62'}], 'margin_call': True}
2025-07-23 03:42:29,156 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.57487697722533156389353687
2025-07-23 03:42:29,157 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:42:29,157 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:42:29,262 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:29,262 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:42:29,364 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:29,364 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:42:29,496 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:29,496 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:42:29,606 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:29,606 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:42:29,608 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:42:29,608 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:42:29,621 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:42:29,663 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:42:29,663 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:42:29,767 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:29,767 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:42:29,768 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:42:29,768 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:42:29,768 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:42:29,768 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:42:29,948 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:42:29,948 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:42:30,241 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:42:30,246 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:42:30,246 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:42:30,246 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:42:30,447 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:42:30,448 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:42:30,752 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:42:30,758 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:42:30,759 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:42:30,759 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:42:30,890 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:30,890 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:42:30,993 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:30,993 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:42:31,133 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:42:31,133 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:42:31,281 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:42:31,281 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:42:31,578 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:42:31,583 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:42:31,583 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:43:01,669 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:43:01,669 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:43:01,669 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:43:01,669 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:43:01,896 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:43:01,896 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:43:01,896 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:43:02,010 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:43:02,369 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:43:02,583 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:43:02,889 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '245.3270213732367710515026874', 'margin': '7.37', 'free_margin': '237.9570213732367710515026874', 'profit_loss': '0.6570213732367710515026874259', 'margin_level': '3328.724849026279118744948269', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.6570213732367710515026874259', 'current_price': '0.583425'}], 'margin_call': False}
2025-07-23 03:43:02,894 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3328.724849026279118744948269
2025-07-23 03:43:02,897 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:43:02,897 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:43:02,998 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:43:02,998 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:43:03,013 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:43:03,092 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:43:03,092 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:43:03,266 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:03,266 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:43:03,524 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:43:03,828 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:43:03,833 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:43:03,836 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:43:03,836 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:43:04,112 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:43:04,408 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:43:04,409 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:43:04,411 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:43:04,414 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:43:04,414 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:43:04,525 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:04,525 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:43:04,785 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:43:05,083 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:43:05,091 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:43:05,096 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:43:05,096 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:43:05,212 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:05,212 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:43:05,351 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:05,352 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:43:05,529 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:05,529 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:43:05,673 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:05,673 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:43:05,796 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:05,797 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:43:06,063 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:43:06,428 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:43:06,438 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:43:06,440 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:43:06,440 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:43:06,577 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:06,577 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:43:06,906 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:43:07,223 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:43:07,226 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:43:07,233 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:43:07,233 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:43:07,485 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:07,485 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:43:07,635 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:07,636 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:43:07,791 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:07,792 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:43:07,945 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:07,945 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:43:08,199 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:43:08,500 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6684.097473367932395520349631', 'margin': '19.55', 'free_margin': '6664.547473367932395520349631', 'profit_loss': '11.45747336793239552034963125', 'margin_level': '34189.75689702267209984833571', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.217945916416347992351816444', 'current_price': '96.53450000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.410000000000000000000000', 'current_price': '0.659185'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.829527451516047527997814805', 'current_price': '96.53450000000001'}], 'margin_call': False}
2025-07-23 03:43:08,503 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34189.75689702267209984833571
2025-07-23 03:43:08,505 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:43:08,505 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:43:08,791 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:43:09,097 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:43:09,101 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:43:09,101 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.80942391546254090455740651% which is below threshold 100.0%
2025-07-23 03:43:09,102 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8910.582000000000000000000000', 'margin': '9705.52', 'free_margin': '-794.938000000000000000000000', 'profit_loss': '-1112.618000000000000000000000', 'margin_level': '91.80942391546254090455740651', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.254815'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.254815'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1112.618000000000000000000000', 'current_price': '118230.53'}], 'margin_call': True}
2025-07-23 03:43:09,104 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.80942391546254090455740651
2025-07-23 03:43:09,106 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:43:09,107 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:43:09,278 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:09,278 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:43:09,435 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:09,436 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:43:09,606 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:09,606 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:43:09,779 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:09,780 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:43:09,782 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:43:09,782 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:43:09,804 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:43:09,849 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:43:09,850 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:43:10,008 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:10,008 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:43:10,010 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:43:10,011 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:43:10,013 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:43:10,013 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:43:10,335 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:43:10,336 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:43:10,640 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:43:10,646 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:43:10,646 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:43:10,646 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:43:10,868 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:43:10,869 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:43:11,191 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:43:11,193 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:43:11,195 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:43:11,195 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:43:11,337 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:11,337 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:43:11,466 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:11,466 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:43:11,588 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:11,589 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:43:11,882 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:43:11,882 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:43:12,177 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:43:12,181 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:43:12,181 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:43:42,271 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:43:42,272 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:43:42,272 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:43:42,272 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:43:42,605 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:43:42,606 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:43:42,606 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:43:42,855 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:42,856 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:43:43,079 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:43:43,079 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:43:43,098 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:43:43,218 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:43:43,218 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:43:43,442 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:43,442 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:43:43,877 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:43:44,175 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:43:44,180 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:43:44,183 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:43:44,183 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:43:44,473 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:43:44,823 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:43:44,824 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:43:44,831 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:43:44,834 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:43:44,834 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:43:45,006 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:45,007 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:43:45,237 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:43:45,541 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:43:45,544 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:43:45,546 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:43:45,546 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:43:45,677 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:45,677 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:43:45,844 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:45,844 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:43:45,993 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:45,993 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:43:46,142 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:46,143 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:43:46,247 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:46,247 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:43:46,561 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:43:46,893 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:43:46,904 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:43:46,907 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:43:46,907 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:43:47,059 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:47,059 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:43:47,323 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:43:47,632 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:43:47,638 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:43:47,640 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:43:47,640 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:43:47,823 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:47,823 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:43:47,996 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:47,996 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:43:48,172 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:48,172 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:43:48,349 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:48,349 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:43:48,540 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:43:48,842 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6684.175583901233319070510632', 'margin': '19.55', 'free_margin': '6664.625583901233319070510632', 'profit_loss': '11.53558390123331907051063191', 'margin_level': '34190.15643939249779575708763', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.252034196905343949305546072', 'current_price': '96.5395'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.420000000000100000000000000', 'current_price': '0.6591950000000001'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.863549704327875121205085834', 'current_price': '96.5395'}], 'margin_call': False}
2025-07-23 03:43:48,853 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34190.15643939249779575708763
2025-07-23 03:43:48,865 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:43:48,865 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:43:49,083 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:43:49,384 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:43:49,387 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:43:49,387 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 92.01549221473965331069329619% which is below threshold 100.0%
2025-07-23 03:43:49,387 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8930.582000000000000000000000', 'margin': '9705.52', 'free_margin': '-774.938000000000000000000000', 'profit_loss': '-1092.618000000000000000000000', 'margin_level': '92.01549221473965331069329619', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.254815'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.254815'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1092.618000000000000000000000', 'current_price': '118280.5300000000'}], 'margin_call': True}
2025-07-23 03:43:49,389 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 92.01549221473965331069329619
2025-07-23 03:43:49,391 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:43:49,391 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:43:49,584 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:49,585 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:43:49,678 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:49,678 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:43:49,817 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:49,817 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:43:49,913 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:49,913 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:43:49,915 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:43:49,915 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:43:49,924 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:43:49,958 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:43:49,958 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:43:50,161 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:50,161 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:43:50,172 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:43:50,172 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:43:50,176 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:43:50,176 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:43:50,492 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:43:50,493 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:43:50,796 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:43:50,799 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:43:50,800 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:43:50,800 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:43:51,069 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:43:51,071 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:43:51,406 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:43:51,429 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:43:51,433 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:43:51,433 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:43:51,566 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:51,566 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:43:51,689 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:51,690 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:43:51,811 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:43:51,811 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:43:51,986 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:43:51,986 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:43:52,292 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:43:52,297 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:43:52,297 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:44:02,014 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:44:02,361 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:44:22,373 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:44:22,374 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:44:22,374 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:44:22,374 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:44:22,529 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:44:22,529 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:44:22,530 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:44:22,738 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:44:23,051 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '245.3522554190113300865527770', 'margin': '7.37', 'free_margin': '237.9822554190113300865527770', 'profit_loss': '0.6822554190113300865527770067', 'margin_level': '3329.067237707073678243592632', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.6822554190113300865527770067', 'current_price': '0.583445'}], 'margin_call': False}
2025-07-23 03:44:23,058 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3329.067237707073678243592632
2025-07-23 03:44:23,061 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:44:23,061 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:44:23,175 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:44:23,175 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:44:23,203 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:44:23,287 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:44:23,288 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:44:23,410 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:23,410 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:44:23,653 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:44:23,977 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:44:23,983 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:44:23,984 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:44:23,984 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:44:24,226 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:44:24,556 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:44:24,556 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:44:24,570 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:44:24,573 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:44:24,573 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:44:24,744 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:24,745 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:44:24,923 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:44:25,219 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:44:25,223 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:44:25,226 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:44:25,226 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:44:25,412 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:25,412 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:44:25,570 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:25,570 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:44:25,739 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:25,740 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:44:25,921 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:25,924 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:44:26,135 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:26,135 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:44:26,393 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:44:26,699 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:44:26,705 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:44:26,706 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:44:26,706 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:44:26,880 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:26,880 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:44:27,249 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:44:27,583 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:44:27,589 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:44:27,591 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:44:27,591 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:44:27,867 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:27,867 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:44:28,073 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:28,073 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:44:28,297 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:28,297 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:44:28,521 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:28,521 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:44:28,805 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:44:29,172 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6684.283898391887875994400628', 'margin': '19.55', 'free_margin': '6664.733898391887875994400628', 'profit_loss': '11.64389839188787599440062822', 'margin_level': '34190.71047770786637337289324', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.286185940114104271228106115', 'current_price': '96.54450000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.460000000000000000000000', 'current_price': '0.659235'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.897712451773771723172522107', 'current_price': '96.54450000000001'}], 'margin_call': False}
2025-07-23 03:44:29,175 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34190.71047770786637337289324
2025-07-23 03:44:29,177 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:44:29,178 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:44:29,497 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:44:29,872 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:44:29,878 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:44:29,879 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.88228966608692785136705710% which is below threshold 100.0%
2025-07-23 03:44:29,879 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8917.654000000000000000000000', 'margin': '9705.52', 'free_margin': '-787.866000000000000000000000', 'profit_loss': '-1105.546000000000000000000000', 'margin_level': '91.88228966608692785136705710', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.255005'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.255005'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1105.546000000000000000000000', 'current_price': '118248.21'}], 'margin_call': True}
2025-07-23 03:44:29,881 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.88228966608692785136705710
2025-07-23 03:44:29,884 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:44:29,885 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:44:30,063 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:30,063 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:44:30,219 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:30,219 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:44:30,358 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:30,359 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:44:30,565 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:30,569 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:44:30,575 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:44:30,575 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:44:30,596 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:44:30,638 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:44:30,638 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:44:30,754 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:30,754 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:44:30,756 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:44:30,757 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:44:30,762 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:44:30,763 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:44:31,008 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:44:31,009 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:44:31,316 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:44:31,322 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:44:31,322 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:44:31,323 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:44:31,564 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:44:31,565 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:44:31,937 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:44:31,940 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:44:31,943 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:44:31,943 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:44:32,100 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:32,100 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:44:32,319 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:32,319 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:44:32,478 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:44:32,479 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:44:32,674 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:44:32,675 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:44:32,961 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:44:32,967 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:44:32,967 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:45:02,005 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:45:02,297 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:45:03,049 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:45:03,049 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:45:03,049 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:45:03,049 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:45:03,155 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:45:03,155 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:45:03,155 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:45:03,354 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:45:03,661 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '245.3900444085587404117884538', 'margin': '7.37', 'free_margin': '238.0200444085587404117884538', 'profit_loss': '0.7200444085587404117884537747', 'margin_level': '3329.579978406495799345840621', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.7200444085587404117884537747', 'current_price': '0.583475'}], 'margin_call': False}
2025-07-23 03:45:03,662 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3329.579978406495799345840621
2025-07-23 03:45:03,664 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:45:03,664 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:45:03,769 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:45:03,769 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:45:03,779 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:45:03,840 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:45:03,840 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:45:03,996 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:03,996 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:45:04,199 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:45:04,499 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:45:04,505 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:45:04,508 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:45:04,508 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:45:04,734 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:45:05,033 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:45:05,033 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:45:05,038 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:45:05,041 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:45:05,041 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:45:05,214 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:05,214 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:45:05,438 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:45:05,727 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:45:05,744 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:45:05,748 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:45:05,748 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:45:05,890 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:05,890 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:45:06,008 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:06,008 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:45:06,136 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:06,136 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:45:06,263 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:06,263 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:45:06,379 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:06,379 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:45:06,607 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:45:06,901 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:45:06,909 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:45:06,911 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:45:06,911 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:45:07,025 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:07,026 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:45:07,242 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:45:07,536 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:45:07,544 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:45:07,573 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:45:07,573 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:45:07,696 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:07,696 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:45:07,813 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:07,813 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:45:07,909 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:07,909 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:45:08,120 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:08,120 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:45:08,592 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:45:08,900 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6684.260820849663521282551994', 'margin': '19.55', 'free_margin': '6664.710820849663521282551994', 'profit_loss': '11.62082084966352128255199443', 'margin_level': '34190.59243401362414978287465', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.299718690682721326250529162', 'current_price': '96.54650000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.410000000000000000000000', 'current_price': '0.659185'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.911102158980799956301465266', 'current_price': '96.54650000000001'}], 'margin_call': False}
2025-07-23 03:45:08,902 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34190.59243401362414978287465
2025-07-23 03:45:08,904 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:45:08,904 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:45:09,187 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:45:09,489 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:45:09,492 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:45:09,493 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.72106182873251510480633701% which is below threshold 100.0%
2025-07-23 03:45:09,493 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8902.006000000000000000000000', 'margin': '9705.52', 'free_margin': '-803.514000000000000000000000', 'profit_loss': '-1121.194000000000000000000000', 'margin_level': '91.72106182873251510480633701', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.254944999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.254944999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1121.194000000000000000000000', 'current_price': '118209.09'}], 'margin_call': True}
2025-07-23 03:45:09,495 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.72106182873251510480633701
2025-07-23 03:45:09,497 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:45:09,497 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:45:09,608 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:09,609 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:45:09,753 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:09,754 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:45:09,861 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:09,861 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:45:09,976 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:09,977 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:45:09,980 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:45:09,980 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:45:09,996 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:45:10,029 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:45:10,029 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:45:10,138 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:10,138 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:45:10,140 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:45:10,140 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:45:10,142 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:45:10,143 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:45:10,346 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:45:10,347 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:45:10,649 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:45:10,652 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:45:10,653 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:45:10,653 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:45:10,889 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:45:10,890 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:45:11,228 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:45:11,235 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:45:11,239 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:45:11,239 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:45:11,357 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:11,358 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:45:11,471 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:11,472 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:45:11,590 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:11,590 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:45:11,765 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:45:11,766 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:45:12,059 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:45:12,067 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:45:12,068 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:45:42,135 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:45:42,135 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:45:42,135 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:45:42,135 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:45:42,269 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:45:42,269 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:45:42,269 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:45:42,473 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:45:42,766 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '245.4026709814161714797572638', 'margin': '7.37', 'free_margin': '238.0326709814161714797572638', 'profit_loss': '0.7326709814161714797572637927', 'margin_level': '3329.751302325863927812174543', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.7326709814161714797572637927', 'current_price': '0.5834849999999999'}], 'margin_call': False}
2025-07-23 03:45:42,767 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3329.751302325863927812174543
2025-07-23 03:45:42,768 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:45:42,768 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:45:42,891 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:45:42,891 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:45:42,900 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:45:43,348 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:45:43,349 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:45:43,460 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:43,460 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:45:43,649 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:45:43,953 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:45:43,957 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:45:43,958 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:45:43,958 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:45:44,080 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:45:44,382 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:45:44,382 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:45:44,385 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:45:44,389 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:45:44,389 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:45:44,504 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:44,504 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:45:44,630 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:45:44,926 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:45:44,930 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:45:44,932 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:45:44,932 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:45:45,038 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:45,038 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:45:45,128 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:45,128 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:45:45,209 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:45,209 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:45:45,298 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:45,298 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:45:45,398 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:45,399 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:45:45,561 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:45:45,872 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:45:45,873 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:45:45,875 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:45:45,875 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:45:45,959 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:45,960 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:45:46,076 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:45:46,374 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:45:46,378 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:45:46,379 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:45:46,379 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:45:46,481 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:46,481 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:45:46,581 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:46,582 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:45:46,668 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:46,668 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:45:46,806 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:46,806 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:45:47,016 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:45:47,314 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6684.298193040913411847927022', 'margin': '19.55', 'free_margin': '6664.748193040913411847927022', 'profit_loss': '11.65819304091341184792702245', 'margin_level': '34190.78359611720415267481853', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.313393783798547003878297919', 'current_price': '96.5485'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.420000000000100000000000000', 'current_price': '0.6591950000000001'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.924799257114764844048724532', 'current_price': '96.5485'}], 'margin_call': False}
2025-07-23 03:45:47,317 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34190.78359611720415267481853
2025-07-23 03:45:47,318 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:45:47,319 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:45:47,498 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:45:47,794 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:45:47,798 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:45:47,798 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.69105828435776753847295148% which is below threshold 100.0%
2025-07-23 03:45:47,798 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8899.094000000000000000000000', 'margin': '9705.52', 'free_margin': '-806.426000000000000000000000', 'profit_loss': '-1124.106000000000000000000000', 'margin_level': '91.69105828435776753847295148', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.254944999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.254944999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1124.106000000000000000000000', 'current_price': '118201.81'}], 'margin_call': True}
2025-07-23 03:45:47,800 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.69105828435776753847295148
2025-07-23 03:45:47,801 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:45:47,801 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:45:47,888 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:47,888 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:45:47,993 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:47,994 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:45:48,095 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:48,096 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:45:48,186 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:48,187 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:45:48,188 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:45:48,189 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:45:48,201 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:45:48,232 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:45:48,233 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:45:48,321 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:48,321 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:45:48,322 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:45:48,323 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:45:48,323 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:45:48,323 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:45:48,470 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:45:48,470 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:45:48,776 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:45:48,782 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:45:48,782 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:45:48,782 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:45:48,921 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:45:48,922 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:45:49,240 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:45:49,244 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:45:49,245 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:45:49,245 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:45:49,329 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:49,329 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:45:49,405 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:49,405 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:45:49,509 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:45:49,509 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:45:49,682 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:45:49,683 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:45:49,986 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:45:49,988 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:45:49,988 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:46:02,008 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:46:02,319 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:46:09,168 - INFO - app - Starting cache validation task
2025-07-23 03:46:09,308 - INFO - app - Validating cache for 37 users
2025-07-23 03:46:09,314 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,350 - WARNING - app - User 8: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,431 - WARNING - app - User 9: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,511 - WARNING - app - User 10: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,595 - WARNING - app - User 11: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,675 - WARNING - app - User 12: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,759 - WARNING - app - User 13: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,828 - WARNING - app - User 14: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,904 - WARNING - app - User 16: Missing balance/margin cache, refreshing...
2025-07-23 03:46:09,978 - WARNING - app - User 17: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,047 - WARNING - app - User 18: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,118 - WARNING - app - User 19: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,194 - WARNING - app - User 20: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,277 - WARNING - app - User 21: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,368 - WARNING - app - User 22: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,453 - WARNING - app - User 23: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,531 - WARNING - app - User 24: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,615 - WARNING - app - User 25: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,693 - WARNING - app - User 26: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,771 - WARNING - app - User 27: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,852 - WARNING - app - User 28: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,923 - WARNING - app - User 29: Missing balance/margin cache, refreshing...
2025-07-23 03:46:10,998 - WARNING - app - User 30: Missing balance/margin cache, refreshing...
2025-07-23 03:46:11,074 - WARNING - app - User 31: Missing balance/margin cache, refreshing...
2025-07-23 03:46:11,150 - WARNING - app - User 1: Missing balance/margin cache, refreshing...
2025-07-23 03:46:11,228 - WARNING - app - User 2: Missing balance/margin cache, refreshing...
2025-07-23 03:46:11,302 - WARNING - app - User 3: Missing balance/margin cache, refreshing...
2025-07-23 03:46:11,380 - WARNING - app - User 5: Missing balance/margin cache, refreshing...
2025-07-23 03:46:11,451 - WARNING - app - User 6: Missing balance/margin cache, refreshing...
2025-07-23 03:46:11,547 - INFO - app - Cache validation completed
2025-07-23 03:46:20,072 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:46:20,072 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:46:20,072 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:46:20,072 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:46:20,448 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:46:20,449 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:46:20,449 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:46:20,700 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:46:21,062 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.67000000', 'equity': '245.4278926120305561162696811', 'margin': '7.37', 'free_margin': '238.0578926120305561162696811', 'profit_loss': '0.7578926120305561162696810658', 'margin_level': '3330.093522551296555173265687', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.7578926120305561162696810658', 'current_price': '0.5835049999999999'}], 'margin_call': False}
2025-07-23 03:46:21,068 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3330.093522551296555173265687
2025-07-23 03:46:21,070 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:46:21,070 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:46:21,233 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:46:21,233 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:46:21,244 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:46:21,303 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:46:21,303 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:46:21,426 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:21,426 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:46:21,619 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:46:21,915 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:46:21,924 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:46:21,928 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:46:21,928 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:46:22,073 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:46:22,378 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:46:22,378 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:46:22,388 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:46:22,390 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:46:22,391 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:46:22,476 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:22,476 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:46:22,616 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:46:22,911 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:46:22,914 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:46:22,916 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:46:22,916 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:46:23,022 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:23,025 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:46:23,118 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:23,119 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:46:23,202 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:23,202 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:46:23,301 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:23,301 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:46:23,400 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:23,400 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:46:23,520 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:46:23,812 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:46:23,819 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:46:23,829 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:46:23,830 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:46:23,925 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:23,925 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:46:24,127 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:46:24,429 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:46:24,442 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:46:24,446 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:46:24,447 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:46:24,558 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:24,558 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:46:24,655 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:24,655 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:46:24,749 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:24,749 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:46:24,838 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:24,838 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:46:24,978 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:46:25,263 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6684.308071828485593336064454', 'margin': '19.55', 'free_margin': '6664.758071828485593336064454', 'profit_loss': '11.66807182848559333606445446', 'margin_level': '34190.83412699992630862437061', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.313355182302335108562064728', 'current_price': '96.5485'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.430000000000000000000000', 'current_price': '0.659205'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.924716646183258227502389731', 'current_price': '96.5485'}], 'margin_call': False}
2025-07-23 03:46:25,265 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34190.83412699992630862437061
2025-07-23 03:46:25,266 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:46:25,266 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:46:25,397 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:46:25,706 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:46:25,710 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:46:25,710 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.89712658363487994460884115% which is below threshold 100.0%
2025-07-23 03:46:25,710 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8919.094000000000000000000000', 'margin': '9705.52', 'free_margin': '-786.426000000000000000000000', 'profit_loss': '-1104.106000000000000000000000', 'margin_level': '91.89712658363487994460884115', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.255064999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.255064999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1104.106000000000000000000000', 'current_price': '118251.8100000000'}], 'margin_call': True}
2025-07-23 03:46:25,712 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.89712658363487994460884115
2025-07-23 03:46:25,713 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:46:25,713 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:46:25,824 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:25,824 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:46:25,903 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:25,904 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:46:26,027 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:26,028 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:46:26,147 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:26,147 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:46:26,148 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:46:26,149 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:46:26,159 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:46:26,189 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:46:26,189 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:46:26,284 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:26,284 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:46:26,285 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:46:26,285 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:46:26,286 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:46:26,286 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:46:26,527 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:46:26,527 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:46:26,833 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:46:26,838 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:46:26,838 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:46:26,838 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:46:26,972 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:46:26,972 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:46:27,271 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:46:27,277 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:46:27,279 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:46:27,279 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:46:27,366 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:27,366 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:46:27,445 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:27,446 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:46:27,536 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:27,536 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:46:27,671 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:46:27,672 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:46:27,970 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:46:27,973 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:46:27,974 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:46:58,054 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:46:58,055 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:46:58,055 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:46:58,055 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:46:58,374 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:46:58,375 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:46:58,375 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:46:58,590 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:46:58,955 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.84000000', 'equity': '245.5474589016035629124033257', 'margin': '7.37', 'free_margin': '238.1774589016035629124033257', 'profit_loss': '0.7074589016035629124033257214', 'margin_level': '3331.715860265991355663545803', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.7074589016035629124033257214', 'current_price': '0.583465'}], 'margin_call': False}
2025-07-23 03:46:58,957 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3331.715860265991355663545803
2025-07-23 03:46:58,959 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:46:58,959 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:46:59,130 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:46:59,130 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:46:59,141 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:46:59,218 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:46:59,218 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:46:59,407 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:46:59,407 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:46:59,714 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:47:00,007 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:47:00,010 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:47:00,011 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:47:00,011 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:47:00,156 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:47:00,462 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:47:00,462 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:47:00,466 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:47:00,468 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:47:00,468 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:47:00,575 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:00,575 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:47:00,753 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:47:01,050 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:47:01,058 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:47:01,059 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:47:01,060 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:47:01,143 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:01,144 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:47:01,246 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:01,246 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:47:01,347 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:01,347 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:47:01,447 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:01,447 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:47:01,556 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:01,556 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:47:01,702 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:47:01,996 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:47:02,002 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:47:02,003 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:47:02,003 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:47:02,004 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:47:02,300 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:47:02,388 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:02,388 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:47:02,517 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:47:02,805 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:47:02,811 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:47:02,813 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:47:02,813 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:47:02,910 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:02,910 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:47:03,005 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:03,005 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:47:03,106 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:03,106 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:47:03,242 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:03,242 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:47:03,374 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:47:03,674 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6684.349191560547608480420607', 'margin': '19.55', 'free_margin': '6664.799191560547608480420607', 'profit_loss': '11.70919156054760848042060701', 'margin_level': '34191.04445811021794619140975', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.333887542248472226963913830', 'current_price': '96.5515'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.430000000000000000000000', 'current_price': '0.659205'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.945304018299136253456693182', 'current_price': '96.5515'}], 'margin_call': False}
2025-07-23 03:47:03,679 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34191.04445811021794619140975
2025-07-23 03:47:03,681 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:47:03,681 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:47:03,814 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:47:04,105 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:47:04,108 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:47:04,108 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.61559607316248897534598867% which is below threshold 100.0%
2025-07-23 03:47:04,108 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8891.770000000000000000000000', 'margin': '9705.52', 'free_margin': '-813.750000000000000000000000', 'profit_loss': '-1131.430000000000000000000000', 'margin_level': '91.61559607316248897534598867', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.254925'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.254925'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1131.430000000000000000000000', 'current_price': '118183.5'}], 'margin_call': True}
2025-07-23 03:47:04,110 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.61559607316248897534598867
2025-07-23 03:47:04,112 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:47:04,112 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:47:04,207 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:04,207 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:47:04,307 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:04,307 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:47:04,411 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:04,411 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:47:04,510 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:04,510 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:47:04,513 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:47:04,513 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:47:04,525 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:47:04,562 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:47:04,562 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:47:04,660 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:04,660 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:47:04,663 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:47:04,663 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:47:04,665 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:47:04,665 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:47:04,876 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:47:04,876 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:47:05,169 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:47:05,185 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:47:05,185 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:47:05,186 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:47:05,425 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:47:05,425 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:47:05,730 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:47:05,734 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:47:05,735 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:47:05,736 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:47:05,832 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:05,832 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:47:05,951 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:05,951 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:47:06,102 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:06,102 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:47:06,560 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:47:06,560 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:47:06,858 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:47:06,864 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:47:06,864 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:47:36,950 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:47:36,951 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:47:36,951 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:47:36,951 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:47:37,036 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:47:37,036 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:47:37,036 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:47:37,207 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:47:37,502 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.84000000', 'equity': '245.3835087630750886401776589', 'margin': '7.37', 'free_margin': '238.0135087630750886401776589', 'profit_loss': '0.5435087630750886401776588899', 'margin_level': '3329.491299363298353326698221', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.5435087630750886401776588899', 'current_price': '0.5833349999999999'}], 'margin_call': False}
2025-07-23 03:47:37,505 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3329.491299363298353326698221
2025-07-23 03:47:37,512 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:47:37,512 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:47:37,603 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:47:37,603 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:47:37,616 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:47:37,677 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:47:37,677 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:47:37,770 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:37,770 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:47:37,899 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:47:38,190 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:47:38,194 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:47:38,195 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:47:38,195 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:47:38,346 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:47:38,635 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:47:38,636 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:47:38,640 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:47:38,641 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:47:38,642 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:47:38,727 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:38,727 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:47:38,868 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:47:39,169 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:47:39,171 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:47:39,173 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:47:39,173 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:47:39,268 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:39,268 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:47:39,362 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:39,362 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:47:39,447 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:39,448 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:47:39,524 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:39,524 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:47:39,599 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:39,599 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:47:39,718 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:47:40,008 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:47:40,013 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:47:40,019 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:47:40,020 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:47:40,114 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:40,114 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:47:40,240 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:47:40,528 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:47:40,535 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:47:40,538 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:47:40,538 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:47:40,614 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:40,615 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:47:40,689 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:40,689 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:47:40,772 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:40,773 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:47:40,869 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:40,869 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:47:41,017 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:47:41,316 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6683.893723153617882633933144', 'margin': '19.55', 'free_margin': '6664.343723153617882633933144', 'profit_loss': '11.25372315361788263393314440', 'margin_level': '34188.71469643794313367740739', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.136043295660258817905555366', 'current_price': '96.52250000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.370000000000100000000000000', 'current_price': '0.6591450000000001'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.747679857957523816027589033', 'current_price': '96.52250000000001'}], 'margin_call': False}
2025-07-23 03:47:41,317 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34188.71469643794313367740739
2025-07-23 03:47:41,318 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:47:41,318 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:47:41,455 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:47:41,771 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:47:41,774 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:47:41,774 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 91.72114425605222594976879137% which is below threshold 100.0%
2025-07-23 03:47:41,775 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8902.014000000000000000000000', 'margin': '9705.52', 'free_margin': '-803.506000000000000000000000', 'profit_loss': '-1121.186000000000000000000000', 'margin_level': '91.72114425605222594976879137', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.255154999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.255154999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1121.186000000000000000000000', 'current_price': '118209.11'}], 'margin_call': True}
2025-07-23 03:47:41,778 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 91.72114425605222594976879137
2025-07-23 03:47:41,780 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:47:41,780 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:47:41,848 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:41,849 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:47:41,935 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:41,936 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:47:42,019 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:42,020 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:47:42,121 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:42,121 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:47:42,121 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:47:42,122 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:47:42,130 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:47:42,159 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:47:42,159 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:47:42,258 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:42,259 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:47:42,261 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:47:42,261 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:47:42,262 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:47:42,263 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:47:42,450 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:47:42,451 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:47:42,780 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:47:42,785 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:47:42,785 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:47:42,785 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:47:42,941 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:47:42,942 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:47:43,257 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:47:43,262 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:47:43,264 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:47:43,264 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:47:43,339 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:43,339 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:47:43,410 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:43,411 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:47:43,480 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:47:43,480 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:47:43,601 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:47:43,601 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:47:43,906 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:47:43,910 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:47:43,910 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:48:02,008 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:48:02,317 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:48:13,965 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:48:13,965 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:48:13,965 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:48:13,965 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:48:14,097 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:48:14,098 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:48:14,098 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:48:14,226 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:48:14,528 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.84000000', 'equity': '245.3960769124011153307510819', 'margin': '7.37', 'free_margin': '238.0260769124011153307510819', 'profit_loss': '0.5560769124011153307510818961', 'margin_level': '3329.661830561751904080747380', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.5560769124011153307510818961', 'current_price': '0.583345'}], 'margin_call': False}
2025-07-23 03:48:14,534 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3329.661830561751904080747380
2025-07-23 03:48:14,541 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:48:14,541 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:48:14,629 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:48:14,630 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:48:14,634 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:48:14,691 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:48:14,691 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:48:14,775 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:14,775 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:48:14,894 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:48:15,192 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:48:15,200 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:48:15,202 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:48:15,202 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:48:15,323 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:48:15,633 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:48:15,633 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:48:15,636 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:48:15,638 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:48:15,638 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:48:15,712 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:15,713 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:48:15,825 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:48:16,130 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:48:16,136 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:48:16,138 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:48:16,138 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:48:16,217 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:16,217 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:48:16,291 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:16,291 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:48:16,375 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:16,376 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:48:16,462 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:16,463 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:48:16,552 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:16,552 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:48:16,681 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:48:16,986 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:48:16,992 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:48:16,998 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:48:16,998 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:48:17,112 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:17,113 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:48:17,236 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:48:17,545 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:48:17,551 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:48:17,552 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:48:17,552 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:48:17,648 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:17,648 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:48:17,740 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:17,740 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:48:17,822 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:17,823 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:48:17,933 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:17,933 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:48:18,065 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:48:18,378 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6683.883695266191510284356306', 'margin': '19.55', 'free_margin': '6664.333695266191510284356306', 'profit_loss': '11.24369526619151028435630583', 'margin_level': '34188.66340289612025720898366', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.136034854817189762080362752', 'current_price': '96.52250000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.360000000000000000000000', 'current_price': '0.659135'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.747660411374320522275943074', 'current_price': '96.52250000000001'}], 'margin_call': False}
2025-07-23 03:48:18,384 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34188.66340289612025720898366
2025-07-23 03:48:18,386 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:48:18,386 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:48:18,561 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:48:18,877 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:48:18,880 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:48:18,881 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 92.04677338256991897394472424% which is below threshold 100.0%
2025-07-23 03:48:18,881 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8933.618000000000000000000000', 'margin': '9705.52', 'free_margin': '-771.902000000000000000000000', 'profit_loss': '-1089.582000000000000000000000', 'margin_level': '92.04677338256991897394472424', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.255125'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.255125'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1089.582000000000000000000000', 'current_price': '118288.12'}], 'margin_call': True}
2025-07-23 03:48:18,884 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 92.04677338256991897394472424
2025-07-23 03:48:18,886 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:48:18,886 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:48:18,988 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:18,989 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:48:19,124 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:19,125 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:48:19,208 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:19,209 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:48:19,298 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:19,298 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:48:19,300 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:48:19,300 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:48:19,310 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:48:19,341 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:48:19,341 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:48:19,438 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:19,438 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:48:19,441 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:48:19,441 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:48:19,443 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:48:19,443 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:48:19,600 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:48:19,600 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:48:19,903 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:48:19,908 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:48:19,908 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:48:19,908 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:48:20,043 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:48:20,044 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:48:20,351 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:48:20,356 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:48:20,359 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:48:20,359 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:48:20,488 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:20,488 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:48:20,606 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:20,607 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:48:20,742 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:20,742 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:48:20,953 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:48:20,954 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:48:21,260 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:48:21,263 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:48:21,263 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:48:46,622 - INFO - app - Application shutdown initiated
2025-07-23 03:48:46,624 - INFO - app - Scheduler shutdown completed
2025-07-23 03:48:47,036 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 03:48:48,928 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 03:48:48,928 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 03:48:48,937 - INFO - app - Redis connection closed
2025-07-23 03:48:48,937 - INFO - app - Application shutdown completed
2025-07-23 03:48:51,395 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:48:51,441 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:48:51,456 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:48:51,456 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:48:51,975 - INFO - app - Application starting up - Trading system initialized
2025-07-23 03:48:51,975 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 03:48:51,975 - INFO - app - Environment: PRODUCTION
2025-07-23 03:48:52,039 - INFO - app - Application startup initiated
2025-07-23 03:48:52,039 - INFO - app - Initializing core services...
2025-07-23 03:48:52,092 - INFO - app - Firebase initialized
2025-07-23 03:48:52,092 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 03:48:52,113 - INFO - app - Redis initialized
2025-07-23 03:48:53,528 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 03:48:53,535 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 03:48:53,540 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 03:48:53,540 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio will run as a background asyncio task, not via APScheduler.
2025-07-23 03:48:53,540 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 03:48:53,542 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 03:48:53,542 - INFO - app - Scheduler initialized
2025-07-23 03:48:53,544 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 03:48:53,545 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 03:48:54,736 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 03:48:54,742 - INFO - app - Starting stale cache cleanup task
2025-07-23 03:48:54,777 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 03:48:54,777 - INFO - app - Background tasks initialized
2025-07-23 03:48:54,777 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 03:48:55,381 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 03:48:55,381 - INFO - app - Application startup completed successfully
2025-07-23 03:48:55,381 - INFO - app - Starting cache validation task
2025-07-23 03:48:55,387 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 03:48:55,396 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 03:48:55,408 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio background loop
2025-07-23 03:48:55,408 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:48:55,408 - INFO - app - [AUTO-CUTOFF] Starting update_all_users_dynamic_portfolio job...
2025-07-23 03:48:55,408 - INFO - app - [AUTO-CUTOFF] update_all_users_dynamic_portfolio heartbeat: task is alive and running.
2025-07-23 03:48:55,408 - INFO - app - [AUTO-CUTOFF] Fetching all active users (live and demo)...
2025-07-23 03:48:55,442 - INFO - app - Found 30 static orders cache entries to check
2025-07-23 03:48:55,447 - WARNING - app - Found stale cache entry for user live:11, will be refreshed on next access
2025-07-23 03:48:55,454 - WARNING - app - Found stale cache entry for user live:24, will be refreshed on next access
2025-07-23 03:48:55,468 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 03:48:55,476 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 03:48:55,477 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 03:48:55,479 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 03:48:55,481 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 03:48:55,481 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 03:48:55,482 - WARNING - app - Found stale cache entry for user live:31, will be refreshed on next access
2025-07-23 03:48:55,482 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 03:48:55,483 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 03:48:55,484 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 03:48:55,485 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 03:48:55,487 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 03:48:55,487 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 03:48:55,488 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 03:48:55,489 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 03:48:55,489 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 03:48:55,490 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 03:48:55,492 - WARNING - app - Found stale cache entry for user live:10, will be refreshed on next access
2025-07-23 03:48:55,493 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 03:48:55,493 - INFO - app - Completed stale cache cleanup task
2025-07-23 03:48:55,615 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 03:48:55,615 - INFO - app - [AUTO-CUTOFF] Processing 37 users for dynamic portfolio update...
2025-07-23 03:48:55,615 - INFO - app - [AUTO-CUTOFF] Processing user 4 (live), group: Group B
2025-07-23 03:48:55,654 - INFO - app - Validating cache for 37 users
2025-07-23 03:48:55,966 - INFO - app - Cache validation completed
2025-07-23 03:48:56,058 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 4...
2025-07-23 03:48:56,365 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 4: {'balance': '244.84000000', 'equity': '245.4213106398010320594506618', 'margin': '7.36843433', 'free_margin': '238.0528763098010320594506618', 'profit_loss': '0.5813106398010320594506617545', 'margin_level': '3330.711785549713002048980218', 'positions': [{'order_id': '1001790-001', 'order_company_name': 'CADCHF', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.58282500'), 'margin': Decimal('7.36585427'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 4, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'swap': 'None', 'created_at': '2025-07-23T08:14:34', 'profit_loss': '0.5813106398010320594506617545', 'current_price': '0.5833649999999999'}], 'margin_call': False}
2025-07-23 03:48:56,367 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 3330.711785549713002048980218
2025-07-23 03:48:56,369 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 4
2025-07-23 03:48:56,369 - INFO - app - [AUTO-CUTOFF] Processing user 5 (live), group: Admin
2025-07-23 03:48:56,462 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 03:48:56,462 - INFO - app - [AUTO-CUTOFF] Processing user 8 (live), group: string
2025-07-23 03:48:56,493 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:48:56,558 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 03:48:56,559 - INFO - app - [AUTO-CUTOFF] Processing user 9 (live), group: Standard
2025-07-23 03:48:56,688 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:56,689 - INFO - app - [AUTO-CUTOFF] Processing user 10 (live), group: Group B
2025-07-23 03:48:56,911 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:48:57,204 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:48:57,207 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:48:57,208 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:48:57,208 - INFO - app - [AUTO-CUTOFF] Processing user 11 (live), group: Group B
2025-07-23 03:48:57,413 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 11...
2025-07-23 03:48:57,550 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:48:57,608 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:48:57,615 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:48:57,639 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:48:57,643 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:48:57,647 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:48:57,682 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 03:48:57,713 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.18645119265485902168181395% which is below threshold 100.0%
2025-07-23 03:48:57,714 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 11: {'balance': '495.06000000', 'equity': '495.06000000', 'margin': '967.17', 'free_margin': '-472.11000000', 'profit_loss': '0.0', 'margin_level': '51.18645119265485902168181395', 'positions': [], 'margin_call': True}
2025-07-23 03:48:57,732 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.18645119265485902168181395
2025-07-23 03:48:57,736 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 11
2025-07-23 03:48:57,736 - INFO - app - [AUTO-CUTOFF] Processing user 12 (live), group: Standard
2025-07-23 03:48:57,857 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:57,857 - INFO - app - [AUTO-CUTOFF] Processing user 13 (live), group: Group B
2025-07-23 03:48:57,985 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:48:57,998 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:48:58,025 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:48:58,027 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:48:58,028 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:48:58,028 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:48:58,047 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:48:58,047 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:48:58,061 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:48:58,062 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:48:58,065 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:48:58,069 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:48:58,069 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:48:58,072 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:48:58,094 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:48:58,095 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:48:58,096 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:48:58,096 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:48:58,159 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 03:48:58,166 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 13...
2025-07-23 03:48:58,177 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 03:48:58,178 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 03:48:58,468 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 13: {'balance': '57.90000000', 'equity': '57.90000000', 'margin': '19.54', 'free_margin': '38.36000000', 'profit_loss': '0.0', 'margin_level': '296.3152507676560900716479017', 'positions': [], 'margin_call': False}
2025-07-23 03:48:58,473 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 03:48:58,475 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 13
2025-07-23 03:48:58,475 - INFO - app - [AUTO-CUTOFF] Processing user 14 (live), group: Standard
2025-07-23 03:48:58,552 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:58,552 - INFO - app - [AUTO-CUTOFF] Processing user 16 (live), group: Standard
2025-07-23 03:48:58,631 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:58,631 - INFO - app - [AUTO-CUTOFF] Processing user 17 (live), group: Group B
2025-07-23 03:48:58,707 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:58,707 - INFO - app - [AUTO-CUTOFF] Processing user 18 (live), group: Group B
2025-07-23 03:48:58,781 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:58,781 - INFO - app - [AUTO-CUTOFF] Processing user 19 (live), group: Elite
2025-07-23 03:48:58,860 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:58,860 - INFO - app - [AUTO-CUTOFF] Processing user 20 (live), group: Standard
2025-07-23 03:48:58,996 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 20...
2025-07-23 03:48:59,305 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 20: {'balance': '8712.00000000', 'equity': '8712.00000000', 'margin': '18.38', 'free_margin': '8693.62000000', 'profit_loss': '0.0', 'margin_level': '47399.34711643090315560391730', 'positions': [], 'margin_call': False}
2025-07-23 03:48:59,311 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 03:48:59,312 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 20
2025-07-23 03:48:59,313 - INFO - app - [AUTO-CUTOFF] Processing user 21 (live), group: Group B
2025-07-23 03:48:59,388 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:59,388 - INFO - app - [AUTO-CUTOFF] Processing user 22 (live), group: VIP
2025-07-23 03:48:59,512 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 22...
2025-07-23 03:48:59,801 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 22: {'balance': '5960.41000000', 'equity': '5960.41000000', 'margin': '26.25', 'free_margin': '5934.16000000', 'profit_loss': '0.0', 'margin_level': '22706.32380952380952380952381', 'positions': [], 'margin_call': False}
2025-07-23 03:48:59,807 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 03:48:59,810 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 22
2025-07-23 03:48:59,810 - INFO - app - [AUTO-CUTOFF] Processing user 23 (live), group: Group B
2025-07-23 03:48:59,901 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:48:59,901 - INFO - app - [AUTO-CUTOFF] Processing user 24 (live), group: Group B
2025-07-23 03:49:00,000 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:00,001 - INFO - app - [AUTO-CUTOFF] Processing user 25 (live), group: Group B
2025-07-23 03:49:00,115 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:00,115 - INFO - app - [AUTO-CUTOFF] Processing user 26 (live), group: Royal+
2025-07-23 03:49:00,209 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:00,209 - INFO - app - [AUTO-CUTOFF] Processing user 27 (live), group: Elite
2025-07-23 03:49:00,694 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 27...
2025-07-23 03:49:01,205 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 27: {'balance': '6672.64000000', 'equity': '6683.975329436588217202810573', 'margin': '19.55', 'free_margin': '6664.425329436588217202810573', 'profit_loss': '11.33532943658821720281057311', 'margin_level': '34189.13211988024663530849398', 'positions': [{'order_id': '1000549-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.34150000'), 'margin': Decimal('6.48460213'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T04:29:24', 'profit_loss': '1.176912466626219724541984472', 'current_price': '96.52850000000001'}, {'order_id': '1001271-001', 'order_company_name': 'AUDUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('0.65167500'), 'margin': Decimal('6.52000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:31:30', 'profit_loss': '7.370000000000100000000000000', 'current_price': '0.6591450000000001'}, {'order_id': '1001272-001', 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('96.10550000'), 'margin': Decimal('6.51498922'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 27, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-22T10:47:30', 'profit_loss': '2.788416969961897478268588636', 'current_price': '96.52850000000001'}], 'margin_call': False}
2025-07-23 03:49:01,206 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34189.13211988024663530849398
2025-07-23 03:49:01,207 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 27
2025-07-23 03:49:01,207 - INFO - app - [AUTO-CUTOFF] Processing user 28 (live), group: Classic
2025-07-23 03:49:01,363 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 28...
2025-07-23 03:49:01,663 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:49:01,665 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 03:49:01,666 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 92.01907780314707506656006067% which is below threshold 100.0%
2025-07-23 03:49:01,666 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 28: {'balance': '10023.20000000', 'equity': '8930.930000000000000000000000', 'margin': '9705.52', 'free_margin': '-774.590000000000000000000000', 'profit_loss': '-1092.270000000000000000000000', 'margin_level': '92.01907780314707506656006067', 'positions': [{'order_id': '1000595-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25638500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:22', 'profit_loss': '0.0', 'current_price': '4.255224999999999'}, {'order_id': '1000597-001', 'order_company_name': 'EURPLN', 'order_type': 'BUY', 'order_quantity': Decimal('0.01000000'), 'order_price': Decimal('4.25646500'), 'margin': Decimal('42.57000000'), 'contract_value': Decimal('1000.00000000'), 'stop_loss': None, 'take_profit': None, 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('0.10000000'), 'created_at': '2025-07-17T12:25:30', 'profit_loss': '0.0', 'current_price': '4.255224999999999'}, {'order_id': '1000812-006', 'order_company_name': 'BTCUSD', 'order_type': 'BUY', 'order_quantity': Decimal('0.40000000'), 'order_price': Decimal('120410.80000000'), 'margin': Decimal('9620.38000000'), 'contract_value': Decimal('0.40000000'), 'stop_loss': Decimal('100410.80000000'), 'take_profit': Decimal('140410.80000000'), 'order_user_id': 28, 'order_status': 'OPEN', 'commission': Decimal('240.51000000'), 'created_at': '2025-07-18T06:41:56', 'profit_loss': '-1092.270000000000000000000000', 'current_price': '118281.4'}], 'margin_call': True}
2025-07-23 03:49:01,671 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 92.01907780314707506656006067
2025-07-23 03:49:01,672 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 28
2025-07-23 03:49:01,672 - INFO - app - [AUTO-CUTOFF] Processing user 29 (live), group: Standard
2025-07-23 03:49:01,769 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:01,770 - INFO - app - [AUTO-CUTOFF] Processing user 30 (live), group: Classic
2025-07-23 03:49:01,862 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:01,862 - INFO - app - [AUTO-CUTOFF] Processing user 31 (live), group: Standard
2025-07-23 03:49:01,962 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:01,963 - INFO - app - [AUTO-CUTOFF] Processing user 1 (demo), group: Group B
2025-07-23 03:49:02,056 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:02,056 - INFO - app - [AUTO-CUTOFF] Processing user 2 (demo), group: 
2025-07-23 03:49:02,059 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 03:49:02,059 - INFO - app - [AUTO-CUTOFF] Processing user 3 (demo), group: string
2025-07-23 03:49:02,080 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 03:49:02,110 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 03:49:02,110 - INFO - app - [AUTO-CUTOFF] Processing user 4 (demo), group: Group B
2025-07-23 03:49:02,220 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:02,220 - INFO - app - [AUTO-CUTOFF] Processing user 5 (demo), group: None
2025-07-23 03:49:02,222 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 03:49:02,222 - INFO - app - [AUTO-CUTOFF] Processing user 6 (demo), group: None
2025-07-23 03:49:02,223 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 03:49:02,224 - INFO - app - [AUTO-CUTOFF] Processing user 9 (demo), group: Group B
2025-07-23 03:49:02,388 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 9...
2025-07-23 03:49:02,388 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 03:49:02,797 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 9: {'balance': '5.75000000', 'equity': '5.75000000', 'margin': '0.0', 'free_margin': '5.75000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:49:02,801 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 03:49:02,801 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 9
2025-07-23 03:49:02,801 - INFO - app - [AUTO-CUTOFF] Processing user 10 (demo), group: Group B
2025-07-23 03:49:02,977 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 10...
2025-07-23 03:49:02,978 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 03:49:03,288 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 10: {'balance': '9677.71000000', 'equity': '9677.71000000', 'margin': '6.59', 'free_margin': '9671.12000000', 'profit_loss': '0.0', 'margin_level': '146854.4764795144157814871017', 'positions': [], 'margin_call': False}
2025-07-23 03:49:03,294 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146854.4764795144157814871017
2025-07-23 03:49:03,296 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 10
2025-07-23 03:49:03,296 - INFO - app - [AUTO-CUTOFF] Processing user 11 (demo), group: Group B
2025-07-23 03:49:03,387 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:03,387 - INFO - app - [AUTO-CUTOFF] Processing user 12 (demo), group: Group B
2025-07-23 03:49:03,495 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:03,496 - INFO - app - [AUTO-CUTOFF] Processing user 13 (demo), group: Group B
2025-07-23 03:49:03,572 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 03:49:03,572 - INFO - app - [AUTO-CUTOFF] Processing user 14 (demo), group: Group B
2025-07-23 03:49:03,709 - INFO - app - [AUTO-CUTOFF] Calculating portfolio metrics for user 14...
2025-07-23 03:49:03,709 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 03:49:03,999 - INFO - app - [AUTO-CUTOFF] Portfolio metrics for user 14: {'balance': '10000.00000000', 'equity': '10000.00000000', 'margin': '0.0', 'free_margin': '10000.00000000', 'profit_loss': '0.0', 'margin_level': '0.0', 'positions': [], 'margin_call': False}
2025-07-23 03:49:04,003 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 03:49:04,003 - INFO - app - [AUTO-CUTOFF] Portfolio update completed for user 14
2025-07-23 03:49:04,427 - INFO - app - Application shutdown initiated
2025-07-23 03:49:04,428 - INFO - app - Scheduler shutdown completed
2025-07-23 03:49:04,430 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 03:49:05,039 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 03:49:05,039 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 03:49:05,042 - INFO - app - Redis connection closed
2025-07-23 03:49:05,042 - INFO - app - Application shutdown completed
