2025-07-15 21:33:34,756 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-15 21:33:35,956 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-15 21:33:35,957 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-15 21:33:35,957 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-15 21:33:35,957 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-15 21:33:40,021 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-15 21:33:40,021 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-15 21:33:40,968 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-15 21:33:45,961 - INFO - orders - Starting the users with orders cache updater task.
2025-07-15 21:33:56,936 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol XAGUSD
2025-07-15 21:33:56,936 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-15 21:33:56,936 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: AllMarginsPerLot=[Decimal('1954')], HighestMarginPerLot=1954
2025-07-15 21:33:56,936 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol XAGUSD: CalculatedTotalMargin=19.54
2025-07-15 21:33:56,936 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol BTCUSD
2025-07-15 21:33:56,936 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: TotalBuyQty=6.00000000, TotalSellQty=0, NetQty=6.00000000, IsHedged=False
2025-07-15 21:33:56,936 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: AllMarginsPerLot=[Decimal('24410.82166666666666666666667')], HighestMarginPerLot=24410.82166666666666666666667
2025-07-15 21:33:56,936 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol BTCUSD: CalculatedTotalMargin=146464.93
2025-07-15 21:33:56,936 - INFO - orders - [TOTAL_USER_MARGIN] User 26 total margin across all symbols: 146484.47
2025-07-15 21:33:56,964 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-15 21:33:56,964 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-15 21:33:56,964 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.341805'), Decimal('654.258453')], HighestMarginPerLot=654.341805
2025-07-15 21:33:56,964 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.54
2025-07-15 21:33:56,964 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.54
2025-07-15 21:35:19,420 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-15 21:35:20,481 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-15 21:35:20,482 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-15 21:35:20,491 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-15 21:35:20,491 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-15 21:35:24,595 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-15 21:35:24,595 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-15 21:35:25,496 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-15 21:35:30,485 - INFO - orders - Starting the users with orders cache updater task.
2025-07-15 21:35:43,382 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:35:43,382 - INFO - orders - Using order model: UserOrder
2025-07-15 21:35:43,385 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:35:43,387 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 21:35:43,388 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 21:35:43,391 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:35:43,741 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:35:43,741 - INFO - orders - Using order model: UserOrder
2025-07-15 21:35:43,746 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:35:43,753 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 21:35:43,754 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 21:35:43,764 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:36:20,199 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 21:36:20,224 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 21:36:20,227 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'account_number': 'DB7JG', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0E-8'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 21:36:20,227 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 21:36:20,229 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 21:36:20,232 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 21:36:20,563 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117589.8000000000', 'o': '117589.7000000000'}
2025-07-15 21:36:20,564 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117589.8000000000, ask=117601.55898000000000
2025-07-15 21:36:20,564 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117589.8000000000, ask=117601.55898000000000
2025-07-15 21:36:20,564 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117601.55898000000000, Margin: 23520.31, Commission: 588.01
2025-07-15 21:36:20,565 - INFO - orders - Calculated initial margin: 23520.31, commission: 588.01 for pending order 1000293-001
2025-07-15 21:36:20,593 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000293-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('103'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000294-005', 'takeprofit_id': '1000295-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23520.31'), 'commission': Decimal('588.01'), 'open_time': None}
2025-07-15 21:36:20,593 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 21:36:20,593 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 103
2025-07-15 21:36:20,593 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000293-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('103'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23520.31'), 'commission': Decimal('588.01'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000294-005', 'takeprofit_id': '1000295-006', 'close_id': None}
2025-07-15 21:36:20,613 - INFO - orders - Order 1000293-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 21:36:20,614 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000293-001
2025-07-15 21:36:20,633 - INFO - orders - [PERF] TOTAL place_order: 0.4356s
2025-07-15 21:36:20,671 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:36:20,678 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 21:36:42,916 - INFO - orders - Service provider update request received: {"order_id":"1000293-001","order_status":"PENDING","status":"PENDING"}
2025-07-15 21:36:42,930 - INFO - orders - Original order status: PENDING_PROCESSING
2025-07-15 21:36:42,930 - INFO - orders - Update fields: {'order_id': '1000293-001', 'order_status': 'PENDING', 'status': 'PENDING'}
2025-07-15 21:36:42,931 - INFO - orders - Processing regular update for order 1000293-001
2025-07-15 21:36:42,960 - INFO - orders - Balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:36:42,960 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:36:42,960 - INFO - orders - Using order model: UserOrder
2025-07-15 21:36:42,963 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:36:42,965 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 21:36:42,966 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 21:36:42,972 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:36:44,248 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:36:44,248 - INFO - orders - Using order model: UserOrder
2025-07-15 21:36:44,254 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:36:44,256 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 21:36:44,258 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 21:36:44,278 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:37:17,186 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 21:37:17,233 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 21:37:17,234 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'user_type': 'live', 'account_number': 'DB7JG', 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0.0'), 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 21:37:17,235 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 21:37:17,236 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 21:37:17,239 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 21:37:17,601 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117609.7000000000', 'o': '117609.6000000000'}
2025-07-15 21:37:17,602 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117609.7000000000, ask=117621.46097000000000
2025-07-15 21:37:17,602 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117609.7000000000, ask=117621.46097000000000
2025-07-15 21:37:17,602 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117621.46097000000000, Margin: 23524.29, Commission: 588.11
2025-07-15 21:37:17,602 - INFO - orders - Calculated initial margin: 23524.29, commission: 588.11 for pending order 1000297-001
2025-07-15 21:37:17,625 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000297-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('105'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000298-005', 'takeprofit_id': '1000299-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23524.29'), 'commission': Decimal('588.11'), 'open_time': None}
2025-07-15 21:37:17,625 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 21:37:17,625 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 105
2025-07-15 21:37:17,625 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000297-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('105'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23524.29'), 'commission': Decimal('588.11'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000298-005', 'takeprofit_id': '1000299-006', 'close_id': None}
2025-07-15 21:37:17,651 - INFO - orders - Order 1000297-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 21:37:17,653 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000297-001
2025-07-15 21:37:17,673 - INFO - orders - [PERF] TOTAL place_order: 0.4876s
2025-07-15 21:37:17,745 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:37:17,760 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 21:37:29,553 - INFO - orders - Service provider update request received: {"order_id":"1000297-001","order_status":"PENDING","status":"PENDING"}
2025-07-15 21:37:29,563 - INFO - orders - Original order status: PENDING_PROCESSING
2025-07-15 21:37:29,563 - INFO - orders - Update fields: {'order_id': '1000297-001', 'order_status': 'PENDING', 'status': 'PENDING'}
2025-07-15 21:37:29,563 - INFO - orders - Processing regular update for order 1000297-001
2025-07-15 21:37:29,590 - INFO - orders - Balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:37:29,591 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:37:29,591 - INFO - orders - Using order model: UserOrder
2025-07-15 21:37:29,594 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:37:29,597 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 21:37:29,598 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 21:37:29,604 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:40:42,194 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol XAGUSD
2025-07-15 21:40:42,194 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-15 21:40:42,194 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: AllMarginsPerLot=[Decimal('1954')], HighestMarginPerLot=1954
2025-07-15 21:40:42,195 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol XAGUSD: CalculatedTotalMargin=19.54
2025-07-15 21:40:42,195 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol BTCUSD
2025-07-15 21:40:42,195 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: TotalBuyQty=6.00000000, TotalSellQty=0, NetQty=6.00000000, IsHedged=False
2025-07-15 21:40:42,195 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: AllMarginsPerLot=[Decimal('24410.82166666666666666666667')], HighestMarginPerLot=24410.82166666666666666666667
2025-07-15 21:40:42,195 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol BTCUSD: CalculatedTotalMargin=146464.93
2025-07-15 21:40:42,195 - INFO - orders - [TOTAL_USER_MARGIN] User 26 total margin across all symbols: 146484.47
2025-07-15 21:40:42,201 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-15 21:40:42,201 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-15 21:40:42,201 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.341805'), Decimal('654.258453')], HighestMarginPerLot=654.341805
2025-07-15 21:40:42,201 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.54
2025-07-15 21:40:42,201 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.54
2025-07-15 21:46:10,624 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-15 21:46:11,857 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-15 21:46:11,857 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-15 21:46:11,858 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-15 21:46:11,858 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-15 21:46:15,935 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-15 21:46:15,935 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-15 21:46:17,028 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-15 21:46:21,862 - INFO - orders - Starting the users with orders cache updater task.
2025-07-15 21:46:36,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol XAGUSD
2025-07-15 21:46:36,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-15 21:46:36,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: AllMarginsPerLot=[Decimal('1954')], HighestMarginPerLot=1954
2025-07-15 21:46:36,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol XAGUSD: CalculatedTotalMargin=19.54
2025-07-15 21:46:36,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol BTCUSD
2025-07-15 21:46:36,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: TotalBuyQty=6.00000000, TotalSellQty=0, NetQty=6.00000000, IsHedged=False
2025-07-15 21:46:36,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: AllMarginsPerLot=[Decimal('24410.82166666666666666666667')], HighestMarginPerLot=24410.82166666666666666666667
2025-07-15 21:46:36,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol BTCUSD: CalculatedTotalMargin=146464.93
2025-07-15 21:46:36,132 - INFO - orders - [TOTAL_USER_MARGIN] User 26 total margin across all symbols: 146484.47
2025-07-15 21:46:36,219 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-15 21:46:36,219 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-15 21:46:36,219 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.341805'), Decimal('654.258453')], HighestMarginPerLot=654.341805
2025-07-15 21:46:36,219 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.54
2025-07-15 21:46:36,220 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.54
2025-07-15 21:46:37,178 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:46:37,178 - INFO - orders - Using order model: UserOrder
2025-07-15 21:46:37,180 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:46:37,182 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 21:46:37,183 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 21:46:37,188 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:47:13,303 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 21:47:13,358 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 21:47:13,360 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'user_type': 'live', 'account_number': 'DB7JG', 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0.0'), 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 21:47:13,360 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 21:47:13,362 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 21:47:13,367 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 21:47:13,786 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117637.3000000000', 'o': '117637.2000000000'}
2025-07-15 21:47:13,786 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117637.3000000000, ask=117649.06373000000000
2025-07-15 21:47:13,786 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117637.3000000000, ask=117649.06373000000000
2025-07-15 21:47:13,786 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117649.06373000000000, Margin: 23529.81, Commission: 588.25
2025-07-15 21:47:13,786 - INFO - orders - Calculated initial margin: 23529.81, commission: 588.25 for pending order 1000301-001
2025-07-15 21:47:13,841 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000301-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('109'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000302-005', 'takeprofit_id': '1000303-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23529.81'), 'commission': Decimal('588.25'), 'open_time': None}
2025-07-15 21:47:13,841 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 21:47:13,841 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 109
2025-07-15 21:47:13,841 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000301-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('109'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23529.81'), 'commission': Decimal('588.25'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000302-005', 'takeprofit_id': '1000303-006', 'close_id': None}
2025-07-15 21:47:13,862 - INFO - orders - Order 1000301-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 21:47:13,863 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000301-001
2025-07-15 21:47:13,877 - INFO - orders - [PERF] TOTAL place_order: 0.5743s
2025-07-15 21:47:13,907 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:47:13,921 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 21:47:53,114 - INFO - orders - Service provider update request received: {"order_id":"1000301-001","order_status":"PENDING","status":"PENDING"}
2025-07-15 21:47:53,130 - INFO - orders - Original order status: PENDING_PROCESSING
2025-07-15 21:47:53,130 - INFO - orders - Update fields: {'order_id': '1000301-001', 'order_status': 'PENDING', 'status': 'PENDING'}
2025-07-15 21:47:53,130 - INFO - orders - Processing regular update for order 1000301-001
2025-07-15 21:47:53,168 - INFO - orders - Balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:47:53,168 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:47:53,168 - INFO - orders - Using order model: UserOrder
2025-07-15 21:47:53,171 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:47:53,174 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 21:47:53,176 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 21:47:53,183 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:51:36,603 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol XAGUSD
2025-07-15 21:51:36,603 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-15 21:51:36,603 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: AllMarginsPerLot=[Decimal('1954')], HighestMarginPerLot=1954
2025-07-15 21:51:36,603 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol XAGUSD: CalculatedTotalMargin=19.54
2025-07-15 21:51:36,603 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol BTCUSD
2025-07-15 21:51:36,603 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: TotalBuyQty=6.00000000, TotalSellQty=0, NetQty=6.00000000, IsHedged=False
2025-07-15 21:51:36,603 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: AllMarginsPerLot=[Decimal('24410.82166666666666666666667')], HighestMarginPerLot=24410.82166666666666666666667
2025-07-15 21:51:36,603 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol BTCUSD: CalculatedTotalMargin=146464.93
2025-07-15 21:51:36,603 - INFO - orders - [TOTAL_USER_MARGIN] User 26 total margin across all symbols: 146484.47
2025-07-15 21:51:36,608 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-15 21:51:36,608 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-15 21:51:36,608 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.341805'), Decimal('654.258453')], HighestMarginPerLot=654.341805
2025-07-15 21:51:36,608 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.54
2025-07-15 21:51:36,608 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.54
2025-07-15 21:55:51,321 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-15 21:55:52,513 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-15 21:55:52,514 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-15 21:55:52,514 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-15 21:55:52,515 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-15 21:55:56,577 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-15 21:55:56,577 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-15 21:55:57,503 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-15 21:56:02,505 - INFO - orders - Starting the users with orders cache updater task.
2025-07-15 21:56:05,543 - INFO - orders - Starting update_user_static_orders for user 5, user_type live
2025-07-15 21:56:05,543 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:05,545 - INFO - orders - Fetched 0 open orders for user 5
2025-07-15 21:56:05,549 - INFO - orders - Fetched 0 pending orders for user 5
2025-07-15 21:56:05,568 - INFO - orders - Updated static orders cache for user 5 with 0 open orders and 0 pending orders
2025-07-15 21:56:05,586 - WARNING - orders - User 5: Could not get user data for balance/margin cache update
2025-07-15 21:56:05,598 - INFO - orders - Starting update_user_static_orders for user 8, user_type live
2025-07-15 21:56:05,598 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:05,604 - INFO - orders - Fetched 0 open orders for user 8
2025-07-15 21:56:05,607 - INFO - orders - Fetched 0 pending orders for user 8
2025-07-15 21:56:07,646 - INFO - orders - Updated static orders cache for user 8 with 0 open orders and 0 pending orders
2025-07-15 21:56:07,703 - INFO - orders - User 8: Updated balance/margin cache after static orders update - balance=0E-8, margin=0.0
2025-07-15 21:56:09,820 - INFO - orders - Starting update_user_static_orders for user 16, user_type live
2025-07-15 21:56:09,820 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:09,825 - INFO - orders - Fetched 0 open orders for user 16
2025-07-15 21:56:09,827 - INFO - orders - Fetched 0 pending orders for user 16
2025-07-15 21:56:09,829 - INFO - orders - Updated static orders cache for user 16 with 0 open orders and 0 pending orders
2025-07-15 21:56:11,888 - INFO - orders - User 16: Updated balance/margin cache after static orders update - balance=0E-8, margin=0.0
2025-07-15 21:56:11,896 - INFO - orders - Starting update_user_static_orders for user 17, user_type live
2025-07-15 21:56:11,896 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:11,898 - INFO - orders - Fetched 0 open orders for user 17
2025-07-15 21:56:11,901 - INFO - orders - Fetched 0 pending orders for user 17
2025-07-15 21:56:11,903 - INFO - orders - Updated static orders cache for user 17 with 0 open orders and 0 pending orders
2025-07-15 21:56:11,913 - INFO - orders - User 17: Updated balance/margin cache after static orders update - balance=26302.98000000, margin=0.0
2025-07-15 21:56:11,916 - INFO - orders - Starting update_user_static_orders for user 18, user_type live
2025-07-15 21:56:11,916 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:11,918 - INFO - orders - Fetched 0 open orders for user 18
2025-07-15 21:56:11,921 - INFO - orders - Fetched 0 pending orders for user 18
2025-07-15 21:56:13,952 - INFO - orders - Updated static orders cache for user 18 with 0 open orders and 0 pending orders
2025-07-15 21:56:13,981 - INFO - orders - User 18: Updated balance/margin cache after static orders update - balance=15000.00000000, margin=0.0
2025-07-15 21:56:13,992 - INFO - orders - Starting update_user_static_orders for user 19, user_type live
2025-07-15 21:56:13,993 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:13,996 - INFO - orders - Fetched 0 open orders for user 19
2025-07-15 21:56:14,000 - INFO - orders - Fetched 0 pending orders for user 19
2025-07-15 21:56:14,003 - INFO - orders - Updated static orders cache for user 19 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,054 - INFO - orders - User 19: Updated balance/margin cache after static orders update - balance=9616.06000000, margin=0.0
2025-07-15 21:56:16,064 - INFO - orders - Starting update_user_static_orders for user 20, user_type live
2025-07-15 21:56:16,064 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:16,066 - INFO - orders - Fetched 0 open orders for user 20
2025-07-15 21:56:16,068 - INFO - orders - Fetched 0 pending orders for user 20
2025-07-15 21:56:16,070 - INFO - orders - Updated static orders cache for user 20 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,080 - INFO - orders - User 20: Updated balance/margin cache after static orders update - balance=10000.00000000, margin=0.0
2025-07-15 21:56:16,092 - INFO - orders - Starting update_user_static_orders for user 21, user_type live
2025-07-15 21:56:16,092 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:16,097 - INFO - orders - Fetched 0 open orders for user 21
2025-07-15 21:56:16,100 - INFO - orders - Fetched 0 pending orders for user 21
2025-07-15 21:56:16,102 - INFO - orders - Updated static orders cache for user 21 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,118 - INFO - orders - User 21: Updated balance/margin cache after static orders update - balance=0E-8, margin=0.0
2025-07-15 21:56:16,122 - INFO - orders - Starting update_user_static_orders for user 22, user_type live
2025-07-15 21:56:16,122 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:16,125 - INFO - orders - Fetched 0 open orders for user 22
2025-07-15 21:56:16,129 - INFO - orders - Fetched 0 pending orders for user 22
2025-07-15 21:56:16,131 - INFO - orders - Updated static orders cache for user 22 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,146 - INFO - orders - User 22: Updated balance/margin cache after static orders update - balance=2000.00000000, margin=0.0
2025-07-15 21:56:16,148 - INFO - orders - Starting update_user_static_orders for user 23, user_type live
2025-07-15 21:56:16,148 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:16,152 - INFO - orders - Fetched 0 open orders for user 23
2025-07-15 21:56:16,156 - INFO - orders - Fetched 0 pending orders for user 23
2025-07-15 21:56:16,158 - INFO - orders - Updated static orders cache for user 23 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,167 - INFO - orders - User 23: Updated balance/margin cache after static orders update - balance=1000000.00000000, margin=0.0
2025-07-15 21:56:16,170 - INFO - orders - Starting update_user_static_orders for user 24, user_type live
2025-07-15 21:56:16,170 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:16,172 - INFO - orders - Fetched 0 open orders for user 24
2025-07-15 21:56:16,175 - INFO - orders - Fetched 0 pending orders for user 24
2025-07-15 21:56:16,178 - INFO - orders - Updated static orders cache for user 24 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,191 - INFO - orders - User 24: Updated balance/margin cache after static orders update - balance=500000.00000000, margin=0.0
2025-07-15 21:56:16,195 - INFO - orders - Starting update_user_static_orders for user 25, user_type live
2025-07-15 21:56:16,195 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:16,198 - INFO - orders - Fetched 0 open orders for user 25
2025-07-15 21:56:16,202 - INFO - orders - Fetched 0 pending orders for user 25
2025-07-15 21:56:16,205 - INFO - orders - Updated static orders cache for user 25 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,215 - INFO - orders - User 25: Updated balance/margin cache after static orders update - balance=250000.00000000, margin=0.0
2025-07-15 21:56:16,261 - INFO - orders - Starting update_user_static_orders for user 2, user_type demo
2025-07-15 21:56:16,262 - INFO - orders - Using order model: DemoUserOrder
2025-07-15 21:56:16,267 - INFO - orders - Fetched 0 open orders for user 2
2025-07-15 21:56:16,272 - INFO - orders - Fetched 0 pending orders for user 2
2025-07-15 21:56:16,277 - INFO - orders - Updated static orders cache for user 2 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,294 - INFO - orders - User 2: Updated balance/margin cache after static orders update - balance=100000.00000000, margin=0.0
2025-07-15 21:56:16,297 - INFO - orders - Starting update_user_static_orders for user 3, user_type demo
2025-07-15 21:56:16,297 - INFO - orders - Using order model: DemoUserOrder
2025-07-15 21:56:16,300 - INFO - orders - Fetched 0 open orders for user 3
2025-07-15 21:56:16,304 - INFO - orders - Fetched 0 pending orders for user 3
2025-07-15 21:56:16,308 - INFO - orders - Updated static orders cache for user 3 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,326 - INFO - orders - User 3: Updated balance/margin cache after static orders update - balance=100000.00000000, margin=0.0
2025-07-15 21:56:16,355 - INFO - orders - Starting update_user_static_orders for user 6, user_type demo
2025-07-15 21:56:16,355 - INFO - orders - Using order model: DemoUserOrder
2025-07-15 21:56:16,360 - INFO - orders - Fetched 0 open orders for user 6
2025-07-15 21:56:16,365 - INFO - orders - Fetched 0 pending orders for user 6
2025-07-15 21:56:16,369 - INFO - orders - Updated static orders cache for user 6 with 0 open orders and 0 pending orders
2025-07-15 21:56:16,387 - INFO - orders - User 6: Updated balance/margin cache after static orders update - balance=100000.00000000, margin=0.0
2025-07-15 21:56:17,415 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:56:17,415 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:17,417 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:56:17,419 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 21:56:17,420 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 21:56:17,424 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:56:28,642 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 21:56:28,670 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 21:56:28,671 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'user_type': 'live', 'account_number': 'DB7JG', 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0.0'), 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 21:56:28,672 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 21:56:28,672 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 21:56:28,675 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 21:56:28,989 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117586.9000000000', 'o': '117586.8000000000'}
2025-07-15 21:56:28,989 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117586.9000000000, ask=117598.65869000000000
2025-07-15 21:56:28,989 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117586.9000000000, ask=117598.65869000000000
2025-07-15 21:56:28,989 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117598.65869000000000, Margin: 23519.73, Commission: 587.99
2025-07-15 21:56:28,989 - INFO - orders - Calculated initial margin: 23519.73, commission: 587.99 for pending order 1000305-001
2025-07-15 21:56:29,009 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000305-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('111'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000306-005', 'takeprofit_id': '1000307-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23519.73'), 'commission': Decimal('587.99'), 'open_time': None}
2025-07-15 21:56:29,010 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 21:56:29,010 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 111
2025-07-15 21:56:29,010 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000305-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('111'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23519.73'), 'commission': Decimal('587.99'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000306-005', 'takeprofit_id': '1000307-006', 'close_id': None}
2025-07-15 21:56:29,034 - INFO - orders - Order 1000305-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 21:56:29,035 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000305-001
2025-07-15 21:56:29,051 - INFO - orders - [PERF] TOTAL place_order: 0.4106s
2025-07-15 21:56:29,088 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:56:29,101 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 21:56:43,870 - INFO - orders - Service provider update request received: {"order_id":"1000305-001","order_status":"PENDING","status":"PENDING"}
2025-07-15 21:56:43,912 - INFO - orders - Original order status: PENDING_PROCESSING
2025-07-15 21:56:43,912 - INFO - orders - Update fields: {'order_id': '1000305-001', 'order_status': 'PENDING', 'status': 'PENDING'}
2025-07-15 21:56:43,912 - INFO - orders - Processing regular update for order 1000305-001
2025-07-15 21:56:43,974 - INFO - orders - Balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:56:43,974 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:56:43,974 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:43,977 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:56:43,980 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 21:56:43,982 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 21:56:43,988 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:56:45,166 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:56:45,166 - INFO - orders - Using order model: UserOrder
2025-07-15 21:56:45,170 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:56:45,174 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 21:56:45,177 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 21:56:45,183 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:56:52,239 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 21:56:52,259 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 21:56:52,260 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'user_type': 'live', 'account_number': 'DB7JG', 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0.0'), 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 21:56:52,260 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 21:56:52,262 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 21:56:52,265 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 21:56:52,640 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117556.8000000000', 'o': '117556.7000000000'}
2025-07-15 21:56:52,640 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117556.8000000000, ask=117568.55568000000000
2025-07-15 21:56:52,640 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117556.8000000000, ask=117568.55568000000000
2025-07-15 21:56:52,641 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117568.55568000000000, Margin: 23513.71, Commission: 587.84
2025-07-15 21:56:52,641 - INFO - orders - Calculated initial margin: 23513.71, commission: 587.84 for pending order 1000309-001
2025-07-15 21:56:52,690 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000309-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('133'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000310-005', 'takeprofit_id': '1000311-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23513.71'), 'commission': Decimal('587.84'), 'open_time': None}
2025-07-15 21:56:52,690 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 21:56:52,690 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 133
2025-07-15 21:56:52,690 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000309-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('133'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23513.71'), 'commission': Decimal('587.84'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000310-005', 'takeprofit_id': '1000311-006', 'close_id': None}
2025-07-15 21:56:53,084 - INFO - orders - Order 1000309-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 21:56:53,112 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000309-001
2025-07-15 21:56:53,168 - INFO - orders - [PERF] TOTAL place_order: 0.9294s
2025-07-15 21:56:53,244 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:56:53,268 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 21:57:07,933 - INFO - orders - Service provider update request received: {"order_id":"1000309-0011","order_status":"PENDING","status":"PENDING"}
2025-07-15 21:57:07,933 - ERROR - orders - Order not found with provided identifier '1000309-0011' in request: {"order_id":"1000309-0011","order_status":"PENDING","status":"PENDING"}
2025-07-15 21:57:07,933 - ERROR - orders - Error in service provider update endpoint: 404: Order not found with provided ID
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 2901, in update_order_by_service_provider
    raise HTTPException(status_code=404, detail="Order not found with provided ID")
fastapi.exceptions.HTTPException: 404: Order not found with provided ID
2025-07-15 21:57:23,743 - INFO - orders - Service provider update request received: {"order_id":"1000309-001","order_status":"PENDING","status":"PENDING"}
2025-07-15 21:57:23,750 - INFO - orders - Original order status: PENDING_PROCESSING
2025-07-15 21:57:23,750 - INFO - orders - Update fields: {'order_id': '1000309-001', 'order_status': 'PENDING', 'status': 'PENDING'}
2025-07-15 21:57:23,750 - INFO - orders - Processing regular update for order 1000309-001
2025-07-15 21:57:23,812 - INFO - orders - Balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:57:23,812 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:57:23,813 - INFO - orders - Using order model: UserOrder
2025-07-15 21:57:23,817 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:57:23,820 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 21:57:23,821 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 21:57:23,828 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:57:24,487 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:57:24,487 - INFO - orders - Using order model: UserOrder
2025-07-15 21:57:24,491 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:57:24,494 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 21:57:24,495 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 21:57:24,501 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:57:31,754 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 21:57:31,817 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 21:57:31,818 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'user_type': 'live', 'account_number': 'DB7JG', 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0.0'), 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 21:57:31,819 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 21:57:31,820 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 21:57:31,826 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 21:57:32,166 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117586.9000000000', 'o': '117586.8000000000'}
2025-07-15 21:57:32,166 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117586.9000000000, ask=117598.65869000000000
2025-07-15 21:57:32,166 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117586.9000000000, ask=117598.65869000000000
2025-07-15 21:57:32,166 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117598.65869000000000, Margin: 23519.73, Commission: 587.99
2025-07-15 21:57:32,166 - INFO - orders - Calculated initial margin: 23519.73, commission: 587.99 for pending order 1000313-001
2025-07-15 21:57:32,184 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000313-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('125'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000314-005', 'takeprofit_id': '1000315-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23519.73'), 'commission': Decimal('587.99'), 'open_time': None}
2025-07-15 21:57:32,184 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 21:57:32,184 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 125
2025-07-15 21:57:32,184 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000313-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('125'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23519.73'), 'commission': Decimal('587.99'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000314-005', 'takeprofit_id': '1000315-006', 'close_id': None}
2025-07-15 21:57:32,203 - INFO - orders - Order 1000313-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 21:57:32,205 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000313-001
2025-07-15 21:57:32,220 - INFO - orders - [PERF] TOTAL place_order: 0.4677s
2025-07-15 21:57:32,273 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:57:32,281 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 21:57:39,459 - INFO - orders - Service provider update request received: {"order_id":"1000313-001","order_status":"PENDING","status":"PENDING"}
2025-07-15 21:57:39,466 - INFO - orders - Original order status: PENDING_PROCESSING
2025-07-15 21:57:39,466 - INFO - orders - Update fields: {'order_id': '1000313-001', 'order_status': 'PENDING', 'status': 'PENDING'}
2025-07-15 21:57:39,466 - INFO - orders - Processing regular update for order 1000313-001
2025-07-15 21:57:39,525 - INFO - orders - Balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 21:57:39,525 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:57:39,525 - INFO - orders - Using order model: UserOrder
2025-07-15 21:57:39,529 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:57:39,532 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 21:57:39,533 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 21:57:39,558 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 21:57:40,102 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 21:57:40,103 - INFO - orders - Using order model: UserOrder
2025-07-15 21:57:40,108 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 21:57:40,111 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 21:57:40,112 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 21:57:40,119 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 22:02:54,041 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-15 22:02:55,261 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-15 22:02:55,262 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-15 22:02:55,262 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-15 22:02:55,262 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-15 22:02:59,349 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-15 22:02:59,349 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-15 22:03:00,274 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-15 22:03:05,273 - INFO - orders - Starting the users with orders cache updater task.
2025-07-15 22:03:19,694 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol XAGUSD
2025-07-15 22:03:19,694 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-15 22:03:19,694 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: AllMarginsPerLot=[Decimal('1954')], HighestMarginPerLot=1954
2025-07-15 22:03:19,694 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol XAGUSD: CalculatedTotalMargin=19.54
2025-07-15 22:03:19,694 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol BTCUSD
2025-07-15 22:03:19,694 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: TotalBuyQty=6.00000000, TotalSellQty=0, NetQty=6.00000000, IsHedged=False
2025-07-15 22:03:19,694 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: AllMarginsPerLot=[Decimal('24410.82166666666666666666667')], HighestMarginPerLot=24410.82166666666666666666667
2025-07-15 22:03:19,695 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol BTCUSD: CalculatedTotalMargin=146464.93
2025-07-15 22:03:19,695 - INFO - orders - [TOTAL_USER_MARGIN] User 26 total margin across all symbols: 146484.47
2025-07-15 22:03:19,737 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-15 22:03:19,737 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-15 22:03:19,737 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.341805'), Decimal('654.258453')], HighestMarginPerLot=654.341805
2025-07-15 22:03:19,738 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.54
2025-07-15 22:03:19,738 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.54
2025-07-15 22:03:24,252 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 22:03:24,321 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 22:03:24,323 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'account_number': 'DB7JG', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0E-8'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 22:03:24,324 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 22:03:24,326 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 22:03:24,331 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 22:03:24,682 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117647.3000000000', 'o': '117647.2000000000'}
2025-07-15 22:03:24,683 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117647.3000000000, ask=117659.06473000000000
2025-07-15 22:03:24,683 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117647.3000000000, ask=117659.06473000000000
2025-07-15 22:03:24,683 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117659.06473000000000, Margin: 23531.81, Commission: 588.30
2025-07-15 22:03:24,684 - INFO - orders - Calculated initial margin: 23531.81, commission: 588.30 for pending order 1000317-001
2025-07-15 22:03:24,751 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000317-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('111'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000318-005', 'takeprofit_id': '1000319-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23531.81'), 'commission': Decimal('588.30'), 'open_time': None}
2025-07-15 22:03:24,752 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 22:03:24,752 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 111
2025-07-15 22:03:24,753 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000317-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('111'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23531.81'), 'commission': Decimal('588.30'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000318-005', 'takeprofit_id': '1000319-006', 'close_id': None}
2025-07-15 22:03:24,830 - INFO - orders - Order 1000317-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 22:03:24,842 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000317-001
2025-07-15 22:03:24,977 - INFO - orders - [PERF] TOTAL place_order: 0.7266s
2025-07-15 22:03:25,127 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 22:03:25,170 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 22:03:35,470 - INFO - orders - Order placement request received - User: 14, Symbol: AUDJPY, Type: SELL
2025-07-15 22:03:37,574 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '97.1570000000', 'o': '97.1510000000'}
2025-07-15 22:03:37,574 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=97.1570000000, ask=97.16671570000000
2025-07-15 22:03:37,574 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=97.1570000000, ask=97.16671570000000
2025-07-15 22:03:37,607 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 971.57 JPY to USD for margin_calculation (user_id: 14, position: None)
2025-07-15 22:03:37,608 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-15 22:03:37,615 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-15 22:03:37,615 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-15 22:03:37,615 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-15 22:03:37,623 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('148.8980000000'), 'o': Decimal('148.8960000000')}
2025-07-15 22:03:37,623 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 148.8980000000
2025-07-15 22:03:37,624 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 971.57 JPY / 148.8980000000 = 6.525070853873121197061075367 USD
2025-07-15 22:03:37,624 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 97.1570000000, Margin: 6.525070853873121197061075367, Commission: 0.10
2025-07-15 22:03:37,625 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 14, Symbol: AUDJPY, OrderType: SELL, Quantity: 0.01, FullMargin: 6.525070853873121197061075367
2025-07-15 22:03:37,625 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-15 22:03:37,625 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=SELL, Qty=0.01, Margin=6.525070853873121197061075367
2025-07-15 22:03:37,625 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-15 22:03:37,626 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-15 22:03:37,631 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 14, Symbol AUDJPY. Returning zero margin.
2025-07-15 22:03:37,632 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 14, Symbol AUDJPY
2025-07-15 22:03:37,632 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.01, NetQty=0.01, IsHedged=False
2025-07-15 22:03:37,633 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol AUDJPY: AllMarginsPerLot=[Decimal('652.5070853873121197061075367')], HighestMarginPerLot=652.5070853873121197061075367
2025-07-15 22:03:37,633 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 14, Symbol AUDJPY: CalculatedTotalMargin=6.53
2025-07-15 22:03:37,638 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-15 22:03:37,639 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 14, Symbol: AUDJPY, OrderType: SELL, MarginBefore: 0.0, MarginAfter: 6.53, AdditionalMargin: 6.53, OpenOrders: 0
2025-07-15 22:03:37,639 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=SELL, Qty=0.01, Margin=6.525070853873121197061075367
2025-07-15 22:03:37,640 - INFO - orders - [PERF] Order processing: 2.1518s
2025-07-15 22:03:37,794 - INFO - orders - [PERF] Order creation: 0.1535s
2025-07-15 22:03:37,794 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-15 22:03:37,795 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-15 22:03:37,795 - INFO - orders - [PERF] TOTAL place_order: 2.3878s
2025-07-15 22:03:37,964 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 22:03:38,035 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-15 22:03:38,347 - INFO - orders - [PUBLISH_ASYNC] Triggering websocket updates for user 14
2025-07-15 22:03:41,205 - INFO - orders - Order placement request received - User: 14, Symbol: AUDJPY, Type: BUY
2025-07-15 22:03:41,556 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '97.1530000000', 'o': '97.1480000000'}
2025-07-15 22:03:41,557 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=97.1530000000, ask=97.16271530000000
2025-07-15 22:03:41,557 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=97.1530000000, ask=97.16271530000000
2025-07-15 22:03:41,560 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 971.63 JPY to USD for margin_calculation (user_id: 14, position: None)
2025-07-15 22:03:41,560 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-15 22:03:41,562 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-15 22:03:41,562 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-15 22:03:41,562 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-15 22:03:41,564 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('148.8970000000'), 'o': Decimal('148.8920000000')}
2025-07-15 22:03:41,565 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 148.8970000000
2025-07-15 22:03:41,565 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 971.63 JPY / 148.8970000000 = 6.525517639710672478290361794 USD
2025-07-15 22:03:41,565 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 97.16271530000000, Margin: 6.525517639710672478290361794, Commission: 0.10
2025-07-15 22:03:41,566 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 14, Symbol: AUDJPY, OrderType: BUY, Quantity: 0.01, FullMargin: 6.525517639710672478290361794
2025-07-15 22:03:41,566 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-15 22:03:41,566 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.01, Margin=6.525517639710672478290361794
2025-07-15 22:03:41,567 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-15 22:03:41,567 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-15 22:03:41,568 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 14, Symbol AUDJPY. Returning zero margin.
2025-07-15 22:03:41,569 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 14, Symbol AUDJPY
2025-07-15 22:03:41,569 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol AUDJPY: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01, IsHedged=False
2025-07-15 22:03:41,570 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol AUDJPY: AllMarginsPerLot=[Decimal('652.5517639710672478290361794')], HighestMarginPerLot=652.5517639710672478290361794
2025-07-15 22:03:41,570 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 14, Symbol AUDJPY: CalculatedTotalMargin=6.53
2025-07-15 22:03:41,571 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-15 22:03:41,571 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 14, Symbol: AUDJPY, OrderType: BUY, MarginBefore: 0.0, MarginAfter: 6.53, AdditionalMargin: 6.53, OpenOrders: 0
2025-07-15 22:03:41,571 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.01, Margin=6.525517639710672478290361794
2025-07-15 22:03:41,571 - INFO - orders - [PERF] Order processing: 0.3637s
2025-07-15 22:03:41,596 - INFO - orders - [PERF] Order creation: 0.0238s
2025-07-15 22:03:41,596 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-15 22:03:41,596 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-15 22:03:41,596 - INFO - orders - [PERF] TOTAL place_order: 0.3927s
2025-07-15 22:03:41,612 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 22:03:41,627 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-15 22:03:41,958 - INFO - orders - [PUBLISH_ASYNC] Triggering websocket updates for user 14
2025-07-15 22:55:56,178 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-15 22:55:57,441 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-15 22:55:57,441 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-15 22:55:57,441 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-15 22:55:57,441 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-15 22:56:01,519 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-15 22:56:01,519 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-15 22:56:02,445 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-15 22:56:07,443 - INFO - orders - Starting the users with orders cache updater task.
2025-07-15 22:56:19,014 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol XAGUSD
2025-07-15 22:56:19,014 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-15 22:56:19,014 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: AllMarginsPerLot=[Decimal('1954')], HighestMarginPerLot=1954
2025-07-15 22:56:19,014 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol XAGUSD: CalculatedTotalMargin=19.54
2025-07-15 22:56:19,014 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol BTCUSD
2025-07-15 22:56:19,014 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: TotalBuyQty=6.00000000, TotalSellQty=0, NetQty=6.00000000, IsHedged=False
2025-07-15 22:56:19,014 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: AllMarginsPerLot=[Decimal('24410.82166666666666666666667')], HighestMarginPerLot=24410.82166666666666666666667
2025-07-15 22:56:19,015 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol BTCUSD: CalculatedTotalMargin=146464.93
2025-07-15 22:56:19,015 - INFO - orders - [TOTAL_USER_MARGIN] User 26 total margin across all symbols: 146484.47
2025-07-15 22:56:19,046 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-15 22:56:19,046 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-15 22:56:19,046 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.341805'), Decimal('654.258453')], HighestMarginPerLot=654.341805
2025-07-15 22:56:19,047 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.54
2025-07-15 22:56:19,047 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.54
2025-07-15 22:56:46,234 - INFO - orders - [get_rejected_orders] user_type: live
2025-07-15 22:57:29,514 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 22:57:29,536 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 22:57:29,537 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'account_number': 'DB7JG', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0E-8'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 22:57:29,537 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 22:57:29,538 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 22:57:29,543 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 22:57:29,831 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117860.2000000000', 'o': '117860.1000000000'}
2025-07-15 22:57:29,831 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117860.2000000000, ask=117871.98602000000000
2025-07-15 22:57:29,831 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117860.2000000000, ask=117871.98602000000000
2025-07-15 22:57:29,831 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117871.98602000000000, Margin: 23574.40, Commission: 589.36
2025-07-15 22:57:29,831 - INFO - orders - Calculated initial margin: 23574.40, commission: 589.36 for pending order 1000322-001
2025-07-15 22:57:29,852 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000322-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('123'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000323-005', 'takeprofit_id': '1000324-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23574.40'), 'commission': Decimal('589.36'), 'open_time': None}
2025-07-15 22:57:29,852 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 22:57:29,852 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 123
2025-07-15 22:57:29,853 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000322-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('123'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23574.40'), 'commission': Decimal('589.36'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000323-005', 'takeprofit_id': '1000324-006', 'close_id': None}
2025-07-15 22:57:29,874 - INFO - orders - Order 1000322-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 22:57:29,875 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000322-001
2025-07-15 22:57:29,884 - INFO - orders - [PERF] TOTAL place_order: 0.3714s
2025-07-15 22:57:29,906 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 22:57:29,916 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 22:58:13,518 - INFO - orders - Service provider update request received: {"order_id":"1000322-001","order_status":"PENDING","status":"PENDING"}
2025-07-15 22:58:13,533 - INFO - orders - Original order status: PENDING_PROCESSING
2025-07-15 22:58:13,533 - INFO - orders - Update fields: {'order_id': '1000322-001', 'order_status': 'PENDING', 'status': 'PENDING'}
2025-07-15 22:58:13,533 - INFO - orders - Processing regular update for order 1000322-001
2025-07-15 22:58:13,560 - INFO - orders - Balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 22:58:13,560 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 22:58:13,560 - INFO - orders - Using order model: UserOrder
2025-07-15 22:58:13,563 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 22:58:13,566 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 22:58:13,567 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 22:58:13,573 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 22:58:14,627 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 22:58:14,628 - INFO - orders - Using order model: UserOrder
2025-07-15 22:58:14,631 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 22:58:14,634 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 22:58:14,636 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 22:58:14,642 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 22:58:25,772 - INFO - orders - Pending order placement request received - User ID: 14, Symbol: BTCUSD, Type: BUY_LIMIT, Quantity: 1
2025-07-15 22:58:25,798 - INFO - orders - Calculated contract_value for pending order: 1.00000000 (contract_size: 1.00000000 * quantity: 1)
2025-07-15 22:58:25,800 - INFO - orders - [DEBUG] User data from cache: {'id': 14, 'email': 'cursordemo3@gmail.com', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'user_type': 'live', 'account_number': 'DB7JG', 'wallet_balance': Decimal('9902.02000000'), 'margin': Decimal('0.0'), 'first_name': None, 'last_name': None, 'country': 'India', 'phone_number': Decimal('918618025298')}
2025-07-15 22:58:25,800 - INFO - orders - [DEBUG] Group name: Standard
2025-07-15 22:58:25,801 - INFO - orders - User 14 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-15 22:58:25,803 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 22:58:26,208 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117849.8000000000', 'o': '117849.7000000000'}
2025-07-15 22:58:26,208 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117849.8000000000, ask=117861.58498000000000
2025-07-15 22:58:26,209 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117849.8000000000, ask=117861.58498000000000
2025-07-15 22:58:26,209 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY_LIMIT, Qty: 1, Price: 117861.58498000000000, Margin: 23572.32, Commission: 589.31
2025-07-15 22:58:26,209 - INFO - orders - Calculated initial margin: 23572.32, commission: 589.31 for pending order 1000326-001
2025-07-15 22:58:26,230 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '1000326-001', 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('1'), 'order_price': Decimal('155'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000327-005', 'takeprofit_id': '1000328-006', 'order_user_id': 14, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23572.32'), 'commission': Decimal('589.31'), 'open_time': None}
2025-07-15 22:58:26,230 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-15 22:58:26,230 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 14 at price 155
2025-07-15 22:58:26,230 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '1000326-001', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 14, 'order_company_name': 'BTCUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('155'), 'order_quantity': Decimal('1'), 'contract_value': Decimal('1.00000000'), 'margin': Decimal('23572.32'), 'commission': Decimal('589.31'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '1000327-005', 'takeprofit_id': '1000328-006', 'close_id': None}
2025-07-15 22:58:26,254 - INFO - orders - Order 1000326-001 verified in database on attempt 1 before adding to Redis.
2025-07-15 22:58:26,255 - INFO - orders - Skipping Redis storage for Barclays user pending order 1000326-001
2025-07-15 22:58:26,276 - INFO - orders - [PERF] TOTAL place_order: 0.5042s
2025-07-15 22:58:26,318 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 22:58:26,333 - INFO - orders - [BARCLAYS] barclays_push called for user 14, is_barclays_live_user=True
2025-07-15 22:58:33,065 - INFO - orders - Service provider update request received: {"order_id":"1000326-001","order_status":"PENDING","status":"PENDING"}
2025-07-15 22:58:33,072 - INFO - orders - Original order status: PENDING_PROCESSING
2025-07-15 22:58:33,072 - INFO - orders - Update fields: {'order_id': '1000326-001', 'order_status': 'PENDING', 'status': 'PENDING'}
2025-07-15 22:58:33,072 - INFO - orders - Processing regular update for order 1000326-001
2025-07-15 22:58:33,101 - INFO - orders - Balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 22:58:33,101 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 22:58:33,102 - INFO - orders - Using order model: UserOrder
2025-07-15 22:58:33,105 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 22:58:33,108 - INFO - orders - Fetched 1 pending orders for user 14
2025-07-15 22:58:33,108 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 1 pending orders
2025-07-15 22:58:33,113 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 22:58:33,685 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 22:58:33,686 - INFO - orders - Using order model: UserOrder
2025-07-15 22:58:33,696 - INFO - orders - Fetched 0 open orders for user 14
2025-07-15 22:58:33,718 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 22:58:33,731 - INFO - orders - Updated static orders cache for user 14 with 0 open orders and 0 pending orders
2025-07-15 22:58:33,753 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=0.0
2025-07-15 22:58:36,160 - INFO - orders - [get_rejected_orders] user_type: live
2025-07-15 22:58:46,575 - INFO - orders - [get_closed_orders] user_type: live
2025-07-15 22:59:00,969 - INFO - orders - [get_rejected_orders] user_type: live
2025-07-15 23:00:08,704 - INFO - orders - Order placement request received - User: 14, Symbol: BTCUSD, Type: BUY
2025-07-15 23:00:09,062 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117858.5000000000', 'o': '117858.4000000000'}
2025-07-15 23:00:09,062 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117858.5000000000, ask=117870.28585000000000
2025-07-15 23:00:09,062 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117858.5000000000, ask=117870.28585000000000
2025-07-15 23:00:09,062 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY, Qty: 0.4, Price: 117870.28585000000000, Margin: 9429.62, Commission: 235.74
2025-07-15 23:00:09,062 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 14, Symbol: BTCUSD, OrderType: BUY, Quantity: 0.4, FullMargin: 9429.62
2025-07-15 23:00:09,063 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-15 23:00:09,063 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.4, Margin=9429.62
2025-07-15 23:00:09,063 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-15 23:00:09,063 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-15 23:00:09,064 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 14, Symbol BTCUSD. Returning zero margin.
2025-07-15 23:00:09,064 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 14, Symbol BTCUSD
2025-07-15 23:00:09,064 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol BTCUSD: TotalBuyQty=0.4, TotalSellQty=0, NetQty=0.4, IsHedged=False
2025-07-15 23:00:09,065 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol BTCUSD: AllMarginsPerLot=[Decimal('23574.05')], HighestMarginPerLot=23574.05
2025-07-15 23:00:09,065 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 14, Symbol BTCUSD: CalculatedTotalMargin=9429.62
2025-07-15 23:00:09,065 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-15 23:00:09,065 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 14, Symbol: BTCUSD, OrderType: BUY, MarginBefore: 0.0, MarginAfter: 9429.62, AdditionalMargin: 9429.62, OpenOrders: 0
2025-07-15 23:00:09,066 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.4, Margin=9429.62
2025-07-15 23:00:09,066 - INFO - orders - [PERF] Order processing: 0.3594s
2025-07-15 23:00:09,080 - INFO - orders - [PERF] Order creation: 0.0136s
2025-07-15 23:00:09,080 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-15 23:00:09,080 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-15 23:00:09,080 - INFO - orders - [PERF] TOTAL place_order: 0.3811s
2025-07-15 23:00:09,105 - INFO - orders - Background balance/margin cache updated for user 14: balance=9902.02000000, margin=0.0
2025-07-15 23:00:09,117 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-15 23:00:09,518 - INFO - orders - [PUBLISH_ASYNC] Triggering websocket updates for user 14
2025-07-15 23:02:06,574 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-15 23:02:07,705 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-15 23:02:07,705 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-15 23:02:07,705 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-15 23:02:07,705 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-15 23:02:11,777 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-15 23:02:11,777 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-15 23:02:12,705 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-15 23:02:17,717 - INFO - orders - Starting the users with orders cache updater task.
2025-07-15 23:02:22,556 - INFO - orders - [get_closed_orders] user_type: live
2025-07-15 23:02:24,089 - INFO - orders - [get_rejected_orders] user_type: live
2025-07-15 23:02:31,260 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol XAGUSD
2025-07-15 23:02:31,260 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-15 23:02:31,260 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol XAGUSD: AllMarginsPerLot=[Decimal('1954')], HighestMarginPerLot=1954
2025-07-15 23:02:31,260 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol XAGUSD: CalculatedTotalMargin=19.54
2025-07-15 23:02:31,260 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 26, Symbol BTCUSD
2025-07-15 23:02:31,260 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: TotalBuyQty=6.00000000, TotalSellQty=0, NetQty=6.00000000, IsHedged=False
2025-07-15 23:02:31,260 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 26, Symbol BTCUSD: AllMarginsPerLot=[Decimal('24410.82166666666666666666667')], HighestMarginPerLot=24410.82166666666666666666667
2025-07-15 23:02:31,260 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 26, Symbol BTCUSD: CalculatedTotalMargin=146464.93
2025-07-15 23:02:31,260 - INFO - orders - [TOTAL_USER_MARGIN] User 26 total margin across all symbols: 146484.47
2025-07-15 23:02:31,293 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-15 23:02:31,293 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-15 23:02:31,293 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.341805'), Decimal('654.258453')], HighestMarginPerLot=654.341805
2025-07-15 23:02:31,293 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.54
2025-07-15 23:02:31,293 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.54
2025-07-15 23:02:52,383 - INFO - orders - Order 1000330-001 transitioning to OPEN. Calculating margin.
2025-07-15 23:02:52,384 - INFO - orders - Using fixed UserOrder model for Barclays service provider integration
2025-07-15 23:02:52,385 - INFO - orders - Using group_name: Standard for order 1000330-001
2025-07-15 23:02:52,753 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for BTCUSD: contract_size=1.00000000, profit_currency=USD, digit=2.00000
2025-07-15 23:02:52,753 - INFO - orders - Using user's leverage from cache: 100.00
2025-07-15 23:02:52,753 - INFO - orders - [MARGIN_CALC] Market data for BTCUSD: {'b': '117772.3300000000', 'o': '117772.3300000000'}
2025-07-15 23:02:52,754 - WARNING - orders - [MARGIN_CALC] Missing ask price for BTCUSD, using bid price with spread: bid=117772.3300000000, ask=117784.10723300000000
2025-07-15 23:02:52,754 - INFO - orders - [MARGIN_CALC] Using prices for BTCUSD: bid=117772.3300000000, ask=117784.10723300000000
2025-07-15 23:02:52,754 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: BTCUSD, Type: BUY, Qty: 0.40000000, Price: 117784.10723300000000, Margin: 9422.73, Commission: 235.57
2025-07-15 23:02:52,754 - INFO - orders - New margin calculated: 9422.73, contract_value: 0.40
2025-07-15 23:02:52,754 - INFO - orders - [MARGIN] Final stored margin (USD): 9422.73
2025-07-15 23:02:52,754 - INFO - orders - Recalculating total hedged margin for user 14 on symbol BTCUSD
2025-07-15 23:02:52,757 - INFO - orders - Found 0 existing open positions for this symbol
2025-07-15 23:02:52,757 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 14, Symbol BTCUSD. Returning zero margin.
2025-07-15 23:02:52,757 - INFO - orders - Old total margin for BTCUSD: 0.0
2025-07-15 23:02:52,757 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 14, Symbol BTCUSD
2025-07-15 23:02:52,757 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol BTCUSD: TotalBuyQty=0.40000000, TotalSellQty=0, NetQty=0.40000000, IsHedged=False
2025-07-15 23:02:52,757 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol BTCUSD: AllMarginsPerLot=[Decimal('23556.825')], HighestMarginPerLot=23556.825
2025-07-15 23:02:52,757 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 14, Symbol BTCUSD: CalculatedTotalMargin=9422.73
2025-07-15 23:02:52,757 - INFO - orders - New total margin for BTCUSD: 9422.73
2025-07-15 23:02:52,757 - INFO - orders - Margin change for user 14: 9422.73
2025-07-15 23:02:52,762 - INFO - orders - User 14 margin updated from 0 to 9422.73
2025-07-15 23:02:52,804 - INFO - orders - Starting update_user_static_orders for user 14, user_type live
2025-07-15 23:02:52,804 - INFO - orders - Using order model: UserOrder
2025-07-15 23:02:52,808 - INFO - orders - Fetched 1 open orders for user 14
2025-07-15 23:02:52,811 - INFO - orders - Fetched 0 pending orders for user 14
2025-07-15 23:02:52,811 - INFO - orders - Updated static orders cache for user 14 with 1 open orders and 0 pending orders
2025-07-15 23:02:52,815 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 14, Symbol BTCUSD
2025-07-15 23:02:52,815 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol BTCUSD: TotalBuyQty=0.40000000, TotalSellQty=0, NetQty=0.40000000, IsHedged=False
2025-07-15 23:02:52,815 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol BTCUSD: AllMarginsPerLot=[Decimal('23556.825')], HighestMarginPerLot=23556.825
2025-07-15 23:02:52,815 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 14, Symbol BTCUSD: CalculatedTotalMargin=9422.73
2025-07-15 23:02:52,815 - INFO - orders - [TOTAL_USER_MARGIN] User 14 total margin across all symbols: 9422.73
2025-07-15 23:02:52,817 - INFO - orders - User 14: Updated balance/margin cache after static orders update - balance=9902.02000000, margin=9422.73
2025-07-15 23:05:06,107 - INFO - orders - [get_rejected_orders] user_type: live
2025-07-15 23:05:09,105 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 14, Symbol BTCUSD
2025-07-15 23:05:09,106 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol BTCUSD: TotalBuyQty=0.40000000, TotalSellQty=0, NetQty=0.40000000, IsHedged=False
2025-07-15 23:05:09,106 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 14, Symbol BTCUSD: AllMarginsPerLot=[Decimal('23556.825')], HighestMarginPerLot=23556.825
2025-07-15 23:05:09,106 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 14, Symbol BTCUSD: CalculatedTotalMargin=9422.73
2025-07-15 23:05:09,106 - INFO - orders - [TOTAL_USER_MARGIN] User 14 total margin across all symbols: 9422.73
