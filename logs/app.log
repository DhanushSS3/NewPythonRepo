2025-07-23 23:21:55,938 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 23:21:55,962 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 23:21:55,978 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 23:21:55,978 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 23:21:56,257 - INFO - app - Application starting up - Trading system initialized
2025-07-23 23:21:56,257 - INFO - app - SL/TP Epsilon accuracy configured: 0.00001
2025-07-23 23:21:56,257 - INFO - app - Environment: PRODUCTION
2025-07-23 23:21:56,328 - INFO - app - Application startup initiated
2025-07-23 23:21:56,328 - INFO - app - Initializing core services...
2025-07-23 23:21:56,367 - INFO - app - Firebase initialized
2025-07-23 23:21:56,367 - WARNING - app.dependencies.redis_client - [Redis] Client not initialized, attempting late connection.
2025-07-23 23:21:56,384 - INFO - app - Redis initialized
2025-07-23 23:21:58,545 - INFO - app - All group settings, group-symbol settings, and external symbol info cached in Redis at startup.
2025-07-23 23:21:58,549 - INFO - app - [SCHEDULER] Initializing APScheduler...
2025-07-23 23:21:58,551 - INFO - app - [SWAP] daily_swap_charge_job triggered
2025-07-23 23:21:58,552 - INFO - app - [SCHEDULER] About to start scheduler...
2025-07-23 23:21:58,552 - INFO - app - [SCHEDULER] Scheduler started successfully.
2025-07-23 23:21:58,552 - INFO - app - Scheduler initialized
2025-07-23 23:21:58,554 - INFO - app.firebase_stream - Starting Firebase Admin event processing task for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 23:21:58,555 - INFO - app.firebase_stream - Attempting to start Firebase Admin listener for path: 'datafeeds'.
2025-07-23 23:21:59,467 - INFO - app.firebase_stream - Firebase Admin listener started successfully for path: 'datafeeds'. Queuing data for Redis publishing.
2025-07-23 23:21:59,469 - INFO - app - Starting stale cache cleanup task
2025-07-23 23:21:59,514 - INFO - app - Cleaned up pending order stream for new trigger price format
2025-07-23 23:21:59,514 - INFO - app - Background tasks initialized
2025-07-23 23:21:59,514 - INFO - app - [SCHEDULER] Starting rotate_service_account_jwt job...
2025-07-23 23:22:00,156 - INFO - app - Service account JWT for 'barclays_service_provider' was generated and pushed to Firebase.
2025-07-23 23:22:00,156 - INFO - app - Application startup completed successfully
2025-07-23 23:22:00,157 - INFO - app - Starting cache validation task
2025-07-23 23:22:00,162 - INFO - app - Starting Barclays pending order margin checker task.
2025-07-23 23:22:00,173 - INFO - app - Starting auto-cutoff order monitoring task.
2025-07-23 23:22:00,181 - INFO - app - [SCHEDULER] Starting update_all_users_dynamic_portfolio job...
2025-07-23 23:22:00,199 - INFO - app - Found 30 static orders cache entries to check
2025-07-23 23:22:00,200 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 23:22:00,202 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 23:22:00,204 - WARNING - app - Found stale cache entry for user live:24, will be refreshed on next access
2025-07-23 23:22:00,206 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 23:22:00,207 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 23:22:00,210 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 23:22:00,213 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 23:22:00,215 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 23:22:00,220 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 23:22:00,223 - WARNING - app - Found stale cache entry for user live:31, will be refreshed on next access
2025-07-23 23:22:00,259 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 23:22:00,262 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 23:22:00,263 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 23:22:00,265 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 23:22:00,267 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 23:22:00,268 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 23:22:00,268 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 23:22:00,269 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 23:22:00,270 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 23:22:00,272 - INFO - app - Completed stale cache cleanup task
2025-07-23 23:22:00,431 - INFO - app - Validating cache for 37 users
2025-07-23 23:22:00,449 - INFO - app - [AUTO-CUTOFF] Found 25 live users and 12 demo users.
2025-07-23 23:22:00,652 - INFO - app - Cache validation completed
2025-07-23 23:22:01,181 - INFO - app - [AUTO-CUTOFF] User 4 margin_level: 403.5681667757148781688995599
2025-07-23 23:22:01,290 - WARNING - app - [AUTO-CUTOFF] No user data found for user 5 (live). Skipping portfolio update.
2025-07-23 23:22:01,307 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 23:22:01,379 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 8.
2025-07-23 23:22:01,486 - WARNING - app - [AUTO-CUTOFF] User 9 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:02,172 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146156.0422960725075528700906
2025-07-23 23:22:02,871 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 23:22:02,879 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 23:22:02,891 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 23:22:02,919 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 51.36916496711961819078797329% which is below threshold 100.0%
2025-07-23 23:22:02,923 - INFO - app - [AUTO-CUTOFF] User 11 margin_level: 51.36916496711961819078797329
2025-07-23 23:22:02,930 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 23:22:02,945 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 23:22:02,975 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 23:22:02,996 - INFO - app.shared_state - Initialized redis_publish_queue in shared_state with maxsize=500.
2025-07-23 23:22:03,078 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:03,185 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 23:22:03,188 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 23:22:03,212 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 23:22:03,212 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 23:22:03,213 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 23:22:03,213 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 23:22:03,218 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 23:22:03,237 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 23:22:03,237 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 23:22:03,272 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 23:22:03,277 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 23:22:03,280 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 23:22:03,294 - INFO - app.core.config - .env file loaded successfully.
2025-07-23 23:22:03,294 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 23:22:03,294 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 23:22:03,295 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 23:22:03,295 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 23:22:03,298 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 23:22:03,298 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 23:22:03,305 - INFO - app.core.config - Settings instance loaded. Project: Trading App, API Prefix: /api/v1
2025-07-23 23:22:03,305 - INFO - app.database.session - Attempting to connect to database using URL: mysql+aiomysql://u43...
2025-07-23 23:22:03,648 - INFO - app - [AUTO-CUTOFF] User 13 margin_level: 296.3152507676560900716479017
2025-07-23 23:22:03,741 - WARNING - app - [AUTO-CUTOFF] User 14 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:03,837 - WARNING - app - [AUTO-CUTOFF] User 16 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:03,967 - WARNING - app - [AUTO-CUTOFF] User 17 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:04,072 - WARNING - app - [AUTO-CUTOFF] User 18 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:04,178 - WARNING - app - [AUTO-CUTOFF] User 19 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:04,637 - INFO - app - [AUTO-CUTOFF] User 20 margin_level: 47399.34711643090315560391730
2025-07-23 23:22:04,734 - WARNING - app - [AUTO-CUTOFF] User 21 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:05,374 - INFO - app - [AUTO-CUTOFF] User 22 margin_level: 22706.32380952380952380952381
2025-07-23 23:22:05,485 - WARNING - app - [AUTO-CUTOFF] User 23 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:05,580 - WARNING - app - [AUTO-CUTOFF] User 24 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:05,679 - WARNING - app - [AUTO-CUTOFF] User 25 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:05,780 - WARNING - app - [AUTO-CUTOFF] User 26 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:06,300 - INFO - app - [AUTO-CUTOFF] User 27 margin_level: 34215.58843953732169264870545
2025-07-23 23:22:06,899 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 23:22:06,908 - ERROR - app.services.portfolio_calculator - Could not convert PnL from PLN to USD
2025-07-23 23:22:06,908 - WARNING - app.services.portfolio_calculator - MARGIN CALL ALERT: User has margin level 88.87414584689949636907656674% which is below threshold 100.0%
2025-07-23 23:22:06,909 - INFO - app - [AUTO-CUTOFF] User 28 margin_level: 88.87414584689949636907656674
2025-07-23 23:22:07,187 - WARNING - app - [AUTO-CUTOFF] User 29 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:07,305 - WARNING - app - [AUTO-CUTOFF] User 30 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:07,430 - WARNING - app - [AUTO-CUTOFF] User 31 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:07,567 - WARNING - app - [AUTO-CUTOFF] User 1 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:07,569 - WARNING - app - [AUTO-CUTOFF] User 2 has no group_name set. Skipping portfolio update.
2025-07-23 23:22:07,584 - WARNING - app - [AUTO-CUTOFF] Group symbol settings missing or incomplete in cache for 'string', fetching from DB.
2025-07-23 23:22:07,620 - ERROR - app - [AUTO-CUTOFF] Group symbol settings not found in DB for group 'string'. Skipping portfolio update for user 3.
2025-07-23 23:22:07,742 - WARNING - app - [AUTO-CUTOFF] User 4 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:07,745 - WARNING - app - [AUTO-CUTOFF] User 5 has no group_name set. Skipping portfolio update.
2025-07-23 23:22:07,747 - WARNING - app - [AUTO-CUTOFF] User 6 has no group_name set. Skipping portfolio update.
2025-07-23 23:22:07,945 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 9, falling back to DB and updating cache.
2025-07-23 23:22:08,636 - INFO - app - [AUTO-CUTOFF] User 9 margin_level: 0.0
2025-07-23 23:22:08,886 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 10, falling back to DB and updating cache.
2025-07-23 23:22:09,180 - INFO - app - [AUTO-CUTOFF] User 10 margin_level: 146156.0422960725075528700906
2025-07-23 23:22:09,288 - WARNING - app - [AUTO-CUTOFF] User 11 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:09,398 - WARNING - app - [AUTO-CUTOFF] User 12 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:09,497 - WARNING - app - [AUTO-CUTOFF] User 13 has no open or pending orders. Skipping portfolio update.
2025-07-23 23:22:09,738 - WARNING - app.services.portfolio_calculator - [PORTFOLIO] user_static_orders cache miss for user 14, falling back to DB and updating cache.
2025-07-23 23:22:10,032 - INFO - app - [AUTO-CUTOFF] User 14 margin_level: 0.0
2025-07-23 23:22:15,159 - INFO - app - Starting stale cache cleanup task
2025-07-23 23:22:15,162 - INFO - app - Found 30 static orders cache entries to check
2025-07-23 23:22:15,164 - WARNING - app - Found stale cache entry for user live:17, will be refreshed on next access
2025-07-23 23:22:15,166 - WARNING - app - Found stale cache entry for user live:16, will be refreshed on next access
2025-07-23 23:22:15,171 - WARNING - app - Found stale cache entry for user live:24, will be refreshed on next access
2025-07-23 23:22:15,172 - WARNING - app - Found stale cache entry for user live:21, will be refreshed on next access
2025-07-23 23:22:15,174 - WARNING - app - Found stale cache entry for user live:5, will be refreshed on next access
2025-07-23 23:22:15,175 - WARNING - app - Found stale cache entry for user live:8, will be refreshed on next access
2025-07-23 23:22:15,176 - WARNING - app - Found stale cache entry for user live:18, will be refreshed on next access
2025-07-23 23:22:15,177 - WARNING - app - Found stale cache entry for user live:29, will be refreshed on next access
2025-07-23 23:22:15,180 - WARNING - app - Found stale cache entry for user live:2, will be refreshed on next access
2025-07-23 23:22:15,181 - WARNING - app - Found stale cache entry for user live:31, will be refreshed on next access
2025-07-23 23:22:15,188 - WARNING - app - Found stale cache entry for user live:6, will be refreshed on next access
2025-07-23 23:22:15,192 - WARNING - app - Found stale cache entry for user live:23, will be refreshed on next access
2025-07-23 23:22:15,193 - WARNING - app - Found stale cache entry for user live:12, will be refreshed on next access
2025-07-23 23:22:15,194 - WARNING - app - Found stale cache entry for user live:20, will be refreshed on next access
2025-07-23 23:22:15,197 - WARNING - app - Found stale cache entry for user live:30, will be refreshed on next access
2025-07-23 23:22:15,198 - WARNING - app - Found stale cache entry for user live:3, will be refreshed on next access
2025-07-23 23:22:15,199 - WARNING - app - Found stale cache entry for user live:19, will be refreshed on next access
2025-07-23 23:22:15,199 - WARNING - app - Found stale cache entry for user live:13, will be refreshed on next access
2025-07-23 23:22:15,200 - WARNING - app - Found stale cache entry for user live:22, will be refreshed on next access
2025-07-23 23:22:15,201 - INFO - app - Completed stale cache cleanup task
2025-07-23 23:22:31,475 - INFO - app - Application shutdown initiated
2025-07-23 23:22:31,477 - INFO - app - Scheduler shutdown completed
2025-07-23 23:22:31,477 - INFO - app.firebase_stream - Firebase event processing task cancelled.
2025-07-23 23:22:31,640 - INFO - app.firebase_stream - Firebase listener closed.
2025-07-23 23:22:31,641 - INFO - app.firebase_stream - Firebase Admin event processing task finished.
2025-07-23 23:22:32,590 - INFO - app - Redis connection closed
2025-07-23 23:22:32,591 - INFO - app - Application shutdown completed
