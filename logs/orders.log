2025-07-10 03:04:55,714 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-10 03:04:57,028 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-10 03:04:57,028 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-10 03:04:57,028 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-10 03:04:57,029 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-10 03:05:01,138 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-10 03:05:01,138 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-10 03:05:02,035 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-10 03:05:07,039 - INFO - orders - Starting the users with orders cache updater task.
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 03:05:09,913 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 03:05:09,914 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 03:05:09,914 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 03:05:09,914 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 03:05:09,914 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 03:05:09,914 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 03:05:09,914 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 03:05:09,914 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 03:05:16,268 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDNZD
2025-07-10 03:05:16,268 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDNZD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:05:16,268 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDNZD: AllMarginsPerLot=[Decimal('599.27')], HighestMarginPerLot=599.27
2025-07-10 03:05:16,268 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDNZD: CalculatedTotalMargin=5.99
2025-07-10 03:05:16,268 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 5.99
2025-07-10 03:05:16,704 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 03:05:16,705 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 03:05:16,705 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 03:05:16,705 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 03:05:16,705 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 03:05:16,705 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:05:16,705 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 03:05:16,705 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:05:16,705 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 03:05:16,706 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 03:05:16,706 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 03:05:16,706 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 03:05:16,706 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 03:05:16,706 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 03:05:16,706 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 03:05:16,706 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 03:05:16,706 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 03:05:25,387 - INFO - orders - [get_rejected_orders] user_type: demo
2025-07-10 03:05:25,887 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDNZD
2025-07-10 03:05:25,887 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDNZD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:05:25,887 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDNZD: AllMarginsPerLot=[Decimal('599.27')], HighestMarginPerLot=599.27
2025-07-10 03:05:25,887 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDNZD: CalculatedTotalMargin=5.99
2025-07-10 03:05:25,887 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 5.99
2025-07-10 03:05:33,686 - INFO - orders - Order close request received - Order ID: 7054593495, User ID: 1, Close Price: 0.99975
2025-07-10 03:05:33,687 - INFO - orders - Request to close order 7054593495 for user 1 (user_type: demo) with price 0.99975. Frontend provided type: BUY, company: AUDNZD, status: CLOSED, frontend_status: CLOSED.
2025-07-10 03:05:33,707 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 03:05:33,730 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDNZD
2025-07-10 03:05:33,730 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDNZD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:05:33,731 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDNZD: AllMarginsPerLot=[Decimal('599.27')], HighestMarginPerLot=599.27
2025-07-10 03:05:33,731 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDNZD: CalculatedTotalMargin=5.99
2025-07-10 03:05:33,731 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDNZD. Returning zero margin.
2025-07-10 03:05:33,750 - INFO - orders - Existing entry commission for order 7054593495: 0.10000000
2025-07-10 03:05:33,750 - INFO - orders - Commission calculation for order 7054593495: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 03:05:33,751 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.500000000000000000000000 NZD to USD for PnL on Close (user_id: 1, position: 7054593495)
2025-07-10 03:05:33,751 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: NZDUSD
2025-07-10 03:05:33,752 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: {'b': Decimal('0.5992700000'), 'o': Decimal('0.5992500000')}
2025-07-10 03:05:33,752 - INFO - orders - [CURRENCY_CONVERT] Found direct conversion rate (bid): 0.5992700000
2025-07-10 03:05:33,752 - INFO - orders - [CURRENCY_CONVERT] Direct conversion successful: -0.500000000000000000000000 NZD * 0.5992700000 = -0.2996350000000000000000000000 USD
2025-07-10 03:05:33,798 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=351.79000000, margin=0
2025-07-10 03:05:33,798 - INFO - orders - Setting user data cache for user 1 with wallet_balance=351.79000000, margin=0
2025-07-10 03:05:33,800 - INFO - orders - User data cache updated for user 1
2025-07-10 03:05:33,803 - INFO - orders - Balance/margin cache updated for user 1: balance=351.79000000, margin=0
2025-07-10 03:05:33,804 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 03:05:33,804 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 03:05:33,807 - INFO - orders - Fetched 0 open orders for user 1
2025-07-10 03:05:33,812 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 03:05:33,813 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 1 pending orders
2025-07-10 03:05:33,821 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=351.79000000, margin=0.0
2025-07-10 03:05:33,821 - INFO - orders - Publishing order update for user 1
2025-07-10 03:05:33,822 - INFO - orders - Publishing user data update for user 1
2025-07-10 03:05:33,824 - INFO - orders - Publishing market data trigger
2025-07-10 03:07:02,046 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCHF, Type: BUY
2025-07-10 03:07:02,446 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5212300000', 'o': '0.5211900000'}
2025-07-10 03:07:02,446 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5212300000, ask=0.52128212300000
2025-07-10 03:07:02,446 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5212300000, ask=0.52128212300000
2025-07-10 03:07:02,447 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.21 CHF to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:07:02,447 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-10 03:07:02,447 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:07:02,447 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-10 03:07:02,447 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-10 03:07:02,449 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7958300000'), 'o': Decimal('0.7958000000')}
2025-07-10 03:07:02,449 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7958300000
2025-07-10 03:07:02,449 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.21 CHF / 0.7958300000 = 6.546624279054571956322330146 USD
2025-07-10 03:07:02,449 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52128212300000, Margin: 6.546624279054571956322330146, Commission: 0.10
2025-07-10 03:07:02,449 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDCHF, OrderType: BUY, Quantity: 0.01, FullMargin: 6.546624279054571956322330146
2025-07-10 03:07:02,449 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-10 03:07:02,449 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.01, Margin=6.546624279054571956322330146
2025-07-10 03:07:02,449 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-10 03:07:02,449 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:07:02,450 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDCHF. Returning zero margin.
2025-07-10 03:07:02,450 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:07:02,450 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01, IsHedged=False
2025-07-10 03:07:02,450 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.6624279054571956322330146')], HighestMarginPerLot=654.6624279054571956322330146
2025-07-10 03:07:02,450 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:07:02,451 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:07:02,451 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDCHF, OrderType: BUY, MarginBefore: 0.0, MarginAfter: 6.55, AdditionalMargin: 6.55, OpenOrders: 0
2025-07-10 03:07:02,451 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.01, Margin=6.546624279054571956322330146
2025-07-10 03:07:02,463 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=351.79000000, margin=6.55000000 (was 0E-8)
2025-07-10 03:07:02,463 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:07:02,464 - INFO - orders - [PERF] Order processing: 0.4165s
2025-07-10 03:07:02,477 - INFO - orders - [PERF] Order creation: 0.0133s
2025-07-10 03:07:02,477 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:07:02,477 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:07:02,477 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:07:02,478 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:07:02,479 - INFO - orders - [PERF] TOTAL place_order: 0.4326s
2025-07-10 03:07:02,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:07:02,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:07:02,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:07:02,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:07:02,494 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:07:02,508 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:07:02,508 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:07:02,508 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:07:02,508 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:07:02,508 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:07:02,510 - INFO - orders - Background balance/margin cache updated for user 1: balance=351.79000000, margin=6.55
2025-07-10 03:11:24,478 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-10 03:11:25,608 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-10 03:11:25,609 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-10 03:11:25,609 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-10 03:11:25,609 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-10 03:11:29,670 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-10 03:11:29,670 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-10 03:11:30,619 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-10 03:11:35,611 - INFO - orders - Starting the users with orders cache updater task.
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 03:11:36,561 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 03:11:36,562 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 03:11:46,984 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:11:46,984 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:11:46,984 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:11:46,984 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:11:46,984 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:11:52,457 - INFO - orders - Order placement request received - User: 1, Symbol: AUDSGD, Type: SELL
2025-07-10 03:11:52,847 - INFO - orders - [MARGIN_CALC] Market data for AUDSGD: {'b': '1.0000000000', 'o': '1.0000000000'}
2025-07-10 03:11:52,847 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDSGD, using bid price with spread: bid=1.0000000000, ask=1.00010000000000
2025-07-10 03:11:52,847 - INFO - orders - [MARGIN_CALC] Using prices for AUDSGD: bid=1.0000000000, ask=1.00010000000000
2025-07-10 03:11:52,849 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 10.00 SGD to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:11:52,849 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: SGDUSD
2025-07-10 03:11:52,850 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:11:52,850 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for SGDUSD, trying inverse
2025-07-10 03:11:52,850 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDSGD
2025-07-10 03:11:52,852 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.2806600000'), 'o': Decimal('1.2806200000')}
2025-07-10 03:11:52,852 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.2806600000
2025-07-10 03:11:52,852 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 10.00 SGD / 1.2806600000 = 7.808473755719707026064685397 USD
2025-07-10 03:11:52,852 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDSGD, Type: SELL, Qty: 0.01, Price: 1.0000000000, Margin: 7.808473755719707026064685397, Commission: 0.10
2025-07-10 03:11:52,852 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDSGD, OrderType: SELL, Quantity: 0.01, FullMargin: 7.808473755719707026064685397
2025-07-10 03:11:52,853 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-10 03:11:52,853 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=SELL, Qty=0.01, Margin=7.808473755719707026064685397
2025-07-10 03:11:52,853 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-10 03:11:52,853 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:11:52,853 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDSGD. Returning zero margin.
2025-07-10 03:11:52,854 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDSGD
2025-07-10 03:11:52,854 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0, TotalSellQty=0.01, NetQty=0.01, IsHedged=False
2025-07-10 03:11:52,854 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.8473755719707026064685397')], HighestMarginPerLot=780.8473755719707026064685397
2025-07-10 03:11:52,854 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:11:52,855 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:11:52,856 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDSGD, OrderType: SELL, MarginBefore: 0.0, MarginAfter: 7.81, AdditionalMargin: 7.81, OpenOrders: 0
2025-07-10 03:11:52,856 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=SELL, Qty=0.01, Margin=7.808473755719707026064685397
2025-07-10 03:11:52,886 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=351.79000000, margin=14.36000000 (was 6.55000000)
2025-07-10 03:11:52,886 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:11:52,886 - INFO - orders - [PERF] Order processing: 0.4286s
2025-07-10 03:11:52,911 - INFO - orders - [PERF] Order creation: 0.0250s
2025-07-10 03:11:52,912 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:11:52,912 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:11:52,913 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:11:52,914 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:11:52,916 - INFO - orders - [PERF] TOTAL place_order: 0.4592s
2025-07-10 03:11:52,948 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:11:52,950 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:11:52,950 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:11:52,951 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:11:52,951 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDSGD
2025-07-10 03:11:52,952 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:11:52,953 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:11:52,953 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:11:52,953 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:11:52,973 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:11:52,973 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:11:52,973 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:11:52,973 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:11:52,974 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDSGD
2025-07-10 03:11:52,974 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:11:52,974 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:11:52,974 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:11:52,974 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:11:52,980 - INFO - orders - Background balance/margin cache updated for user 1: balance=351.79000000, margin=14.36
2025-07-10 03:23:45,759 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-10 03:23:47,051 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-10 03:23:47,051 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-10 03:23:47,051 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-10 03:23:47,051 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-10 03:23:51,116 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-10 03:23:51,116 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-10 03:23:52,063 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-10 03:23:57,061 - INFO - orders - Starting the users with orders cache updater task.
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 03:23:57,881 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 03:23:57,881 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 03:24:10,420 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:24:10,420 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:24:10,421 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:24:10,421 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:24:10,421 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDSGD
2025-07-10 03:24:10,421 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:24:10,421 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:24:10,421 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:24:10,421 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:24:16,181 - INFO - orders - Order placement request received - User: 1, Symbol: AUDSGD, Type: BUY
2025-07-10 03:24:16,552 - INFO - orders - [MARGIN_CALC] Market data for AUDSGD: {'b': '1.0000000000', 'o': '1.0000000000'}
2025-07-10 03:24:16,552 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDSGD, using bid price with spread: bid=1.0000000000, ask=1.00010000000000
2025-07-10 03:24:16,552 - INFO - orders - [MARGIN_CALC] Using prices for AUDSGD: bid=1.0000000000, ask=1.00010000000000
2025-07-10 03:24:16,553 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 10.00 SGD to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:24:16,554 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: SGDUSD
2025-07-10 03:24:16,554 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:24:16,554 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for SGDUSD, trying inverse
2025-07-10 03:24:16,554 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDSGD
2025-07-10 03:24:16,555 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.2806600000'), 'o': Decimal('1.2806200000')}
2025-07-10 03:24:16,555 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.2806600000
2025-07-10 03:24:16,555 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 10.00 SGD / 1.2806600000 = 7.808473755719707026064685397 USD
2025-07-10 03:24:16,556 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDSGD, Type: BUY, Qty: 0.01, Price: 1.00010000000000, Margin: 7.808473755719707026064685397, Commission: 0.10
2025-07-10 03:24:16,556 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDSGD, OrderType: BUY, Quantity: 0.01, FullMargin: 7.808473755719707026064685397
2025-07-10 03:24:16,556 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 1
2025-07-10 03:24:16,556 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.01, Margin=7.808473755719707026064685397
2025-07-10 03:24:16,556 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 1 existing orders + 1 new order
2025-07-10 03:24:16,556 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:24:16,557 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDSGD
2025-07-10 03:24:16,557 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:24:16,557 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:24:16,557 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:24:16,557 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:24:16,557 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01, TotalSellQty=0.01000000, NetQty=0.01, IsHedged=True
2025-07-10 03:24:16,557 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.8473755719707026064685397')], HighestMarginPerLot=780.847376
2025-07-10 03:24:16,557 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:24:16,557 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:24:16,557 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDSGD, OrderType: BUY, MarginBefore: 7.81, MarginAfter: 7.81, AdditionalMargin: 0.0, OpenOrders: 1
2025-07-10 03:24:16,558 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.01, Margin=7.808473755719707026064685397
2025-07-10 03:24:16,574 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=351.79000000, margin=14.36000000 (was 14.36000000)
2025-07-10 03:24:16,574 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:24:16,574 - INFO - orders - [PERF] Order processing: 0.3914s
2025-07-10 03:24:16,594 - INFO - orders - [PERF] Order creation: 0.0198s
2025-07-10 03:24:16,594 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:24:16,594 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:24:16,595 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:24:16,595 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:24:16,596 - INFO - orders - [PERF] TOTAL place_order: 0.4145s
2025-07-10 03:24:16,614 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:24:16,614 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:24:16,614 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:24:16,614 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:24:16,614 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:24:16,614 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:24:16,614 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:24:16,614 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:24:16,614 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:24:16,622 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:24:16,622 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:24:16,622 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:24:16,622 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:24:16,622 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:24:16,623 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:24:16,623 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:24:16,623 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:24:16,623 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:24:16,625 - INFO - orders - Background balance/margin cache updated for user 1: balance=351.79000000, margin=14.36
2025-07-10 03:38:44,527 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-10 03:38:45,808 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-10 03:38:45,808 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-10 03:38:45,812 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-10 03:38:45,812 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-10 03:38:49,904 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-10 03:38:49,905 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-10 03:38:50,814 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-10 03:38:55,816 - INFO - orders - Starting the users with orders cache updater task.
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 03:38:58,762 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 03:38:58,763 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 03:38:58,763 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 03:38:58,763 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 03:38:58,763 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 03:39:06,634 - INFO - orders - [get_rejected_orders] user_type: demo
2025-07-10 03:39:07,033 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:39:07,033 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:39:07,033 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:39:07,033 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:39:07,033 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:39:07,033 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:39:07,034 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:39:07,034 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:39:07,034 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:39:07,566 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:39:07,566 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:39:07,566 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:39:07,566 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:39:07,566 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:39:07,567 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:39:07,567 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:39:07,567 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:39:07,567 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:39:13,558 - INFO - orders - Order placement request received - User: 1, Symbol: AUDUSD, Type: BUY
2025-07-10 03:39:13,956 - INFO - orders - [MARGIN_CALC] Market data for AUDUSD: {'b': '0.6563500000', 'o': '0.6563500000'}
2025-07-10 03:39:13,957 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDUSD, using bid price with spread: bid=0.6563500000, ask=0.65641563500000
2025-07-10 03:39:13,957 - INFO - orders - [MARGIN_CALC] Using prices for AUDUSD: bid=0.6563500000, ask=0.65641563500000
2025-07-10 03:39:13,957 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDUSD, Type: BUY, Qty: 0.01, Price: 0.65641563500000, Margin: 6.56, Commission: 0.10
2025-07-10 03:39:13,957 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDUSD, OrderType: BUY, Quantity: 0.01, FullMargin: 6.56
2025-07-10 03:39:13,957 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-10 03:39:13,957 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.01, Margin=6.56
2025-07-10 03:39:13,957 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-10 03:39:13,957 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:39:13,958 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDUSD. Returning zero margin.
2025-07-10 03:39:13,958 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:39:13,958 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01, IsHedged=False
2025-07-10 03:39:13,958 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:39:13,959 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:39:13,961 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:39:13,961 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDUSD, OrderType: BUY, MarginBefore: 0.0, MarginAfter: 6.56, AdditionalMargin: 6.56, OpenOrders: 0
2025-07-10 03:39:13,961 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.01, Margin=6.56
2025-07-10 03:39:13,995 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=351.79000000, margin=20.92000000 (was 14.36000000)
2025-07-10 03:39:13,995 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:39:13,995 - INFO - orders - [PERF] Order processing: 0.4358s
2025-07-10 03:39:14,021 - INFO - orders - [PERF] Order creation: 0.0259s
2025-07-10 03:39:14,022 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:39:14,022 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:39:14,022 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:39:14,023 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:39:14,025 - INFO - orders - [PERF] TOTAL place_order: 0.4811s
2025-07-10 03:39:14,055 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:39:14,055 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:39:14,055 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:39:14,060 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:39:14,061 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:39:14,061 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:39:14,061 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:39:14,061 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:39:14,061 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:39:14,061 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:39:14,061 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:39:14,061 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:39:14,062 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 20.92
2025-07-10 03:39:14,099 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:39:14,099 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:39:14,099 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:39:14,099 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:39:14,099 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:39:14,100 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:39:14,100 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:39:14,100 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:39:14,100 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:39:14,100 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:39:14,100 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:39:14,100 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:39:14,100 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 20.92
2025-07-10 03:39:14,103 - INFO - orders - Background balance/margin cache updated for user 1: balance=351.79000000, margin=20.92
2025-07-10 03:39:37,288 - INFO - orders - Order close request received - Order ID: 7791060265, User ID: 1, Close Price: 0.65612
2025-07-10 03:39:37,288 - INFO - orders - Request to close order 7791060265 for user 1 (user_type: demo) with price 0.65612. Frontend provided type: BUY, company: AUDUSD, status: CLOSED, frontend_status: CLOSED.
2025-07-10 03:39:37,300 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 03:39:37,312 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:39:37,312 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:39:37,313 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:39:37,313 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:39:37,313 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDUSD. Returning zero margin.
2025-07-10 03:39:37,321 - INFO - orders - Existing entry commission for order 7791060265: 0.10000000
2025-07-10 03:39:37,322 - INFO - orders - Commission calculation for order 7791060265: entry=0.10000000, exit=0.0, total=0.10
2025-07-10 03:39:37,322 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.380000000000000000000000 USD to USD for PnL on Close (user_id: 1, position: 7791060265)
2025-07-10 03:39:37,322 - INFO - orders - [CURRENCY_CONVERT] Currency is already USD, no conversion needed
2025-07-10 03:39:37,350 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=351.31000000, margin=14.36
2025-07-10 03:39:37,350 - INFO - orders - Setting user data cache for user 1 with wallet_balance=351.31000000, margin=14.36
2025-07-10 03:39:37,351 - INFO - orders - User data cache updated for user 1
2025-07-10 03:39:37,358 - INFO - orders - Balance/margin cache updated for user 1: balance=351.31000000, margin=14.36
2025-07-10 03:39:37,359 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 03:39:37,359 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 03:39:37,363 - INFO - orders - Fetched 3 open orders for user 1
2025-07-10 03:39:37,368 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 03:39:37,369 - INFO - orders - Updated static orders cache for user 1 with 3 open orders and 1 pending orders
2025-07-10 03:39:37,371 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:39:37,372 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:39:37,372 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:39:37,372 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:39:37,372 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:39:37,372 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:39:37,372 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:39:37,372 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:39:37,372 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:39:37,374 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=351.31000000, margin=14.36
2025-07-10 03:39:37,374 - INFO - orders - Publishing order update for user 1
2025-07-10 03:39:37,375 - INFO - orders - Publishing user data update for user 1
2025-07-10 03:39:37,375 - INFO - orders - Publishing market data trigger
2025-07-10 03:40:05,453 - INFO - orders - Pending order placement request received - User ID: 1, Symbol: AUDUSD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-10 03:40:05,464 - INFO - orders - Validating pending order price: Order type=BUY_LIMIT, Order price=0.65645, Current buy price=0.6565, Current sell price=0.65619
2025-07-10 03:40:05,476 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-10 03:40:05,477 - INFO - orders - [DEBUG] User data from cache: {'id': 1, 'email': 'dhanush777ss@gmail.com', 'group_name': 'Group B', 'leverage': Decimal('100.00'), 'user_type': 'demo', 'account_number': '5O42G', 'wallet_balance': Decimal('351.31000000'), 'margin': Decimal('14.36'), 'first_name': None, 'last_name': None, 'country': None, 'phone_number': Decimal('8618025298')}
2025-07-10 03:40:05,478 - INFO - orders - [DEBUG] Group name: Group B
2025-07-10 03:40:05,480 - INFO - orders - User 1 is_barclays_live_user: False (user_type: demo, sending_orders_normalized: barclays)
2025-07-10 03:40:05,485 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDUSD: contract_size=100000.00000000, profit_currency=USD, digit=5.00000
2025-07-10 03:40:05,890 - INFO - orders - [MARGIN_CALC] Market data for AUDUSD: {'b': '0.6563500000', 'o': '0.6563400000'}
2025-07-10 03:40:05,896 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDUSD, using bid price with spread: bid=0.6563500000, ask=0.65641563500000
2025-07-10 03:40:05,896 - INFO - orders - [MARGIN_CALC] Using prices for AUDUSD: bid=0.6563500000, ask=0.65641563500000
2025-07-10 03:40:05,899 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDUSD, Type: BUY_LIMIT, Qty: 0.01, Price: 0.65641563500000, Margin: 6.56, Commission: 0.10
2025-07-10 03:40:05,900 - INFO - orders - Calculated initial margin: 6.56, commission: 0.10 for pending order 8843080535
2025-07-10 03:40:05,915 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '8843080535', 'order_company_name': 'AUDUSD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.65645'), 'user_type': 'demo', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '2555973759', 'takeprofit_id': '5896492327', 'order_user_id': 1, 'order_status': 'PENDING', 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.56'), 'commission': Decimal('0.10'), 'open_time': None}
2025-07-10 03:40:05,916 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 1 at price 0.65645
2025-07-10 03:40:05,916 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '8843080535', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDUSD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.65645'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.56'), 'commission': Decimal('0.10'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '2555973759', 'takeprofit_id': '5896492327', 'close_id': None}
2025-07-10 03:40:06,113 - INFO - orders - Order 8843080535 verified in database on attempt 1 before adding to Redis.
2025-07-10 03:40:06,123 - INFO - orders - Pending order 8843080535 added to Redis for non-Barclays user or demo user.
2025-07-10 03:40:06,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:40:06,132 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:40:06,133 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:40:06,133 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:40:06,133 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:40:06,133 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:40:06,134 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:40:06,134 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:40:06,134 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:40:06,158 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:40:06,159 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:40:06,159 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:40:06,159 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:40:06,159 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:40:06,159 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:40:06,160 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:40:06,160 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:40:06,160 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:40:06,168 - INFO - orders - [PERF] TOTAL place_order: 0.7157s
2025-07-10 03:40:06,202 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:40:06,203 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:40:06,204 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:40:06,205 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:40:06,205 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:40:06,206 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:40:06,207 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:40:06,207 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:40:06,208 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:40:06,240 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:40:06,241 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:40:06,241 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:40:06,241 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:40:06,241 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:40:06,242 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:40:06,242 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:40:06,244 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:40:06,245 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:40:06,253 - INFO - orders - Background balance/margin cache updated for user 1: balance=351.31000000, margin=14.36
2025-07-10 03:40:47,389 - INFO - orders - [PENDING_CHECK] Found 1 matching BUY_LIMIT orders for AUDUSD at price 0.65644
2025-07-10 03:40:47,391 - INFO - orders - [PENDING_ORDER] Starting execution of order 8843080535 for user 1
2025-07-10 03:40:47,391 - INFO - orders - [PENDING_ORDER] Order 8843080535: Placed at 0.65645000, Triggered at 0.65644
2025-07-10 03:40:47,391 - INFO - orders - [PENDING_ORDER] Order 8843080535: Type BUY_LIMIT -> BUY
2025-07-10 03:40:47,394 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDUSD: contract_size=100000.00000000, profit_currency=USD, digit=5.00000
2025-07-10 03:40:47,742 - INFO - orders - [MARGIN_CALC] Market data for AUDUSD: {'b': '0.6562900000', 'o': '0.6562900000'}
2025-07-10 03:40:47,743 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDUSD, using bid price with spread: bid=0.6562900000, ask=0.65635562900000
2025-07-10 03:40:47,743 - INFO - orders - [MARGIN_CALC] Using prices for AUDUSD: bid=0.6562900000, ask=0.65635562900000
2025-07-10 03:40:47,743 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDUSD, Type: BUY, Qty: 0.01000000, Price: 0.65635562900000, Margin: 6.56, Commission: 0.10
2025-07-10 03:40:47,750 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:40:47,750 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:40:47,750 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:40:47,750 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:40:47,750 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:40:47,750 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:40:47,750 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:40:47,750 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:40:47,750 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:40:47,750 - INFO - orders - [PENDING_ORDER] Total user margin: 14.36
2025-07-10 03:40:47,758 - INFO - orders - [PENDING_ORDER] Updated user 1 total margin to 14.36 (includes all symbols)
2025-07-10 03:40:47,778 - INFO - orders - [PENDING_ORDER] Order 8843080535 status is OPEN, margin/commission updated
2025-07-10 03:40:47,804 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:40:47,805 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:40:47,805 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:40:47,805 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:40:47,805 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:40:47,805 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:40:47,805 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:40:47,805 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:40:47,805 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:40:47,806 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:40:47,806 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:40:47,806 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:40:47,806 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 20.92
2025-07-10 03:40:47,812 - WARNING - orders - [PENDING_ORDER] Cache verification failed for user 1, retrying...
2025-07-10 03:40:47,815 - INFO - orders - [PENDING_ORDER] Successfully executed order 8843080535 for user 1
2025-07-10 03:40:47,815 - INFO - orders - [PENDING_ORDER] Order 8843080535: Final price=0.65635562900000, margin=6.56, commission=0.10
2025-07-10 03:40:47,815 - INFO - orders - [PENDING_ORDER_SUMMARY] Order 8843080535 executed: BUY_LIMIT -> BUY, Placed: 0.65645000, Triggered: 0.65644, Margin: 6.56, Commission: 0.10, AdditionalMargin: None
2025-07-10 03:41:47,449 - INFO - orders - [get_rejected_orders] user_type: demo
2025-07-10 03:41:49,828 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:41:49,829 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:41:49,829 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:41:49,829 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:41:49,829 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:41:49,830 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:41:49,830 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:41:49,830 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:41:49,830 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:41:49,830 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:41:49,830 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:41:49,831 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:41:49,831 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 20.92
2025-07-10 03:44:06,771 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: BUY
2025-07-10 03:44:07,223 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8976200000', 'o': '0.8976200000'}
2025-07-10 03:44:07,223 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8976200000, ask=0.89770976200000
2025-07-10 03:44:07,223 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8976200000, ask=0.89770976200000
2025-07-10 03:44:09,259 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.98 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:44:09,260 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-10 03:44:09,275 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:44:09,276 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-10 03:44:09,276 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-10 03:44:09,283 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3689400000'), 'o': Decimal('1.3689200000')}
2025-07-10 03:44:09,283 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3689400000
2025-07-10 03:44:09,283 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.98 CAD / 1.3689400000 = 6.559820006720528291963124753 USD
2025-07-10 03:44:09,283 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89770976200000, Margin: 6.559820006720528291963124753, Commission: 0.10
2025-07-10 03:44:09,284 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDCAD, OrderType: BUY, Quantity: 0.01, FullMargin: 6.559820006720528291963124753
2025-07-10 03:44:09,284 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-10 03:44:09,284 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.01, Margin=6.559820006720528291963124753
2025-07-10 03:44:09,284 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-10 03:44:09,284 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:44:09,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDCAD. Returning zero margin.
2025-07-10 03:44:09,286 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCAD
2025-07-10 03:44:09,286 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01, IsHedged=False
2025-07-10 03:44:09,286 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.9820006720528291963124753')], HighestMarginPerLot=655.9820006720528291963124753
2025-07-10 03:44:09,286 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCAD: CalculatedTotalMargin=6.56
2025-07-10 03:44:09,292 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:44:09,292 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDCAD, OrderType: BUY, MarginBefore: 0.0, MarginAfter: 6.56, AdditionalMargin: 6.56, OpenOrders: 0
2025-07-10 03:44:09,293 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.01, Margin=6.559820006720528291963124753
2025-07-10 03:44:09,300 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 03:44:09,300 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 03:44:09,301 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 03:44:09,305 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 03:44:09,305 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 03:44:09,306 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:09,325 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 03:44:09,337 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:44:09,337 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 03:44:09,338 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 03:44:09,338 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 03:44:09,338 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 03:44:09,338 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 03:44:09,338 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 03:44:09,338 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 03:44:09,339 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 03:44:09,339 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 03:44:09,397 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=351.31000000, margin=20.92000000 (was 14.36000000)
2025-07-10 03:44:09,397 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:44:09,398 - INFO - orders - [PERF] Order processing: 2.6243s
2025-07-10 03:44:09,415 - INFO - orders - [PERF] Order creation: 0.0171s
2025-07-10 03:44:09,415 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:44:09,415 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:44:11,476 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:44:11,486 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:44:11,512 - INFO - orders - [PERF] TOTAL place_order: 4.7450s
2025-07-10 03:44:11,541 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:44:11,541 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:11,541 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:44:11,541 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:44:11,541 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:44:11,541 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:44:11,541 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:44:11,541 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:44:11,542 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:44:11,542 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:11,542 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:44:11,542 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:44:11,542 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCAD
2025-07-10 03:44:11,542 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:11,543 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.982001')], HighestMarginPerLot=655.982001
2025-07-10 03:44:11,543 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCAD: CalculatedTotalMargin=6.56
2025-07-10 03:44:11,543 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 27.48
2025-07-10 03:44:11,573 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:44:11,573 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:11,573 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:44:11,574 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:44:11,574 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:44:11,574 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:44:11,574 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:44:11,574 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:44:11,574 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:44:11,575 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:11,575 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:44:11,575 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:44:11,575 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCAD
2025-07-10 03:44:11,575 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:11,575 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.982001')], HighestMarginPerLot=655.982001
2025-07-10 03:44:11,575 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCAD: CalculatedTotalMargin=6.56
2025-07-10 03:44:11,575 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 27.48
2025-07-10 03:44:11,582 - INFO - orders - Background balance/margin cache updated for user 1: balance=351.31000000, margin=27.48
2025-07-10 03:44:15,814 - INFO - orders - Order close request received - Order ID: 2180510646, User ID: 1, Close Price: 0.89761
2025-07-10 03:44:15,815 - INFO - orders - Request to close order 2180510646 for user 1 (user_type: demo) with price 0.89761. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-10 03:44:15,822 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 03:44:15,831 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCAD
2025-07-10 03:44:15,832 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:15,832 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.982001')], HighestMarginPerLot=655.982001
2025-07-10 03:44:15,832 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCAD: CalculatedTotalMargin=6.56
2025-07-10 03:44:15,832 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDCAD. Returning zero margin.
2025-07-10 03:44:15,836 - INFO - orders - Existing entry commission for order 2180510646: 0.10000000
2025-07-10 03:44:15,836 - INFO - orders - Commission calculation for order 2180510646: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 03:44:15,836 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.010000000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 2180510646)
2025-07-10 03:44:15,836 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-10 03:44:15,837 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:44:15,837 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-10 03:44:15,837 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-10 03:44:15,837 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3689400000'), 'o': Decimal('1.3689200000')}
2025-07-10 03:44:15,837 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3689400000
2025-07-10 03:44:15,837 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.010000000000000000000000 CAD / 1.3689400000 = -0.007304922056481657340716174558 USD
2025-07-10 03:44:15,890 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=351.10000000, margin=14.36
2025-07-10 03:44:15,891 - INFO - orders - Setting user data cache for user 1 with wallet_balance=351.10000000, margin=14.36
2025-07-10 03:44:15,891 - INFO - orders - User data cache updated for user 1
2025-07-10 03:44:15,893 - INFO - orders - Balance/margin cache updated for user 1: balance=351.10000000, margin=14.36
2025-07-10 03:44:15,893 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 03:44:15,893 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 03:44:15,896 - INFO - orders - Fetched 4 open orders for user 1
2025-07-10 03:44:15,898 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 03:44:15,898 - INFO - orders - Updated static orders cache for user 1 with 4 open orders and 1 pending orders
2025-07-10 03:44:15,900 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:44:15,900 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:15,900 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:44:15,900 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:44:15,900 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:44:15,900 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:44:15,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:44:15,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:44:15,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:44:15,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:15,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:44:15,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:44:15,901 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 20.92
2025-07-10 03:44:15,903 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=351.10000000, margin=20.92
2025-07-10 03:44:15,903 - INFO - orders - Publishing order update for user 1
2025-07-10 03:44:15,904 - INFO - orders - Publishing user data update for user 1
2025-07-10 03:44:15,904 - INFO - orders - Publishing market data trigger
2025-07-10 03:44:17,233 - INFO - orders - Order close request received - Order ID: 8843080535, User ID: 1, Close Price: 0.6562
2025-07-10 03:44:17,233 - INFO - orders - Request to close order 8843080535 for user 1 (user_type: demo) with price 0.6562. Frontend provided type: BUY, company: AUDUSD, status: CLOSED, frontend_status: CLOSED.
2025-07-10 03:44:17,242 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 03:44:17,248 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDUSD
2025-07-10 03:44:17,248 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:17,248 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDUSD: AllMarginsPerLot=[Decimal('656')], HighestMarginPerLot=656
2025-07-10 03:44:17,248 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDUSD: CalculatedTotalMargin=6.56
2025-07-10 03:44:17,249 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDUSD. Returning zero margin.
2025-07-10 03:44:17,259 - INFO - orders - Existing entry commission for order 8843080535: 0.10000000
2025-07-10 03:44:17,259 - INFO - orders - Commission calculation for order 8843080535: entry=0.10000000, exit=0.0, total=0.10
2025-07-10 03:44:17,259 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.240000000000000000000000 USD to USD for PnL on Close (user_id: 1, position: 8843080535)
2025-07-10 03:44:17,259 - INFO - orders - [CURRENCY_CONVERT] Currency is already USD, no conversion needed
2025-07-10 03:44:17,277 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=350.76000000, margin=7.80
2025-07-10 03:44:17,277 - INFO - orders - Setting user data cache for user 1 with wallet_balance=350.76000000, margin=7.80
2025-07-10 03:44:17,278 - INFO - orders - User data cache updated for user 1
2025-07-10 03:44:17,279 - INFO - orders - Balance/margin cache updated for user 1: balance=350.76000000, margin=7.80
2025-07-10 03:44:17,279 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 03:44:17,279 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 03:44:17,281 - INFO - orders - Fetched 3 open orders for user 1
2025-07-10 03:44:17,284 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 03:44:17,285 - INFO - orders - Updated static orders cache for user 1 with 3 open orders and 1 pending orders
2025-07-10 03:44:17,287 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:44:17,287 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:17,287 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:44:17,287 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:44:17,287 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:44:17,287 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:44:17,287 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:44:17,287 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:44:17,287 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:44:17,288 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=350.76000000, margin=14.36
2025-07-10 03:44:17,288 - INFO - orders - Publishing order update for user 1
2025-07-10 03:44:17,289 - INFO - orders - Publishing user data update for user 1
2025-07-10 03:44:17,289 - INFO - orders - Publishing market data trigger
2025-07-10 03:44:21,973 - INFO - orders - Order close request received - Order ID: 5127352554, User ID: 1, Close Price: 0.99985
2025-07-10 03:44:21,973 - INFO - orders - Request to close order 5127352554 for user 1 (user_type: demo) with price 0.99985. Frontend provided type: BUY, company: AUDSGD, status: CLOSED, frontend_status: CLOSED.
2025-07-10 03:44:21,985 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 03:44:21,993 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDSGD
2025-07-10 03:44:21,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:44:21,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376'), Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:44:21,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:44:21,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDSGD
2025-07-10 03:44:21,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:21,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:44:21,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:44:21,998 - INFO - orders - Existing entry commission for order 5127352554: 0.10000000
2025-07-10 03:44:21,998 - INFO - orders - Commission calculation for order 5127352554: entry=0.10000000, exit=0.0, total=0.10
2025-07-10 03:44:21,998 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.300000000000000000000000 SGD to USD for PnL on Close (user_id: 1, position: 5127352554)
2025-07-10 03:44:21,998 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: SGDUSD
2025-07-10 03:44:21,998 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:44:21,998 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for SGDUSD, trying inverse
2025-07-10 03:44:21,998 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDSGD
2025-07-10 03:44:21,999 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.2806600000'), 'o': Decimal('1.2806200000')}
2025-07-10 03:44:21,999 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.2806600000
2025-07-10 03:44:21,999 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.300000000000000000000000 SGD / 1.2806600000 = -0.2342542126715912107819405619 USD
2025-07-10 03:44:22,011 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=350.43000000, margin=7.80
2025-07-10 03:44:22,011 - INFO - orders - Setting user data cache for user 1 with wallet_balance=350.43000000, margin=7.80
2025-07-10 03:44:22,012 - INFO - orders - User data cache updated for user 1
2025-07-10 03:44:22,013 - INFO - orders - Balance/margin cache updated for user 1: balance=350.43000000, margin=7.80
2025-07-10 03:44:22,013 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 03:44:22,013 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 03:44:22,015 - INFO - orders - Fetched 2 open orders for user 1
2025-07-10 03:44:22,017 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 03:44:22,017 - INFO - orders - Updated static orders cache for user 1 with 2 open orders and 1 pending orders
2025-07-10 03:44:22,019 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:44:22,019 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:22,019 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:44:22,019 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:44:22,019 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDSGD
2025-07-10 03:44:22,020 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:22,020 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:44:22,020 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:44:22,020 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 14.36
2025-07-10 03:44:22,020 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=350.43000000, margin=14.36
2025-07-10 03:44:22,020 - INFO - orders - Publishing order update for user 1
2025-07-10 03:44:22,021 - INFO - orders - Publishing user data update for user 1
2025-07-10 03:44:22,021 - INFO - orders - Publishing market data trigger
2025-07-10 03:44:23,585 - INFO - orders - Order close request received - Order ID: 7182402224, User ID: 1, Close Price: 1.00015
2025-07-10 03:44:23,585 - INFO - orders - Request to close order 7182402224 for user 1 (user_type: demo) with price 1.00015. Frontend provided type: SELL, company: AUDSGD, status: CLOSED, frontend_status: CLOSED.
2025-07-10 03:44:23,596 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 03:44:23,606 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDSGD
2025-07-10 03:44:23,606 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:23,606 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDSGD: AllMarginsPerLot=[Decimal('780.847376')], HighestMarginPerLot=780.847376
2025-07-10 03:44:23,606 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDSGD: CalculatedTotalMargin=7.81
2025-07-10 03:44:23,606 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDSGD. Returning zero margin.
2025-07-10 03:44:23,611 - INFO - orders - Existing entry commission for order 7182402224: 0.10000000
2025-07-10 03:44:23,611 - INFO - orders - Commission calculation for order 7182402224: entry=0.10000000, exit=0.0, total=0.10
2025-07-10 03:44:23,611 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.300000000000000000000000 SGD to USD for PnL on Close (user_id: 1, position: 7182402224)
2025-07-10 03:44:23,611 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: SGDUSD
2025-07-10 03:44:23,612 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:44:23,612 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for SGDUSD, trying inverse
2025-07-10 03:44:23,612 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDSGD
2025-07-10 03:44:23,612 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.2806600000'), 'o': Decimal('1.2806200000')}
2025-07-10 03:44:23,612 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.2806600000
2025-07-10 03:44:23,612 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.300000000000000000000000 SGD / 1.2806600000 = -0.2342542126715912107819405619 USD
2025-07-10 03:44:23,630 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=350.10000000, margin=0
2025-07-10 03:44:23,630 - INFO - orders - Setting user data cache for user 1 with wallet_balance=350.10000000, margin=0
2025-07-10 03:44:23,631 - INFO - orders - User data cache updated for user 1
2025-07-10 03:44:23,632 - INFO - orders - Balance/margin cache updated for user 1: balance=350.10000000, margin=0
2025-07-10 03:44:23,632 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 03:44:23,632 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 03:44:23,634 - INFO - orders - Fetched 1 open orders for user 1
2025-07-10 03:44:23,637 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 03:44:23,638 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 1 pending orders
2025-07-10 03:44:23,640 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:44:23,640 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:23,640 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:44:23,640 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:44:23,640 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:44:23,641 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=350.10000000, margin=6.55
2025-07-10 03:44:23,641 - INFO - orders - Publishing order update for user 1
2025-07-10 03:44:23,641 - INFO - orders - Publishing user data update for user 1
2025-07-10 03:44:23,642 - INFO - orders - Publishing market data trigger
2025-07-10 03:44:24,794 - INFO - orders - Order close request received - Order ID: 2622196470, User ID: 1, Close Price: 0.5213300000000001
2025-07-10 03:44:24,795 - INFO - orders - Request to close order 2622196470 for user 1 (user_type: demo) with price 0.5213300000000001. Frontend provided type: BUY, company: AUDCHF, status: CLOSED, frontend_status: CLOSED.
2025-07-10 03:44:24,809 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 03:44:24,825 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDCHF
2025-07-10 03:44:24,825 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:44:24,825 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('654.662428')], HighestMarginPerLot=654.662428
2025-07-10 03:44:24,825 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:44:24,826 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDCHF. Returning zero margin.
2025-07-10 03:44:24,829 - INFO - orders - Existing entry commission for order 2622196470: 0.10000000
2025-07-10 03:44:24,829 - INFO - orders - Commission calculation for order 2622196470: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 03:44:24,830 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.09999999999990000000000000000 CHF to USD for PnL on Close (user_id: 1, position: 2622196470)
2025-07-10 03:44:24,830 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-10 03:44:24,830 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:44:24,830 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-10 03:44:24,830 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-10 03:44:24,831 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7958300000'), 'o': Decimal('0.7958000000')}
2025-07-10 03:44:24,831 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7958300000
2025-07-10 03:44:24,832 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.09999999999990000000000000000 CHF / 0.7958300000 = -0.1256549765652212155862432932 USD
2025-07-10 03:44:24,855 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=349.77000000, margin=0
2025-07-10 03:44:24,855 - INFO - orders - Setting user data cache for user 1 with wallet_balance=349.77000000, margin=0
2025-07-10 03:44:24,856 - INFO - orders - User data cache updated for user 1
2025-07-10 03:44:24,857 - INFO - orders - Balance/margin cache updated for user 1: balance=349.77000000, margin=0
2025-07-10 03:44:24,857 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 03:44:24,857 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 03:44:24,860 - INFO - orders - Fetched 0 open orders for user 1
2025-07-10 03:44:24,862 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 03:44:24,862 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 1 pending orders
2025-07-10 03:44:24,867 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=349.77000000, margin=0.0
2025-07-10 03:44:24,867 - INFO - orders - Publishing order update for user 1
2025-07-10 03:44:24,867 - INFO - orders - Publishing user data update for user 1
2025-07-10 03:44:24,868 - INFO - orders - Publishing market data trigger
2025-07-10 03:49:43,917 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-10 03:49:45,127 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-10 03:49:45,127 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-10 03:49:45,128 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-10 03:49:45,128 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-10 03:49:49,206 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-10 03:49:49,207 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-10 03:49:50,130 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-10 03:49:55,128 - INFO - orders - Starting the users with orders cache updater task.
2025-07-10 03:49:55,990 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 03:49:55,993 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 03:49:55,993 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 03:49:55,993 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 03:49:55,994 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 03:49:55,994 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 03:50:25,127 - INFO - orders - [get_rejected_orders] user_type: demo
2025-07-10 03:50:38,328 - INFO - orders - Order placement request received - User: 1, Symbol: AUDJPY, Type: BUY
2025-07-10 03:50:38,720 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.9100000000', 'o': '95.9060000000'}
2025-07-10 03:50:38,720 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.9100000000, ask=95.91959100000000
2025-07-10 03:50:38,720 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.9100000000, ask=95.91959100000000
2025-07-10 03:50:38,722 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 959.20 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:50:38,722 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 03:50:38,723 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:50:38,723 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 03:50:38,724 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 03:50:38,725 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 03:50:38,725 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 03:50:38,725 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 959.20 JPY / 146.4780000000 = 6.548423654064091535930310354 USD
2025-07-10 03:50:38,725 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 95.91959100000000, Margin: 6.548423654064091535930310354, Commission: 0.10
2025-07-10 03:50:38,725 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDJPY, OrderType: BUY, Quantity: 0.01, FullMargin: 6.548423654064091535930310354
2025-07-10 03:50:38,725 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-10 03:50:38,726 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.01, Margin=6.548423654064091535930310354
2025-07-10 03:50:38,726 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-10 03:50:38,726 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:50:38,726 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDJPY. Returning zero margin.
2025-07-10 03:50:38,726 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:38,726 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01, IsHedged=False
2025-07-10 03:50:38,726 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.8423654064091535930310354')], HighestMarginPerLot=654.8423654064091535930310354
2025-07-10 03:50:38,726 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:38,727 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:50:38,728 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDJPY, OrderType: BUY, MarginBefore: 0.0, MarginAfter: 6.55, AdditionalMargin: 6.55, OpenOrders: 0
2025-07-10 03:50:38,728 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.01, Margin=6.548423654064091535930310354
2025-07-10 03:50:38,755 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=349.77000000, margin=6.55000000 (was 0E-8)
2025-07-10 03:50:38,755 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:50:38,755 - INFO - orders - [PERF] Order processing: 0.4195s
2025-07-10 03:50:38,785 - INFO - orders - [PERF] Order creation: 0.0297s
2025-07-10 03:50:38,785 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:50:38,786 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:50:38,786 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:50:38,789 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:50:38,794 - INFO - orders - [PERF] TOTAL place_order: 0.4698s
2025-07-10 03:50:38,816 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:38,817 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:50:38,817 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.842365')], HighestMarginPerLot=654.842365
2025-07-10 03:50:38,817 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:38,818 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:50:38,839 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:38,839 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:50:38,839 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.842365')], HighestMarginPerLot=654.842365
2025-07-10 03:50:38,839 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:38,839 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:50:38,844 - INFO - orders - Background balance/margin cache updated for user 1: balance=349.77000000, margin=6.55
2025-07-10 03:50:45,306 - INFO - orders - Order placement request received - User: 1, Symbol: AUDJPY, Type: SELL
2025-07-10 03:50:45,656 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.9100000000', 'o': '95.9040000000'}
2025-07-10 03:50:45,656 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.9100000000, ask=95.91959100000000
2025-07-10 03:50:45,656 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.9100000000, ask=95.91959100000000
2025-07-10 03:50:45,658 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 959.10 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:50:45,658 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 03:50:45,659 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:50:45,660 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 03:50:45,660 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 03:50:45,660 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 03:50:45,661 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 03:50:45,661 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 959.10 JPY / 146.4780000000 = 6.547740957686478515544996518 USD
2025-07-10 03:50:45,661 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 95.9100000000, Margin: 6.547740957686478515544996518, Commission: 0.10
2025-07-10 03:50:45,661 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDJPY, OrderType: SELL, Quantity: 0.01, FullMargin: 6.547740957686478515544996518
2025-07-10 03:50:45,661 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 1
2025-07-10 03:50:45,661 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=SELL, Qty=0.01, Margin=6.547740957686478515544996518
2025-07-10 03:50:45,661 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 1 existing orders + 1 new order
2025-07-10 03:50:45,661 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:50:45,662 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:45,662 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 03:50:45,662 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.842365')], HighestMarginPerLot=654.842365
2025-07-10 03:50:45,662 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:45,662 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:45,662 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01, NetQty=0.01000000, IsHedged=True
2025-07-10 03:50:45,662 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.842365'), Decimal('654.7740957686478515544996518')], HighestMarginPerLot=654.842365
2025-07-10 03:50:45,662 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:45,663 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:50:45,663 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDJPY, OrderType: SELL, MarginBefore: 6.55, MarginAfter: 6.55, AdditionalMargin: 0.0, OpenOrders: 1
2025-07-10 03:50:45,663 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=SELL, Qty=0.01, Margin=6.547740957686478515544996518
2025-07-10 03:50:45,679 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=349.77000000, margin=6.55000000 (was 6.55000000)
2025-07-10 03:50:45,679 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:50:45,679 - INFO - orders - [PERF] Order processing: 0.3720s
2025-07-10 03:50:45,708 - INFO - orders - [PERF] Order creation: 0.0286s
2025-07-10 03:50:45,708 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:50:45,709 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:50:45,710 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:50:45,711 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:50:45,714 - INFO - orders - [PERF] TOTAL place_order: 0.4083s
2025-07-10 03:50:45,765 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:45,765 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:50:45,765 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.842365'), Decimal('654.774096')], HighestMarginPerLot=654.842365
2025-07-10 03:50:45,766 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:45,768 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:50:45,791 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:45,791 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:50:45,791 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.842365'), Decimal('654.774096')], HighestMarginPerLot=654.842365
2025-07-10 03:50:45,792 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:45,792 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:50:45,796 - INFO - orders - Background balance/margin cache updated for user 1: balance=349.77000000, margin=6.55
2025-07-10 03:50:51,953 - INFO - orders - Order close request received - Order ID: 6837172294, User ID: 1, Close Price: 95.86
2025-07-10 03:50:51,954 - INFO - orders - Request to close order 6837172294 for user 1 (user_type: demo) with price 95.86. Frontend provided type: BUY, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-10 03:50:51,987 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 03:50:52,009 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:52,010 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=True
2025-07-10 03:50:52,011 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.842365'), Decimal('654.774096')], HighestMarginPerLot=654.842365
2025-07-10 03:50:52,020 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:52,021 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:52,021 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:50:52,032 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096')], HighestMarginPerLot=654.774096
2025-07-10 03:50:52,036 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:52,061 - INFO - orders - Existing entry commission for order 6837172294: 0.10000000
2025-07-10 03:50:52,062 - INFO - orders - Commission calculation for order 6837172294: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 03:50:52,062 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -100.000000000000000000000000 JPY to USD for PnL on Close (user_id: 1, position: 6837172294)
2025-07-10 03:50:52,062 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 03:50:52,070 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:50:52,071 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 03:50:52,071 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 03:50:52,074 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 03:50:52,074 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 03:50:52,075 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -100.000000000000000000000000 JPY / 146.4780000000 = -0.6826963776130203853138355248 USD
2025-07-10 03:50:52,126 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=348.89000000, margin=6.55
2025-07-10 03:50:52,126 - INFO - orders - Setting user data cache for user 1 with wallet_balance=348.89000000, margin=6.55
2025-07-10 03:50:52,127 - INFO - orders - User data cache updated for user 1
2025-07-10 03:50:52,130 - INFO - orders - Balance/margin cache updated for user 1: balance=348.89000000, margin=6.55
2025-07-10 03:50:52,130 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 03:50:52,130 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 03:50:52,133 - INFO - orders - Fetched 1 open orders for user 1
2025-07-10 03:50:52,137 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 03:50:52,137 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 1 pending orders
2025-07-10 03:50:52,141 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:52,141 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:50:52,141 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096')], HighestMarginPerLot=654.774096
2025-07-10 03:50:52,142 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:52,142 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 03:50:52,144 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=348.89000000, margin=6.55
2025-07-10 03:50:52,144 - INFO - orders - Publishing order update for user 1
2025-07-10 03:50:52,145 - INFO - orders - Publishing user data update for user 1
2025-07-10 03:50:52,146 - INFO - orders - Publishing market data trigger
2025-07-10 03:50:55,149 - INFO - orders - Order placement request received - User: 1, Symbol: AUDJPY, Type: SELL
2025-07-10 03:50:55,485 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.9050000000', 'o': '95.9000000000'}
2025-07-10 03:50:55,486 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.9050000000, ask=95.91459050000000
2025-07-10 03:50:55,486 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.9050000000, ask=95.91459050000000
2025-07-10 03:50:55,487 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 959.05 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:50:55,487 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 03:50:55,488 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:50:55,489 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 03:50:55,489 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 03:50:55,490 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 03:50:55,491 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 03:50:55,492 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 959.05 JPY / 146.4780000000 = 6.547399609497672005352339600 USD
2025-07-10 03:50:55,492 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 95.9050000000, Margin: 6.547399609497672005352339600, Commission: 0.10
2025-07-10 03:50:55,492 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDJPY, OrderType: SELL, Quantity: 0.01, FullMargin: 6.547399609497672005352339600
2025-07-10 03:50:55,492 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 1
2025-07-10 03:50:55,493 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=SELL, Qty=0.01, Margin=6.547399609497672005352339600
2025-07-10 03:50:55,493 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 1 existing orders + 1 new order
2025-07-10 03:50:55,493 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:50:55,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:55,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 03:50:55,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096')], HighestMarginPerLot=654.774096
2025-07-10 03:50:55,495 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 03:50:55,495 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:55,495 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=False
2025-07-10 03:50:55,495 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.7399609497672005352339600')], HighestMarginPerLot=654.774096
2025-07-10 03:50:55,496 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:50:55,497 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:50:55,497 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDJPY, OrderType: SELL, MarginBefore: 6.55, MarginAfter: 13.10, AdditionalMargin: 6.55, OpenOrders: 1
2025-07-10 03:50:55,497 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=SELL, Qty=0.01, Margin=6.547399609497672005352339600
2025-07-10 03:50:55,522 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=348.89000000, margin=13.10000000 (was 6.55000000)
2025-07-10 03:50:55,522 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:50:55,523 - INFO - orders - [PERF] Order processing: 0.3706s
2025-07-10 03:50:55,542 - INFO - orders - [PERF] Order creation: 0.0189s
2025-07-10 03:50:55,542 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:50:55,542 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:50:55,543 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:50:55,546 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:50:55,548 - INFO - orders - [PERF] TOTAL place_order: 0.3999s
2025-07-10 03:50:55,577 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:55,578 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=False
2025-07-10 03:50:55,580 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961')], HighestMarginPerLot=654.774096
2025-07-10 03:50:55,580 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:50:55,581 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:50:55,601 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 03:50:55,602 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=False
2025-07-10 03:50:55,602 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961')], HighestMarginPerLot=654.774096
2025-07-10 03:50:55,602 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:50:55,602 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:50:55,605 - INFO - orders - Background balance/margin cache updated for user 1: balance=348.89000000, margin=13.10
2025-07-10 03:51:02,144 - INFO - orders - Order placement request received - User: 1, Symbol: AUDJPY, Type: BUY
2025-07-10 03:51:02,444 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.9030000000', 'o': '95.8980000000'}
2025-07-10 03:51:02,445 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.9030000000, ask=95.91259030000000
2025-07-10 03:51:02,445 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.9030000000, ask=95.91259030000000
2025-07-10 03:51:02,446 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 959.13 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:51:02,446 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 03:51:02,447 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:51:02,447 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 03:51:02,447 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 03:51:02,447 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 03:51:02,447 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 03:51:02,448 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 959.13 JPY / 146.4780000000 = 6.547945766599762421660590669 USD
2025-07-10 03:51:02,448 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 95.91259030000000, Margin: 6.547945766599762421660590669, Commission: 0.10
2025-07-10 03:51:02,448 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDJPY, OrderType: BUY, Quantity: 0.01, FullMargin: 6.547945766599762421660590669
2025-07-10 03:51:02,448 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 2
2025-07-10 03:51:02,448 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.01, Margin=6.547945766599762421660590669
2025-07-10 03:51:02,448 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 2 existing orders + 1 new order
2025-07-10 03:51:02,448 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 03:51:02,449 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:02,449 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=False
2025-07-10 03:51:02,449 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961')], HighestMarginPerLot=654.774096
2025-07-10 03:51:02,449 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:02,449 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:02,449 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:02,449 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.7945766599762421660590669')], HighestMarginPerLot=654.7945766599762421660590669
2025-07-10 03:51:02,449 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:02,450 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 03:51:02,450 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDJPY, OrderType: BUY, MarginBefore: 13.10, MarginAfter: 13.10, AdditionalMargin: 0.0, OpenOrders: 2
2025-07-10 03:51:02,450 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.01, Margin=6.547945766599762421660590669
2025-07-10 03:51:02,458 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=348.89000000, margin=13.10000000 (was 13.10000000)
2025-07-10 03:51:02,459 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 03:51:02,459 - INFO - orders - [PERF] Order processing: 0.3139s
2025-07-10 03:51:02,469 - INFO - orders - [PERF] Order creation: 0.0100s
2025-07-10 03:51:02,469 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 03:51:02,469 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 03:51:02,470 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 03:51:02,471 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 03:51:02,471 - INFO - orders - [PERF] TOTAL place_order: 0.3276s
2025-07-10 03:51:02,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:02,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:02,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 03:51:02,494 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:02,495 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:51:02,513 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:02,513 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:02,514 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 03:51:02,514 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:02,514 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:51:02,520 - INFO - orders - Background balance/margin cache updated for user 1: balance=348.89000000, margin=13.10
2025-07-10 03:51:10,508 - INFO - orders - Pending order placement request received - User ID: 1, Symbol: AUDJPY, Type: BUY_LIMIT, Quantity: 0.01
2025-07-10 03:51:10,525 - INFO - orders - Validating pending order price: Order type=BUY_LIMIT, Order price=95.957, Current buy price=95.959, Current sell price=95.854
2025-07-10 03:51:10,534 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-10 03:51:10,539 - INFO - orders - [DEBUG] User data from cache: {'wallet_balance': Decimal('348.89000000'), 'margin': Decimal('13.10000000'), 'group_name': 'Group B', 'leverage': Decimal('100.00'), 'user_id': 1, 'user_type': 'demo'}
2025-07-10 03:51:10,540 - INFO - orders - [DEBUG] Group name: Group B
2025-07-10 03:51:10,541 - INFO - orders - User 1 is_barclays_live_user: False (user_type: demo, sending_orders_normalized: barclays)
2025-07-10 03:51:10,547 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDJPY: contract_size=100000.00000000, profit_currency=JPY, digit=3.00000
2025-07-10 03:51:10,840 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.9090000000', 'o': '95.9040000000'}
2025-07-10 03:51:10,840 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.9090000000, ask=95.91859090000000
2025-07-10 03:51:10,840 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.9090000000, ask=95.91859090000000
2025-07-10 03:51:10,841 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 959.19 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:51:10,841 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 03:51:10,842 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:51:10,842 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 03:51:10,842 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 03:51:10,844 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 03:51:10,844 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 03:51:10,844 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 959.19 JPY / 146.4780000000 = 6.548355384426330233891778970 USD
2025-07-10 03:51:10,845 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY_LIMIT, Qty: 0.01, Price: 95.91859090000000, Margin: 6.548355384426330233891778970, Commission: 0.10
2025-07-10 03:51:10,845 - INFO - orders - Calculated initial margin: 6.548355384426330233891778970, commission: 0.10 for pending order 6007857887
2025-07-10 03:51:10,855 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '6007857887', 'order_company_name': 'AUDJPY', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('95.957'), 'user_type': 'demo', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6482718404', 'takeprofit_id': '3654815668', 'order_user_id': 1, 'order_status': 'PENDING', 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.548355384426330233891778970'), 'commission': Decimal('0.10'), 'open_time': None}
2025-07-10 03:51:10,855 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 1 at price 95.957
2025-07-10 03:51:10,856 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '6007857887', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDJPY', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('95.957'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.548355384426330233891778970'), 'commission': Decimal('0.10'), 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6482718404', 'takeprofit_id': '3654815668', 'close_id': None}
2025-07-10 03:51:10,876 - INFO - orders - Order 6007857887 verified in database on attempt 1 before adding to Redis.
2025-07-10 03:51:10,879 - INFO - orders - Pending order 6007857887 added to Redis for non-Barclays user or demo user.
2025-07-10 03:51:10,886 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:10,886 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:10,886 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 03:51:10,886 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:10,886 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:51:10,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:10,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:10,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 03:51:10,901 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:10,902 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:51:10,907 - INFO - orders - [PERF] TOTAL place_order: 0.3997s
2025-07-10 03:51:10,927 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:10,927 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:10,927 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 03:51:10,927 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:10,927 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:51:10,948 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:10,949 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:10,949 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 03:51:10,949 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:10,949 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:51:10,955 - INFO - orders - Background balance/margin cache updated for user 1: balance=348.89000000, margin=13.10
2025-07-10 03:51:12,789 - INFO - orders - [PENDING_CHECK] Found 1 matching BUY_LIMIT orders for AUDJPY at price 95.955
2025-07-10 03:51:12,792 - INFO - orders - [PENDING_ORDER] Starting execution of order 6007857887 for user 1
2025-07-10 03:51:12,792 - INFO - orders - [PENDING_ORDER] Order 6007857887: Placed at 95.95700000, Triggered at 95.955
2025-07-10 03:51:12,792 - INFO - orders - [PENDING_ORDER] Order 6007857887: Type BUY_LIMIT -> BUY
2025-07-10 03:51:12,798 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDJPY: contract_size=100000.00000000, profit_currency=JPY, digit=3.00000
2025-07-10 03:51:13,087 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.9050000000', 'o': '95.9010000000'}
2025-07-10 03:51:13,088 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.9050000000, ask=95.91459050000000
2025-07-10 03:51:13,088 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.9050000000, ask=95.91459050000000
2025-07-10 03:51:13,089 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 959.15 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 03:51:13,089 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 03:51:13,089 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 03:51:13,090 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 03:51:13,090 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 03:51:13,090 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 03:51:13,090 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 03:51:13,091 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 959.15 JPY / 146.4780000000 = 6.548082305875285025737653436 USD
2025-07-10 03:51:13,091 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01000000, Price: 95.91459050000000, Margin: 6.548082305875285025737653436, Commission: 0.10
2025-07-10 03:51:13,101 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:13,101 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:13,102 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 03:51:13,102 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:13,102 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:51:13,102 - INFO - orders - [PENDING_ORDER] Total user margin: 13.10
2025-07-10 03:51:13,115 - INFO - orders - [PENDING_ORDER] Updated user 1 total margin to 13.10 (includes all symbols)
2025-07-10 03:51:13,141 - INFO - orders - [PENDING_ORDER] Order 6007857887 status is OPEN, margin/commission updated
2025-07-10 03:51:13,173 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 4 positions for User 1, Symbol AUDJPY
2025-07-10 03:51:13,173 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.02000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 03:51:13,173 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577'), Decimal('654.808231')], HighestMarginPerLot=654.808231
2025-07-10 03:51:13,173 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 03:51:13,174 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 03:51:13,179 - WARNING - orders - [PENDING_ORDER] Cache verification failed for user 1, retrying...
2025-07-10 03:51:13,182 - INFO - orders - [PENDING_ORDER] Successfully executed order 6007857887 for user 1
2025-07-10 03:51:13,182 - INFO - orders - [PENDING_ORDER] Order 6007857887: Final price=95.91459050000000, margin=6.548082305875285025737653436, commission=0.10
2025-07-10 03:51:13,182 - INFO - orders - [PENDING_ORDER_SUMMARY] Order 6007857887 executed: BUY_LIMIT -> BUY, Placed: 95.95700000, Triggered: 95.955, Margin: 6.548082305875285025737653436, Commission: 0.10, AdditionalMargin: None
2025-07-10 04:05:01,177 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-10 04:05:02,323 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-10 04:05:02,323 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-10 04:05:02,323 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-10 04:05:02,323 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-10 04:05:06,421 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-10 04:05:06,421 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-10 04:05:07,325 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-10 04:05:12,321 - INFO - orders - Starting the users with orders cache updater task.
2025-07-10 04:05:13,284 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 04:05:13,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 04:05:13,285 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 04:05:23,786 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 4 positions for User 1, Symbol AUDJPY
2025-07-10 04:05:23,787 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.02000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:05:23,787 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577'), Decimal('654.808231')], HighestMarginPerLot=654.808231
2025-07-10 04:05:23,787 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:05:23,787 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 04:10:23,641 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 04:10:23,641 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 04:10:23,641 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 04:10:23,641 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 04:10:23,641 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 04:10:23,642 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 04:10:23,643 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 04:10:23,643 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 04:10:25,502 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 4 positions for User 1, Symbol AUDJPY
2025-07-10 04:10:25,503 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.02000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:10:25,503 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577'), Decimal('654.808231')], HighestMarginPerLot=654.808231
2025-07-10 04:10:25,503 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:10:25,503 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 04:15:23,718 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 04:15:23,718 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 04:15:23,719 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 04:15:23,719 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 04:15:26,031 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 4 positions for User 1, Symbol AUDJPY
2025-07-10 04:15:26,032 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.02000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:15:26,032 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577'), Decimal('654.808231')], HighestMarginPerLot=654.808231
2025-07-10 04:15:26,032 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:15:26,032 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 04:28:32,980 - INFO - orders - [CLEANUP] Starting pending order stream cleanup
2025-07-10 04:28:34,177 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream
2025-07-10 04:28:34,178 - INFO - orders - [CLEANUP] Pending order stream cleanup completed
2025-07-10 04:28:34,178 - INFO - orders - [CLEANUP] Starting pending order stream cleanup with trigger price validation
2025-07-10 04:28:34,189 - INFO - orders - [PENDING_TRIGGER_WORKER] Starting pending order trigger worker
2025-07-10 04:28:38,308 - INFO - orders - [CLEANUP] Cleared pending_trigger_queue stream to remove old format entries
2025-07-10 04:28:38,308 - INFO - orders - [CLEANUP] Pending order stream cleanup with trigger price validation completed
2025-07-10 04:28:39,183 - INFO - orders - Starting the simplified pending order checker background task.
2025-07-10 04:28:44,179 - INFO - orders - Starting the users with orders cache updater task.
2025-07-10 04:28:45,228 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 9 positions for User 4, Symbol AUDCAD
2025-07-10 04:28:45,228 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: TotalBuyQty=0.07000000, TotalSellQty=0.02000000, NetQty=0.07000000, IsHedged=True
2025-07-10 04:28:45,228 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCAD: AllMarginsPerLot=[Decimal('655.706338'), Decimal('655.701512'), Decimal('655.759422'), Decimal('655.691862'), Decimal('655.696687'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764'), Decimal('650.706764')], HighestMarginPerLot=655.759422
2025-07-10 04:28:45,228 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCAD: CalculatedTotalMargin=45.90
2025-07-10 04:28:45,228 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 4, Symbol AUDCHF
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDCHF: AllMarginsPerLot=[Decimal('655.464939')], HighestMarginPerLot=655.464939
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDCHF: CalculatedTotalMargin=6.55
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 6 positions for User 4, Symbol AUDJPY
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: TotalBuyQty=0.06000000, TotalSellQty=0, NetQty=0.06000000, IsHedged=False
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDJPY: AllMarginsPerLot=[Decimal('95100'), Decimal('655.103666'), Decimal('651.752583'), Decimal('651.745686'), Decimal('651.787069'), Decimal('653.442838')], HighestMarginPerLot=95100
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDJPY: CalculatedTotalMargin=5706.00
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 4, Symbol AUDSGD
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: TotalBuyQty=0.02000000, TotalSellQty=0, NetQty=0.02000000, IsHedged=False
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 4, Symbol AUDSGD: AllMarginsPerLot=[Decimal('783.177351'), Decimal('783.177351')], HighestMarginPerLot=783.177351
2025-07-10 04:28:45,229 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 4, Symbol AUDSGD: CalculatedTotalMargin=15.66
2025-07-10 04:28:45,229 - INFO - orders - [TOTAL_USER_MARGIN] User 4 total margin across all symbols: 5774.11
2025-07-10 04:28:49,385 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 4 positions for User 1, Symbol AUDJPY
2025-07-10 04:28:49,385 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.02000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:28:49,386 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577'), Decimal('654.808231')], HighestMarginPerLot=654.808231
2025-07-10 04:28:49,386 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:28:49,386 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 04:32:48,524 - INFO - orders - [get_rejected_orders] user_type: demo
2025-07-10 04:32:48,983 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 4 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:48,983 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.02000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:32:48,983 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577'), Decimal('654.808231')], HighestMarginPerLot=654.808231
2025-07-10 04:32:48,983 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:32:48,983 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 04:32:57,190 - INFO - orders - Order close request received - Order ID: 6007857887, User ID: 1, Close Price: 95.904
2025-07-10 04:32:57,190 - INFO - orders - Request to close order 6007857887 for user 1 (user_type: demo) with price 95.904. Frontend provided type: BUY, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-10 04:32:57,208 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 04:32:57,233 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 4 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:57,234 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.02000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:32:57,234 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577'), Decimal('654.808231')], HighestMarginPerLot=654.808231
2025-07-10 04:32:57,235 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:32:57,235 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:57,236 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:32:57,236 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 04:32:57,237 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:32:57,254 - INFO - orders - Existing entry commission for order 6007857887: 0.10000000
2025-07-10 04:32:57,254 - INFO - orders - Commission calculation for order 6007857887: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 04:32:57,255 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -51.000000000000000000000000 JPY to USD for PnL on Close (user_id: 1, position: 6007857887)
2025-07-10 04:32:57,255 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 04:32:57,257 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 04:32:57,257 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 04:32:57,258 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 04:32:57,260 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 04:32:57,260 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 04:32:57,261 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -51.000000000000000000000000 JPY / 146.4780000000 = -0.3481751525826403965100561176 USD
2025-07-10 04:32:57,321 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=348.34000000, margin=13.10
2025-07-10 04:32:57,321 - INFO - orders - Setting user data cache for user 1 with wallet_balance=348.34000000, margin=13.10
2025-07-10 04:32:57,323 - INFO - orders - User data cache updated for user 1
2025-07-10 04:32:57,326 - INFO - orders - Balance/margin cache updated for user 1: balance=348.34000000, margin=13.10
2025-07-10 04:32:57,327 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 04:32:57,327 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 04:32:57,332 - INFO - orders - Fetched 3 open orders for user 1
2025-07-10 04:32:57,336 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 04:32:57,337 - INFO - orders - Updated static orders cache for user 1 with 3 open orders and 1 pending orders
2025-07-10 04:32:57,341 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:57,341 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:32:57,341 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 04:32:57,341 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:32:57,341 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 04:32:57,343 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=348.34000000, margin=13.10
2025-07-10 04:32:57,344 - INFO - orders - Publishing order update for user 1
2025-07-10 04:32:57,345 - INFO - orders - Publishing user data update for user 1
2025-07-10 04:32:57,345 - INFO - orders - Publishing market data trigger
2025-07-10 04:32:57,910 - INFO - orders - Order close request received - Order ID: 6901192288, User ID: 1, Close Price: 95.9
2025-07-10 04:32:57,910 - INFO - orders - Request to close order 6901192288 for user 1 (user_type: demo) with price 95.9. Frontend provided type: BUY, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-10 04:32:57,932 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 04:32:57,950 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 3 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:57,950 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=True
2025-07-10 04:32:57,950 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961'), Decimal('654.794577')], HighestMarginPerLot=654.794577
2025-07-10 04:32:57,950 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:32:57,950 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:57,950 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=False
2025-07-10 04:32:57,951 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961')], HighestMarginPerLot=654.774096
2025-07-10 04:32:57,951 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:32:57,963 - INFO - orders - Existing entry commission for order 6901192288: 0.10000000
2025-07-10 04:32:57,963 - INFO - orders - Commission calculation for order 6901192288: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 04:32:57,963 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -55.000000000000000000000000 JPY to USD for PnL on Close (user_id: 1, position: 6901192288)
2025-07-10 04:32:57,964 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 04:32:57,966 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 04:32:57,966 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 04:32:57,966 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 04:32:57,967 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 04:32:57,968 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 04:32:57,968 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -55.000000000000000000000000 JPY / 146.4780000000 = -0.3754830076871612119226095386 USD
2025-07-10 04:32:58,007 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=347.76000000, margin=13.10
2025-07-10 04:32:58,007 - INFO - orders - Setting user data cache for user 1 with wallet_balance=347.76000000, margin=13.10
2025-07-10 04:32:58,009 - INFO - orders - User data cache updated for user 1
2025-07-10 04:32:58,015 - INFO - orders - Balance/margin cache updated for user 1: balance=347.76000000, margin=13.10
2025-07-10 04:32:58,015 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 04:32:58,015 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 04:32:58,022 - INFO - orders - Fetched 2 open orders for user 1
2025-07-10 04:32:58,029 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 04:32:58,031 - INFO - orders - Updated static orders cache for user 1 with 2 open orders and 1 pending orders
2025-07-10 04:32:58,037 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:58,038 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=False
2025-07-10 04:32:58,038 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961')], HighestMarginPerLot=654.774096
2025-07-10 04:32:58,038 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:32:58,038 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 13.10
2025-07-10 04:32:58,042 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=347.76000000, margin=13.10
2025-07-10 04:32:58,043 - INFO - orders - Publishing order update for user 1
2025-07-10 04:32:58,044 - INFO - orders - Publishing user data update for user 1
2025-07-10 04:32:58,047 - INFO - orders - Publishing market data trigger
2025-07-10 04:32:58,601 - INFO - orders - Order close request received - Order ID: 6766804699, User ID: 1, Close Price: 96
2025-07-10 04:32:58,601 - INFO - orders - Request to close order 6766804699 for user 1 (user_type: demo) with price 96. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-10 04:32:58,613 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 04:32:58,623 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 2 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:58,624 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.02000000, NetQty=0.02000000, IsHedged=False
2025-07-10 04:32:58,624 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096'), Decimal('654.739961')], HighestMarginPerLot=654.774096
2025-07-10 04:32:58,624 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=13.10
2025-07-10 04:32:58,624 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:58,625 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 04:32:58,625 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096')], HighestMarginPerLot=654.774096
2025-07-10 04:32:58,625 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 04:32:58,636 - INFO - orders - Existing entry commission for order 6766804699: 0.10000000
2025-07-10 04:32:58,637 - INFO - orders - Commission calculation for order 6766804699: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 04:32:58,637 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -147.000000000000000000000000 JPY to USD for PnL on Close (user_id: 1, position: 6766804699)
2025-07-10 04:32:58,637 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 04:32:58,638 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 04:32:58,638 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 04:32:58,638 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 04:32:58,639 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 04:32:58,640 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 04:32:58,640 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -147.000000000000000000000000 JPY / 146.4780000000 = -1.003563675091139966411338221 USD
2025-07-10 04:32:58,667 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=346.56000000, margin=6.55
2025-07-10 04:32:58,667 - INFO - orders - Setting user data cache for user 1 with wallet_balance=346.56000000, margin=6.55
2025-07-10 04:32:58,668 - INFO - orders - User data cache updated for user 1
2025-07-10 04:32:58,672 - INFO - orders - Balance/margin cache updated for user 1: balance=346.56000000, margin=6.55
2025-07-10 04:32:58,672 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 04:32:58,673 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 04:32:58,678 - INFO - orders - Fetched 1 open orders for user 1
2025-07-10 04:32:58,682 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 04:32:58,684 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 1 pending orders
2025-07-10 04:32:58,695 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:58,696 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 04:32:58,696 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096')], HighestMarginPerLot=654.774096
2025-07-10 04:32:58,696 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 04:32:58,696 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 04:32:58,699 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=346.56000000, margin=6.55
2025-07-10 04:32:58,699 - INFO - orders - Publishing order update for user 1
2025-07-10 04:32:58,701 - INFO - orders - Publishing user data update for user 1
2025-07-10 04:32:58,703 - INFO - orders - Publishing market data trigger
2025-07-10 04:32:59,243 - INFO - orders - Order close request received - Order ID: 4307769882, User ID: 1, Close Price: 96
2025-07-10 04:32:59,244 - INFO - orders - Request to close order 4307769882 for user 1 (user_type: demo) with price 96. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-10 04:32:59,270 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 04:32:59,284 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 04:32:59,284 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000, IsHedged=False
2025-07-10 04:32:59,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('654.774096')], HighestMarginPerLot=654.774096
2025-07-10 04:32:59,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 04:32:59,285 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDJPY. Returning zero margin.
2025-07-10 04:32:59,295 - INFO - orders - Existing entry commission for order 4307769882: 0.10000000
2025-07-10 04:32:59,295 - INFO - orders - Commission calculation for order 4307769882: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 04:32:59,296 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -146.000000000000000000000000 JPY to USD for PnL on Close (user_id: 1, position: 4307769882)
2025-07-10 04:32:59,296 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 04:32:59,297 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 04:32:59,297 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 04:32:59,297 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 04:32:59,298 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 04:32:59,298 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 04:32:59,299 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -146.000000000000000000000000 JPY / 146.4780000000 = -0.9967367113150097625581998662 USD
2025-07-10 04:32:59,325 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=345.36000000, margin=0
2025-07-10 04:32:59,325 - INFO - orders - Setting user data cache for user 1 with wallet_balance=345.36000000, margin=0
2025-07-10 04:32:59,326 - INFO - orders - User data cache updated for user 1
2025-07-10 04:32:59,330 - INFO - orders - Balance/margin cache updated for user 1: balance=345.36000000, margin=0
2025-07-10 04:32:59,330 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 04:32:59,330 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 04:32:59,334 - INFO - orders - Fetched 0 open orders for user 1
2025-07-10 04:32:59,338 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 04:32:59,340 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 1 pending orders
2025-07-10 04:32:59,348 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=345.36000000, margin=0.0
2025-07-10 04:32:59,348 - INFO - orders - Publishing order update for user 1
2025-07-10 04:32:59,351 - INFO - orders - Publishing user data update for user 1
2025-07-10 04:32:59,352 - INFO - orders - Publishing market data trigger
2025-07-10 04:33:02,934 - INFO - orders - [get_closed_orders] user_type: demo
2025-07-10 04:33:08,044 - INFO - orders - [get_rejected_orders] user_type: demo
2025-07-10 04:33:19,432 - INFO - orders - Order placement request received - User: 1, Symbol: AUDJPY, Type: BUY
2025-07-10 04:33:19,775 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '95.9460000000', 'o': '95.9400000000'}
2025-07-10 04:33:19,776 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=95.9460000000, ask=95.95559460000000
2025-07-10 04:33:19,776 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=95.9460000000, ask=95.95559460000000
2025-07-10 04:33:19,777 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 959.56 JPY to USD for margin_calculation (user_id: 1, position: None)
2025-07-10 04:33:19,777 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 04:33:19,778 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 04:33:19,778 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 04:33:19,778 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 04:33:19,779 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 04:33:19,780 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 04:33:19,780 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 959.56 JPY / 146.4780000000 = 6.550881361023498409317440162 USD
2025-07-10 04:33:19,780 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 95.95559460000000, Margin: 6.550881361023498409317440162, Commission: 0.10
2025-07-10 04:33:19,780 - INFO - orders - [HEDGING_MARGIN_DEBUG] Starting hedging calculation for User: 1, Symbol: AUDJPY, OrderType: BUY, Quantity: 0.01, FullMargin: 6.550881361023498409317440162
2025-07-10 04:33:19,780 - INFO - orders - [HEDGING_MARGIN_DEBUG] Existing open orders count: 0
2025-07-10 04:33:19,780 - INFO - orders - [HEDGING_MARGIN_DEBUG] Created simulated order: Type=BUY, Qty=0.01, Margin=6.550881361023498409317440162
2025-07-10 04:33:19,780 - INFO - orders - [HEDGING_MARGIN_DEBUG] About to calculate margin before and after for 0 existing orders + 1 new order
2025-07-10 04:33:19,781 - INFO - orders - [HEDGING_MARGIN_DEBUG] Executing margin calculation tasks...
2025-07-10 04:33:19,781 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDJPY. Returning zero margin.
2025-07-10 04:33:19,781 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 04:33:19,781 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01, IsHedged=False
2025-07-10 04:33:19,781 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('655.0881361023498409317440162')], HighestMarginPerLot=655.0881361023498409317440162
2025-07-10 04:33:19,781 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 04:33:19,781 - INFO - orders - [HEDGING_MARGIN_DEBUG] Margin calculation tasks completed
2025-07-10 04:33:19,782 - INFO - orders - [HEDGING_MARGIN_DEBUG] User: 1, Symbol: AUDJPY, OrderType: BUY, MarginBefore: 0.0, MarginAfter: 6.55, AdditionalMargin: 6.55, OpenOrders: 0
2025-07-10 04:33:19,782 - INFO - orders - [HEDGING_MARGIN_DEBUG] Simulated order: Type=BUY, Qty=0.01, Margin=6.550881361023498409317440162
2025-07-10 04:33:19,799 - INFO - orders - [CACHE_UPDATE] Updating balance/margin cache for user 1: balance=345.36000000, margin=6.55000000 (was 0E-8)
2025-07-10 04:33:19,799 - INFO - orders - [CACHE_UPDATE] Balance/margin cache updated for user 1
2025-07-10 04:33:19,799 - INFO - orders - [PERF] Order processing: 0.3637s
2025-07-10 04:33:19,816 - INFO - orders - [PERF] Order creation: 0.0167s
2025-07-10 04:33:19,816 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-10 04:33:19,816 - INFO - orders - [PUBLISH_DEBUG] Publishing order update for user 1
2025-07-10 04:33:19,817 - INFO - orders - [PUBLISH_DEBUG] Publishing user data update for user 1
2025-07-10 04:33:19,819 - INFO - orders - [PUBLISH_DEBUG] Publishing market data trigger
2025-07-10 04:33:19,820 - INFO - orders - [PERF] TOTAL place_order: 0.3886s
2025-07-10 04:33:19,845 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 04:33:19,845 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 04:33:19,845 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('655.088136')], HighestMarginPerLot=655.088136
2025-07-10 04:33:19,845 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 04:33:19,845 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 04:33:19,865 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 04:33:19,865 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 04:33:19,866 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('655.088136')], HighestMarginPerLot=655.088136
2025-07-10 04:33:19,866 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 04:33:19,866 - INFO - orders - [TOTAL_USER_MARGIN] User 1 total margin across all symbols: 6.55
2025-07-10 04:33:19,869 - INFO - orders - Background balance/margin cache updated for user 1: balance=345.36000000, margin=6.55
2025-07-10 04:33:22,650 - INFO - orders - Order close request received - Order ID: 1706360528, User ID: 1, Close Price: 95.89
2025-07-10 04:33:22,651 - INFO - orders - Request to close order 1706360528 for user 1 (user_type: demo) with price 95.89. Frontend provided type: BUY, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-10 04:33:22,664 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-10 04:33:22,675 - INFO - orders - [MARGIN_TOTAL_CONTRIB] Calculating margin for 1 positions for User 1, Symbol AUDJPY
2025-07-10 04:33:22,675 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000, IsHedged=False
2025-07-10 04:33:22,675 - INFO - orders - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDJPY: AllMarginsPerLot=[Decimal('655.088136')], HighestMarginPerLot=655.088136
2025-07-10 04:33:22,675 - INFO - orders - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDJPY: CalculatedTotalMargin=6.55
2025-07-10 04:33:22,676 - INFO - orders - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDJPY. Returning zero margin.
2025-07-10 04:33:22,682 - INFO - orders - Existing entry commission for order 1706360528: 0.10000000
2025-07-10 04:33:22,682 - INFO - orders - Commission calculation for order 1706360528: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-10 04:33:22,683 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -105.000000000000000000000000 JPY to USD for PnL on Close (user_id: 1, position: 1706360528)
2025-07-10 04:33:22,683 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-10 04:33:22,683 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-10 04:33:22,684 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-10 04:33:22,684 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-10 04:33:22,685 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('146.4780000000'), 'o': Decimal('146.4770000000')}
2025-07-10 04:33:22,685 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 146.4780000000
2025-07-10 04:33:22,685 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -105.000000000000000000000000 JPY / 146.4780000000 = -0.7168311964936714045795273010 USD
2025-07-10 04:33:22,707 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=344.44000000, margin=0
2025-07-10 04:33:22,708 - INFO - orders - Setting user data cache for user 1 with wallet_balance=344.44000000, margin=0
2025-07-10 04:33:22,709 - INFO - orders - User data cache updated for user 1
2025-07-10 04:33:22,713 - INFO - orders - Balance/margin cache updated for user 1: balance=344.44000000, margin=0
2025-07-10 04:33:22,713 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-10 04:33:22,713 - INFO - orders - Using order model: DemoUserOrder
2025-07-10 04:33:22,718 - INFO - orders - Fetched 0 open orders for user 1
2025-07-10 04:33:22,721 - INFO - orders - Fetched 1 pending orders for user 1
2025-07-10 04:33:22,722 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 1 pending orders
2025-07-10 04:33:22,732 - INFO - orders - User 1: Updated balance/margin cache after static orders update - balance=344.44000000, margin=0.0
2025-07-10 04:33:22,732 - INFO - orders - Publishing order update for user 1
2025-07-10 04:33:22,734 - INFO - orders - Publishing user data update for user 1
2025-07-10 04:33:22,736 - INFO - orders - Publishing market data trigger
